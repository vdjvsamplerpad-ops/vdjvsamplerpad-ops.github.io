const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/AdminAccessDialog-CsgmN8Q-.js","assets/ui-vendor-DQigaf8h.js","assets/react-vendor-ClOJDe5F.js","assets/utils-vendor-Dm3UHTo7.js","assets/supabase-vendor-BjTeASSi.js","assets/index-DcmRPkj8.js","assets/admin-bank-utils-fkyDaT_B.js","assets/VolumeMixer-Jyskqlbo.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=(t,a,n)=>((t,a,n)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[a]=n)(t,"symbol"!=typeof a?a+"":a,n);import{r as a,j as n,S as s,R as i,I as r,O as o,P as l,C as d,a as c,T as u,D as m,b as h,c as f,d as p,e as g,f as b,g as v,h as y,i as _,V as x,L as w,k,l as M,m as S,n as C,o as N,p as A,q as E,s as I,t as j,u as T,v as B,w as P,x as R,y as D}from"./ui-vendor-DQigaf8h.js";import{a as O,g as L}from"./react-vendor-ClOJDe5F.js";import{c as F,_ as U}from"./supabase-vendor-BjTeASSi.js";import{t as V,c as $,a as H,X as K,C as q,b as z,d as G,T as X,e as W,S as Y,P as Z,I as J,A as Q,V as ee,Z as te,M as ae,f as ne,g as se,h as ie,i as re,j as oe,D as le,U as de,k as ce,l as ue,m as me,L as he,E as fe,n as pe,o as ge,p as be,q as ve,r as ye,s as _e,u as xe,v as we,w as ke,R as Me,H as Se,B as Ce}from"./utils-vendor-Dm3UHTo7.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var Ne,Ae={};var Ee=function(){if(Ne)return Ae;Ne=1;var e=O();return Ae.createRoot=e.createRoot,Ae.hydrateRoot=e.hydrateRoot,Ae}();function Ie(...e){return V($(e))}const je=H("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",lg:"h-10 rounded-md px-8",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),Te=a.forwardRef(({className:e,variant:t,size:a,asChild:i=!1,...r},o)=>{const l=i?s:"button";return n.jsx(l,{className:Ie(je({variant:t,size:a,className:e})),ref:o,...r})});Te.displayName="Button";const Be=a.forwardRef(({className:e,value:t,...a},s)=>n.jsx(i,{ref:s,className:Ie("relative h-2 w-full overflow-hidden rounded-full bg-primary/20",e),...a,children:n.jsx(r,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(t||0)}%)`}})}));Be.displayName=i.displayName;class Pe{constructor(e={}){t(this,"config"),t(this,"state"),t(this,"audioContext",null),t(this,"silentAudio",null),t(this,"silentInterval",null),t(this,"unlockListeners",new Set),t(this,"isIOS"),this.config={enableRingerBypass:!0,enableControlCenterSupport:!0,silentAudioInterval:3e4,unlockRetryCount:3,debugLogging:!0,...e},this.state={isUnlocked:!1,isRingerBypassed:!1,lastUserInteraction:0,failureCount:0,contextState:"unknown"},this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,this.isIOS&&(this.log("üçé iOS detected, initializing enhanced audio service..."),this.initialize())}log(e,...t){this.config.debugLogging&&console.log(`[IOSAudioService] ${e}`,...t)}async initialize(){this.setupAudioContext(),this.setupSilentAudio(),this.setupUnlockHandlers(),this.setupControlCenterSupport(),this.startSilentAudioLoop()}setupAudioContext(){try{const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e({sampleRate:44100,latencyHint:"interactive"}),this.state.contextState=this.audioContext.state,this.log(`AudioContext created with state: ${this.audioContext.state}`),this.audioContext.addEventListener("statechange",()=>{this.state.contextState=this.audioContext.state,this.log(`AudioContext state changed to: ${this.audioContext.state}`),"suspended"===this.audioContext.state&&(this.state.isUnlocked=!1,this.attemptUnlock("statechange"))})}catch(e){this.log("‚ùå Failed to create AudioContext:",e)}}setupSilentAudio(){if(this.config.enableRingerBypass)try{this.silentAudio=new Audio,this.silentAudio.src=this.createSilentAudioDataURL(),this.silentAudio.loop=!0,this.silentAudio.volume=.01,this.silentAudio.preload="auto",this.silentAudio.playsInline=!0,this.silentAudio.disableRemotePlayback=!0,this.silentAudio.addEventListener("canplaythrough",()=>{this.log("üîá Silent audio ready")}),this.silentAudio.addEventListener("ended",()=>{var e;this.state.isRingerBypassed&&(null==(e=this.silentAudio)||e.play().catch(()=>{}))}),this.silentAudio.addEventListener("error",e=>{this.log("‚ùå Silent audio error:",e),this.recreateSilentAudio()})}catch(e){this.log("‚ùå Failed to setup silent audio:",e)}}createSilentAudioDataURL(){const e=44100,t=44100,a=new ArrayBuffer(88244),n=new DataView(a),s=(e,t)=>{for(let a=0;a<t.length;a++)n.setUint8(e+a,t.charCodeAt(a))};s(0,"RIFF"),n.setUint32(4,88236,!0),s(8,"WAVE"),s(12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,1,!0),n.setUint32(24,e,!0),n.setUint32(28,88200,!0),n.setUint16(32,2,!0),n.setUint16(34,16,!0),s(36,"data"),n.setUint32(40,88200,!0);for(let r=0;r<t;r++)n.setInt16(44+2*r,0,!0);const i=new Blob([a],{type:"audio/wav"});return URL.createObjectURL(i)}recreateSilentAudio(){this.log("üîÑ Recreating silent audio..."),this.silentAudio&&(this.silentAudio.pause(),this.silentAudio.src=""),setTimeout(()=>{this.setupSilentAudio()},1e3)}setupUnlockHandlers(){const e=e=>{this.state.lastUserInteraction=Date.now(),this.attemptUnlock(e.type)};["touchstart","touchend","touchmove","click","mousedown","mouseup","keydown","keyup","focus","scroll","gesturestart","gesturechange","gestureend","orientationchange","devicemotion","deviceorientation"].forEach(t=>{document.addEventListener(t,e,{passive:!0,capture:!0})}),document.addEventListener("visibilitychange",()=>{document.hidden||(this.log("üì± App became visible, attempting unlock..."),this.attemptUnlock("visibilitychange"))}),window.addEventListener("focus",()=>{this.log("üîÑ Window focused, attempting unlock..."),this.attemptUnlock("focus")})}setupControlCenterSupport(){this.config.enableControlCenterSupport&&"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:"VDJV Sampler Pad",artist:"Audio Sampler",album:"Live Performance",artwork:[{src:"/assets/logo.png",sizes:"192x192",type:"image/png"}]}),navigator.mediaSession.setActionHandler("play",()=>{this.log("‚ñ∂Ô∏è Control Center play requested"),this.handleControlCenterPlay()}),navigator.mediaSession.setActionHandler("pause",()=>{this.log("‚è∏Ô∏è Control Center pause requested"),this.handleControlCenterPause()}),navigator.mediaSession.setActionHandler("stop",()=>{this.log("‚èπÔ∏è Control Center stop requested"),this.handleControlCenterStop()}),this.log("üéõÔ∏è Control Center support enabled"))}startSilentAudioLoop(){this.config.enableRingerBypass&&!this.silentInterval&&(this.silentInterval=setInterval(()=>{this.state.isRingerBypassed&&this.silentAudio&&(this.silentAudio.paused||this.silentAudio.ended)&&(this.log("üîÑ Restarting silent audio..."),this.silentAudio.play().catch(()=>{}))},this.config.silentAudioInterval),this.log("üîÅ Silent audio loop started"))}async attemptUnlock(e){if(this.state.isUnlocked||!this.audioContext)return this.state.isUnlocked;this.log(`üîì Attempting unlock (trigger: ${e})...`);try{"suspended"===this.audioContext.state&&(await this.audioContext.resume(),this.log("‚úÖ AudioContext resumed"));const e=this.config.enableRingerBypass&&this.silentAudio&&!this.state.isRingerBypassed?this.silentAudio.play().then(()=>{this.state.isRingerBypassed=!0,this.log("üîá Silent audio started (ringer bypass active)")}).catch(e=>{this.log("‚ö†Ô∏è Silent audio failed:",e)}):Promise.resolve(),t="running"===this.audioContext.state?Promise.resolve().then(()=>{const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();t.gain.value=0,e.connect(t),t.connect(this.audioContext.destination),e.start(),e.stop(this.audioContext.currentTime+.01),this.log("üéµ Test oscillator played")}):Promise.resolve();await Promise.all([e,t]);const a="running"===this.audioContext.state;return a&&!this.state.isUnlocked?(this.state.isUnlocked=!0,this.state.failureCount=0,this.log("üéâ AudioContext successfully unlocked!"),this.notifyUnlockListeners()):a||(this.state.failureCount++,this.log(`‚ùå Unlock failed (attempt ${this.state.failureCount})`)),a}catch(t){return this.state.failureCount++,this.log("‚ùå Unlock attempt failed:",t),this.state.failureCount>=this.config.unlockRetryCount&&(this.log("üîÑ Attempting recovery..."),this.recreateAudioContext()),!1}}recreateAudioContext(){if(this.log("üîÑ Recreating AudioContext..."),this.audioContext)try{this.audioContext.close()}catch(e){this.log("‚ö†Ô∏è Error closing old AudioContext:",e)}this.state.isUnlocked=!1,this.state.failureCount=0,setTimeout(()=>{this.setupAudioContext()},1e3)}handleControlCenterPlay(){window.dispatchEvent(new CustomEvent("ios-audio-control-play"))}handleControlCenterPause(){window.dispatchEvent(new CustomEvent("ios-audio-control-pause"))}handleControlCenterStop(){window.dispatchEvent(new CustomEvent("ios-audio-control-stop"))}notifyUnlockListeners(){this.unlockListeners.forEach(e=>{try{e()}catch(t){this.log("‚ùå Unlock listener error:",t)}})}getAudioContext(){return this.audioContext}isUnlocked(){var e;return this.state.isUnlocked&&"running"===(null==(e=this.audioContext)?void 0:e.state)}isRingerBypassed(){return this.state.isRingerBypassed}getState(){return{...this.state}}onUnlock(e){return this.unlockListeners.add(e),()=>this.unlockListeners.delete(e)}async forceUnlock(){return this.log("üî® Force unlock requested"),this.attemptUnlock("manual")}updateMediaSession(e,t){"mediaSession"in navigator&&navigator.mediaSession.metadata&&(navigator.mediaSession.metadata.title=e,t&&(navigator.mediaSession.metadata.artist=t))}destroy(){if(this.log("üßπ Destroying iOS Audio Service..."),this.silentInterval&&(clearInterval(this.silentInterval),this.silentInterval=null),this.silentAudio&&(this.silentAudio.pause(),this.silentAudio.src="",this.silentAudio=null),this.audioContext&&"closed"!==this.audioContext.state)try{this.audioContext.close()}catch(e){this.log("‚ö†Ô∏è Error closing AudioContext:",e)}this.unlockListeners.clear(),this.state.isUnlocked=!1,this.state.isRingerBypassed=!1}}let Re=null;function De(){return Re||(Re=new Pe),Re}const Oe="undefined"!=typeof navigator&&/iPad|iPhone|iPod/.test(navigator.userAgent),Le="undefined"!=typeof navigator&&/Android/.test(navigator.userAgent),Fe=Oe?100:Le?50:16,Ue=52428800;const Ve=new class{constructor(){t(this,"audioInstances",new Map),t(this,"registeredPads",new Map),t(this,"stateChangeListeners",new Set),t(this,"globalMuted",!1),t(this,"masterVolume",1),t(this,"globalEQ",{low:0,mid:0,high:0}),t(this,"audioContext",null),t(this,"isIOS",!1),t(this,"isAndroid",!1),t(this,"contextUnlocked",!1),t(this,"silentAudio",null),t(this,"iosAudioService",null),t(this,"notificationTimeout",null),t(this,"sharedIOSGainNode",null),t(this,"channelAssignments",new Map),t(this,"channelVolumes",new Map),t(this,"deckChannels",new Map),t(this,"deckChannelCount",4),t(this,"waveformCacheRefs",new Map),t(this,"isPrewarmed",!1),t(this,"bufferCache",new Map),t(this,"bufferMemoryUsage",0),t(this,"bufferAccessTime",new Map),t(this,"masterVolumeRafId",null),t(this,"pendingMasterVolume",null),t(this,"eqRafId",null),t(this,"pendingGlobalEQ",null),t(this,"foregroundUnlockTimeout",null),this.isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,this.isAndroid=/Android/.test(navigator.userAgent);for(let t=1;t<=8;t+=1)this.ensureDeckChannelRuntime(t);this.isIOS&&(this.iosAudioService=De(),this.iosAudioService.onUnlock(()=>{this.contextUnlocked=!0,this.audioContext=this.iosAudioService.getAudioContext(),this.setupSharedIOSNodes()}),window.addEventListener("ios-audio-control-pause",()=>this.stopAllPads("fadeout")),window.addEventListener("ios-audio-control-stop",()=>this.stopAllPads("instant")));const e=()=>{"undefined"!=typeof document&&document.hidden||(this.foregroundUnlockTimeout&&clearTimeout(this.foregroundUnlockTimeout),this.foregroundUnlockTimeout=setTimeout(()=>{(this.contextUnlocked||this.hasUserActivation())&&this.preUnlockAudio().catch(e=>{console.warn("Foreground audio restore failed:",e)})},60))};"undefined"!=typeof document&&document.addEventListener("visibilitychange",e),"undefined"!=typeof window&&(window.addEventListener("focus",e),window.addEventListener("pageshow",e)),this.initializeAudioContext()}hasUserActivation(){var e,t;const a=navigator;return Boolean((null==(e=a.userActivation)?void 0:e.isActive)||(null==(t=a.userActivation)?void 0:t.hasBeenActive))}initializeAudioContext(){if(!this.audioContext)try{if(this.isIOS&&this.iosAudioService)return this.audioContext=this.iosAudioService.getAudioContext(),this.contextUnlocked=this.iosAudioService.isUnlocked(),void(this.contextUnlocked&&this.setupSharedIOSNodes());const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e({latencyHint:"interactive",sampleRate:44100}),this.isIOS&&(this.createSilentAudio(),this.setupSharedIOSNodes()),this.contextUnlocked||this.setupAudioContextUnlock()}catch(e){console.error("Failed to create AudioContext:",e)}}setupSharedIOSNodes(){if(this.audioContext&&!this.sharedIOSGainNode)try{this.sharedIOSGainNode=this.audioContext.createGain(),this.sharedIOSGainNode.gain.setValueAtTime(this.masterVolume,this.audioContext.currentTime),this.sharedIOSGainNode.connect(this.audioContext.destination),console.log("üéß iOS shared audio nodes created")}catch(e){console.error("Failed to setup shared iOS nodes:",e)}}createSilentAudio(){this.silentAudio=new Audio,this.silentAudio.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA",this.silentAudio.loop=!0,this.silentAudio.volume=.01}setupAudioContextUnlock(){const e=async()=>{if(this.audioContext&&!this.contextUnlocked)try{"suspended"===this.audioContext.state&&await this.audioContext.resume(),this.isIOS&&this.silentAudio&&(this.silentAudio.play().catch(()=>{}),this.silentAudio.load()),this.contextUnlocked=!0,this.setupSharedIOSNodes(),["click","touchstart","touchend","mousedown"].forEach(t=>{document.removeEventListener(t,e)}),console.log("üîì AudioContext unlocked")}catch(t){console.error("Failed to unlock AudioContext:",t)}};["click","touchstart","touchend","mousedown"].forEach(t=>{document.addEventListener(t,e,{once:!1,passive:!0})})}async preUnlockAudio(){var e,t;try{if(this.audioContext||this.initializeAudioContext(),"suspended"===(null==(e=this.audioContext)?void 0:e.state)){if(!this.contextUnlocked&&!this.hasUserActivation())return;await this.audioContext.resume()}if(this.isIOS&&this.iosAudioService&&!this.iosAudioService.isUnlocked())try{await this.iosAudioService.forceUnlock()}catch(a){console.warn("iOS force unlock failed:",a)}if(this.audioContext&&!this.isPrewarmed){const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();t.gain.setValueAtTime(0,this.audioContext.currentTime),e.connect(t),t.connect(this.audioContext.destination),e.start(),e.stop(this.audioContext.currentTime+.001),this.isPrewarmed=!0}this.contextUnlocked="running"===(null==(t=this.audioContext)?void 0:t.state),console.log("üî• Audio system pre-warmed")}catch(a){if("notallowederror"===String((null==a?void 0:a.name)||"").toLowerCase())return;console.error("Pre-warm failed:",a)}}getBufferSize(e){return e.length*e.numberOfChannels*4}evictOldestBuffers(e){if(!this.isIOS)return;const t=Array.from(this.bufferAccessTime.entries()).sort((e,t)=>e[1]-t[1]);let a=0;for(const[n]of t){if(this.bufferMemoryUsage+e-a<=Ue)break;const t=this.bufferCache.get(n);if(t){const e=this.getBufferSize(t);this.bufferCache.delete(n),this.bufferAccessTime.delete(n),a+=e,this.audioInstances.forEach(e=>{e.lastAudioUrl!==n||e.isPlaying||(e.audioBuffer=null)}),console.log(`üóëÔ∏è Evicted buffer: ${(e/1024/1024).toFixed(2)}MB freed`)}}this.bufferMemoryUsage-=a}async decodeAudioBuffer(e){if(!this.audioContext)return null;const t=this.bufferCache.get(e);if(t)return this.bufferAccessTime.set(e,Date.now()),t;try{const t=await fetch(e),a=await t.arrayBuffer(),n=await this.audioContext.decodeAudioData(a),s=this.getBufferSize(n);return this.isIOS&&this.bufferMemoryUsage+s>Ue&&this.evictOldestBuffers(s),this.bufferCache.set(e,n),this.bufferAccessTime.set(e,Date.now()),this.bufferMemoryUsage+=s,this.isIOS&&console.log(`üéµ Buffer cached: ${(s/1024/1024).toFixed(2)}MB (total: ${(this.bufferMemoryUsage/1024/1024).toFixed(2)}MB)`),n}catch(a){return console.error("Failed to decode audio buffer:",a),null}}enforceAudioLimit(){let e=0;if(this.audioInstances.forEach(t=>{t.audioElement&&e++}),e<800)return;const t=[];this.audioInstances.forEach(e=>{!e.audioElement||e.isPlaying||e.isFading||t.push(e)}),t.sort((e,t)=>e.lastUsedTime-t.lastUsedTime),t.length>0&&this.dehydrateInstance(t[0])}dehydrateInstance(e){if(e.audioElement||e.bufferSourceNode)try{e.cleanupFunctions.forEach(e=>{try{e()}catch(t){}}),e.cleanupFunctions=[],e.audioElement&&(e.audioElement.pause(),e.audioElement.src="",e.audioElement.load()),e.iosProgressInterval&&(clearInterval(e.iosProgressInterval),e.iosProgressInterval=null),this.disconnectAudioNodes(e),e.audioElement=null,e.sourceNode=null,e.bufferSourceNode=null,e.isConnected=!1,e.sourceConnected=!1}catch(t){console.error("Error dehydrating instance:",t)}}ensureAudioResources(e){if(e.lastUsedTime=Date.now(),this.isIOS&&e.audioBuffer)return!0;if(e.audioElement)return!0;if(!e.lastAudioUrl)return!1;try{this.enforceAudioLimit();const t=new Audio;t.crossOrigin="anonymous",t.src=e.lastAudioUrl,t.muted=!1,t.volume=1,t.preload=this.isIOS?"none":"metadata",t.playsInline=!0,t.muted=!1,t.volume=1,"preservesPitch"in t&&!this.isIOS&&(t.preservesPitch=!1),t.playbackRate=Math.pow(2,(e.pitch||0)/12),t.loop="loop"===e.playbackMode,e.audioElement=t;const a=()=>{if(!e.audioElement)return;const t=1e3*e.audioElement.currentTime,a=(e.endTimeMs||1e3*e.audioElement.duration)-(e.startTimeMs||0),n=(t-(e.startTimeMs||0))/a*100;e.progress=Math.max(0,Math.min(100,n)),this.notifyStateChange(),e.endTimeMs>0&&t>=e.endTimeMs&&("once"===e.playbackMode||"stopper"===e.playbackMode?this.stopPad(e.padId,"instant"):"loop"===e.playbackMode&&(e.audioElement.currentTime=(e.startTimeMs||0)/1e3))},n=()=>{"once"!==e.playbackMode&&"stopper"!==e.playbackMode||(e.isPlaying=!1,e.progress=0,e.isFading=!1,this.stopFadeAutomation(e),this.releaseChannel(e),this.notifyStateChange())},s=()=>{e.audioElement&&(e.startTimeMs>0&&(e.audioElement.currentTime=e.startTimeMs/1e3),0===e.endTimeMs&&(e.endTimeMs=1e3*e.audioElement.duration))},i=()=>{};return t.addEventListener("timeupdate",a),t.addEventListener("ended",n),t.addEventListener("loadedmetadata",s),t.addEventListener("canplaythrough",i),e.cleanupFunctions.push(()=>t.removeEventListener("timeupdate",a),()=>t.removeEventListener("ended",n),()=>t.removeEventListener("loadedmetadata",s),()=>t.removeEventListener("canplaythrough",i)),!0}catch(t){return console.error("Failed to hydrate audio instance:",t),!1}}async registerPad(e,t,a,n){this.audioContext||this.initializeAudioContext();const s=this.audioInstances.get(e);if(s&&s.lastAudioUrl===t.audioUrl)return s.padName=t.name,s.bankId=a,s.bankName=n,s.color=t.color,s.volume=t.volume,s.ignoreChannel=!!t.ignoreChannel,"number"!=typeof s.playToken&&(s.playToken=0),void 0===s.pendingDecodePlayToken&&(s.pendingDecodePlayToken=null),void 0===s.reversedBackspinBuffer&&(s.reversedBackspinBuffer=null),this.updatePadSettings(e,{triggerMode:t.triggerMode,playbackMode:t.playbackMode,startTimeMs:t.startTimeMs,endTimeMs:t.endTimeMs,fadeInMs:t.fadeInMs,fadeOutMs:t.fadeOutMs,pitch:t.pitch,ignoreChannel:t.ignoreChannel}),s.lastUsedTime=Date.now(),this.registeredPads.set(e,{padId:e,padName:t.name,bankId:a,bankName:n,color:t.color,audioUrl:t.audioUrl,volume:"number"==typeof t.volume?t.volume:1,startTimeMs:"number"==typeof t.startTimeMs?t.startTimeMs:0,endTimeMs:"number"==typeof t.endTimeMs?t.endTimeMs:0,fadeInMs:"number"==typeof t.fadeInMs?t.fadeInMs:0,fadeOutMs:"number"==typeof t.fadeOutMs?t.fadeOutMs:0,pitch:"number"==typeof t.pitch?t.pitch:0,playbackMode:"loop"===t.playbackMode?"loop":"stopper"===t.playbackMode?"stopper":"once",savedHotcuesMs:Array.isArray(t.savedHotcuesMs)?t.savedHotcuesMs.slice(0,4):[null,null,null,null]}),void this.notifyStateChange();if(s&&this.cleanupInstance(s),!t.audioUrl)return;const i={padId:e,padName:t.name,bankId:a,bankName:n,color:t.color,volume:t.volume,channelId:null,ignoreChannel:!!t.ignoreChannel,audioElement:null,audioContext:this.audioContext,sourceNode:null,gainNode:null,filterNode:null,eqNodes:{low:null,mid:null,high:null},isPlaying:!1,progress:0,triggerMode:t.triggerMode,playbackMode:t.playbackMode,startTimeMs:t.startTimeMs||0,endTimeMs:t.endTimeMs||0,fadeInMs:t.fadeInMs||0,fadeOutMs:t.fadeOutMs||0,pitch:t.pitch||0,fadeIntervalId:null,fadeAnimationFrameId:null,fadeMonitorFrameId:null,cleanupFunctions:[],isFading:!1,isConnected:!1,lastAudioUrl:t.audioUrl,sourceConnected:!1,fadeInStartTime:null,fadeOutStartTime:null,playStartTime:null,softMuted:!1,nextPlayOverrides:void 0,lastUsedTime:Date.now(),audioBuffer:null,bufferSourceNode:null,isBufferDecoding:!1,bufferDuration:0,iosProgressInterval:null,stopEffectTimeoutId:null,playToken:0,pendingDecodePlayToken:null,reversedBackspinBuffer:null};this.audioInstances.set(e,i),this.registeredPads.set(e,{padId:e,padName:t.name,bankId:a,bankName:n,color:t.color,audioUrl:t.audioUrl,volume:"number"==typeof t.volume?t.volume:1,startTimeMs:"number"==typeof t.startTimeMs?t.startTimeMs:0,endTimeMs:"number"==typeof t.endTimeMs?t.endTimeMs:0,fadeInMs:"number"==typeof t.fadeInMs?t.fadeInMs:0,fadeOutMs:"number"==typeof t.fadeOutMs?t.fadeOutMs:0,pitch:"number"==typeof t.pitch?t.pitch:0,playbackMode:"loop"===t.playbackMode?"loop":"stopper"===t.playbackMode?"stopper":"once",savedHotcuesMs:Array.isArray(t.savedHotcuesMs)?t.savedHotcuesMs.slice(0,4):[null,null,null,null]}),this.isIOS?this.audioInstances.size<=12&&this.startBufferDecode(i):this.ensureAudioResources(i),this.notifyStateChange()}async startBufferDecode(e){if(e.lastAudioUrl&&!e.isBufferDecoding&&!e.audioBuffer){e.isBufferDecoding=!0;try{const t=await this.decodeAudioBuffer(e.lastAudioUrl);t&&(e.audioBuffer=t,e.reversedBackspinBuffer=null,e.bufferDuration=1e3*t.duration,0===e.endTimeMs&&(e.endTimeMs=e.bufferDuration),console.log(`üéµ Buffer decoded for ${e.padName} (${t.duration.toFixed(2)}s)`))}catch(t){console.error(`Failed to decode buffer for ${e.padName}:`,t)}finally{e.isBufferDecoding=!1}}}getBaseGain(e){const t=e.channelId?this.channelVolumes.get(e.channelId)??1:1;return this.globalMuted||e.softMuted?0:this.isIOS&&this.sharedIOSGainNode?e.volume*t:e.volume*this.masterVolume*t}getStopTimingProfile(){return this.isIOS?{instantStopFadeSec:.014,instantStopFinalizeDelayMs:18,defaultFadeOutMs:900,brakeDurationSec:1.35,brakeMinRate:.08,brakeWebDurationMs:1350,backspinIOSPitchStart:1.7,backspinIOSPitchEnd:2.8,backspinIOSPitchRampSec:.22,backspinIOSDurationSec:.56,backspinWebSpeedUpMs:420,backspinWebTotalMs:900,backspinWebMaxRate:2.8,backspinWebMinRate:.24,filterDurationSec:1.2,filterEndHz:120,volumeSmoothingSec:.016,softMuteSmoothingSec:.014,masterSmoothingSec:.012}:this.isAndroid?{instantStopFadeSec:.02,instantStopFinalizeDelayMs:24,defaultFadeOutMs:800,brakeDurationSec:1.2,brakeMinRate:.1,brakeWebDurationMs:1200,backspinIOSPitchStart:1.8,backspinIOSPitchEnd:3,backspinIOSPitchRampSec:.24,backspinIOSDurationSec:.58,backspinWebSpeedUpMs:380,backspinWebTotalMs:780,backspinWebMaxRate:2.7,backspinWebMinRate:.28,filterDurationSec:1.1,filterEndHz:160,volumeSmoothingSec:.02,softMuteSmoothingSec:.018,masterSmoothingSec:.015}:{instantStopFadeSec:.012,instantStopFinalizeDelayMs:14,defaultFadeOutMs:900,brakeDurationSec:1.4,brakeMinRate:.08,brakeWebDurationMs:1400,backspinIOSPitchStart:1.8,backspinIOSPitchEnd:3.1,backspinIOSPitchRampSec:.28,backspinIOSDurationSec:.62,backspinWebSpeedUpMs:500,backspinWebTotalMs:950,backspinWebMaxRate:3,backspinWebMinRate:.2,filterDurationSec:1.35,filterEndHz:100,volumeSmoothingSec:.012,softMuteSmoothingSec:.01,masterSmoothingSec:.01}}assignChannel(e){if(e.ignoreChannel)return this.releaseChannel(e),!0;if(e.channelId&&this.channelAssignments.get(e.channelId)===e.padId)return!0;if(e.channelId&&!this.channelAssignments.has(e.channelId))return this.channelAssignments.set(e.channelId,e.padId),!0;for(let t=1;t<=8;t+=1)if(!this.channelAssignments.has(t))return this.channelAssignments.set(t,e.padId),e.channelId=t,!0;return!1}releaseChannel(e,t){t||(e.channelId&&this.channelAssignments.get(e.channelId)===e.padId&&this.channelAssignments.delete(e.channelId),e.channelId=null)}stopFadeAutomation(e){e.fadeIntervalId&&(clearInterval(e.fadeIntervalId),e.fadeIntervalId=null),null!==e.fadeAnimationFrameId&&(cancelAnimationFrame(e.fadeAnimationFrameId),e.fadeAnimationFrameId=null),null!==e.fadeMonitorFrameId&&(cancelAnimationFrame(e.fadeMonitorFrameId),e.fadeMonitorFrameId=null),e.iosProgressInterval&&(clearInterval(e.iosProgressInterval),e.iosProgressInterval=null),e.stopEffectTimeoutId&&(clearTimeout(e.stopEffectTimeoutId),e.stopEffectTimeoutId=null),e.gainNode&&this.audioContext&&e.gainNode.gain.cancelScheduledValues(this.audioContext.currentTime)}setGain(e,t){if(!e.gainNode||!this.audioContext)return;const a=Math.max(0,t),n=this.audioContext.currentTime;e.gainNode.gain.cancelScheduledValues(n),e.gainNode.gain.setValueAtTime(a,n)}startManualFade(e,t,a,n,s){if(!e.gainNode||!this.audioContext)return void(s&&s());const i=this.audioContext.currentTime,r=Math.max(0,n)/1e3,o=Math.max(0,t),l=Math.max(0,a);e.gainNode.gain.cancelScheduledValues(i),e.gainNode.gain.setValueAtTime(o,i),e.gainNode.gain.linearRampToValueAtTime(l,i+r),0===n?s&&s():setTimeout(()=>{s&&s()},n)}startFadeOutMonitor(e){if(this.isIOS&&e.bufferSourceNode)return void this.startIOSFadeOutMonitor(e);if(!e.audioElement)return;null!==e.fadeMonitorFrameId&&cancelAnimationFrame(e.fadeMonitorFrameId),e.fadeOutStartTime=null;const t=()=>{if(!e.audioElement||!e.isPlaying)return void(e.fadeMonitorFrameId=null);const a=e.startTimeMs||0,n=(e.endTimeMs>a?e.endTimeMs:1e3*(e.audioElement.duration||0))-1e3*e.audioElement.currentTime;if(e.fadeOutMs>0&&n<=e.fadeOutMs&&null===e.fadeOutStartTime){const t=e.gainNode?e.gainNode.gain.value:this.getBaseGain(e);e.fadeOutStartTime=performance.now(),e.isFading=!0,this.startManualFade(e,t,0,Math.max(0,n),()=>{e.fadeOutStartTime=null,e.isFading=!1})}e.fadeMonitorFrameId=requestAnimationFrame(t)};e.fadeMonitorFrameId=requestAnimationFrame(t)}startIOSFadeOutMonitor(e){e.iosProgressInterval&&clearInterval(e.iosProgressInterval);const t=performance.now(),a=e.startTimeMs||0,n=(e.endTimeMs||e.bufferDuration)-a;let s=0;const i=this.isIOS?200:this.isAndroid?100:50;e.iosProgressInterval=setInterval(()=>{if(!e.isPlaying)return void(e.iosProgressInterval&&(clearInterval(e.iosProgressInterval),e.iosProgressInterval=null));const a=(performance.now()-t)*Math.pow(2,(e.pitch||0)/12),i=Math.min(100,a/n*100);e.progress=i;const r=n-a;if(e.fadeOutMs>0&&r<=e.fadeOutMs&&null===e.fadeOutStartTime){const t=e.gainNode?e.gainNode.gain.value:this.getBaseGain(e);e.fadeOutStartTime=performance.now(),e.isFading=!0,this.startManualFade(e,t,0,Math.max(0,r),()=>{e.fadeOutStartTime=null,e.isFading=!1})}a>=n&&("loop"===e.playbackMode||this.stopPad(e.padId,"instant")),(Math.abs(i-s)>=5||i>=100)&&(s=i,this.notifyStateChange())},i)}connectAudioNodesIOS(e){if(this.audioContext&&this.sharedIOSGainNode)try{e.eqNodes.low||(e.eqNodes.low=this.audioContext.createBiquadFilter(),e.eqNodes.low.type="peaking",e.eqNodes.low.frequency.setValueAtTime(100,this.audioContext.currentTime)),e.eqNodes.mid||(e.eqNodes.mid=this.audioContext.createBiquadFilter(),e.eqNodes.mid.type="peaking",e.eqNodes.mid.frequency.setValueAtTime(1e3,this.audioContext.currentTime)),e.eqNodes.high||(e.eqNodes.high=this.audioContext.createBiquadFilter(),e.eqNodes.high.type="peaking",e.eqNodes.high.frequency.setValueAtTime(1e4,this.audioContext.currentTime)),e.filterNode||(e.filterNode=this.audioContext.createBiquadFilter(),e.filterNode.type="lowpass",e.filterNode.frequency.setValueAtTime(2e4,this.audioContext.currentTime),e.filterNode.Q.setValueAtTime(1,this.audioContext.currentTime)),e.gainNode||(e.gainNode=this.audioContext.createGain(),e.eqNodes.low.connect(e.eqNodes.mid),e.eqNodes.mid.connect(e.eqNodes.high),e.eqNodes.high.connect(e.filterNode),e.filterNode.connect(e.gainNode),e.gainNode.connect(this.sharedIOSGainNode)),e.audioElement&&!e.sourceNode&&(e.sourceNode=this.audioContext.createMediaElementSource(e.audioElement)),e.sourceNode&&!e.sourceConnected&&(e.sourceNode.connect(e.eqNodes.low||e.filterNode||e.gainNode),e.sourceConnected=!0),e.isConnected=!0,this.applyGlobalSettingsToInstance(e)}catch(t){console.error("Failed to connect iOS audio nodes:",t),e.isConnected=!1}}connectAudioNodes(e){if(this.audioContext&&!e.isConnected&&e.audioElement)if(this.isIOS)this.connectAudioNodesIOS(e);else try{e.sourceNode||(e.sourceNode=this.audioContext.createMediaElementSource(e.audioElement),e.sourceConnected=!0),e.gainNode||(e.gainNode=this.audioContext.createGain()),e.filterNode||(e.filterNode=this.audioContext.createBiquadFilter(),e.filterNode.type="lowpass",e.filterNode.frequency.setValueAtTime(2e4,this.audioContext.currentTime)),e.eqNodes.low||(e.eqNodes.low=this.audioContext.createBiquadFilter(),e.eqNodes.low.type="peaking",e.eqNodes.low.frequency.setValueAtTime(100,this.audioContext.currentTime)),e.eqNodes.mid||(e.eqNodes.mid=this.audioContext.createBiquadFilter(),e.eqNodes.mid.type="peaking",e.eqNodes.mid.frequency.setValueAtTime(1e3,this.audioContext.currentTime)),e.eqNodes.high||(e.eqNodes.high=this.audioContext.createBiquadFilter(),e.eqNodes.high.type="peaking",e.eqNodes.high.frequency.setValueAtTime(1e4,this.audioContext.currentTime)),e.sourceNode&&(e.sourceNode.connect(e.eqNodes.low),e.eqNodes.low.connect(e.eqNodes.mid),e.eqNodes.mid.connect(e.eqNodes.high),e.eqNodes.high.connect(e.filterNode),e.filterNode.connect(e.gainNode),e.gainNode.connect(this.audioContext.destination)),e.isConnected=!0,this.applyGlobalSettingsToInstance(e)}catch(t){console.error("Failed to connect audio nodes:",t),e.isConnected=!1}}disconnectAudioNodes(e){var t,a,n,s,i;if(e.isConnected)try{if(e.bufferSourceNode){try{e.bufferSourceNode.stop(),e.bufferSourceNode.disconnect()}catch(r){}e.bufferSourceNode=null}if(e.sourceNode){try{e.sourceNode.disconnect()}catch(r){}e.sourceConnected=!1}null==(t=e.gainNode)||t.disconnect(),null==(a=e.filterNode)||a.disconnect(),null==(n=e.eqNodes.high)||n.disconnect(),null==(s=e.eqNodes.mid)||s.disconnect(),null==(i=e.eqNodes.low)||i.disconnect(),e.isConnected=!1}catch(o){console.warn("Error disconnecting audio nodes:",o)}}playPad(e){const t=this.audioInstances.get(e);if(!t)return;t.lastUsedTime=Date.now();const a=(t.playToken||0)+1;if(t.playToken=a,t.pendingDecodePlayToken=null,this.isIOS)return void this.playPadIOS(t,a);if(!this.ensureAudioResources(t))return console.error("Could not allocate audio resource for pad:",e),void this.releaseChannel(t);if(!this.contextUnlocked&&this.audioContext){const e="suspended"===this.audioContext.state?this.audioContext.resume():Promise.resolve(),n=this.silentAudio?this.silentAudio.play().catch(()=>{}):Promise.resolve();return void Promise.all([e,n]).then(()=>{this.contextUnlocked=!!this.audioContext&&"running"===this.audioContext.state,t.playToken===a&&this.proceedWithPlay(t,a)})}this.proceedWithPlay(t,a)}playPadIOS(e,t){this.audioContext?"suspended"!==this.audioContext.state?this.playPadIOSInternal(e,t):this.audioContext.resume().then(()=>{e.playToken===t&&this.playPadIOSInternal(e,t)}):console.error("No AudioContext for iOS playback")}playPadIOSInternal(e,t){if(!this.audioContext||!this.sharedIOSGainNode)return;if(e.playToken!==t)return;if(!e.audioBuffer)return e.pendingDecodePlayToken=t,void(e.lastAudioUrl&&!e.isBufferDecoding&&this.startBufferDecode(e).finally(()=>{e.pendingDecodePlayToken===t&&e.playToken===t&&this.playPadIOSInternal(e,t)}));if(e.pendingDecodePlayToken=null,this._applyNextPlayOverrides(e),"unmute"===e.triggerMode&&e.isPlaying){e.softMuted=!e.softMuted;const t=this.getBaseGain(e);return this.setGain(e,t),void this.notifyStateChange()}if("stopper"===e.playbackMode&&this.audioInstances.forEach(t=>{t.padId!==e.padId&&t.isPlaying&&this.stopPad(t.padId,"instant")}),this.stopFadeAutomation(e),e.bufferSourceNode)try{e.bufferSourceNode.stop(),e.bufferSourceNode.disconnect()}catch(l){}e.isConnected||this.connectAudioNodesIOS(e);const a=this.audioContext.createBufferSource();a.buffer=e.audioBuffer,a.loop="loop"===e.playbackMode,a.playbackRate.setValueAtTime(Math.pow(2,(e.pitch||0)/12),this.audioContext.currentTime),e.filterNode&&(e.filterNode.frequency.cancelScheduledValues(this.audioContext.currentTime),e.filterNode.frequency.setValueAtTime(2e4,this.audioContext.currentTime)),a.connect(e.eqNodes.low||e.filterNode||e.gainNode),e.bufferSourceNode=a;const n=this.getBaseGain(e),s=e.fadeInMs>0?0:n;this.setGain(e,s);const i=(e.startTimeMs||0)/1e3,r=e.endTimeMs>0?e.endTimeMs/1e3:e.audioBuffer.duration,o=r-i;a.onended=()=>{e.playToken===t&&("once"!==e.playbackMode&&"stopper"!==e.playbackMode||(e.isPlaying=!1,e.progress=0,e.isFading=!1,e.pendingDecodePlayToken=null,e.iosProgressInterval&&(clearInterval(e.iosProgressInterval),e.iosProgressInterval=null),this.releaseChannel(e),this.notifyStateChange()))};try{if("loop"===e.playbackMode?(a.loopStart=i,a.loopEnd=r,a.start(0,i)):a.start(0,i,o),e.playToken!==t){try{a.stop(),a.disconnect()}catch(l){}return}e.isPlaying=!0,e.playStartTime=Date.now(),e.isFading=e.fadeInMs>0,e.progress=0,e.fadeInMs>0&&this.startManualFade(e,s,n,e.fadeInMs,()=>{e.fadeInStartTime=null,e.isFading=!1}),this.startIOSFadeOutMonitor(e),console.log(`‚ñ∂Ô∏è iOS buffer play: ${e.padName}`),this.notifyStateChange()}catch(d){console.error("Failed to play iOS buffer:",d)}}proceedWithPlay(e,t){var a;if(!e.audioElement)return;if(e.playToken!==t)return;if("suspended"===(null==(a=this.audioContext)?void 0:a.state)&&this.audioContext.resume().catch(e=>console.error(e)),e.isConnected||this.connectAudioNodes(e),this._applyNextPlayOverrides(e),"unmute"===e.triggerMode&&e.isPlaying){e.softMuted=!e.softMuted;const t=this.getBaseGain(e);return this.setGain(e,t),void this.notifyStateChange()}"stopper"===e.playbackMode&&this.audioInstances.forEach(t=>{t.padId!==e.padId&&t.isPlaying&&this.stopPad(t.padId,"instant")}),e.audioElement.currentTime=(e.startTimeMs||0)/1e3,this.stopFadeAutomation(e),e.fadeInStartTime=e.fadeInMs>0?performance.now():null,e.fadeOutStartTime=null;const n=this.getBaseGain(e),s=e.fadeInMs>0?0:n;e.audioElement.muted=!0,e.audioElement.volume=1,this.setGain(e,s);const i=e.audioElement.play();void 0!==i&&i.then(()=>{if(e.playToken!==t||!e.audioElement)return void(e.audioElement&&(e.audioElement.pause(),e.audioElement.muted=!0));e.isPlaying=!0,e.playStartTime=Date.now(),e.audioElement.muted=!1,e.isFading=e.fadeInMs>0,this.resetInstanceAudio(e);const a=this.getBaseGain(e),n=e.fadeInMs>0?0:a;this.setGain(e,n),e.fadeInMs>0?this.startManualFade(e,n,a,e.fadeInMs,()=>{e.fadeInStartTime=null,e.isFading=!1}):this.setGain(e,a),this.startFadeOutMonitor(e),this.notifyStateChange()}).catch(e=>console.error("Failed to play audio:",e))}getOrCreateReversedBackspinBuffer(e){if(!this.audioContext||!e.audioBuffer)return null;if(e.reversedBackspinBuffer)return e.reversedBackspinBuffer;try{const t=e.audioBuffer,a=this.audioContext.createBuffer(t.numberOfChannels,t.length,t.sampleRate);for(let e=0;e<t.numberOfChannels;e+=1){const n=t.getChannelData(e),s=a.getChannelData(e);for(let e=0;e<n.length;e+=1)s[e]=n[n.length-1-e]}return e.reversedBackspinBuffer=a,a}catch(t){return console.error("Failed to create reversed backspin buffer:",t),null}}getBufferPlaybackPositionMs(e){const t=e.startTimeMs||0,a=e.endTimeMs>0?e.endTimeMs:e.bufferDuration,n=Math.max(0,a-t);if(!e.playStartTime||n<=0)return t;const s=(Date.now()-e.playStartTime)*Math.pow(2,(e.pitch||0)/12);if("loop"===e.playbackMode&&n>0){return t+s%n}return Math.min(a,t+s)}stopPadInstant(e,t){e.playToken+=1,e.pendingDecodePlayToken=null;const a=this.getStopTimingProfile(),n=()=>{if(e.bufferSourceNode){try{e.bufferSourceNode.stop(),e.bufferSourceNode.disconnect()}catch(a){}e.bufferSourceNode=null}e.iosProgressInterval&&(clearInterval(e.iosProgressInterval),e.iosProgressInterval=null),e.audioElement&&(e.audioElement.muted=!0,e.audioElement.pause(),e.audioElement.currentTime=(e.startTimeMs||0)/1e3),e.isPlaying=!1,e.progress=0,e.isFading=!1,e.fadeInStartTime=null,e.fadeOutStartTime=null,e.playStartTime=null,this.releaseChannel(e,t),this.isIOS||this.disconnectAudioNodes(e),this.stopFadeAutomation(e),this.resetInstanceAudio(e),this.notifyStateChange()};if(this.stopFadeAutomation(e),e.isPlaying&&e.gainNode&&this.audioContext){const t=this.audioContext.currentTime,s=Math.max(0,e.gainNode.gain.value);return e.gainNode.gain.cancelScheduledValues(t),e.gainNode.gain.setValueAtTime(s,t),e.gainNode.gain.linearRampToValueAtTime(1e-4,t+a.instantStopFadeSec),void(e.stopEffectTimeoutId=setTimeout(()=>{e.stopEffectTimeoutId=null,n()},a.instantStopFinalizeDelayMs))}n()}stopPadFadeout(e){if(!e.audioElement&&!e.bufferSourceNode)return void this.stopPadInstant(e);this.stopFadeAutomation(e),e.isFading=!0;const t=this.getStopTimingProfile(),a=e.fadeOutMs>0?e.fadeOutMs:t.defaultFadeOutMs;this.applyManualFadeOut(e,()=>this.stopPadInstant(e),a)}stopPadBrake(e){const t=this.getStopTimingProfile();if(this.isIOS&&e.bufferSourceNode&&this.audioContext){this.stopFadeAutomation(e),e.isFading=!0;const a=e.bufferSourceNode.playbackRate.value,n=t.brakeDurationSec;if(e.bufferSourceNode.playbackRate.cancelScheduledValues(this.audioContext.currentTime),e.bufferSourceNode.playbackRate.setValueAtTime(a,this.audioContext.currentTime),e.bufferSourceNode.playbackRate.linearRampToValueAtTime(t.brakeMinRate,this.audioContext.currentTime+n),e.gainNode){const t=Math.max(1e-4,e.gainNode.gain.value);e.gainNode.gain.cancelScheduledValues(this.audioContext.currentTime),e.gainNode.gain.setValueAtTime(t,this.audioContext.currentTime),e.gainNode.gain.exponentialRampToValueAtTime(1e-4,this.audioContext.currentTime+n)}return void(e.stopEffectTimeoutId=setTimeout(()=>{e.stopEffectTimeoutId=null,this.stopPadInstant(e)},1e3*n))}if(!e.audioElement)return void this.stopPadInstant(e);this.stopFadeAutomation(e);const a=e.audioElement.playbackRate,n=t.brakeWebDurationMs,s=performance.now(),i=e.gainNode?e.gainNode.gain.value:this.getBaseGain(e);e.isFading=!0,null!==e.fadeAnimationFrameId&&cancelAnimationFrame(e.fadeAnimationFrameId);const r=()=>{if(!e.audioElement||!e.isPlaying)return void(e.fadeAnimationFrameId=null);const o=Math.min(1,(performance.now()-s)/n),l=1-Math.pow(1-o,2),d=a*(1-.95*l);if(e.audioElement.playbackRate=Math.max(t.brakeMinRate,d),e.gainNode&&this.audioContext){const t=Math.max(0,i*(1-l));e.gainNode.gain.cancelScheduledValues(this.audioContext.currentTime),e.gainNode.gain.setValueAtTime(t,this.audioContext.currentTime)}if(o>=1)return e.audioElement&&(e.audioElement.playbackRate=a),e.fadeAnimationFrameId=null,void this.stopPadInstant(e);e.fadeAnimationFrameId=requestAnimationFrame(r)};e.fadeAnimationFrameId=requestAnimationFrame(r)}stopPadBackspin(e){const t=this.getStopTimingProfile();if(this.isIOS&&e.bufferSourceNode&&this.audioContext){this.stopFadeAutomation(e),e.isFading=!0;const a=this.getOrCreateReversedBackspinBuffer(e),n=this.audioContext.currentTime;try{e.bufferSourceNode.stop(),e.bufferSourceNode.disconnect()}catch(l){}if(!a||!e.gainNode)return void this.stopPadInstant(e);const s=this.getBufferPlaybackPositionMs(e),i=Math.max(0,Math.min(a.duration,s/1e3)),r=Math.max(0,Math.min(a.duration-.02,a.duration-i)),o=this.audioContext.createBufferSource();o.buffer=a,o.playbackRate.setValueAtTime(t.backspinIOSPitchStart,n),o.playbackRate.linearRampToValueAtTime(t.backspinIOSPitchEnd,n+t.backspinIOSPitchRampSec),o.connect(e.eqNodes.low||e.filterNode||e.gainNode),e.bufferSourceNode=o,e.playStartTime=Date.now();const c=Math.max(1e-4,e.gainNode.gain.value||this.getBaseGain(e));e.gainNode.gain.cancelScheduledValues(n),e.gainNode.gain.setValueAtTime(c,n),e.gainNode.gain.exponentialRampToValueAtTime(1e-4,n+t.backspinIOSDurationSec);try{o.start(0,r,t.backspinIOSDurationSec)}catch(d){return console.error("Backspin reverse start failed:",d),void this.stopPadInstant(e)}return void(e.stopEffectTimeoutId=setTimeout(()=>{e.stopEffectTimeoutId=null,this.stopPadInstant(e)},Math.ceil(1e3*t.backspinIOSDurationSec+24)))}if(!e.audioElement)return void this.stopPadInstant(e);this.stopFadeAutomation(e);const a=e.audioElement.playbackRate,n=t.backspinWebSpeedUpMs,s=t.backspinWebTotalMs,i=performance.now(),r=e.gainNode?e.gainNode.gain.value:this.getBaseGain(e);e.isFading=!0,null!==e.fadeAnimationFrameId&&cancelAnimationFrame(e.fadeAnimationFrameId);const o=()=>{if(!e.audioElement||!e.isPlaying)return void(e.fadeAnimationFrameId=null);const l=performance.now()-i,d=Math.min(1,l/s);if(l<=n){const s=l/n;e.audioElement.playbackRate=Math.min(t.backspinWebMaxRate,a+(t.backspinWebMaxRate-a)*s)}else{const a=Math.min(1,(l-n)/(s-n));if(e.audioElement.playbackRate=Math.max(t.backspinWebMinRate,t.backspinWebMaxRate-(t.backspinWebMaxRate-t.backspinWebMinRate)*a),e.gainNode&&this.audioContext){const t=Math.max(0,r*(1-a));e.gainNode.gain.cancelScheduledValues(this.audioContext.currentTime),e.gainNode.gain.setValueAtTime(t,this.audioContext.currentTime)}}if(d>=1)return e.audioElement&&(e.audioElement.playbackRate=a),e.fadeAnimationFrameId=null,void this.stopPadInstant(e);e.fadeAnimationFrameId=requestAnimationFrame(o)};e.fadeAnimationFrameId=requestAnimationFrame(o)}stopPadFilter(e){if(!e.filterNode||!this.audioContext)return void this.stopPadInstant(e);const t=this.getStopTimingProfile(),a=t.filterDurationSec;if(this.stopFadeAutomation(e),e.isFading=!0,e.filterNode.frequency.cancelScheduledValues(this.audioContext.currentTime),e.filterNode.frequency.setValueAtTime(2e4,this.audioContext.currentTime),e.filterNode.frequency.exponentialRampToValueAtTime(t.filterEndHz,this.audioContext.currentTime+a),e.gainNode){const t=Math.max(1e-4,e.gainNode.gain.value);e.gainNode.gain.cancelScheduledValues(this.audioContext.currentTime),e.gainNode.gain.setValueAtTime(t,this.audioContext.currentTime),e.gainNode.gain.exponentialRampToValueAtTime(1e-4,this.audioContext.currentTime+a)}e.stopEffectTimeoutId=setTimeout(()=>{e.stopEffectTimeoutId=null,e.isPlaying&&this.stopPadInstant(e),e.filterNode&&this.audioContext&&(e.filterNode.frequency.cancelScheduledValues(this.audioContext.currentTime),e.filterNode.frequency.setValueAtTime(2e4,this.audioContext.currentTime))},1e3*a)}applyManualFadeOut(e,t,a){if(!e.gainNode||!this.audioContext)return void t();e.isFading=!0;const n=e.gainNode.gain.value;this.startManualFade(e,n,0,a,()=>{e.isFading=!1,t()})}resetInstanceAudio(e){e.audioElement&&(e.startTimeMs>0&&(e.audioElement.currentTime=e.startTimeMs/1e3),!e.isPlaying||e.fadeInMs>0&&null===e.fadeInStartTime||this.updateInstanceVolume(e),e.audioElement.playbackRate=Math.pow(2,e.pitch/12),e.filterNode&&this.audioContext&&e.filterNode.frequency.setValueAtTime(2e4,this.audioContext.currentTime))}updateInstanceVolume(e){if(!e.isConnected||!e.gainNode||!this.audioContext)return;if(e.isFading||e.fadeInStartTime||e.fadeOutStartTime)return;const t=this.getBaseGain(e);e.audioElement&&(e.audioElement.volume=1);const a=this.audioContext.currentTime,n=this.getStopTimingProfile();e.gainNode.gain.cancelScheduledValues(a),e.gainNode.gain.setTargetAtTime(Math.max(0,t),a,n.volumeSmoothingSec)}applySoftMute(e){if(!e.gainNode||!this.audioContext)return;this.stopFadeAutomation(e);const t=this.getBaseGain(e);e.audioElement&&(e.audioElement.volume=1);const a=this.audioContext.currentTime,n=this.getStopTimingProfile();e.gainNode.gain.cancelScheduledValues(a),e.gainNode.gain.setTargetAtTime(Math.max(0,t),a,n.softMuteSmoothingSec)}updateInstanceEQ(e){if(!e.isConnected||!this.audioContext)return;const{low:t,mid:a,high:n}=e.eqNodes;t&&t.gain.setValueAtTime(this.globalEQ.low,this.audioContext.currentTime),a&&a.gain.setValueAtTime(this.globalEQ.mid,this.audioContext.currentTime),n&&n.gain.setValueAtTime(this.globalEQ.high,this.audioContext.currentTime)}applyGlobalSettingsToInstance(e){this.updateInstanceVolume(e),this.updateInstanceEQ(e)}notifyStateChange(){this.notificationTimeout&&clearTimeout(this.notificationTimeout),this.notificationTimeout=setTimeout(()=>{this.stateChangeListeners.forEach(e=>{try{e()}catch(t){}})},Fe)}cleanupInstance(e){e.isPlaying&&this.stopPad(e.padId,"instant"),this.stopFadeAutomation(e),this.dehydrateInstance(e),e.isPlaying=!1,e.isFading=!1,e.progress=0}_applyNextPlayOverrides(e){const t=e.nextPlayOverrides;t&&("string"==typeof t.padName&&(e.padName=t.padName),"string"==typeof t.name&&(e.padName=t.name),"string"==typeof t.color&&(e.color=t.color),"string"==typeof t.bankId&&(e.bankId=t.bankId),"string"==typeof t.bankName&&(e.bankName=t.bankName),void 0!==t.triggerMode&&(e.triggerMode=t.triggerMode),void 0!==t.playbackMode&&(e.playbackMode=t.playbackMode,e.audioElement&&(e.audioElement.loop="loop"===t.playbackMode)),"number"==typeof t.startTimeMs&&(e.startTimeMs=Math.max(0,t.startTimeMs)),"number"==typeof t.endTimeMs&&(e.endTimeMs=Math.max(0,t.endTimeMs)),"number"==typeof t.fadeInMs&&(e.fadeInMs=Math.max(0,t.fadeInMs)),"number"==typeof t.fadeOutMs&&(e.fadeOutMs=Math.max(0,t.fadeOutMs)),"number"==typeof t.pitch&&(e.pitch=t.pitch),"number"==typeof t.volume&&(e.volume=t.volume),e.nextPlayOverrides=void 0)}stopPad(e,t="instant",a){const n=this.audioInstances.get(e);if(n)switch(n.fadeIntervalId&&(clearInterval(n.fadeIntervalId),n.fadeIntervalId=null),t){case"instant":this.stopPadInstant(n,a);break;case"fadeout":this.stopPadFadeout(n);break;case"brake":this.stopPadBrake(n);break;case"backspin":this.stopPadBackspin(n);break;case"filter":this.stopPadFilter(n)}}unregisterPad(e){const t=this.audioInstances.get(e);t&&(this.deckChannels.forEach(t=>{var a;(null==(a=t.loadedPadRef)?void 0:a.padId)===e&&this.unloadChannel(t.channelId)}),this.releaseChannel(t),this.cleanupInstance(t),this.audioInstances.delete(e),this.registeredPads.delete(e),this.notifyStateChange())}togglePad(e){const t=this.audioInstances.get(e);t&&(t.isPlaying?this.stopPad(e):this.playPad(e))}updatePadSettings(e,t){const a=this.audioInstances.get(e);if(!a)return;const n=this.registeredPads.get(e),s=void 0!==t.fadeInMs||void 0!==t.fadeOutMs||void 0!==t.startTimeMs||void 0!==t.endTimeMs;void 0!==t.triggerMode&&(a.triggerMode=t.triggerMode),void 0!==t.playbackMode&&(a.playbackMode=t.playbackMode,a.audioElement&&(a.audioElement.loop="loop"===t.playbackMode),n&&(n.playbackMode="loop"===t.playbackMode?"loop":"stopper"===t.playbackMode?"stopper":"once")),void 0!==t.startTimeMs&&(a.startTimeMs=t.startTimeMs,n&&(n.startTimeMs=t.startTimeMs)),void 0!==t.endTimeMs&&(a.endTimeMs=t.endTimeMs,n&&(n.endTimeMs=t.endTimeMs)),void 0!==t.fadeInMs&&(a.fadeInMs=t.fadeInMs,n&&(n.fadeInMs=t.fadeInMs)),void 0!==t.fadeOutMs&&(a.fadeOutMs=t.fadeOutMs,n&&(n.fadeOutMs=t.fadeOutMs)),void 0!==t.pitch&&(a.pitch=t.pitch,n&&(n.pitch=t.pitch),a.audioElement&&(a.audioElement.playbackRate=Math.pow(2,t.pitch/12)),a.bufferSourceNode&&this.audioContext&&a.bufferSourceNode.playbackRate.setValueAtTime(Math.pow(2,t.pitch/12),this.audioContext.currentTime)),void 0!==t.volume&&(a.volume=t.volume,n&&(n.volume=t.volume),this.updateInstanceVolume(a)),void 0!==t.savedHotcuesMs&&n&&(n.savedHotcuesMs=Array.isArray(t.savedHotcuesMs)?t.savedHotcuesMs.slice(0,4):[null,null,null,null]),void 0!==t.ignoreChannel&&(a.ignoreChannel=t.ignoreChannel,t.ignoreChannel?(this.releaseChannel(a),this.updateInstanceVolume(a),this.notifyStateChange()):a.isPlaying&&!a.channelId&&(this.assignChannel(a),this.updateInstanceVolume(a),this.notifyStateChange())),s&&a.isPlaying&&!a.isFading&&(a.fadeOutStartTime=null,this.startFadeOutMonitor(a))}updatePadSettingsNextPlay(e,t){const a=this.audioInstances.get(e);a&&(a.nextPlayOverrides={...a.nextPlayOverrides||{},...t})}updatePadMetadata(e,t){const a=this.audioInstances.get(e);if(!a)return;const n=this.registeredPads.get(e);void 0!==t.name&&(a.padName=t.name),void 0!==t.color&&(a.color=t.color),void 0!==t.bankId&&(a.bankId=t.bankId),void 0!==t.bankName&&(a.bankName=t.bankName),n&&(void 0!==t.name&&(n.padName=t.name),void 0!==t.color&&(n.color=t.color),void 0!==t.bankId&&(n.bankId=t.bankId),void 0!==t.bankName&&(n.bankName=t.bankName)),this.notifyStateChange()}computeEffectiveVolumeFactor(e,t){const a=this.getBaseGain(e);if(a<=0)return 0;const n=e.gainNode?e.gainNode.gain.value:a;return Math.max(0,Math.min(1,n/a))}getPadState(e){const t=this.audioInstances.get(e);if(!t)return null;const a=this.computeEffectiveVolumeFactor(t);return{isPlaying:t.isPlaying,progress:t.progress,effectiveVolume:t.volume*a}}getAllPlayingPads(){const e=[];return this.audioInstances.forEach(t=>{if(t.isPlaying){let a=0,n=0;if(t.audioElement){const e=1e3*t.audioElement.currentTime,s=t.startTimeMs||0,i=t.endTimeMs>0?t.endTimeMs:1e3*t.audioElement.duration;a=Math.max(0,Math.min(i-s,e-s)),n=Math.max(0,i-s)}else if(t.bufferSourceNode&&t.playStartTime){const e=(Date.now()-t.playStartTime)*Math.pow(2,(t.pitch||0)/12),s=t.startTimeMs||0,i=t.endTimeMs||t.bufferDuration;a=Math.min(e,i-s),n=i-s}const s=this.computeEffectiveVolumeFactor(t);e.push({padId:t.padId,padName:t.padName,bankId:t.bankId,bankName:t.bankName,color:t.color,volume:t.volume,effectiveVolume:t.volume*s,currentMs:a,endMs:n,playStartTime:t.playStartTime||0,channelId:t.channelId??null})}}),e.sort((e,t)=>(e.playStartTime||0)-(t.playStartTime||0))}getLegacyPlayingPads(){const e=[];return this.audioInstances.forEach(t=>{if(t.isPlaying){let a=0,n=0;if(t.audioElement){const e=1e3*t.audioElement.currentTime,s=t.startTimeMs||0,i=t.endTimeMs>0?t.endTimeMs:1e3*t.audioElement.duration;a=Math.max(0,Math.min(i-s,e-s)),n=Math.max(0,i-s)}else if(t.bufferSourceNode&&t.playStartTime){const e=(Date.now()-t.playStartTime)*Math.pow(2,(t.pitch||0)/12),s=t.startTimeMs||0,i=t.endTimeMs||t.bufferDuration;a=Math.min(e,i-s),n=i-s}e.push({padId:t.padId,padName:t.padName,bankId:t.bankId,bankName:t.bankName,color:t.color,volume:t.volume,currentMs:a,endMs:n,playStartTime:t.playStartTime||0})}}),e.sort((e,t)=>(e.playStartTime||0)-(t.playStartTime||0))}cloneHotcues(e){if(!Array.isArray(e))return[null,null,null,null];const t=[null,null,null,null];for(let a=0;a<4;a+=1){const n=e[a];t[a]="number"==typeof n&&Number.isFinite(n)&&n>=0?n:null}return t}ensureDeckChannelRuntime(e){if(!Number.isFinite(e))return null;if(e<1||e>8)return null;const t=this.deckChannels.get(e);if(t)return this.channelVolumes.has(e)||this.channelVolumes.set(e,t.channelVolume),t;const a={channelId:e,channelVolume:this.channelVolumes.get(e)??1,loadedPadRef:null,pad:null,audioElement:null,isPlaying:!1,isPaused:!1,playheadMs:0,durationMs:0,hotcuesMs:[null,null,null,null],hasLocalHotcueOverride:!1,collapsed:!1,waveformKey:null};return this.channelVolumes.set(e,a.channelVolume),this.deckChannels.set(e,a),a}getDeckChannel(e){return Number.isFinite(e)?e<1||e>8?null:this.deckChannels.get(e)||null:null}getDeckStartMs(e){var t;return(null==(t=e.pad)?void 0:t.startTimeMs)||0}getDeckEndMs(e){return e.pad?e.pad.endTimeMs>e.pad.startTimeMs?e.pad.endTimeMs:e.durationMs>e.pad.startTimeMs?e.durationMs:e.pad.startTimeMs:0}syncDeckChannelVolume(e){if(!e.audioElement||!e.pad)return;const t=Math.max(0,Math.min(1,e.pad.volume||1)),a=this.globalMuted?0:Math.max(0,Math.min(1,t*e.channelVolume*this.masterVolume));e.audioElement.volume=a}releaseWaveformRef(e){if(!e.waveformKey)return;const t=e.waveformKey,a=this.waveformCacheRefs.get(t)||0;a<=1?this.waveformCacheRefs.delete(t):this.waveformCacheRefs.set(t,a-1),e.waveformKey=null}retainWaveformRef(e,t){this.releaseWaveformRef(e),e.waveformKey=t,this.waveformCacheRefs.set(t,(this.waveformCacheRefs.get(t)||0)+1)}createDeckAudioElement(e){if(!e.pad)return;const t=new Audio(e.pad.audioUrl);t.preload="auto",t.loop="loop"===e.pad.playbackMode,t.playbackRate=Math.pow(2,(e.pad.pitch||0)/12),t.currentTime=(e.pad.startTimeMs||0)/1e3,t.addEventListener("loadedmetadata",()=>{if(!e.pad)return;const a=Number.isFinite(t.duration)?1e3*t.duration:0,n=e.pad.endTimeMs>e.pad.startTimeMs?e.pad.endTimeMs:a;e.durationMs=Math.max(e.pad.startTimeMs,n),this.notifyStateChange()}),t.addEventListener("timeupdate",()=>{if(!e.pad)return;const a=1e3*t.currentTime,n=this.getDeckStartMs(e),s=this.getDeckEndMs(e);e.playheadMs=Math.max(0,Math.min(Math.max(0,s-n),a-n)),s>n&&a>=s?this.stopChannel(e.channelId,"instant"):this.notifyStateChange()}),t.addEventListener("ended",()=>{e.isPlaying=!1,e.isPaused=!1,e.playheadMs=0,e.pad&&e.audioElement&&(e.audioElement.currentTime=(e.pad.startTimeMs||0)/1e3),this.notifyStateChange()}),e.audioElement=t,this.syncDeckChannelVolume(e)}stopDeckChannelInternal(e,t="instant"){const a=e.audioElement,n=e.pad;if(!a||!n)return e.isPlaying=!1,e.isPaused=!1,void(e.playheadMs=0);const s=(n.startTimeMs||0)/1e3,i=()=>{try{a.pause(),a.currentTime=s,a.playbackRate=Math.pow(2,(n.pitch||0)/12)}catch{}e.isPlaying=!1,e.isPaused=!1,e.playheadMs=0,this.syncDeckChannelVolume(e),this.notifyStateChange()};if("instant"===t)return void i();const r=(t,n,s)=>{const r=a.volume,o=a.playbackRate,l=performance.now(),d=()=>{const a=Math.min(1,(performance.now()-l)/t);if(n(a),a>=1||!e.isPlaying)return s&&s(),void i();requestAnimationFrame(d)};return e.isPlaying=!0,e.isPaused=!1,requestAnimationFrame(d),{startVolume:r,originalRate:o}};if("fadeout"===t||"filter"===t)return void r(700,e=>{const t=Math.max(0,1-e);a.volume=t*Math.max(0,a.volume||1)});if("brake"===t){const e=a.volume,t=a.playbackRate;return void r(1e3,n=>{const s=Math.max(.08,t*(1-n));a.playbackRate=s,a.volume=Math.max(0,e*(1-n))},()=>{a.playbackRate=t})}const o=a.volume,l=a.playbackRate;r(900,e=>{if(e<.45){const t=e/.45;a.playbackRate=l+(2.8-l)*t}else{const t=(e-.45)/.55;a.playbackRate=Math.max(.2,2.8-2.6*t)}a.volume=Math.max(0,o*(1-e))},()=>{a.playbackRate=l})}loadPadToChannel(e,t){var a,n;if(e<1||e>this.deckChannelCount)return!1;const s=this.getDeckChannel(e)||this.ensureDeckChannelRuntime(e);if(!s)return!1;const i=this.registeredPads.get(t);if(!i||!i.audioUrl)return!1;if((null==(a=s.loadedPadRef)?void 0:a.padId)===t&&(null==(n=s.loadedPadRef)?void 0:n.bankId)===i.bankId)return!0;if(this.stopDeckChannelInternal(s,"instant"),s.audioElement)try{s.audioElement.pause(),s.audioElement.src=""}catch{}return this.releaseWaveformRef(s),s.loadedPadRef={bankId:i.bankId,padId:i.padId},s.pad={...i,savedHotcuesMs:this.cloneHotcues(i.savedHotcuesMs)},s.isPlaying=!1,s.isPaused=!1,s.playheadMs=0,s.durationMs=Math.max(s.pad.startTimeMs||0,s.pad.endTimeMs||0),s.hotcuesMs=this.cloneHotcues(s.pad.savedHotcuesMs),s.hasLocalHotcueOverride=!1,this.retainWaveformRef(s,`${i.padId}:${i.audioUrl}`),this.createDeckAudioElement(s),this.notifyStateChange(),!0}unloadChannel(e){const t=this.getDeckChannel(e);if(t){if(this.stopDeckChannelInternal(t,"instant"),t.audioElement)try{t.audioElement.pause(),t.audioElement.src=""}catch{}t.audioElement=null,t.loadedPadRef=null,t.pad=null,t.isPlaying=!1,t.isPaused=!1,t.playheadMs=0,t.durationMs=0,t.hotcuesMs=[null,null,null,null],t.hasLocalHotcueOverride=!1,this.releaseWaveformRef(t),this.notifyStateChange()}}playChannel(e){const t=this.getDeckChannel(e);t&&t.audioElement&&t.pad&&(t.audioElement.playbackRate=Math.pow(2,(t.pad.pitch||0)/12),t.audioElement.loop="loop"===t.pad.playbackMode,this.syncDeckChannelVolume(t),t.audioElement.play().then(()=>{t.isPlaying=!0,t.isPaused=!1,this.notifyStateChange()}).catch(()=>{this.notifyStateChange()}))}pauseChannel(e){const t=this.getDeckChannel(e);if(t&&t.audioElement){try{t.audioElement.pause()}catch{}t.isPlaying=!1,t.isPaused=!0,this.notifyStateChange()}}seekChannel(e,t){const a=this.getDeckChannel(e);if(!a||!a.audioElement||!a.pad)return;const n=this.getDeckStartMs(a),s=this.getDeckEndMs(a),i=Math.max(0,Math.min(s>n?s-n:0,t));a.playheadMs=i;try{a.audioElement.currentTime=(n+i)/1e3}catch{}this.notifyStateChange()}setChannelHotcue(e,t,a){const n=this.getDeckChannel(e);if(n&&!(t<0||t>3)){if(null===a)n.hotcuesMs[t]=null;else{const e=Math.max(0,a);n.hotcuesMs[t]=e}n.hasLocalHotcueOverride=!0,this.notifyStateChange()}}clearChannelHotcue(e,t){this.setChannelHotcue(e,t,null)}triggerChannelHotcue(e,t){const a=this.getDeckChannel(e);if(!a)return;if(t<0||t>3)return;const n=a.hotcuesMs[t];null!=n&&(this.seekChannel(e,n),a.isPlaying&&this.playChannel(e))}setChannelCollapsed(e,t){const a=this.getDeckChannel(e);a&&(a.collapsed=t,this.notifyStateChange())}cleanupRemovedChannels(e){for(let t=e+1;t<=8;t+=1){this.getDeckChannel(t)&&(this.unloadChannel(t),this.deckChannels.delete(t),this.channelVolumes.delete(t))}}setChannelCount(e){const t=Math.max(2,Math.min(8,Math.floor(e)));if(t!==this.deckChannelCount){if(t<this.deckChannelCount&&this.cleanupRemovedChannels(t),t>this.deckChannelCount)for(let e=1;e<=t;e+=1)this.ensureDeckChannelRuntime(e);this.deckChannelCount=t,this.notifyStateChange()}}getChannelCount(){return this.deckChannelCount}resetDeckPlaybackToStart(){for(let e=1;e<=8;e+=1){const t=this.getDeckChannel(e);if(t&&t.pad&&(this.stopDeckChannelInternal(t,"instant"),t.isPaused=!1,t.playheadMs=0,t.audioElement))try{t.audioElement.currentTime=(t.pad.startTimeMs||0)/1e3}catch{}}this.notifyStateChange()}hydrateDeckLayout(e){Array.isArray(e)&&(e.forEach(e=>{var t;const a=this.getDeckChannel(e.channelId);if(!a)return;if("number"==typeof e.channelVolume&&Number.isFinite(e.channelVolume)&&this.setChannelVolume(e.channelId,e.channelVolume),"boolean"==typeof e.collapsed&&(a.collapsed=e.collapsed),!(null==(t=e.loadedPadRef)?void 0:t.padId))return void this.unloadChannel(e.channelId);this.loadPadToChannel(e.channelId,e.loadedPadRef.padId)&&(Array.isArray(e.hotcuesMs)&&(a.hotcuesMs=this.cloneHotcues(e.hotcuesMs),a.hasLocalHotcueOverride=!0),this.stopDeckChannelInternal(a,"instant"),a.isPaused=!1,a.playheadMs=0)}),this.notifyStateChange())}persistDeckLayoutSnapshot(){const e=[];for(let t=1;t<=this.deckChannelCount;t+=1){const a=this.getDeckChannel(t);a&&e.push({channelId:t,loadedPadRef:a.loadedPadRef?{...a.loadedPadRef}:null,hotcuesMs:this.cloneHotcues(a.hotcuesMs),collapsed:a.collapsed,channelVolume:a.channelVolume})}return e}saveChannelHotcuesToPad(e){var t;const a=this.getDeckChannel(e);if(!(null==(t=null==a?void 0:a.loadedPadRef)?void 0:t.padId))return{ok:!1};const n=this.registeredPads.get(a.loadedPadRef.padId);return n?(n.savedHotcuesMs=this.cloneHotcues(a.hotcuesMs),a.hasLocalHotcueOverride=!1,this.notifyStateChange(),{ok:!0,padId:n.padId}):{ok:!1}}getDeckChannelStates(){const e=[];for(let t=1;t<=this.deckChannelCount;t+=1){const a=this.getDeckChannel(t);if(!a)continue;const n=a.pad?{padId:a.pad.padId,padName:a.pad.padName,bankId:a.pad.bankId,bankName:a.pad.bankName,color:a.pad.color,volume:a.pad.volume,effectiveVolume:Math.max(0,Math.min(1,a.pad.volume*a.channelVolume*this.masterVolume)),currentMs:a.playheadMs,endMs:Math.max(0,this.getDeckEndMs(a)-this.getDeckStartMs(a)),playStartTime:0,channelId:a.channelId}:null;e.push({channelId:a.channelId,channelVolume:a.channelVolume,loadedPadRef:a.loadedPadRef?{...a.loadedPadRef}:null,isPlaying:a.isPlaying,isPaused:a.isPaused,playheadMs:a.playheadMs,durationMs:a.durationMs,hotcuesMs:this.cloneHotcues(a.hotcuesMs),hasLocalHotcueOverride:a.hasLocalHotcueOverride,collapsed:a.collapsed,waveformKey:a.waveformKey,pad:n})}return e}getChannelStates(){return this.getDeckChannelStates()}setChannelVolume(e,t){const a=Math.max(0,Math.min(1,t));this.channelVolumes.set(e,a);const n=this.getDeckChannel(e);n&&(n.channelVolume=a,this.syncDeckChannelVolume(n)),this.notifyStateChange()}getChannelVolume(e){const t=this.getDeckChannel(e);return t?t.channelVolume:this.channelVolumes.get(e)??1}stopChannel(e,t="instant"){const a=this.getDeckChannel(e);a&&this.stopDeckChannelInternal(a,t)}stopAllPads(e="instant"){this.audioInstances.forEach(t=>{t.isPlaying&&this.stopPad(t.padId,e)});for(let t=1;t<=this.deckChannelCount;t+=1)this.stopChannel(t,e)}setGlobalMute(e){this.globalMuted=e,this.audioInstances.forEach(e=>this.updateInstanceVolume(e));for(let t=1;t<=this.deckChannelCount;t+=1){const e=this.getDeckChannel(t);e&&this.syncDeckChannelVolume(e)}this.notifyStateChange()}setMasterVolume(e){const t=Math.max(0,Math.min(1,e));this.pendingMasterVolume=t,null===this.masterVolumeRafId&&(this.masterVolumeRafId=requestAnimationFrame(()=>{this.masterVolumeRafId=null;const e=this.pendingMasterVolume;if(this.pendingMasterVolume=null,"number"==typeof e&&!(Math.abs(this.masterVolume-e)<1e-4)){if(this.masterVolume=e,this.sharedIOSGainNode&&this.audioContext){const t=this.audioContext.currentTime,a=this.getStopTimingProfile();this.sharedIOSGainNode.gain.cancelScheduledValues(t),this.sharedIOSGainNode.gain.setTargetAtTime(e,t,a.masterSmoothingSec)}this.isIOS||this.audioInstances.forEach(e=>this.updateInstanceVolume(e));for(let e=1;e<=this.deckChannelCount;e+=1){const t=this.getDeckChannel(e);t&&this.syncDeckChannelVolume(t)}this.notifyStateChange()}}))}applyGlobalEQ(e){this.pendingGlobalEQ={low:e.low,mid:e.mid,high:e.high},null===this.eqRafId&&(this.eqRafId=requestAnimationFrame(()=>{this.eqRafId=null;const e=this.pendingGlobalEQ;if(this.pendingGlobalEQ=null,!e)return;this.globalEQ.low===e.low&&this.globalEQ.mid===e.mid&&this.globalEQ.high===e.high||(this.globalEQ=e,this.audioInstances.forEach(e=>this.updateInstanceEQ(e)))}))}updatePadVolume(e,t){const a=this.audioInstances.get(e);a&&(a.volume=t,this.updateInstanceVolume(a),this.notifyStateChange())}addStateChangeListener(e){this.stateChangeListeners.add(e)}removeStateChangeListener(e){this.stateChangeListeners.delete(e)}isPadRegistered(e){return this.audioInstances.has(e)}getAllRegisteredPads(){return Array.from(this.audioInstances.keys())}playStutterPad(e){this.audioInstances.get(e)&&(this.stopPad(e,"instant"),setTimeout(()=>{this.playPad(e)},5))}triggerToggle(e){const t=this.audioInstances.get(e);t&&(t.isPlaying?this.stopPad(e,"instant"):(t.softMuted=!1,this.playPad(e)))}triggerHoldStart(e){const t=this.audioInstances.get(e);t&&(t.isPlaying||(t.softMuted=!1,this.playPad(e)))}triggerHoldStop(e){const t=this.audioInstances.get(e);t&&t.isPlaying&&this.stopPad(e,"instant")}triggerStutter(e){const t=this.audioInstances.get(e);if(t){if(!t.isPlaying)return t.softMuted=!1,void this.playPad(e);this.stopPad(e,"instant",!0),setTimeout(()=>{this.playPad(e)},5)}}triggerUnmuteToggle(e){const t=this.audioInstances.get(e);if(t){if(!t.isPlaying)return t.softMuted=!1,void this.playPad(e);t.softMuted=!t.softMuted,this.applySoftMute(t),this.notifyStateChange()}}toggleMutePad(e){const t=this.audioInstances.get(e);t&&(t.softMuted=!t.softMuted,this.applySoftMute(t),this.notifyStateChange())}getDebugInfo(){var e;return{totalInstances:this.audioInstances.size,activeElements:Array.from(this.audioInstances.values()).filter(e=>e.audioElement).length,activeBuffers:Array.from(this.audioInstances.values()).filter(e=>e.audioBuffer).length,playingCount:Array.from(this.audioInstances.values()).filter(e=>e.isPlaying).length,isIOS:this.isIOS,contextState:(null==(e=this.audioContext)?void 0:e.state)||"none",isUnlocked:this.contextUnlocked}}getIOSDebugInfo(){var e;return{isIOS:this.isIOS,contextState:(null==(e=this.audioContext)?void 0:e.state)||"none",isUnlocked:this.contextUnlocked,hasSharedGain:!!this.sharedIOSGainNode,bufferCacheSize:this.bufferCache.size,isPrewarmed:this.isPrewarmed}}forceIOSUnlock(){return this.iosAudioService?this.iosAudioService.forceUnlock():this.preUnlockAudio().then(()=>this.contextUnlocked)}getAudioState(){var e;return{isIOS:this.isIOS,contextState:(null==(e=this.audioContext)?void 0:e.state)||"none",isUnlocked:this.contextUnlocked,totalInstances:this.audioInstances.size,playingCount:Array.from(this.audioInstances.values()).filter(e=>e.isPlaying).length,bufferedCount:Array.from(this.audioInstances.values()).filter(e=>e.audioBuffer).length,masterVolume:this.masterVolume,globalMuted:this.globalMuted}}async runDiagnostics(){var e;const t={contextState:(null==(e=this.audioContext)?void 0:e.state)||"none",isUnlocked:this.contextUnlocked,isIOS:this.isIOS,silentAudioTest:{success:!1,latencyMs:0},oscillatorTest:{success:!1,latencyMs:0},bufferTest:{success:!1,latencyMs:0},mediaElementTest:{success:!1,latencyMs:0},totalInstances:this.audioInstances.size,activeBuffers:this.bufferCache.size};if(!this.audioContext)return t;try{const e=performance.now();"suspended"===this.audioContext.state&&await this.audioContext.resume(),t.silentAudioTest={success:"running"===this.audioContext.state,latencyMs:performance.now()-e}}catch(a){t.silentAudioTest={success:!1,latencyMs:0}}try{const e=performance.now(),a=this.audioContext.createOscillator(),n=this.audioContext.createGain();n.gain.setValueAtTime(.01,this.audioContext.currentTime),a.connect(n),n.connect(this.audioContext.destination),a.start(),a.stop(this.audioContext.currentTime+.1),t.oscillatorTest={success:!0,latencyMs:performance.now()-e}}catch(a){t.oscillatorTest={success:!1,latencyMs:0}}try{const e=performance.now(),a=this.audioContext.createBuffer(1,44100,44100),n=this.audioContext.createBufferSource();n.buffer=a;const s=this.audioContext.createGain();s.gain.setValueAtTime(.01,this.audioContext.currentTime),n.connect(s),s.connect(this.audioContext.destination),n.start(),n.stop(this.audioContext.currentTime+.05),t.bufferTest={success:!0,latencyMs:performance.now()-e}}catch(a){t.bufferTest={success:!1,latencyMs:0}}if(this.isIOS)t.mediaElementTest={success:!0,latencyMs:0};else try{const e=performance.now(),a=new Audio;a.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA",a.volume=.01,await a.play(),a.pause(),t.mediaElementTest={success:!0,latencyMs:performance.now()-e}}catch(a){t.mediaElementTest={success:!1,latencyMs:0}}return t}};function $e(){const[,e]=a.useReducer(e=>e+1,0);return a.useEffect(()=>(Ve.addStateChangeListener(e),()=>{Ve.removeStateChangeListener(e)}),[]),{registerPad:(e,t,a,n)=>Ve.registerPad(e,t,a,n),unregisterPad:e=>Ve.unregisterPad(e),playPad:e=>Ve.playPad(e),stopPad:(e,t,a)=>Ve.stopPad(e,t,a),togglePad:e=>Ve.togglePad(e),triggerToggle:e=>Ve.triggerToggle(e),triggerHoldStart:e=>Ve.triggerHoldStart(e),triggerHoldStop:e=>Ve.triggerHoldStop(e),triggerStutter:e=>Ve.triggerStutter(e),triggerUnmuteToggle:e=>Ve.triggerUnmuteToggle(e),updatePadSettings:(e,t)=>Ve.updatePadSettings(e,t),updatePadSettingsNextPlay:(e,t)=>Ve.updatePadSettingsNextPlay(e,t),updatePadMetadata:(e,t)=>Ve.updatePadMetadata(e,t),getPadState:e=>Ve.getPadState(e),getAllPlayingPads:()=>Ve.getAllPlayingPads(),getLegacyPlayingPads:()=>Ve.getLegacyPlayingPads(),getChannelStates:()=>Ve.getChannelStates(),getDeckChannelStates:()=>Ve.getDeckChannelStates(),loadPadToChannel:(e,t)=>Ve.loadPadToChannel(e,t),unloadChannel:e=>Ve.unloadChannel(e),playChannel:e=>Ve.playChannel(e),pauseChannel:e=>Ve.pauseChannel(e),seekChannel:(e,t)=>Ve.seekChannel(e,t),setChannelHotcue:(e,t,a)=>Ve.setChannelHotcue(e,t,a),clearChannelHotcue:(e,t)=>Ve.clearChannelHotcue(e,t),triggerChannelHotcue:(e,t)=>Ve.triggerChannelHotcue(e,t),setChannelCollapsed:(e,t)=>Ve.setChannelCollapsed(e,t),setChannelCount:e=>Ve.setChannelCount(e),getChannelCount:()=>Ve.getChannelCount(),resetDeckPlaybackToStart:()=>Ve.resetDeckPlaybackToStart(),hydrateDeckLayout:e=>Ve.hydrateDeckLayout(e),persistDeckLayoutSnapshot:()=>Ve.persistDeckLayoutSnapshot(),saveChannelHotcuesToPad:e=>Ve.saveChannelHotcuesToPad(e),setChannelVolume:(e,t)=>Ve.setChannelVolume(e,t),getChannelVolume:e=>Ve.getChannelVolume(e),stopChannel:(e,t)=>Ve.stopChannel(e,t),stopAllPads:e=>Ve.stopAllPads(e),setGlobalMute:e=>Ve.setGlobalMute(e),setMasterVolume:e=>Ve.setMasterVolume(e),applyGlobalEQ:e=>Ve.applyGlobalEQ(e),updatePadVolume:(e,t)=>Ve.updatePadVolume(e,t),addStateChangeListener:e=>Ve.addStateChangeListener(e),removeStateChangeListener:e=>Ve.removeStateChangeListener(e),isPadRegistered:e=>Ve.isPadRegistered(e),playStutterPad:e=>Ve.playStutterPad(e),toggleMutePad:e=>Ve.toggleMutePad(e),getAllRegisteredPads:()=>Ve.getAllRegisteredPads(),preUnlockAudio:()=>Ve.preUnlockAudio(),runDiagnostics:()=>Ve.runDiagnostics(),getAudioState:()=>Ve.getAudioState()}}"undefined"!=typeof window&&(window.debugPlaybackManager=()=>Ve.getDebugInfo(),window.debugIOSAudio=()=>Ve.getIOSDebugInfo(),window.runAudioDiagnostics=()=>Ve.runDiagnostics());let He=0;const Ke=({open:e,onOpenChange:t,useHistory:s=!0,...i})=>{const r=a.useRef(!1),o=a.useRef(!1),l=a.useRef(!1);return a.useEffect(()=>{if("undefined"!=typeof window&&s){if(e){r.current||0!==He||(window.history.pushState({vdjvDialog:!0},""),r.current=!0,l.current=!0),He+=1;const e=()=>{l.current&&(o.current?o.current=!1:r.current&&(r.current=!1,null==t||t(!1)))};return l.current&&window.addEventListener("popstate",e),()=>{He=Math.max(0,He-1),l.current&&window.removeEventListener("popstate",e)}}r.current&&l.current&&(r.current=!1,o.current=!0,window.history.back()),l.current=!1}},[e,t,s]),n.jsx(h,{open:e,onOpenChange:t,...i})},qe=l,ze=a.forwardRef(({className:e,...t},a)=>n.jsx(o,{ref:a,className:Ie("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",e),...t}));ze.displayName=o.displayName;const Ge=a.forwardRef(({className:e,children:t,hideCloseButton:a=!1,...s},i)=>n.jsxs(qe,{children:[n.jsx(ze,{}),n.jsxs(d,{ref:i,className:Ie("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg max-h-[85vh] translate-x-[-50%] translate-y-[-50%] gap-4 overflow-y-auto border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",e),onInteractOutside:e=>{e.preventDefault()},onEscapeKeyDown:e=>{e.preventDefault()},...s,children:[t,!a&&n.jsxs(c,{className:Ie("absolute right-4 top-4 h-8 w-8 p-0 rounded-md border transition-colors inline-flex items-center justify-center leading-none","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none","border-red-300 bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700","dark:border-red-500/50 dark:bg-red-900/40 dark:text-red-300 dark:hover:bg-red-800/60 dark:hover:text-red-100"),children:[n.jsx(K,{className:"h-4 w-4"}),n.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Ge.displayName=d.displayName;const Xe=({className:e,...t})=>n.jsx("div",{className:Ie("flex flex-col space-y-1.5 text-center sm:text-left",e),...t});Xe.displayName="DialogHeader";const We=({className:e,...t})=>n.jsx("div",{className:Ie("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",e),...t});We.displayName="DialogFooter";const Ye=a.forwardRef(({className:e,...t},a)=>n.jsx(u,{ref:a,className:Ie("text-lg font-semibold leading-none tracking-tight",e),...t}));Ye.displayName=u.displayName;const Ze=a.forwardRef(({className:e,...t},a)=>n.jsx(m,{ref:a,className:Ie("text-sm text-muted-foreground",e),...t}));Ze.displayName=m.displayName;const Je=a.forwardRef(({className:e,type:t,...a},s)=>n.jsx("input",{type:t,className:Ie("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",e),ref:s,...a}));Je.displayName="Input";const Qe=H("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),et=a.forwardRef(({className:e,...t},a)=>n.jsx(f,{ref:a,className:Ie(Qe(),e),...t}));et.displayName=f.displayName;const tt=N,at=A,nt=a.forwardRef(({className:e,children:t,...a},s)=>n.jsxs(p,{ref:s,className:Ie("flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",e),...a,children:[t,n.jsx(g,{asChild:!0,children:n.jsx(q,{className:"h-4 w-4 opacity-50"})})]}));nt.displayName=p.displayName;const st=a.forwardRef(({className:e,...t},a)=>n.jsx(b,{ref:a,className:Ie("flex cursor-default items-center justify-center py-1",e),...t,children:n.jsx(z,{className:"h-4 w-4"})}));st.displayName=b.displayName;const it=a.forwardRef(({className:e,...t},a)=>n.jsx(v,{ref:a,className:Ie("flex cursor-default items-center justify-center py-1",e),...t,children:n.jsx(q,{className:"h-4 w-4"})}));it.displayName=v.displayName;const rt=a.forwardRef(({className:e,children:t,position:a="popper",...s},i)=>n.jsx(y,{children:n.jsxs(_,{ref:i,className:Ie("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","popper"===a&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",e),position:a,...s,children:[n.jsx(st,{}),n.jsx(x,{className:Ie("p-1","popper"===a&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:t}),n.jsx(it,{})]})}));rt.displayName=_.displayName;a.forwardRef(({className:e,...t},a)=>n.jsx(w,{ref:a,className:Ie("px-2 py-1.5 text-sm font-semibold",e),...t})).displayName=w.displayName;const ot=a.forwardRef(({className:e,children:t,...a},s)=>n.jsxs(k,{ref:s,className:Ie("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",e),...a,children:[n.jsx("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center",children:n.jsx(M,{children:n.jsx(G,{className:"h-4 w-4"})})}),n.jsx(S,{children:t})]}));ot.displayName=k.displayName;a.forwardRef(({className:e,...t},a)=>n.jsx(C,{ref:a,className:Ie("-mx-1 my-1 h-px bg-muted",e),...t})).displayName=C.displayName;const lt=a.forwardRef(({className:e,...t},a)=>n.jsxs(E,{ref:a,className:Ie("relative flex w-full touch-none select-none items-center",e),...t,children:[n.jsx(I,{className:"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20",children:n.jsx(j,{className:"absolute h-full bg-primary"})}),n.jsx(T,{className:"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50"})]}));function dt({open:e,onOpenChange:t,title:a,description:s,confirmText:i="Confirm",cancelText:r="Cancel",variant:o="default",onConfirm:l,theme:d="light"}){return n.jsx(Ke,{open:e,onOpenChange:t,children:n.jsxs(Ge,{className:"sm:max-w-md backdrop-blur-md "+("dark"===d?"bg-gray-800/95 border-gray-600":"bg-white/95 border-gray-300"),children:[n.jsxs(Xe,{children:[n.jsxs("div",{className:"flex items-center gap-3",children:["destructive"===o?n.jsx("div",{className:"w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center",children:n.jsx(X,{className:"w-5 h-5 text-red-600 dark:text-red-400"})}):n.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center",children:n.jsx(X,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"})}),n.jsx(Ye,{className:"dark"===d?"text-white":"text-gray-900",children:a})]}),n.jsx(Ze,{className:"sr-only",children:s})]}),n.jsx("div",{className:"py-4",children:n.jsx("p",{className:"text-sm "+("dark"===d?"text-gray-300":"text-gray-600"),children:s})}),n.jsxs(We,{className:"gap-2",children:[n.jsx(Te,{variant:"outline",onClick:()=>{t(!1)},className:"flex-1",children:r}),n.jsxs(Te,{variant:o,onClick:()=>{l(),t(!1)},className:"flex-1 "+("destructive"===o?"bg-red-600 hover:bg-red-700 text-white":"bg-blue-600 hover:bg-blue-700 text-white"),children:["destructive"===o&&n.jsx(W,{className:"w-4 h-4 mr-2"}),i]})]})]})})}function ct({audioUrl:e,startTimeMs:t,endTimeMs:s,durationMs:i,onStartTimeChange:r,onEndTimeChange:o}){const l=a.useRef(null),d=a.useRef(null),c=a.useRef(null),[u,m]=a.useState(null),[h,f]=a.useState(!0),[p,g]=a.useState(1),[b,v]=a.useState(0),[y,_]=a.useState(null),[x,w]=a.useState(0),[k,M]=a.useState(0),[S,C]=a.useState(null),[N,A]=a.useState(!1),[E,I]=a.useState(null),j=a.useRef(null),T=a.useRef(null),B=a.useCallback(()=>i/p,[i,p]),P=a.useCallback((e,t)=>{const a=e/t*B();return Math.max(0,Math.min(i,b+a))},[i,b,B]),R=a.useCallback((e,t)=>{const a=B();return(e-b)/a*t},[b,B]),D=a.useCallback((e,t)=>{const a=i/t,n=Math.max(0,i-a);return Math.max(0,Math.min(n,e))},[i]);a.useEffect(()=>{const e=()=>{d.current&&(c.current=d.current.getBoundingClientRect())};return e(),window.addEventListener("resize",e),window.addEventListener("scroll",e,!0),()=>{window.removeEventListener("resize",e),window.removeEventListener("scroll",e,!0)}},[]),a.useEffect(()=>{if(!e||0===i)return void f(!1);let t=!1,a=null;return(async()=>{f(!0);try{const n=await fetch(e);if(t)return;const s=await n.arrayBuffer();if(t)return;a=new(window.AudioContext||window.webkitAudioContext);const i=await a.decodeAudioData(s);if(t)return;const r=i.getChannelData(0),o=2e3,l=Math.floor(r.length/o),d=[];for(let e=0;e<o;e++){const t=e*l,a=t+l;let n=0;for(let e=t;e<a;e+=10){const t=Math.abs(r[e]);t>n&&(n=t)}d.push(n)}const c=Math.max(...d)||1,u=d.map(e=>e/c);t||(m({peaks:u,duration:i.duration}),f(!1))}catch(n){console.error("Failed to generate waveform:",n),t||f(!1)}finally{a&&"closed"!==a.state&&a.close()}})(),()=>{t=!0}},[e,i]),a.useEffect(()=>{const e=d.current;if(!e||h)return;const t=t=>{t.preventDefault();const a=c.current||e.getBoundingClientRect(),n=t.clientX-a.left,s=a.width,r=P(n,s),o=.001*-t.deltaY,l=Math.max(1,Math.min(50,p*(1+o))),d=r-n/s*(i/l);g(l),v(D(d,l))},a=t=>{if(t.preventDefault(),c.current=e.getBoundingClientRect(),2===t.touches.length){const e=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY);return void(T.current=e)}1===t.touches.length&&O(t.touches[0].clientX)},n=t=>{t.preventDefault();const a=c.current||e.getBoundingClientRect();if(2===t.touches.length){const e=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY);if(null!==T.current){const n=e/T.current,s=(t.touches[0].clientX+t.touches[1].clientX)/2-a.left,r=P(s,a.width),o=Math.max(1,Math.min(50,p*n)),l=i/o,d=r-s/a.width*l;g(o),v(D(d,o))}return void(T.current=e)}1===t.touches.length&&L(t.touches[0].clientX)},s=()=>{T.current=null,F()};return e.addEventListener("wheel",t,{passive:!1}),e.addEventListener("touchstart",a,{passive:!1}),e.addEventListener("touchmove",n,{passive:!1}),e.addEventListener("touchend",s),e.addEventListener("touchcancel",s),()=>{e.removeEventListener("wheel",t),e.removeEventListener("touchstart",a),e.removeEventListener("touchmove",n),e.removeEventListener("touchend",s),e.removeEventListener("touchcancel",s)}},[h,p,b,i,t,s,y,x,k]);const O=e=>{if(!d.current)return;c.current=d.current.getBoundingClientRect();const a=c.current,n=e-a.left,i=a.width,l=P(n,i),u=R(t,i),m=R(s,i),h=Math.abs(n-u)<20,f=Math.abs(n-m)<20;if(h)_("start");else if(f)_("end");else if(p>1)_("pan"),w(n),M(b);else{Math.abs(l-t)<Math.abs(l-s)?(_("start"),r(Math.max(0,Math.min(l,s-10)))):(_("end"),o(Math.max(l,t+10)))}},L=e=>{if(!d.current||!y)return;const a=c.current||d.current.getBoundingClientRect(),n=e-a.left,l=a.width;if("pan"===y){return void v(D(k-(n-x)/l*(i/p),p))}const u=P(n,l),m=Math.max(0,Math.min(i,u));"start"===y?r(Math.min(m,s-10)):o(Math.max(m,t+10)),C(m)},F=()=>{_(null)};a.useEffect(()=>{if(!l.current||!u||!d.current)return;const e=l.current,a=e.getContext("2d");if(!a)return;const n=d.current.clientWidth,r=120;e.width===n&&e.height===r||(e.width=n,e.height=r);const{peaks:o}=u,c=i/p,m=o.length/i,h=Math.floor(b*m),f=Math.ceil((b+c)*m),g=o.slice(Math.max(0,h),Math.min(o.length,f));a.clearRect(0,0,n,r),a.fillStyle="#1f2937",a.fillRect(0,0,n,r);const v=R(t,n),_=R(s,n);a.fillStyle="rgba(59, 130, 246, 0.2)";const x=Math.max(0,v),w=Math.min(n,_);w>x&&a.fillRect(x,0,w-x,r);const k=n/g.length;if(a.beginPath(),g.forEach((e,t)=>{const n=t*k,s=n>=v&&n<=_;a.fillStyle=s?"#3b82f6":"#6b7280";const i=96*e;a.fillRect(n,60-i/2,Math.max(1,k-.5),i)}),v>=-5&&v<=n+5&&(a.strokeStyle="#10b981",a.lineWidth=2,a.beginPath(),a.moveTo(v,0),a.lineTo(v,r),a.stroke(),a.fillStyle="#10b981",a.beginPath(),a.moveTo(v,0),a.lineTo(v-6,0),a.lineTo(v-6,12),a.lineTo(v,18),a.lineTo(v,0),a.fill()),_>=-5&&_<=n+5&&(a.strokeStyle="#ef4444",a.lineWidth=2,a.beginPath(),a.moveTo(_,0),a.lineTo(_,r),a.stroke(),a.fillStyle="#ef4444",a.beginPath(),a.moveTo(_,0),a.lineTo(_+6,0),a.lineTo(_+6,12),a.lineTo(_,18),a.lineTo(_,0),a.fill()),N&&null!==E){const e=R(E,n);e>=0&&e<=n&&(a.strokeStyle="#fbbf24",a.lineWidth=2,a.beginPath(),a.moveTo(e,0),a.lineTo(e,r),a.stroke())}if(null!==S&&!y){const e=R(S,n);e>=0&&e<=n&&(a.strokeStyle="rgba(255, 255, 255, 0.3)",a.lineWidth=1,a.beginPath(),a.moveTo(e,0),a.lineTo(e,r),a.stroke())}},[u,t,s,p,b,N,E,S]);const U=e=>!isFinite(e)||e<0?"0.00s":(e/1e3).toFixed(3)+"s",V=()=>{if(!e||i<=0)return;if(N&&j.current)return j.current.pause(),A(!1),void I(null);const a=new Audio(e);j.current=a,a.currentTime=t/1e3;const n=s/1e3,r=()=>{if(!j.current)return;const e=j.current.currentTime;I(1e3*e),e>=n?(j.current.pause(),A(!1),I(null)):requestAnimationFrame(r)};a.play().then(()=>{A(!0),requestAnimationFrame(r)}).catch(()=>A(!1)),a.onended=()=>{A(!1),I(null)}};a.useEffect(()=>()=>{j.current&&j.current.pause()},[]);const $=s-t;return n.jsxs("div",{className:"space-y-4 select-none",children:[n.jsxs("div",{className:"flex items-center justify-between text-sm",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("div",{className:"flex items-center gap-2",children:n.jsxs("span",{className:"text-green-500 font-bold",children:["IN: ",U(t)]})}),n.jsx("div",{className:"flex items-center gap-2",children:n.jsxs("span",{className:"text-red-500 font-bold",children:["OUT: ",U(s)]})})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(Te,{variant:"ghost",size:"sm",onClick:()=>{g(1),v(0)},children:"Reset View"}),n.jsxs("span",{className:"text-xs text-gray-500 bg-gray-900 px-2 py-1 rounded",children:[p.toFixed(1),"x"]}),n.jsx(Te,{onClick:V,variant:N?"destructive":"outline",size:"sm",className:"h-6 w-6 p-0",disabled:h||$<=0,children:N?n.jsx(Y,{className:"w-3 h-3 text-red-500"}):n.jsx(Z,{className:"w-3 h-3 text-green-500"})})]})]}),n.jsxs("div",{ref:d,className:"relative w-full bg-gray-800 rounded-lg overflow-hidden border border-gray-700 touch-none",style:{height:"120px",cursor:"pan"===y?"grab":"crosshair"},onMouseDown:e=>{O(e.clientX)},onMouseMove:e=>{if(d.current&&!y){const t=c.current||d.current.getBoundingClientRect(),a=e.clientX-t.left;C(P(a,t.width))}L(e.clientX)},onMouseUp:()=>_(null),onMouseLeave:()=>{_(null),C(null)},onDoubleClick:V,children:[h?n.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:"Loading..."}):n.jsx("canvas",{ref:l,className:"w-full h-full block"}),1===p&&!h&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none opacity-20",children:n.jsx("span",{className:"text-xs text-white",children:"Scroll to Zoom ‚Ä¢ Drag to Move"})})]})]})}lt.displayName=E.displayName;const ut=["Space","M","Z","X","B","[","]","N","ArrowDown","ArrowUp","+","-","V","`","C"],mt=new Set(ut);function ht(e,t){if(!e)return null;const a=null==t?void 0:t.code;let n=e;if((null==a?void 0:a.startsWith("Digit"))&&6===a.length)n=a.replace("Digit","");else if((null==a?void 0:a.startsWith("Key"))&&4===a.length)n=a.replace("Key","").toUpperCase();else if("Semicolon"===a)n=";";else if("Comma"===a)n=",";else if("Period"===a)n=".";else if(" "===e||"Spacebar"===e)n="Space";else if(e.startsWith("Arrow"))n=e;else if(e.startsWith("Numpad"))n=e;else if((null==a?void 0:a.startsWith("Numpad"))&&1===e.length&&/[0-9]/.test(e))n=`Numpad${e}`;else{if(1!==e.length)return null;n=e.toUpperCase()}const s=[];return(null==t?void 0:t.shiftKey)&&s.push("Shift"),(null==t?void 0:t.ctrlKey)&&s.push("Ctrl"),(null==t?void 0:t.altKey)&&s.push("Alt"),(null==t?void 0:t.metaKey)&&s.push("Meta"),s.push(n),s.join("+")}function ft(e){if(!e)return null;if(!e.includes("+"))return ht(e)||null;const t=e.split("+").map(e=>e.trim()).filter(Boolean);let a="",n=!1,s=!1,i=!1,r=!1;return t.forEach(e=>{const t=e.toLowerCase();"shift"===t?n=!0:"ctrl"===t||"control"===t?s=!0:"alt"===t||"option"===t?i=!0:"meta"===t||"cmd"===t||"command"===t||"win"===t?r=!0:a=e}),a&&ht(a,{shiftKey:n,ctrlKey:s,altKey:i,metaKey:r})||null}function pt(e){return function(e){const t=function(e){const t=e.split("+");return t[t.length-1]||e}(e);return mt.has(t)}(e)&&!function(e){return e.includes("+")}(e)}const gt=[{name:"Red",hex:"#ff0000"},{name:"Orange",hex:"#ff5400"},{name:"Warm Yellow",hex:"#ffbd6c"},{name:"Yellow",hex:"#ffff00"},{name:"Yellow Green",hex:"#bdff2d"},{name:"Lime",hex:"#54ff00"},{name:"Green",hex:"#00ff00"},{name:"Cyan",hex:"#4cc3ff"},{name:"Blue",hex:"#0000ff"},{name:"Purple",hex:"#5400ff"},{name:"Pink",hex:"#ff00ff"},{name:"White",hex:"#ffffff"}],bt=[{velocity:0,hex:"#000000",name:"Off"},{velocity:1,hex:"#1e1e1e",name:"Dim Gray"},{velocity:2,hex:"#7f7f7f",name:"Gray"},{velocity:3,hex:"#ffffff",name:"White"},{velocity:4,hex:"#ff4c4c",name:"Light Red"},{velocity:5,hex:"#ff0000",name:"Red"},{velocity:6,hex:"#590000",name:"Dark Red"},{velocity:7,hex:"#190000",name:"Deep Red"},{velocity:8,hex:"#ffbd6c",name:"Amber"},{velocity:9,hex:"#ff5400",name:"Orange"},{velocity:10,hex:"#591d00",name:"Brown"},{velocity:11,hex:"#271b00",name:"Deep Brown"},{velocity:12,hex:"#ffff4c",name:"Light Yellow"},{velocity:13,hex:"#ffff00",name:"Yellow"},{velocity:14,hex:"#595900",name:"Olive"},{velocity:15,hex:"#191900",name:"Deep Olive"},{velocity:16,hex:"#88ff4c",name:"Light Lime"},{velocity:17,hex:"#54ff00",name:"Lime"},{velocity:18,hex:"#1d5900",name:"Dark Green"},{velocity:19,hex:"#142b00",name:"Deep Green"},{velocity:20,hex:"#4cff4c",name:"Light Green"},{velocity:21,hex:"#00ff00",name:"Green"},{velocity:22,hex:"#005900",name:"Forest Green"},{velocity:23,hex:"#001900",name:"Deep Forest"},{velocity:24,hex:"#4cff5e",name:"Mint"},{velocity:25,hex:"#00ff19",name:"Neon Green"},{velocity:26,hex:"#00590d",name:"Deep Green 2"},{velocity:27,hex:"#001902",name:"Deep Green 3"},{velocity:28,hex:"#4cff88",name:"Sea Green"},{velocity:29,hex:"#00ff55",name:"Bright Sea"},{velocity:30,hex:"#00591d",name:"Deep Sea"},{velocity:31,hex:"#001f12",name:"Deep Sea 2"},{velocity:32,hex:"#4cffb7",name:"Aqua"},{velocity:33,hex:"#00ff99",name:"Aqua Green"},{velocity:34,hex:"#005935",name:"Deep Aqua"},{velocity:35,hex:"#001912",name:"Deep Aqua 2"},{velocity:36,hex:"#4cc3ff",name:"Sky"},{velocity:37,hex:"#00a9ff",name:"Light Blue"},{velocity:38,hex:"#004152",name:"Deep Sky"},{velocity:39,hex:"#001019",name:"Deep Sky 2"},{velocity:40,hex:"#4c88ff",name:"Soft Blue"},{velocity:41,hex:"#0055ff",name:"Blue"},{velocity:42,hex:"#001d59",name:"Dark Blue"},{velocity:43,hex:"#000819",name:"Deep Blue"},{velocity:44,hex:"#4c4cff",name:"Indigo"},{velocity:45,hex:"#0000ff",name:"Pure Blue"},{velocity:46,hex:"#000059",name:"Deep Indigo"},{velocity:47,hex:"#000019",name:"Deep Indigo 2"},{velocity:48,hex:"#874cff",name:"Violet"},{velocity:49,hex:"#5400ff",name:"Purple"},{velocity:50,hex:"#190064",name:"Deep Purple"},{velocity:51,hex:"#0f0030",name:"Deep Purple 2"},{velocity:52,hex:"#ff4cff",name:"Magenta"},{velocity:53,hex:"#ff00ff",name:"Hot Pink"},{velocity:54,hex:"#590059",name:"Deep Magenta"},{velocity:55,hex:"#190019",name:"Deep Magenta 2"},{velocity:56,hex:"#ff4c87",name:"Pink"},{velocity:57,hex:"#ff0054",name:"Hot Pink 2"},{velocity:58,hex:"#59001d",name:"Deep Pink"},{velocity:59,hex:"#220013",name:"Deep Pink 2"},{velocity:60,hex:"#ff1500",name:"Orange Red"},{velocity:61,hex:"#993500",name:"Burnt Orange"},{velocity:62,hex:"#795100",name:"Gold Brown"},{velocity:63,hex:"#436400",name:"Olive Green"},{velocity:64,hex:"#033900",name:"Deep Olive"},{velocity:65,hex:"#005735",name:"Teal Green"},{velocity:66,hex:"#00547f",name:"Teal Blue"},{velocity:67,hex:"#0000ff",name:"Pure Blue 2"},{velocity:68,hex:"#00454f",name:"Deep Teal"},{velocity:69,hex:"#2500cc",name:"Deep Violet"},{velocity:70,hex:"#7f7f7f",name:"Gray 2"},{velocity:71,hex:"#202020",name:"Dark Gray"},{velocity:72,hex:"#ff0000",name:"Red 2"},{velocity:73,hex:"#bdff2d",name:"Yellow Green"},{velocity:74,hex:"#afed06",name:"Yellow Green 2"},{velocity:75,hex:"#64ff09",name:"Bright Green"},{velocity:76,hex:"#108b00",name:"Dark Green 2"},{velocity:77,hex:"#00ff87",name:"Aqua 2"},{velocity:78,hex:"#00a9ff",name:"Light Blue 2"},{velocity:79,hex:"#002aff",name:"Deep Blue 2"},{velocity:80,hex:"#3f00ff",name:"Violet 2"},{velocity:81,hex:"#7a00ff",name:"Purple 2"},{velocity:82,hex:"#b21a7d",name:"Magenta 2"},{velocity:83,hex:"#402100",name:"Brown 2"},{velocity:84,hex:"#ff4a00",name:"Orange 2"},{velocity:85,hex:"#88e106",name:"Lime 2"},{velocity:86,hex:"#72ff15",name:"Lime 3"},{velocity:87,hex:"#00ff00",name:"Green 2"},{velocity:88,hex:"#3bff26",name:"Bright Green 2"},{velocity:89,hex:"#59ff71",name:"Mint 2"},{velocity:90,hex:"#38ffcc",name:"Cyan 2"},{velocity:91,hex:"#5b8aff",name:"Blue 2"},{velocity:92,hex:"#3151c6",name:"Blue 3"},{velocity:93,hex:"#877fe9",name:"Purple 3"},{velocity:94,hex:"#d31dff",name:"Violet 3"},{velocity:95,hex:"#ff005d",name:"Pink 2"},{velocity:96,hex:"#ff7f00",name:"Orange 3"},{velocity:97,hex:"#b9b000",name:"Olive 2"},{velocity:98,hex:"#90ff00",name:"Lime 4"},{velocity:99,hex:"#835d07",name:"Gold 2"},{velocity:100,hex:"#392b00",name:"Deep Gold"},{velocity:101,hex:"#144c10",name:"Deep Green 4"},{velocity:102,hex:"#0d5038",name:"Deep Teal"},{velocity:103,hex:"#15152a",name:"Deep Indigo"},{velocity:104,hex:"#16205a",name:"Deep Blue 3"},{velocity:105,hex:"#693c1c",name:"Brown 3"},{velocity:106,hex:"#a8000a",name:"Dark Red 2"},{velocity:107,hex:"#de513d",name:"Red 3"},{velocity:108,hex:"#d86a1c",name:"Orange 4"},{velocity:109,hex:"#ffe126",name:"Yellow 2"},{velocity:110,hex:"#9ee12f",name:"Yellow Green 3"},{velocity:111,hex:"#67b50f",name:"Green 3"},{velocity:112,hex:"#1e1e30",name:"Deep Gray"},{velocity:113,hex:"#dcff6b",name:"Pale Yellow"},{velocity:114,hex:"#80ffbd",name:"Pale Cyan"},{velocity:115,hex:"#9a99ff",name:"Pale Blue"},{velocity:116,hex:"#8e66ff",name:"Pale Purple"},{velocity:117,hex:"#404040",name:"Gray 3"},{velocity:118,hex:"#757575",name:"Gray 4"},{velocity:119,hex:"#e0ffff",name:"White 2"},{velocity:120,hex:"#a00000",name:"Dark Red 3"},{velocity:121,hex:"#350000",name:"Deep Red 2"},{velocity:122,hex:"#1ad000",name:"Lime 5"},{velocity:123,hex:"#074200",name:"Deep Green 5"},{velocity:124,hex:"#b9b000",name:"Olive 3"},{velocity:125,hex:"#3f3100",name:"Deep Olive 2"},{velocity:126,hex:"#b35f00",name:"Orange 5"},{velocity:127,hex:"#4b1502",name:"Deep Brown 2"}],vt=e=>{const t=e.replace("#","");if(6!==t.length)return{r:0,g:0,b:0};return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16)}},yt=e=>(e=>{const t=vt(e);let a=bt[0],n=Number.POSITIVE_INFINITY;for(const s of bt){const e=vt(s.hex),i=(t.r-e.r)**2+(t.g-e.g)**2+(t.b-e.b)**2;i<n&&(n=i,a=s)}return a})(e).velocity,_t=bt.filter(e=>e.velocity>0).filter((e,t,a)=>a.findIndex(t=>t.hex===e.hex)===t).map(e=>({label:e.name,value:e.hex})),xt=["Dim Gray","Gray","White","Red","Amber","Orange","Light Yellow","Yellow","Green","Aqua","Blue","Pure Blue","Violet","Purple","Hot Pink","Hot Pink 2","Deep Magenta","Deep Brown 2"].map(e=>_t.find(t=>t.label===e)).filter(Boolean),wt=_t.filter(e=>!xt.some(t=>t.value===e.value));function kt({pad:e,allBanks:t=[],allPads:s=[],bankPads:i=[],open:r,onOpenChange:o,onSave:l,onUnload:d,midiEnabled:c=!1,blockedShortcutKeys:u,blockedMidiNotes:m,blockedMidiCCs:h}){const[f,p]=a.useState(e.name),[g,b]=a.useState(e.color),[v,y]=a.useState(e.triggerMode),[_,x]=a.useState(e.playbackMode),[w,k]=a.useState([100*e.volume]),[M,S]=a.useState([e.startTimeMs||0]),[C,N]=a.useState([e.endTimeMs||0]),[A,E]=a.useState([e.fadeInMs||0]),[I,j]=a.useState([e.fadeOutMs||0]),[T,B]=a.useState([e.pitch||0]),[P,R]=a.useState(e.imageUrl||""),[D,O]=a.useState(e.imageData||""),[L,F]=a.useState(e.shortcutKey||""),[U,V]=a.useState(null),[$,H]=a.useState(null),[K,q]=a.useState(e.midiNote),[z,G]=a.useState(e.midiCC),[X,W]=a.useState(!1),[Y,Z]=a.useState(0),[Q,ee]=a.useState(!1),[te,ae]=a.useState(null),[ne,se]=a.useState(!1),[ie,re]=a.useState(!1),[oe,le]=a.useState(!1),de=a.useRef(null),ce=a.useRef("");a.useEffect(()=>{if(r&&(p(e.name),b(e.color),y(e.triggerMode),x(e.playbackMode),k([100*e.volume]),S([e.startTimeMs||0]),N([e.endTimeMs||0]),E([e.fadeInMs||0]),j([e.fadeOutMs||0]),B([e.pitch||0]),R(e.imageUrl||""),O(e.imageData||""),F(e.shortcutKey||""),V(null),q(e.midiNote),G(e.midiCC),W(!1),H(null),ae(null),ce.current=JSON.stringify({name:e.name,color:e.color,triggerMode:e.triggerMode,playbackMode:e.playbackMode,volume:e.volume,startTimeMs:e.startTimeMs||0,endTimeMs:e.endTimeMs||0,fadeInMs:e.fadeInMs||0,fadeOutMs:e.fadeOutMs||0,pitch:e.pitch||0,imageUrl:e.imageUrl||"",imageData:e.imageData||"",shortcutKey:e.shortcutKey||"",midiNote:e.midiNote??null,midiCC:e.midiCC??null}),e.audioUrl)){let t=!1;const a=new Audio(e.audioUrl);a.addEventListener("loadedmetadata",()=>{!t&&a.duration&&isFinite(a.duration)&&(t=!0,Z(1e3*a.duration),0===C[0]&&N([1e3*a.duration]))});const n=setTimeout(async()=>{if(!t)try{const a=await fetch(e.audioUrl),n=await a.arrayBuffer(),s=new(window.AudioContext||window.webkitAudioContext),i=await s.decodeAudioData(n);if(!t){t=!0;const e=1e3*i.duration;Z(e),0===C[0]&&N([e])}s.close()}catch(a){console.warn("Failed to decode audio for duration:",a),e.endTimeMs>0&&Z(e.endTimeMs)}},500);return()=>clearTimeout(n)}},[r,e]);const ue=a.useCallback(()=>JSON.stringify({name:f,color:g,triggerMode:v,playbackMode:_,volume:w[0]/100,startTimeMs:M[0],endTimeMs:C[0],fadeInMs:A[0],fadeOutMs:I[0],pitch:T[0],imageUrl:P,imageData:D,shortcutKey:L||"",midiNote:K??null,midiCC:z??null}),[f,g,v,_,w,M,C,A,I,T,P,D,L,K,z]),me=a.useMemo(()=>!!r&&ce.current!==ue(),[r,ue]);a.useEffect(()=>{if(!X)return;const a=a=>{const n=a.detail;if(n){if("noteon"===n.type){if(null==m?void 0:m.has(n.note))return H("That MIDI note is already assigned."),void W(!1);const a=t.find(e=>"number"==typeof e.midiNote&&e.midiNote===n.note);if(a)return H(`That MIDI note is already assigned to bank "${a.name}".`),void W(!1);const s=i.find(t=>t.id!==e.id&&("number"==typeof t.midiNote&&t.midiNote===n.note));if(s)return H(`That MIDI note is already assigned to pad "${s.name}".`),void W(!1);q(n.note)}else{if("cc"!==n.type)return;{if(null==h?void 0:h.has(n.cc))return H("That MIDI CC is already assigned."),void W(!1);const a=t.find(e=>"number"==typeof e.midiCC&&e.midiCC===n.cc);if(a)return H(`That MIDI CC is already assigned to bank "${a.name}".`),void W(!1);const s=i.find(t=>t.id!==e.id&&("number"==typeof t.midiCC&&t.midiCC===n.cc));if(s)return H(`That MIDI CC is already assigned to pad "${s.name}".`),void W(!1);G(n.cc)}}H(null),W(!1)}};return window.addEventListener("vdjv-midi",a),()=>window.removeEventListener("vdjv-midi",a)},[X,m,h,t,i,e.id]);const he=a=>{if(!a)return F(""),void V(null);if(pt(a))return void V(`"${a}" is reserved for global controls.`);if(null==u?void 0:u.has(a))return void V(`"${a}" is already assigned to system or channel mapping.`);const n=t.find(e=>ft(e.shortcutKey)===a);if(n)return void V(`"${a}" is already assigned to bank "${n.name}".`);const s=i.find(t=>{if(t.id===e.id)return!1;return ft(t.shortcutKey)===a});s?V(`"${a}" is already assigned to "${s.name}".`):(F(a),V(null),H(null))},fe=async()=>{try{if(U)return ae(U),!1;const t=f.slice(0,32),a={...e,name:t,color:g,triggerMode:v,playbackMode:_,volume:w[0]/100,fadeInMs:A[0],fadeOutMs:I[0],startTimeMs:M[0],endTimeMs:C[0],pitch:T[0],imageUrl:P,imageData:D,shortcutKey:L||void 0,midiNote:K,midiCC:z,ignoreChannel:e.ignoreChannel};return await l(a),p(t),ce.current=JSON.stringify({name:t,color:g,triggerMode:v,playbackMode:_,volume:w[0]/100,startTimeMs:M[0],endTimeMs:C[0],fadeInMs:A[0],fadeOutMs:I[0],pitch:T[0],imageUrl:P,imageData:D,shortcutKey:L||"",midiNote:K??null,midiCC:z??null}),!0}catch(t){return console.error("Failed to save pad:",t),t instanceof Error?ae(t.message):ae("Failed to save pad changes. Please try again."),!1}},pe=a.useCallback(async()=>{if(Q)return;await fe()&&o(!1)},[fe,o,Q]),ge=a.useCallback(e=>{e||!me?o(e):re(!0)},[me,o]),be=a.useCallback(e=>{var t;if("Enter"!==e.key)return;if(e.shiftKey||e.ctrlKey||e.altKey||e.metaKey)return;const a=e.target,n=null==(t=null==a?void 0:a.tagName)?void 0:t.toLowerCase();"textarea"!==n&&"button"!==n&&(e.preventDefault(),pe())},[pe]),ve=(e,t)=>()=>e([t]),ye=ut.join(", "),_e=C[0]-M[0],xe=_e>10?Math.min(5e3,Math.floor(_e/2)):0;return n.jsxs(n.Fragment,{children:[n.jsx(Ke,{open:r,onOpenChange:ge,children:n.jsxs(Ge,{className:"sm:max-w-lg max-h-[80vh] overflow-y-auto backdrop-blur-md bg-white/95 border-gray-300 dark:bg-gray-800/95 dark:border-gray-600","aria-describedby":void 0,onKeyDown:be,children:[n.jsx(Xe,{children:n.jsx(Ye,{children:"Edit Pad Settings"})}),n.jsxs("div",{className:"space-y-6",children:[te&&n.jsx("div",{className:"p-3 rounded-lg bg-red-50 border border-red-200 text-red-700 text-sm",children:te}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsx(et,{children:"Pad Image"}),n.jsx(Te,{onClick:pe,variant:"outline",size:"sm",disabled:Q,children:Q?"Saving...":"Save"})]}),P?n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("img",{src:P,alt:"Pad preview",className:"w-16 h-16 object-cover rounded border"}),n.jsxs("div",{className:"flex-1",children:[n.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Image uploaded"}),n.jsx(Te,{onClick:()=>{P&&P.startsWith("blob:")&&URL.revokeObjectURL(P),R(""),O(""),ae(null)},variant:"outline",size:"sm",disabled:Q,children:"Remove Image"})]})]}):n.jsxs(n.Fragment,{children:[n.jsx("input",{ref:de,type:"file",accept:"image/jpeg,image/png,image/webp",onChange:async e=>{var t;const a=null==(t=e.target.files)?void 0:t[0];if(a){ee(!0),ae(null);try{const e=await(e=>new Promise(t=>{if(!e.type.startsWith("image/jpeg")&&!e.type.startsWith("image/png")&&!e.type.startsWith("image/webp"))return void t({valid:!1,error:"Invalid file type. Please select a JPG, PNG, or WebP image."});if(e.size>2097152)return void t({valid:!1,error:`Image too large. Please use an image under 2MB. Current size: ${(e.size/1024/1024).toFixed(1)}MB`});const a=new Image,n=URL.createObjectURL(e);a.onload=()=>{URL.revokeObjectURL(n),a.width>1024||a.height>1024?t({valid:!1,error:`Image too large. Please use an image under 1024x1024px. Current dimensions: ${a.width}x${a.height}px`}):t({valid:!0})},a.onerror=()=>{URL.revokeObjectURL(n),t({valid:!1,error:"Invalid image file. Please select a valid JPG, PNG, or WebP image."})},a.src=n}))(a);if(!e.valid)return void ae(e.error||"Invalid image file");const t=URL.createObjectURL(a),n=new FileReader;n.onload=()=>{O(n.result),R(t),ae(null)},n.onerror=()=>{ae("Failed to process image file"),URL.revokeObjectURL(t)},n.readAsDataURL(a)}catch(n){console.error("Image upload error:",n),ae("Failed to upload image. Please try again.")}finally{ee(!1),e.target&&(e.target.value="")}}},className:"hidden",disabled:Q}),n.jsxs(Te,{onClick:()=>{var e;return null==(e=de.current)?void 0:e.click()},variant:"outline",className:"w-full",disabled:Q,children:[n.jsx(J,{className:"w-4 h-4 mr-2"}),Q?"Uploading...":"Upload Image (JPG/PNG/WebP)"]})]}),n.jsx("p",{className:"text-xs text-gray-500",children:"It will replace the pad name display. Maximum: 1024x1024px, 2MB"})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"name",children:"Pad Name"}),n.jsx(Je,{id:"name",value:f,onChange:e=>p(e.target.value.slice(0,32)),placeholder:"Enter pad name",autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",maxLength:32,onFocus:e=>{window.innerWidth<=1800&&setTimeout(()=>e.target.focus(),100)}})]}),n.jsxs("div",{className:"grid gap-3 "+(c?"grid-cols-2":"grid-cols-1"),children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"shortcutKey",children:"Keyboard Shortcut"}),n.jsx(Je,{id:"shortcutKey",value:L,onKeyDown:e=>{if("Tab"===e.key)return;if(e.preventDefault(),"Backspace"===e.key||"Delete"===e.key||"Escape"===e.key)return void he(null);if(e.shiftKey)return void V("Shift is reserved for the secondary bank.");if(e.ctrlKey)return void V("Ctrl shortcuts are reserved by the browser. Use Alt or Meta instead.");const t=ht(e.key,{shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,code:e.code});t?he(t):V("Please press a letter or number key.")},placeholder:"Press a key",readOnly:!0}),U&&n.jsx("p",{className:"text-xs text-red-500",children:U}),!U&&n.jsxs("p",{className:"text-xs text-gray-500",children:["Reserved keys: ",ye]})]}),c&&n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{children:"MIDI Assignment"}),n.jsxs("div",{className:"text-xs text-gray-500",children:["Note: ",K??"‚Äî"," | CC: ",z??"‚Äî"]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:()=>W(!0),className:"flex-1",children:X?"Listening‚Ä¶":"Learn MIDI"}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:()=>{q(void 0),G(void 0),W(!1),H(null)},children:"Clear"})]}),$&&n.jsx("p",{className:"text-xs text-red-500",children:$})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{children:"Pad Color"}),n.jsx("div",{className:"flex gap-1 flex-wrap",children:(oe?[...xt,...wt]:xt).map(e=>n.jsx("button",{onClick:()=>b(e.value),className:"w-6 h-6 rounded-full border-2 transition-all "+(g===e.value?"border-white scale-110":"border-gray-400"),style:{backgroundColor:e.value},title:e.label},e.value))}),wt.length>0&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>le(e=>!e),children:oe?"Show Less":"Load More"})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{children:"Trigger Mode"}),n.jsxs(tt,{value:v,onValueChange:e=>y(e),children:[n.jsx(nt,{children:n.jsx(at,{})}),n.jsxs(rt,{children:[n.jsx(ot,{value:"toggle",children:"On/Off - Click to play/pause"}),n.jsx(ot,{value:"hold",children:"Hold - Play while pressed"}),n.jsx(ot,{value:"stutter",children:"Stutter - Restart on each click"}),n.jsx(ot,{value:"unmute",children:"Unmute - Play continuously, mute when released"})]})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{children:"Playback Mode"}),n.jsxs(tt,{value:_,onValueChange:e=>x(e),children:[n.jsx(nt,{children:n.jsx(at,{})}),n.jsxs(rt,{children:[n.jsx(ot,{value:"once",children:"Play Once"}),n.jsx(ot,{value:"loop",children:"Loop"}),n.jsx(ot,{value:"stopper",children:"Stopper - Play and stop all other pads"})]})]})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("div",{className:"flex items-center justify-between gap-2",children:n.jsxs(et,{className:"cursor-pointer",onDoubleClick:ve(k,100),title:"Double-click to reset to 100%",children:["Volume: ",w[0],"%"]})}),n.jsx(lt,{value:w,onValueChange:k,max:100,min:0,step:1,className:"w-full cursor-pointer",onDoubleClick:ve(k,100)})]}),Y>0&&e.audioUrl&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{children:"Trim In / Trim Out"}),n.jsx(ct,{audioUrl:e.audioUrl,startTimeMs:M[0],endTimeMs:C[0],durationMs:Y,onStartTimeChange:e=>S([e]),onEndTimeChange:e=>N([e])})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs(et,{className:"cursor-pointer",onDoubleClick:ve(E,0),title:"Double-click to reset to 0ms",children:["Fade In: ",A[0],"ms"]}),n.jsx(lt,{value:A,onValueChange:e=>{const t=Math.min(e[0],xe);E([t])},max:xe,min:0,step:10,className:"w-full cursor-pointer",onDoubleClick:ve(E,0),disabled:xe<=0}),n.jsx("p",{className:"text-xs text-gray-500",children:xe>0?`Gradual volume increase at playback start (max ${xe}ms)`:"Adjust trim settings to enable fade in"})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs(et,{className:"cursor-pointer",onDoubleClick:ve(j,0),title:"Double-click to reset to 0ms",children:["Fade Out: ",I[0],"ms"]}),n.jsx(lt,{value:I,onValueChange:e=>{const t=Math.min(e[0],xe);j([t])},max:xe,min:0,step:10,className:"w-full cursor-pointer",onDoubleClick:ve(j,0),disabled:xe<=0}),n.jsx("p",{className:"text-xs text-gray-500",children:xe>0?`Gradual volume decrease before playback end (max ${xe}ms)`:"Adjust trim settings to enable fade out"})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs(et,{className:"cursor-pointer",onDoubleClick:ve(B,0),title:"Double-click to reset to 0",children:["Pitch: ",T[0]>0?"+":"",T[0]," semitones"]}),n.jsx(lt,{value:T,onValueChange:B,max:12,min:-12,step:1,className:"w-full cursor-pointer",onDoubleClick:ve(B,0)})]}),n.jsxs("div",{className:"grid grid-cols-3 gap-2 pt-4",children:[n.jsx(Te,{onClick:pe,className:"w-full",disabled:Q,children:Q?"Saving...":"Save Changes"}),n.jsx(Te,{onClick:()=>ge(!1),variant:"outline",disabled:Q,className:"w-full",children:"Cancel"}),n.jsx(Te,{onClick:()=>{se(!0)},variant:"destructive",disabled:Q,className:"w-full",children:"Unload"})]})]})]})}),n.jsx(dt,{open:ne,onOpenChange:se,title:"Unload Pad",description:`Are you sure you want to unload the pad "${f}"? This will permanently remove the pad and its audio. This action cannot be undone.`,confirmText:"Unload Pad",variant:"destructive",onConfirm:()=>{d(),se(!1)}}),n.jsx(Ke,{open:ie,onOpenChange:re,children:n.jsxs(Ge,{className:"sm:max-w-md","aria-describedby":void 0,children:[n.jsx(Xe,{children:n.jsx(Ye,{children:"Discard changes?"})}),n.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:"You have unsaved changes for this pad. Save them or discard the changes."}),n.jsxs("div",{className:"flex gap-2 pt-2",children:[n.jsx(Te,{onClick:()=>{re(!1),pe()},className:"flex-1",disabled:Q,children:"Save"}),n.jsx(Te,{onClick:()=>{re(!1),o(!1)},variant:"outline",className:"flex-1",children:"Discard"})]})]})})]})}function Mt({pad:e,availableBanks:t,open:s,onOpenChange:i,onTransfer:r,theme:o="light"}){var l;const[d,c]=a.useState("");a.useEffect(()=>{s&&c("")},[s]);return n.jsx(Ke,{open:s,onOpenChange:i,children:n.jsxs(Ge,{className:"sm:max-w-md backdrop-blur-md "+("dark"===o?"bg-gray-800/95 border-gray-600":"bg-white/95 border-gray-300"),"aria-describedby":void 0,children:[n.jsx(Xe,{children:n.jsx(Ye,{className:"dark"===o?"text-white":"text-gray-900",children:"Transfer Pad"})}),n.jsxs("div",{className:"space-y-6",children:[n.jsx("div",{className:"p-3 rounded-lg border "+("dark"===o?"bg-gray-700/50 border-gray-600/50":"bg-gray-50/50 border-gray-300/50"),children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"w-4 h-4 rounded-full flex-shrink-0",style:{backgroundColor:e.color}}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:"font-medium truncate "+("dark"===o?"text-white":"text-gray-900"),children:e.name}),n.jsxs("p",{className:"text-sm "+("dark"===o?"text-gray-400":"text-gray-600"),children:["Volume: ",Math.round(100*e.volume),"% ‚Ä¢ Mode: ",e.triggerMode]})]})]})}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{className:"dark"===o?"text-white":"text-gray-900",children:"Transfer to Bank:"}),n.jsxs(tt,{value:d,onValueChange:c,children:[n.jsx(nt,{className:"backdrop-blur-sm",children:n.jsx(at,{placeholder:"Select destination bank..."})}),n.jsx(rt,{children:t.map(e=>n.jsx(ot,{value:e.id,children:e.name},e.id))})]}),0===t.length&&n.jsx("p",{className:"text-sm "+("dark"===o?"text-gray-400":"text-gray-600"),children:"No other banks available for transfer."})]}),n.jsxs("div",{className:"flex gap-2 pt-2",children:[n.jsxs(Te,{onClick:()=>{d&&r(d)},disabled:!d,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",children:[n.jsx(Q,{className:"w-4 h-4 mr-2"}),"Transfer Pad"]}),n.jsx(Te,{onClick:()=>{i(!1)},variant:"outline",className:"flex-1",children:"Cancel"})]}),d&&n.jsx("div",{className:"p-3 rounded-lg border "+("dark"===o?"bg-blue-900/20 border-blue-600/50":"bg-blue-50/50 border-blue-300/50"),children:n.jsxs("p",{className:"text-sm "+("dark"===o?"text-blue-300":"text-blue-700"),children:['The pad will be moved to "',null==(l=t.find(e=>e.id===d))?void 0:l.name,"\" and will adopt that bank's default color."]})})]})]})})}function St({pad:e,bankId:t,bankName:s,allBanks:i=[],allPads:r=[],bankPads:o=[],editMode:l,globalMuted:d,masterVolume:c,theme:u,stopMode:m,eqSettings:h,padSize:f=5,onUpdatePad:p,onRemovePad:g,onDragStart:b,onTransferPad:v,availableBanks:y=[],canTransferFromBank:_,midiEnabled:x=!1,blockedShortcutKeys:w,blockedMidiNotes:k,blockedMidiCCs:M,hideShortcutLabel:S=!1,editRequestToken:C,channelLoadArmed:N=!1,onSelectPadForChannelLoad:A}){var E;const I=function(e,t,n){const s=$e(),[i,r]=a.useState(!1),o=a.useRef(!1),l=a.useRef(e.id),d=a.useRef(null);a.useEffect(()=>{e.audioUrl&&(async()=>{try{await s.registerPad(e.id,e,t,n),o.current=!0,l.current=e.id}catch(a){console.error("Failed to register pad:",e.id,a)}})()},[e.audioUrl,e.id]),a.useEffect(()=>{o.current&&s.updatePadSettings(e.id,{triggerMode:e.triggerMode,playbackMode:e.playbackMode,startTimeMs:e.startTimeMs,endTimeMs:e.endTimeMs,pitch:e.pitch,volume:e.volume})},[e.triggerMode,e.playbackMode,e.startTimeMs,e.endTimeMs,e.pitch,e.volume]),a.useEffect(()=>{o.current&&s.updatePadMetadata(e.id,{name:e.name,color:e.color,bankId:t,bankName:n})},[e.name,e.color,t,n]);const c=s.getPadState(e.id),u=(null==c?void 0:c.isPlaying)||!1,m=(null==c?void 0:c.progress)||0,h=(null==c?void 0:c.effectiveVolume)??e.volume;a.useEffect(()=>{"hold"===e.triggerMode&&i&&!u&&r(!1)},[e.triggerMode,i,u]);const f=a.useCallback(()=>{"undefined"!=typeof window&&(null!==d.current&&window.clearTimeout(d.current),d.current=window.setTimeout(()=>{try{const t=s.getAudioState();"running"!==t.contextState?window.dispatchEvent(new CustomEvent("vdjv-audio-unlock-required",{detail:{contextState:t.contextState,padId:e.id}})):window.dispatchEvent(new Event("vdjv-audio-unlock-restored"))}catch(t){console.warn("Failed to check audio state after play attempt:",t)}},250))},[s,e.id]);a.useEffect(()=>()=>{null!==d.current&&"undefined"!=typeof window&&window.clearTimeout(d.current)},[]);const p=a.useCallback(()=>{const a=()=>{switch(e.triggerMode){case"toggle":s.triggerToggle(e.id);break;case"stutter":s.triggerStutter(e.id);break;case"hold":i||(r(!0),s.triggerHoldStart(e.id));break;case"unmute":s.triggerUnmuteToggle(e.id)}f()};if(!o.current)return e.audioUrl?void s.registerPad(e.id,e,t,n).then(()=>{o.current=!0,l.current=e.id,a()}).catch(t=>{console.warn("Failed late pad registration on play:",e.id,t)}):void console.warn("Trying to play unregistered pad with no audio URL:",e.id);a()},[e.id,e.audioUrl,e.triggerMode,e,t,n,i,s,f]),g=a.useCallback(()=>{o.current&&(s.stopPad(e.id,"instant"),r(!1))},[e.id,s]),b=a.useCallback(()=>{o.current&&(s.stopPad(e.id,"fadeout"),r(!1))},[e.id,s]),v=a.useCallback(()=>{o.current&&(s.stopPad(e.id,"brake"),r(!1))},[e.id,s]),y=a.useCallback(()=>{o.current&&(s.stopPad(e.id,"backspin"),r(!1))},[e.id,s]),_=a.useCallback(()=>{o.current&&(s.stopPad(e.id,"filter"),r(!1))},[e.id,s]),x=a.useCallback(()=>{"hold"===e.triggerMode&&i&&(r(!1),s.triggerHoldStop(e.id))},[e.id,e.triggerMode,i,s]),w=a.useCallback(e=>{s.updatePadSettingsNextPlay(e.id,{name:e.name,color:e.color,imageUrl:e.imageUrl,imageData:e.imageData,startTimeMs:e.startTimeMs,endTimeMs:e.endTimeMs,fadeInMs:e.fadeInMs,fadeOutMs:e.fadeOutMs,pitch:e.pitch,volume:e.volume,triggerMode:e.triggerMode,playbackMode:e.playbackMode})},[s]);return{isPlaying:u,progress:m,effectiveVolume:h,playAudio:p,stopAudio:g,queueNextPlaySettings:w,fadeOutStop:b,brakeStop:v,backspinStop:y,filterStop:_,releaseAudio:x}}(e,t,s,d,c,h),{isPlaying:j,progress:T,effectiveVolume:B,playAudio:P,stopAudio:R,queueNextPlaySettings:D}=I,[O,L]=a.useState(!1),[F,U]=a.useState(!1),[V,$]=a.useState(!1),[H,K]=a.useState(!1),[q,z]=a.useState(!1),G=a.useRef(void 0);a.useEffect(()=>{l&&C&&G.current!==C&&(G.current=C,L(!0))},[l,C]);const X=a.useMemo(()=>e.shortcutKey?e.shortcutKey.startsWith("Numpad")?`Num${e.shortcutKey.replace("Numpad","")}`:ft(e.shortcutKey)||ht(e.shortcutKey)||e.shortcutKey:null,[e.shortcutKey]),W=(null==(E=e.name)?void 0:E.length)||0,Y=W>40?.6:W>30?.7:W>22?.8:W>16?.9:1,J=e.imageUrl&&!H,Q=!J,se=y.filter(e=>e.id!==t);return n.jsxs(n.Fragment,{children:[n.jsxs(Te,{onClick:a=>{a.target.closest(".transfer-indicator")||(N&&A?A(e,t,s):l?L(!0):"toggle"===e.triggerMode?j?R():P():"hold"!==e.triggerMode&&P())},onMouseDown:"hold"!==e.triggerMode||l?void 0:t=>{l||N||t.target.closest(".transfer-indicator")||"hold"===e.triggerMode&&(t.preventDefault(),$(!0),P())},onMouseUp:"hold"!==e.triggerMode||l?void 0:()=>{l||N||"hold"===e.triggerMode&&V&&($(!1),R())},onMouseLeave:"hold"!==e.triggerMode||l?void 0:()=>{l||N||"hold"===e.triggerMode&&V&&($(!1),R())},onTouchStart:"hold"!==e.triggerMode||l?void 0:t=>{l||N||"hold"===e.triggerMode&&(t.preventDefault(),$(!0),P())},onTouchEnd:"hold"!==e.triggerMode||l?void 0:()=>{l||N||"hold"===e.triggerMode&&V&&($(!1),R())},draggable:l,onDragStart:a=>{if(!l)return void a.preventDefault();z(!0),a.dataTransfer.effectAllowed="move";const n={type:"pad-transfer",pad:e,sourceBankId:t};a.dataTransfer.setData("application/json",JSON.stringify(n)),a.dataTransfer.setData("text/plain",JSON.stringify(n)),console.log("Drag started for pad:",e.id,"from bank:",t),b&&b(a,e,t)},onDragEnd:()=>{console.log("Drag ended for pad:",e.id),z(!1)},title:Q?e.name:void 0,className:`\n          w-full h-full min-h-[80px] font-bold border-2 transition-colors duration-150 relative overflow-hidden select-none\n          ${"unmute"===e.triggerMode&&j?"opacity-60":q?"opacity-50":""} ${l?"ring-2 ring-orange-400 cursor-grab active:cursor-grabbing":N?"ring-2 ring-emerald-400 shadow-[0_0_0_2px_rgba(16,185,129,0.35)] cursor-pointer":"cursor-pointer"} \n          ${q?"z-50":""}\n          ${j?"bg-green-400 border-green-300 text-white":"dark"===u?"bg-gray-700 border-gray-600 hover:bg-gray-600 hover:border-gray-500 text-white":"bg-white border-gray-300 hover:bg-gray-100 hover:border-gray-400 text-gray-900"}\n        `,style:{backgroundColor:j?void 0:`${e.color}CC`,...l?{animationDelay:`${Math.random()}s`}:{}},children:[X&&!S&&n.jsx("div",{className:"absolute top-0 left-1/2 -translate-x-1/2 z-20 px-1.5 py-0.5 rounded text-[9px] font-semibold tracking-wide "+("dark"===u?"bg-gray-900/70 text-gray-100":"bg-white/70 text-gray-800"),children:X}),N&&!l&&n.jsx("div",{className:"absolute top-0.5 left-0.5 z-20 px-1.5 py-0.5 rounded text-[9px] font-semibold tracking-wide "+("dark"===u?"bg-emerald-800/80 text-emerald-100":"bg-emerald-200/90 text-emerald-900"),children:"LOAD"}),l&&n.jsx("div",{onClick:e=>{e.stopPropagation(),e.preventDefault(),_&&!_(t)||y.length>1&&U(!0)},className:"transfer-indicator absolute top-0.5 left-0.5 sm:top-1 sm:left-1 p-0.5 sm:p-1 rounded-full transition-all hover:scale-110 z-10 "+(se.length>0&&(!_||_(t))?"bg-orange-500 hover:bg-orange-400 cursor-pointer":"bg-gray-500 cursor-not-allowed"),title:se.length>0&&(!_||_(t))?"Click to transfer to another bank":_&&!_(t)?"Transfers not allowed from this bank":"No other banks available",style:{pointerEvents:"auto"},children:n.jsxs("div",{className:"w-2.5 h-2.5 sm:w-3 sm:h-3 grid grid-cols-2 gap-0.5",children:[n.jsx("div",{className:"w-0.5 h-0.5 sm:w-1 sm:h-1 bg-white rounded-full"}),n.jsx("div",{className:"w-0.5 h-0.5 sm:w-1 sm:h-1 bg-white rounded-full"}),n.jsx("div",{className:"w-0.5 h-0.5 sm:w-1 sm:h-1 bg-white rounded-full"}),n.jsx("div",{className:"w-0.5 h-0.5 sm:w-1 sm:h-1 bg-white rounded-full"})]})}),n.jsx("div",{className:"absolute top-0.5 right-0.5 sm:top-1 sm:right-1 p-0.5 sm:p-1 rounded-full bg-black bg-opacity-20 pointer-events-none z-10",children:n.jsx("div",{className:"w-2.5 h-2.5 sm:w-3 sm:h-3 flex items-center justify-center",children:(()=>{const t="w-2 h-2 sm:w-3 sm:h-3";switch(e.triggerMode){case"toggle":return j?n.jsx(ne,{className:`${t} text-blue-400`}):n.jsx(Z,{className:`${t} text-blue-400`});case"hold":return n.jsx(ae,{className:`${t} text-green-400`});case"stutter":return n.jsx(te,{className:`${t} text-orange-400`});case"unmute":return n.jsx(ee,{className:`${t} text-purple-400`});default:return null}})()})}),n.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full pointer-events-none p-0 sm:p-2 overflow-hidden",children:[J?n.jsx("div",{className:"absolute inset-0 z-0",children:n.jsx("img",{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover rounded object-center",onError:()=>{console.warn("Image failed to load for pad:",e.id,e.name),K(!0)},onLoad:()=>{K(!1)}})}):Q?n.jsx("div",{className:"absolute inset-0 flex items-center justify-center px-0 py-0 w-full h-full overflow-hidden",children:n.jsx("span",{className:"text-center font-bold leading-[1.05] break-words whitespace-normal "+(j||"dark"===u?"text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.9)]":"text-gray-900 drop-shadow-[0_2px_4px_rgba(255,255,255,0.9)]"),style:{fontSize:f<=4?`clamp(${Math.round(12*Y)}px, min(6vw, 6vh, 1.4em), ${Math.round(24*Y)}px)`:f<=8?`clamp(${Math.round(11*Y)}px, min(5vw, 5vh, 1.2em), ${Math.round(20*Y)}px)`:`clamp(${Math.round(10*Y)}px, min(4vw, 4vh, 1.1em), ${Math.round(16*Y)}px)`,padding:"1px 2px",maxWidth:"calc(100% - 4px)",maxHeight:"100%",wordBreak:"break-word",overflowWrap:"break-word",display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%",boxSizing:"border-box"},children:e.name})}):null,!j&&n.jsxs("div",{className:"absolute bottom-0 right-0 opacity-75 whitespace-nowrap z-20 "+("dark"===u?"text-gray-300 drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]":"text-gray-600 drop-shadow-[0_1px_2px_rgba(255,255,255,0.8)]"),style:{fontSize:"clamp(7px, min(2vw, 2vh), 10px)",padding:"1px 2px"},children:[Math.round(100*e.volume),"%"]}),j&&n.jsxs("div",{className:"absolute bottom-0 left-0 right-0 px-0 w-full z-10",children:[n.jsx(Be,{value:T,className:"h-0.5 sm:h-1 rounded-full"}),n.jsxs("div",{className:"absolute bottom-0 right-0 opacity-75 whitespace-nowrap text-white drop-shadow-[0_1px_2px_rgba(0,0,0,0.8)]",style:{fontSize:"clamp(7px, min(2vw, 2vh), 10px)",padding:"1px 2px"},children:[Math.round(100*B),"%"]})]})]})]}),O&&n.jsx(kt,{pad:e,allBanks:i,allPads:r,bankPads:o,open:O,onOpenChange:L,onSave:async a=>{try{await p(t,e.id,a),D(a),L(!1)}catch(n){console.error("Failed to save pad:",n)}},onUnload:()=>{g(e.id),L(!1)},midiEnabled:x,blockedShortcutKeys:w,blockedMidiNotes:k,blockedMidiCCs:M}),F&&n.jsx(Mt,{pad:e,availableBanks:se,open:F,onOpenChange:U,onTransfer:a=>{v&&a!==t&&(console.log("Transferring pad:",e.id,"from:",t,"to:",a),v(e.id,t,a)),U(!1)},theme:u})]})}function Ct({pads:e,bankId:t,bankName:s,allBanks:i,allPads:r,editMode:o,globalMuted:l,masterVolume:d,padSize:c,theme:u,stopMode:m,eqSettings:h,windowWidth:f,onUpdatePad:p,onRemovePad:g,onReorderPads:b,onFileUpload:v,onPadDragStart:y,onTransferPad:_,availableBanks:x=[],canTransferFromBank:w,midiEnabled:k=!1,blockedShortcutKeys:M,blockedMidiNotes:S,blockedMidiCCs:C,hideShortcutLabel:N=!1,editRequest:A=null,channelLoadArmed:E=!1,onSelectPadForChannelLoad:I}){const[j,T]=a.useState(null),[B,P]=a.useState(null),[R,D]=a.useState(!1),[O,L]=a.useState(!1),F=a.useRef(null),U=a.useCallback(e=>{e.preventDefault(),D(!1),L(!1);let a=e.dataTransfer.getData("application/json");if(a||(a=e.dataTransfer.getData("text/plain")),a)try{const e=JSON.parse(a);if("pad-transfer"===e.type&&e.sourceBankId!==t&&_)return void(w&&!w(e.sourceBankId)||(console.log("Grid handling pad transfer:",e.pad.id,"from",e.sourceBankId,"to",t),_(e.pad.id,e.sourceBankId,t)))}catch(n){console.warn("Failed to parse drag data:",n)}if(!v)return;Array.from(e.dataTransfer.files).filter(e=>e.type.startsWith("audio/")).forEach(e=>{try{v(e)}catch(n){console.error("Failed to handle file upload:",n)}})},[v,_,t]),V=a.useCallback(e=>{e.preventDefault();let a=e.dataTransfer.getData("application/json");if(a||(a=e.dataTransfer.getData("text/plain")),a)try{const e=JSON.parse(a);if("pad-transfer"===e.type&&e.sourceBankId!==t)return void(w&&!w(e.sourceBankId)||(L(!0),D(!1)))}catch(n){}D(!0),L(!1)},[t]),$=a.useCallback(e=>{e.currentTarget.contains(e.relatedTarget)||(D(!1),L(!1))},[]),H=a.useCallback(e=>{const t=e.target.files;t&&t.length>0&&v&&Array.from(t).forEach(e=>{if(e.type.startsWith("audio/"))try{v(e)}catch(t){console.error("Failed to handle file upload:",t)}}),F.current&&(F.current.value="")},[v]),K=()=>{var e;E||v&&(null==(e=F.current)||e.click())},q=(e,t,a)=>{console.log("Pad drag start from grid:",t.id,a),y&&y(e,t,a)},z=a.useMemo(()=>[...e].sort((e,t)=>(e.position||0)-(t.position||0)),[e]),G=f<768?"gap-0":"gap-1";if(0===e.length)return n.jsxs(n.Fragment,{children:[n.jsx("input",{ref:F,type:"file",accept:"audio/*",multiple:!0,onChange:H,className:"hidden"}),n.jsx("div",{className:"flex items-center justify-center h-64 rounded-2xl border-2 border-dashed transition-all duration-300 cursor-pointer relative "+(O?"border-orange-400 bg-orange-100 scale-105":R?"border-blue-400 bg-blue-50":"dark"===u?"bg-gray-800 border-gray-600 hover:bg-gray-700":"bg-white border-gray-300 hover:bg-gray-50"),onDrop:U,onDragOver:V,onDragLeave:$,onClick:O?void 0:K,children:O?n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"text-4xl mb-2",children:"üéØ"}),n.jsx("p",{className:"text-lg font-bold text-orange-700",children:"DROP PAD HERE"}),n.jsxs("p",{className:"text-sm text-orange-600",children:["Transfer to ",s]})]}):n.jsxs("div",{className:"text-center",children:[n.jsx("p",{className:"text-lg mb-2 "+("dark"===u?"text-gray-300":"text-gray-700"),children:"No pads loaded"}),n.jsx("p",{className:"text-sm "+("dark"===u?"text-gray-400":"text-gray-600"),children:"Click here or drag audio files to create pads"})]})})]});const X=()=>{o&&(null!==j&&null!==B&&j!==B&&b(j,B),T(null),P(null))},W=()=>{P(null)};return n.jsxs("div",{className:`grid ${G} w-full transition-all duration-200 ${O?"ring-4 ring-orange-400 ring-offset-2 ring-offset-transparent bg-orange-50 dark:bg-orange-900/20 rounded-2xl p-2":E?"ring-2 ring-emerald-300 rounded-2xl p-1 bg-emerald-50/30 dark:bg-emerald-900/15":""}`,style:{gridTemplateColumns:`repeat(${c}, minmax(0, 1fr))`},onDrop:U,onDragOver:V,onDragLeave:$,children:[O&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-50 pointer-events-none",children:n.jsxs("div",{className:"text-center p-4 rounded-xl "+("dark"===u?"bg-orange-900/80 text-orange-200 border border-orange-600":"bg-orange-100/90 text-orange-800 border border-orange-400"),children:[n.jsx("div",{className:"text-3xl mb-2",children:"üéØ"}),n.jsx("p",{className:"font-bold text-lg",children:"DROP PAD HERE"}),n.jsxs("p",{className:"text-sm opacity-75",children:["Transfer to ",s]})]})}),z.map((a,f)=>n.jsx("div",{className:"aspect-square "+(o&&B===f?"ring-2 ring-blue-400":""),draggable:o,onDragStart:e=>((e,t)=>{o&&(T(t),e.dataTransfer.effectAllowed="move")})(e,f),onDragOver:e=>((e,t)=>{o&&null!==j&&(e.preventDefault(),P(t))})(e,f),onDragEnd:X,onDragLeave:W,children:n.jsx(St,{pad:a,bankId:t,bankName:s,allBanks:i,allPads:r,bankPads:e,editMode:o,globalMuted:l,masterVolume:d,theme:u,stopMode:m,eqSettings:h,padSize:c,onUpdatePad:p,onRemovePad:g,onDragStart:q,onTransferPad:_,availableBanks:x,canTransferFromBank:w,midiEnabled:k,blockedShortcutKeys:M,blockedMidiNotes:S,blockedMidiCCs:C,hideShortcutLabel:N,editRequestToken:(null==A?void 0:A.padId)===a.id?A.token:void 0,channelLoadArmed:E,onSelectPadForChannelLoad:I})},a.id))]})}function Nt({open:e,onOpenChange:t,title:a,description:s,progress:i,status:r,type:o,theme:l="light",errorMessage:d,onRetry:c,onLogin:u,etaSeconds:m,statusMessage:h,showWarning:f,hideCloseButton:p=!1,useHistory:g=!0}){const b=d&&(d.toLowerCase().includes("sign in")||d.toLowerCase().includes("login required")||d.toLowerCase().includes("please sign in"));return n.jsxs(Ke,{open:e,onOpenChange:e=>{(e||"loading"!==r)&&t(e)},useHistory:g,children:[n.jsx("style",{children:"\n        @keyframes flow-glow {\n          0% { transform: translateX(-100%); }\n          100% { transform: translateX(100%); }\n        }\n        .animate-flow-glow {\n          animation: flow-glow 1.5s infinite linear;\n        }\n      "}),n.jsxs(Ge,{hideCloseButton:p,className:"sm:max-w-md backdrop-blur-md transition-colors duration-200 "+("dark"===l?"bg-gray-800/95 border-gray-600":"bg-white/95 border-gray-300"),onEscapeKeyDown:e=>{"loading"===r&&e.preventDefault()},onPointerDownOutside:e=>{"loading"===r&&e.preventDefault()},children:[n.jsx(Xe,{children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"w-12 h-12 rounded-full flex items-center justify-center transition-all "+("success"===r?"bg-green-100 dark:bg-green-900/30":"error"===r?"bg-red-100 dark:bg-red-900/30":"bg-blue-100 dark:bg-blue-900/30"),children:"success"===r?n.jsx(re,{className:"w-6 h-6 text-green-500"}):"error"===r?n.jsx(ie,{className:"w-6 h-6 text-red-500"}):"loading"===r&&i<20&&"import"===o?n.jsx(oe,{className:"w-6 h-6 text-blue-500 animate-pulse"}):"export"===o?n.jsx(le,{className:"w-6 h-6 text-blue-500"}):n.jsx(de,{className:"w-6 h-6 text-blue-500"})}),n.jsxs("div",{className:"flex-1",children:[n.jsx(Ye,{className:"dark"===l?"text-white":"text-gray-900",children:a}),"loading"===r&&h&&n.jsx("p",{className:"text-xs mt-1 font-medium "+("dark"===l?"text-blue-300":"text-blue-600"),children:h})]})]})}),n.jsxs("div",{className:"space-y-4",children:[s&&!h&&n.jsx("p",{className:"text-sm "+("dark"===l?"text-gray-300":"text-gray-600"),children:s}),"loading"===r&&n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex justify-between text-sm",children:[n.jsx("span",{className:"dark"===l?"text-gray-300":"text-gray-600",children:"Progress"}),n.jsxs("span",{className:"font-mono "+("dark"===l?"text-white":"text-gray-900"),children:[Math.round(i),"%"]})]}),n.jsxs("div",{className:"relative",children:[n.jsx(Be,{value:i,className:"h-2 overflow-hidden"}),n.jsx("div",{className:"absolute top-0 left-0 h-full overflow-hidden rounded-full pointer-events-none transition-all duration-300 ease-in-out",style:{width:`${i}%`},children:n.jsx("div",{className:"w-full h-full animate-flow-glow bg-gradient-to-r from-transparent via-white/50 to-transparent"})})]}),n.jsx("div",{className:"flex justify-between items-center text-xs mt-1",children:null!=m&&n.jsxs("div",{className:"flex items-center gap-1 "+("dark"===l?"text-gray-400":"text-gray-500"),children:[n.jsx(se,{className:"w-3 h-3"}),n.jsxs("span",{children:["Est. remaining: ",(e=>{if(e===1/0)return"Calculating...";if(e<2)return"Almost there...";if(e<60)return`${Math.ceil(e)}s`;return`${Math.floor(e/60)}m ${Math.ceil(e%60)}s`})(m)]})]})}),f&&n.jsxs("div",{className:"mt-2 p-2 rounded text-xs font-medium flex gap-2 items-start animate-in fade-in slide-in-from-top-1 "+("dark"===l?"bg-amber-900/30 text-amber-200":"bg-amber-50 text-amber-700"),children:[n.jsx(ie,{className:"w-4 h-4 shrink-0"}),n.jsx("p",{children:"It may take longer when verifying. Please wait, don't close the app."})]})]}),"success"===r&&n.jsx("div",{className:"p-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800",children:n.jsx("p",{className:"text-sm text-green-800 dark:text-green-200",children:d&&"success"===r?d:"export"===o?"Bank exported successfully!":"Bank imported successfully!"})}),"error"===r&&n.jsx("div",{className:"p-3 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800",children:n.jsx("p",{className:"text-sm text-red-800 dark:text-red-200",children:d||`Failed to ${o} bank. Please try again.`})}),n.jsx("div",{className:"flex gap-2 pt-2",children:"loading"===r?n.jsx(Te,{onClick:()=>t(!1),variant:"outline",className:"w-full",disabled:!0,children:"Processing..."}):"error"===r&&(b?u:c)?n.jsxs(n.Fragment,{children:[n.jsx(Te,{onClick:b?u:c,variant:"default",className:"flex-1",children:b?"Login":"Retry"}),n.jsx(Te,{onClick:()=>t(!1),variant:"outline",className:"flex-1",children:"Cancel"})]}):n.jsx(Te,{onClick:()=>t(!1),className:"w-full",children:"success"===r?"Done":"Close"})})]})]})]})}const At=a.forwardRef(({className:e,...t},a)=>n.jsx(B,{className:Ie("peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",e),...t,ref:a,children:n.jsx(P,{className:Ie("pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0")})}));At.displayName=B.displayName;const Et="https://bdwtvnvqlgvphxuibqqp.supabase.co",It="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkd3R2bnZxbGd2cGh4dWlicXFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNDU1ODgsImV4cCI6MjA3MTcyMTU4OH0.jhLvdTwUT8TqSctES9o4tmCPGP3Gr1jqMdvclzkXRUk",jt=F(Et,It),Tt=Object.freeze(Object.defineProperty({__proto__:null,supabase:jt,supabaseAnonKey:It,supabaseUrl:Et},Symbol.toStringTag,{value:"Module"})),Bt=new Map,Pt="vdjv-accessible-banks",Rt="vdjv-bank-derived-keys",Dt=864e5,Ot=new Map;function Lt(e,t){if("undefined"==typeof window)return null;try{const a=localStorage.getItem(Pt);if(!a)return null;const n=JSON.parse(a);return n.userId!==e||!(null==t?void 0:t.allowStale)&&Date.now()-n.timestamp>Dt?null:Array.isArray(n.bankIds)?n.bankIds:null}catch{return null}}function Ft(e,t){if("undefined"!=typeof window)try{const a={userId:e,bankIds:t,timestamp:Date.now()};localStorage.setItem(Pt,JSON.stringify(a)),console.log("‚úÖ Cached accessible banks:",t.length)}catch(a){console.warn("Failed to cache accessible banks:",a)}}function Ut(e,t){if("undefined"==typeof window)return null;try{const a=localStorage.getItem(Rt);if(!a)return null;const n=JSON.parse(a);return n.userId!==e||!(null==t?void 0:t.allowStale)&&Date.now()-n.timestamp>Dt?null:n.keys&&"object"==typeof n.keys?n.keys:null}catch{return null}}function Vt(e,t){if("undefined"!=typeof window)try{const a={userId:e,keys:t,timestamp:Date.now()};localStorage.setItem(Rt,JSON.stringify(a))}catch(a){console.warn("Failed to cache bank keys:",a)}}function $t(e,t){if("undefined"!=typeof window)try{const a=localStorage.getItem(Rt);if(!a)return;const n=JSON.parse(a);if(n.userId!==e)return;if(!n.keys[t])return;delete n.keys[t],n.timestamp=Date.now(),localStorage.setItem(Rt,JSON.stringify(n))}catch(a){console.warn("Failed to remove cached bank key:",a)}}async function Ht(e){const t=e+"vdjv-sampler-secret-2024",a=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}async function Kt(e,t){const a=await e.generateAsync({type:"blob"}),n=(new TextEncoder).encode(t),s=await zt(a,n,"application/octet-stream");if(s)return s;const i=await a.arrayBuffer(),r=new Uint8Array(i);for(let o=0;o<r.length;o++)r[o]^=n[o%n.length];return new Blob([r],{type:"application/octet-stream"})}async function qt(e,t){const a=(new TextEncoder).encode(t),n=await zt(e,a,"application/zip");if(n)return n;const s=await e.arrayBuffer(),i=new Uint8Array(s);for(let r=0;r<i.length;r++)i[r]^=a[r%a.length];return new Blob([i],{type:"application/zip"})}async function zt(e,t,a){try{const n=1048576,s=8,i=[];let r=0,o=0;for(;r<e.size;){const a=Math.min(e.size,r+n),l=new Uint8Array(await e.slice(r,a).arrayBuffer());if(0===l.length)break;const d=new Uint8Array(l.length);for(let e=0;e<l.length;e++)d[e]=l[e]^t[(r+e)%t.length];r=a,i.push(d),o+=1,o%s===0&&await new Promise(e=>setTimeout(e,0))}return new Blob(i,{type:a})}catch{return null}}async function Gt(e,t){try{const a=e.slice(0,8),n=await a.arrayBuffer(),s=new Uint8Array(n),i=(new TextEncoder).encode(t);for(let e=0;e<s.length;e++)s[e]^=i[e%i.length];const r=s[0],o=s[1],l=s[2],d=s[3];return 80===r&&75===o&&(3===l&&4===d||5===l&&6===d||7===l&&8===d)}catch(a){return!1}}async function Xt(e,t){const a=`${t}-${e}`,n="undefined"==typeof navigator||navigator.onLine;let s=!n;try{if(n){const{data:n,error:i}=await jt.from("user_bank_access").select("id").eq("user_id",t).eq("bank_id",e).maybeSingle();if(i)s=!0;else if(!n)return Bt.delete(a),$t(t,e),null;const{data:r,error:o}=await jt.from("banks").select("derived_key").eq("id",e).maybeSingle();if(o)s=!0;else if(!(null==r?void 0:r.derived_key))return Bt.delete(a),$t(t,e),null;if(null==r?void 0:r.derived_key)return Bt.set(a,r.derived_key),function(e,t,a){if("undefined"!=typeof window)try{let n;const s=localStorage.getItem(Rt);s?(n=JSON.parse(s),n.userId===e?(n.keys[t]=a,n.timestamp=Date.now()):n={userId:e,keys:{[t]:a},timestamp:Date.now()}):n={userId:e,keys:{[t]:a},timestamp:Date.now()},localStorage.setItem(Rt,JSON.stringify(n))}catch(n){console.warn("Failed to add to cached bank keys:",n)}}(t,e,r.derived_key),r.derived_key}}catch(r){s=!0,console.error("Error getting derived key:",r)}if(Bt.has(a))return Bt.get(a);const i=Ut(t,{allowStale:s});if(i&&i[e]){const t=i[e];return Bt.set(a,t),t}return null}function Wt(e,t){e.file("metadata.json",JSON.stringify(t,null,2))}function Yt(e){const t=e.match(/[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/);return t?t[0]:null}async function Zt(e){try{if(!("undefined"==typeof navigator||navigator.onLine))return;const{data:t,error:a}=await jt.from("user_bank_access").select("bank_id").eq("user_id",e);if(a||!t)return void console.warn("Failed to fetch accessible banks:",a);const n=t.map(e=>e.bank_id);Ft(e,n),Jt(e,n);const s={};for(const i of n){const{data:t,error:a}=await jt.from("banks").select("derived_key").eq("id",i).maybeSingle();!a&&(null==t?void 0:t.derived_key)&&(s[i]=t.derived_key,Bt.set(`${e}-${i}`,t.derived_key))}Object.keys(s).length>0?Vt(e,s):Vt(e,{})}catch(t){console.error("Error refreshing accessible banks cache:",t)}}function Jt(e,t){if("undefined"==typeof window)return;const a=new Set(t),n=[];for(const r of Bt.keys()){if(!r.startsWith(`${e}-`))continue;const t=r.slice(e.length+1);a.has(t)||n.push(r)}n.forEach(e=>Bt.delete(e));const s=Ut(e)||{},i={};Object.entries(s).forEach(([e,t])=>{a.has(e)&&(i[e]=t)}),Vt(e,i),Ft(e,t)}function Qt(e){if("undefined"!=typeof window)try{if(!e)return localStorage.removeItem(Pt),localStorage.removeItem(Rt),void Bt.clear();Lt(e)&&localStorage.removeItem(Pt);Ut(e)&&localStorage.removeItem(Rt);for(const t of Bt.keys())t.startsWith(`${e}-`)&&Bt.delete(t)}catch(t){console.warn("Failed clearing user bank cache:",t)}}function ea(e){return e.filter(e=>!function(e){var t;const a=null==(t=e.bankMetadata)?void 0:t.bankId;return Boolean(e.isAdminBank||a||e.sourceBankId)}(e))}const ta={},aa=null==ta?void 0:ta.VITE_EDGE_FUNCTIONS_URL,na=(aa&&aa.trim().length>0?aa:`${Et}/functions/v1`).replace(/\/+$/,"");const sa=(e,t="")=>{const a=t?`/${(e=>e.replace(/^\/+/,""))(t)}`:"";return`${na}/${e}${a}`},ia=async(e=!1)=>{const t={},a=await(async()=>{var e;const{data:t}=await jt.auth.getSession();return(null==(e=t.session)?void 0:e.access_token)||null})();if(a&&(t.Authorization=`Bearer ${a}`),e&&!a)throw new Error("Not authenticated");return t},ra="vdjv-activity-queue",oa="vdjv-session-key",la="vdjv-device-session-id",da="undefined"!=typeof window;let ca=!1,ua=!1,ma=null,ha=null;const fa=e=>Boolean(null==e?void 0:e.Authorization),pa=()=>da?"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}):"00000000-0000-4000-8000-000000000000",ga=()=>{if(!da)return pa();try{const e=sessionStorage.getItem(oa);if(e)return e;const t=pa();return sessionStorage.setItem(oa,t),t}catch{return pa()}},ba=()=>{if(!da)return pa();try{const e=localStorage.getItem(la);if(e)return e;const t=pa();return localStorage.setItem(la,t),t}catch{return pa()}},va=()=>{if(!da)return[];const e=((e,t)=>{if(!e)return t;try{return JSON.parse(e)}catch{return t}})(localStorage.getItem(ra),[]);if(!Array.isArray(e))return[];const t=[];for(const a of e){const e=String((null==a?void 0:a.endpoint)||""),n="event"===e||"/api/activity/event"===e?"event":"signout"===e||"/api/activity/signout"===e?"signout":null;n&&t.push({endpoint:n,payload:(null==a?void 0:a.payload)&&"object"==typeof a.payload?a.payload:{}})}return t},ya=e=>{if(da)try{if(0===e.length)return void localStorage.removeItem(ra);localStorage.setItem(ra,JSON.stringify(e))}catch(t){console.warn("Failed to persist activity queue:",t)}},_a=e=>{const t=va();t.push(e),t.length>1e3&&t.splice(0,t.length-1e3),ya(t)},xa=(e,t)=>{const a=`${e} ${t}`.toLowerCase();return a.includes("edg/")?"Edge":a.includes("opr/")||a.includes("opera")?"Opera":a.includes("chrome/")||a.includes("chromium")?"Chrome":a.includes("firefox/")?"Firefox":a.includes("safari/")&&!a.includes("chrome/")?"Safari":"Unknown"},wa=(e,t)=>{const a=e.toLowerCase(),n=t.toLowerCase();return a.includes("windows")||n.includes("win")?"Windows":a.includes("android")?"Android":a.includes("iphone")||a.includes("ipad")||a.includes("ios")?"iOS":a.includes("mac os")||n.includes("mac")?"macOS":a.includes("linux")||n.includes("linux")?"Linux":t||"Unknown"},ka=(e,t,a)=>t||(/iPad/i.test(a)?"iPad":/iPhone/i.test(a)?"iPhone":/Android/i.test(a)?"Android Device":/Macintosh|Mac OS X/i.test(a)?"Mac":/Windows NT/i.test(a)?"Windows PC":/Linux/i.test(a)?"Linux Device":e||"Unknown Device"),Ma=async()=>da?ma||(ha||(ha=(async()=>{var e,t;const a=navigator.userAgent||"",n=navigator,s=n.userAgentData,i=(Array.isArray(null==s?void 0:s.brands)?s.brands:[]).map(e=>`${e.brand}/${e.version}`).join(", "),r=String((null==s?void 0:s.platform)||navigator.platform||"unknown");let o="",l="",d="";try{if(null==s?void 0:s.getHighEntropyValues){const e=await s.getHighEntropyValues(["model","platformVersion","architecture"]);o=String((null==e?void 0:e.model)||""),l=String((null==e?void 0:e.platformVersion)||""),d=String((null==e?void 0:e.architecture)||"")}}catch{}const c=Intl.DateTimeFormat().resolvedOptions().timeZone||"unknown",u=navigator.language||"unknown",m=(null==(e=window.screen)?void 0:e.width)||0,h=(null==(t=window.screen)?void 0:t.height)||0,f=Number(window.devicePixelRatio||1),p=Number(navigator.hardwareConcurrency||0),g=Number(n.deviceMemory||0),b=xa(a,i),v=wa(a,r),y=ka(r,o,a),_=JSON.stringify({ua:a,brands:i,platform:r,platformVersion:l,architecture:d,model:o,language:u,timezone:c,screen:`${m}x${h}`,dpr:f,hardwareConcurrency:p,deviceMemory:g,mobile:Boolean(null==s?void 0:s.mobile)}),x={fingerprint:await(async e=>{try{if("undefined"==typeof crypto||!crypto.subtle)return btoa(e).replace(/=/g,"").slice(0,64);const t=(new TextEncoder).encode(e),a=await crypto.subtle.digest("SHA-256",t),n=new Uint8Array(a);return Array.from(n).map(e=>e.toString(16).padStart(2,"0")).join("")}catch{return btoa(e).replace(/=/g,"").slice(0,64)}})(_),name:y,model:o,platform:r,browser:b,os:v,raw:{mobile:Boolean(null==s?void 0:s.mobile),platformVersion:l,architecture:d,timezone:c,language:u,screenWidth:m,screenHeight:h,dpr:f,hardwareConcurrency:p,deviceMemory:g}};return ma=x,x})(),ha)):(()=>{if(!da)return{fingerprint:"server",name:"unknown",model:"unknown",platform:"unknown",browser:"unknown",os:"unknown",raw:{}};const e=navigator.userAgent||"",t=navigator.platform||"unknown",a=xa(e,""),n=wa(e,t);return{fingerprint:"pending",name:ka(t,"",e),model:"",platform:t,browser:a,os:n,raw:{}}})(),Sa=async(e,t,a)=>{const n=e.endsWith("/event"),s=a??await ia(!1),i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",...s},body:JSON.stringify(t),keepalive:!n,credentials:"omit"});if(409===i.status){let e={};try{e=await i.json()}catch{e={}}if("SESSION_CONFLICT"===(null==e?void 0:e.code)||!0===(null==e?void 0:e.invalidate))throw new Ca((null==e?void 0:e.message)||"Session conflict detected.")}if(!i.ok){const e=await i.text().catch(()=>"");throw new Error(`HTTP ${i.status}: ${e||"request failed"}`)}};class Ca extends Error{constructor(e="Session conflict detected."){super(e),t(this,"code","SESSION_CONFLICT"),this.name="SessionConflictError"}}const Na=async(e,t)=>{if(!da)return;const a=await ia(!1);if(!fa(a)){return void(("string"==typeof t.userId?t.userId:"")&&_a({endpoint:e,payload:t}))}if(navigator.onLine)try{await Sa(sa("activity-api",e),t,a)}catch(n){const a=String((null==n?void 0:n.message)||"");if(a.includes("HTTP 5")||a.includes("HTTP 429")||a.includes("HTTP 401")||a.includes("Not authenticated")||a.includes("Failed to fetch")||a.includes("NetworkError"))return void _a({endpoint:e,payload:t});throw n}else _a({endpoint:e,payload:t})},Aa=()=>{if(!da||ca)return;ca=!0,Ma().catch(()=>{});const e=()=>{(async()=>{if(!da||ua||!navigator.onLine)return;const e=va();if(e.length){ua=!0;try{const a=await ia(!1);if(!fa(a))return;const n=[];for(const s of e)try{await Sa(sa("activity-api",s.endpoint),s.payload,a)}catch(t){const e=String((null==t?void 0:t.message)||"");e.includes("HTTP 5")||e.includes("HTTP 429")||e.includes("HTTP 401")||e.includes("Not authenticated")||e.includes("Failed to fetch")||e.includes("NetworkError")?n.push(s):console.warn("Dropping non-retriable queued activity item:",e)}ya(n)}finally{ua=!1}}})()};window.addEventListener("online",e),window.addEventListener("focus",e),navigator.onLine&&e()},Ea=async e=>{const t=await Ma();return{requestId:e.requestId||pa(),eventType:e.eventType,status:e.status,userId:e.userId||null,email:e.email||null,sessionKey:ga(),deviceSessionId:ba(),device:t,bankId:e.bankId||null,bankName:e.bankName||null,padCount:"number"==typeof e.padCount?e.padCount:null,padNames:Array.isArray(e.padNames)?e.padNames:[],errorMessage:e.errorMessage||null,meta:e.meta||{}}},Ia=async e=>{Aa();const t=await Ea(e);await Na("event",t)},ja=async e=>{Aa();const t=await Ea({eventType:"auth.signout",status:e.status,userId:e.userId,email:e.email,errorMessage:e.errorMessage,meta:e.meta});await Na("signout",t)},Ta=async e=>{if(!da||!e.userId||!navigator.onLine)return;const t=await ia(!1);if(!fa(t))return;const a=await Ma();await Sa(sa("activity-api","session-check"),{sessionKey:ga(),deviceSessionId:ba(),userId:e.userId,email:e.email||null,device:a,lastEvent:e.lastEvent||"session-check",meta:e.meta||{}},t)},Ba="vdjv-cached-user",Pa="vdjv-cached-profile",Ra="vdjv-cached-ban",Da="vdjv-offline-signout-pending",Oa="vdjv-session-conflict-reason",La="vdjv-hide-protected-banks";function Fa(){if("undefined"==typeof window)return null;try{const e=localStorage.getItem(Ba);return e?JSON.parse(e):null}catch{return null}}function Ua(){if("undefined"==typeof window)return null;try{const e=localStorage.getItem(Pa);return e?JSON.parse(e):null}catch{return null}}function Va(){if("undefined"==typeof window)return!1;try{const e=localStorage.getItem(Ra);return"1"===e||"true"===e}catch{return!1}}function $a(e,t){if("undefined"!=typeof window)try{e?localStorage.setItem(Ba,JSON.stringify(e)):localStorage.removeItem(Ba),t?localStorage.setItem(Pa,JSON.stringify(t)):localStorage.removeItem(Pa)}catch(a){console.warn("Failed to cache user data:",a)}}function Ha(e){if("undefined"!=typeof window)try{e?localStorage.setItem(Ra,"1"):localStorage.removeItem(Ra)}catch(t){console.warn("Failed to cache ban state:",t)}}const Ka=a.createContext(null),qa=e=>{if("undefined"!=typeof window)try{e?localStorage.setItem(Da,"1"):localStorage.removeItem(Da)}catch(t){console.warn("Failed to persist offline signout flag:",t)}},za=()=>{if("undefined"==typeof window)return null;try{return localStorage.getItem(Oa)}catch{return null}},Ga=e=>{if("undefined"!=typeof window)try{localStorage.setItem("vdjv-session-enforcement-event",JSON.stringify({reason:e,ts:Date.now()}))}catch(t){console.warn("Failed to emit session enforcement event:",t)}},Xa=e=>{if("undefined"!=typeof window)try{e?localStorage.setItem(La,"1"):localStorage.removeItem(La)}catch(t){console.warn("Failed to persist protected bank visibility lock:",t)}};function Wa(e){if(!e)return!1;const t=(e.message||"").toLowerCase(),a=(e.code||"").toLowerCase(),n=e.status;return t.includes("banned")||t.includes("ban")||t.includes("suspended")||a.includes("banned")||a.includes("suspended")||403===n}function Ya(e){if(!e)return!1;if(401===e.status||403===e.status)return!1;if(0===e.status)return!0;if("undefined"!=typeof navigator&&!navigator.onLine)return!0;const t=`${e.name||""} ${e.code||""} ${e.message||""}`.toLowerCase();return t.includes("failed to fetch")||t.includes("fetch failed")||t.includes("networkerror")||t.includes("network request failed")||t.includes("load failed")||t.includes("timeout")||t.includes("aborterror")}function Za(){var e,t,n,s,i;const r=Va(),o=r?null:Fa(),l=r?null:Ua(),[d,c]=a.useState({user:o,profile:l,loading:!0,isPasswordRecovery:!1,redirectError:null,sessionConflictReason:za(),banned:r}),u=a.useRef(null),m=a.useRef(!1);a.useEffect(()=>{Aa()},[]);const h=a.useCallback(e=>{Ha(e),c(t=>t.banned===e?t:{...t,banned:e})},[]),f=a.useCallback(e=>{(e=>{if("undefined"!=typeof window)try{e?localStorage.setItem(Oa,e):localStorage.removeItem(Oa)}catch(t){console.warn("Failed to persist session conflict reason:",t)}})(e),c(t=>t.sessionConflictReason===e?t:{...t,sessionConflictReason:e})},[]),p=a.useCallback(async()=>{Ha(!0),Xa(!0),$a(null,null),Qt(),u.current=null,c(e=>({...e,user:null,profile:null,loading:!1,isPasswordRecovery:!1,banned:!0}));try{await jt.auth.signOut({scope:"global"})}catch(e){console.warn("Failed to sign out banned user:",e)}},[]),g=a.useCallback(async e=>{if(m.current)return;m.current=!0;const t=e||"This account was used on another device. You were signed out on this device.",a=d.user||Fa();qa(!1),Xa(!0),f(t),Ga(t),$a(null,null),Qt(null==a?void 0:a.id),u.current=null,c(e=>({...e,user:null,profile:null,loading:!1,isPasswordRecovery:!1}));try{await jt.auth.signOut({scope:"local"})}catch(n){console.warn("Failed local signout after session conflict:",n)}},[f,d.user]),b=a.useCallback(async e=>{var t,a;const{data:n,error:s}=await jt.from("profiles").select("id, display_name, role").eq("id",e.id).maybeSingle();if(s)return console.error("Error checking profile:",s),null;if(n)return n;const i=(null==(t=e.user_metadata)?void 0:t.display_name)||(null==(a=e.email)?void 0:a.split("@")[0])||"User",{data:r,error:o}=await jt.from("profiles").upsert({id:e.id,display_name:i,role:"user"},{onConflict:"id"}).select("*").single();return o?(console.error("Error creating profile:",o),null):r},[]);a.useEffect(()=>{if(Va()&&jt.auth.signOut({scope:"global"}).catch(e=>{console.warn("Failed to sign out banned user:",e)}),"undefined"!=typeof window&&window.location.hash){const e=function(e){const t=e.replace(/^#/,""),a=new URLSearchParams(t),n={};return a.forEach((e,t)=>n[t]=e),n}(window.location.hash),t=e.error,a=e.error_code,n=e.error_description;(t||a)&&(c(e=>({...e,redirectError:{code:a||t||"unknown_error",description:decodeURIComponent(n||"There was a problem handling the link.")}})),history.replaceState(null,"",window.location.pathname+window.location.search))}const e=async e=>{if(m.current)return $a(null,null),Qt(),u.current=null,void c(e=>({...e,user:null,profile:null,loading:!1}));if(null==e?void 0:e.user){const{data:t,error:a}=await jt.auth.getUser(),n=Ya(a),s=Fa()||e.user,i=(null==t?void 0:t.user)||(n?s:null);if(!i||401===(null==a?void 0:a.status)||403===(null==a?void 0:a.status))return $a(null,null),Qt(),u.current=null,void c(e=>({...e,user:null,profile:null,loading:!1}));if(function(e){var t,a;if(!e)return!1;const n=e.banned_until||(null==(t=e.app_metadata)?void 0:t.banned_until)||(null==(a=e.user_metadata)?void 0:a.banned_until);if(!n)return!1;const s=new Date(n);return!Number.isNaN(s.getTime())&&s>new Date}(i))return void(await p());if(Wa(a))return void(await p());a?n?console.warn("Using cached auth state due transient auth validation failure:",a):console.warn("Failed to validate auth user:",a):h(!1),Xa(!1),f(null);const{data:r,error:o}=await jt.from("profiles").select("*").eq("id",i.id).maybeSingle();if(o)if(Ya(o)){const e=Ua();$a(i,e),c(t=>({...t,user:i,profile:e,loading:!1}))}else console.warn("Profile lookup failed, clearing local auth state:",o),$a(null,null),Qt(),u.current=null,c(e=>({...e,user:null,profile:null,loading:!1}));else{const e=r||await b(i);$a(i,e),c(t=>({...t,user:i,profile:e,loading:!1}))}u.current!==i.id&&(u.current=i.id,Zt(i.id).catch(console.warn))}else $a(null,null),Xa(!0),Qt(),u.current=null,c(e=>({...e,user:null,profile:null,loading:!1}))};jt.auth.getSession().then(({data:{session:t}})=>{e(t)});const{data:{subscription:t}}=jt.auth.onAuthStateChange((t,a)=>{const n="PASSWORD_RECOVERY"===t;c(e=>({...e,isPasswordRecovery:n})),e(a)});return()=>t.unsubscribe()},[b,p,h,f]),a.useEffect(()=>{if(!d.user||d.banned)return;const e=()=>{(async e=>{if(!da||!e.userId)return;if(!navigator.onLine)return;Aa();const t=await ia(!1);if(!fa(t))return;const a=await Ma(),n={sessionKey:ga(),deviceSessionId:ba(),userId:e.userId,email:e.email||null,device:a,lastEvent:e.lastEvent||"heartbeat",meta:e.meta||{}};await Sa(sa("activity-api","heartbeat"),n,t)})({userId:d.user.id,email:d.user.email||null,lastEvent:"heartbeat",meta:{visibility:"undefined"!=typeof document?document.visibilityState:"unknown"}}).catch(e=>{if(e instanceof Ca)return void g(e.message);const t=String((null==e?void 0:e.message)||e||"");t.includes("Failed to fetch")||t.includes("NetworkError")||t.includes("Load failed")||t.includes("TypeError: Failed to fetch")||console.warn("Heartbeat failed:",e)})};Ta({userId:d.user.id,email:d.user.email||null,lastEvent:"startup-check",meta:{visibility:"undefined"!=typeof document?document.visibilityState:"unknown"}}).catch(e=>{e instanceof Ca&&g(e.message)}),e();const t=window.setInterval(e,6e4),a=()=>{"visible"===document.visibilityState&&(e(),Ta({userId:d.user.id,email:d.user.email||null,lastEvent:"visibility-check",meta:{visibility:document.visibilityState}}).catch(e=>{e instanceof Ca&&g(e.message)}))},n=()=>{var e,t;null==(e=d.user)||e.id,null==(t=d.user)||t.email};return document.addEventListener("visibilitychange",a),window.addEventListener("pagehide",n),window.addEventListener("beforeunload",n),()=>{window.clearInterval(t),document.removeEventListener("visibilitychange",a),window.removeEventListener("pagehide",n),window.removeEventListener("beforeunload",n)}},[null==(e=d.user)?void 0:e.id,null==(t=d.user)?void 0:t.email,d.banned,g]),a.useEffect(()=>{if(!d.user||d.banned)return;const e=()=>{Ta({userId:d.user.id,email:d.user.email||null,lastEvent:"reconnect-check",meta:{visibility:"undefined"!=typeof document?document.visibilityState:"unknown"}}).catch(e=>{e instanceof Ca&&g(e.message)}),Zt(d.user.id).catch(console.warn)};return window.addEventListener("online",e),()=>window.removeEventListener("online",e)},[null==(n=d.user)?void 0:n.id,null==(s=d.user)?void 0:s.email,d.banned,g]),a.useEffect(()=>{if(!d.user||d.banned)return;if(!(()=>{if("undefined"==typeof window)return!1;try{return"1"===localStorage.getItem(Da)}catch{return!1}})())return;if("undefined"!=typeof navigator&&!navigator.onLine)return;const e=d.user;(async()=>{const{error:t}=await jt.auth.signOut();$a(null,null),Xa(!0),Qt(e.id),qa(!1),c(e=>({...e,user:null,profile:null,loading:!1})),ja({status:t?"failed":"success",userId:e.id,email:e.email||null,errorMessage:(null==t?void 0:t.message)||null,meta:{source:"useAuth.signOut.offline-finalize"}}).catch(e=>{console.warn("Failed to log deferred signout activity:",e)}),Ga("deferred-signout-finalized")})()},[null==(i=d.user)?void 0:i.id,d.banned]);const v=a.useCallback(async(e,t)=>{f(null),m.current=!1;const{data:a,error:n}=await jt.auth.signInWithPassword({email:e,password:t});return!n&&(null==a?void 0:a.user)&&Xa(!1),Wa(n)&&await p(),{error:n,data:{user:a.user}}},[p,f]),y=a.useCallback(async(e,t,a)=>{const{data:n,error:s}=await jt.auth.signUp({email:e,password:t,options:{data:{display_name:a},emailRedirectTo:`${window.location.origin}${window.location.pathname}`}});return{error:s,data:n}},[]),_=a.useCallback(async()=>{const e=d.user||Fa();if("undefined"!=typeof navigator&&!navigator.onLine)return qa(!0),Xa(!0),ja({status:"success",userId:(null==e?void 0:e.id)||null,email:(null==e?void 0:e.email)||null,meta:{source:"useAuth.signOut.offline-deferred",deferred:!0}}).catch(e=>{console.warn("Failed to queue deferred signout activity:",e)}),{error:null};const{error:t}=await jt.auth.signOut();return qa(!1),Xa(!0),$a(null,null),Qt(null==e?void 0:e.id),ja({status:t?"failed":"success",userId:(null==e?void 0:e.id)||null,email:(null==e?void 0:e.email)||null,errorMessage:(null==t?void 0:t.message)||null,meta:{source:"useAuth.signOut"}}).catch(e=>{console.warn("Failed to log signout activity:",e)}),{error:t}},[d.user]),x=a.useCallback(async e=>{try{const t=`password_reset_${e}`,a=localStorage.getItem(t),n=Date.now(),s=3e5;if(a&&n-parseInt(a)<s){const e=Math.ceil((s-(n-parseInt(a)))/1e3/60);return{error:{message:`Please wait ${e} minute${e>1?"s":""} before requesting another reset.`}}}localStorage.setItem(t,n.toString());const{error:i}=await jt.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}${window.location.pathname}`});return i?(localStorage.removeItem(t),i.message.includes("User not found")||i.message.includes("No user found")||i.message.includes("Invalid email")?{error:{message:"No account found with this email address."}}:{error:i}):{error:null}}catch(t){return console.error("Password reset error:",t),{error:{message:"Failed to send reset email. Please try again."}}}},[]),w=a.useCallback(async e=>{const{error:t}=await jt.auth.updateUser({password:e});return t||c(e=>({...e,isPasswordRecovery:!1})),{error:t}},[]),k=a.useCallback(()=>{c(e=>({...e,redirectError:null}))},[]),M=a.useCallback(()=>{f(null)},[f]);return{...d,signIn:v,signUp:y,signOut:_,requestPasswordReset:x,updatePassword:w,clearRedirectError:k,clearSessionConflictReason:M}}function Ja({children:e}){const t=Za();return a.createElement(Ka.Provider,{value:t},e)}function Qa(){const e=a.useContext(Ka);if(!e)throw new Error("useAuth must be used within AuthProvider");return e}const en=e=>{const t=e.replace("#","");if(6!==t.length)return"#ffffff";return(.299*parseInt(t.slice(0,2),16)+.587*parseInt(t.slice(2,4),16)+.114*parseInt(t.slice(4,6),16))/255>.6?"#000000":"#ffffff"},tn=["Dim Gray","Gray","White","Red","Amber","Orange","Light Yellow","Yellow","Green","Aqua","Blue","Pure Blue","Violet","Purple","Hot Pink","Hot Pink 2","Deep Magenta","Deep Brown 2"].map(e=>bt.find(t=>t.name===e)).filter(Boolean).map(e=>({label:e.name,value:e.hex,textColor:en(e.hex)}));function an({bank:e,allBanks:t,allPads:s,open:i,onOpenChange:r,theme:o,onSave:l,onDelete:d,onExport:c,onClearPadShortcuts:u,onClearPadMidi:m,onExportAdmin:h,midiEnabled:f=!1,blockedShortcutKeys:p,blockedMidiNotes:g,blockedMidiCCs:b}){var v,y;const _="undefined"!=typeof navigator&&/Mac|iPhone|iPad|iPod/.test(navigator.userAgent),{profile:x}=Qa(),[w,k]=a.useState(e.name),[M,S]=a.useState(e.defaultColor),[C,N]=a.useState(e.shortcutKey||""),[A,E]=a.useState(null),[I,j]=a.useState(null),[T,B]=a.useState(e.midiNote),[P,R]=a.useState(e.midiCC),[D,O]=a.useState(!1),[L,F]=a.useState(!1),[U,V]=a.useState(!1),[$,H]=a.useState(e.name),[K,q]=a.useState(""),[z,G]=a.useState(!1),[X,Y]=a.useState(!1),[Z,J]=a.useState(!1),[Q,ee]=a.useState(!1),[te,ae]=a.useState(0),[ne,se]=a.useState("loading"),[ie,re]=a.useState("");a.useEffect(()=>{i&&(k(e.name),S(e.defaultColor),N(e.shortcutKey||""),E(null),B(e.midiNote),R(e.midiCC),O(!1),j(null),H(e.name),q(""),G(!1),Y(!1),J(!0))},[i,e]);const oe=a.useCallback(e=>{if(!e)return null;if(!e.includes("+"))return ht(e)||e;const t=e.split("+").map(e=>e.trim()).filter(Boolean),a=new Set;let n="";t.forEach(e=>{const t=e.toLowerCase();"shift"===t?a.add("shift"):"ctrl"===t||"control"===t?a.add("ctrl"):"alt"===t||"option"===t?a.add("alt"):"meta"===t||"cmd"===t||"command"===t||"win"===t?a.add("meta"):n=e});const s=ht(n)||n;if(_){const e={meta:"‚åò",ctrl:"‚åÉ",alt:"‚å•",shift:"‚áß"};return`${["meta","ctrl","alt","shift"].filter(e=>a.has(e)).map(t=>e[t]).join("")}${s}`}const i={ctrl:"Ctrl",alt:"Alt",shift:"Shift",meta:"Meta"};return[...["ctrl","alt","shift","meta"].filter(e=>a.has(e)).map(e=>i[e]),s].filter(Boolean).join("+")},[_]);a.useEffect(()=>{if(!D)return;const a=a=>{const n=a.detail;if(n){if("noteon"===n.type){if(null==g?void 0:g.has(n.note))return j("That MIDI note is already assigned."),void O(!1);const a=t.find(t=>{if(t.id===e.id)return!1;const a=t.midiNote;return"number"==typeof a&&a===n.note});if(a)return j(`That MIDI note is already assigned to bank "${a.name}".`),void O(!1);const i=s.find(e=>"number"==typeof e.midiNote&&e.midiNote===n.note);if(i)return j(`That MIDI note is already assigned to pad "${i.name}".`),void O(!1);B(n.note)}else{if("cc"!==n.type)return;{if(null==b?void 0:b.has(n.cc))return j("That MIDI CC is already assigned."),void O(!1);const a=t.find(t=>{if(t.id===e.id)return!1;const a=t.midiCC;return"number"==typeof a&&a===n.cc});if(a)return j(`That MIDI CC is already assigned to bank "${a.name}".`),void O(!1);const i=s.find(e=>"number"==typeof e.midiCC&&e.midiCC===n.cc);if(i)return j(`That MIDI CC is already assigned to pad "${i.name}".`),void O(!1);R(n.cc)}}O(!1)}};return window.addEventListener("vdjv-midi",a),()=>window.removeEventListener("vdjv-midi",a)},[D,t,s,e,g,b]);const de=async()=>{if(h){ee(!0),se("loading"),ae(0),re("");try{const t=await h(e.id,$,K,z,X,Z,e=>{ae(e)});se("success"),re(t||"")}catch(t){console.error("Admin export failed:",t),se("error"),re(t instanceof Error?t.message:"Admin export failed")}}},ue="admin"===(null==x?void 0:x.role),me=Boolean(null==(v=e.bankMetadata)?void 0:v.bankId),he=a=>{if(!a)return N(""),void E(null);if(pt(a))return void E(`"${a}" is reserved for global controls.`);if(null==p?void 0:p.has(a))return void E(`"${a}" is already assigned to system or channel mapping.`);const n=t.find(t=>{if(t.id===e.id)return!1;return ft(t.shortcutKey)===a});if(n)return void E(`"${a}" is already assigned to bank "${n.name}".`);const i=s.find(e=>ft(e.shortcutKey)===a);i?E(`"${a}" is already assigned to pad "${i.name}".`):(j(null),N(a),E(null))},fe=ut.join(", "),pe=a.useMemo(()=>e.pads.map(e=>({name:e.name,key:e.shortcutKey?oe(e.shortcutKey):null,midi:"number"==typeof e.midiNote?`Note ${e.midiNote}`:"number"==typeof e.midiCC?`CC ${e.midiCC}`:null})).filter(e=>!!e.key||!!e.midi),[e.pads,oe]);return n.jsxs(n.Fragment,{children:[n.jsx(Ke,{open:i,onOpenChange:r,children:n.jsxs(Ge,{className:"sm:max-w-md backdrop-blur-md "+("dark"===o?"bg-gray-800/90":"bg-white/90"),"aria-describedby":void 0,children:[n.jsx(Xe,{children:n.jsx(Ye,{children:"Edit Bank"})}),n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{children:"Bank Color"}),n.jsx("div",{className:"flex gap-1 flex-wrap",children:tn.map(e=>n.jsx("button",{onClick:()=>S(e.value),className:"w-6 h-6 rounded-full border-2 transition-all "+(M===e.value?"border-white scale-110 shadow-lg":"border-gray-400"),style:{backgroundColor:e.value,color:e.textColor},title:e.label},e.value))})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"name",children:"Bank Name"}),n.jsx(Je,{id:"name",value:w,onChange:e=>{e.target.value.length<=18&&k(e.target.value)},placeholder:"Enter bank name",className:"backdrop-blur-sm",maxLength:24,autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",onFocus:e=>{window.innerWidth<=768&&setTimeout(()=>e.target.focus(),100)}})]}),n.jsxs("div",{className:"grid gap-3 "+(f?"grid-cols-2":"grid-cols-1"),children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"bankShortcutKey",children:"Bank Shortcut Key"}),n.jsx(Je,{id:"bankShortcutKey",value:C,onKeyDown:e=>{if("Tab"===e.key)return;if(e.preventDefault(),"Backspace"===e.key||"Delete"===e.key||"Escape"===e.key)return void he(null);if(e.shiftKey)return void E("Shift is reserved for the secondary bank.");if(e.ctrlKey)return void E("Ctrl shortcuts are reserved by the browser. Use Alt or Meta instead.");const t=ht(e.key,{shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,code:e.code});t?he(t):E("Please press a letter or number key.")},placeholder:"Press a key",readOnly:!0}),A&&n.jsx("p",{className:"text-xs text-red-500",children:A}),!A&&n.jsxs("p",{className:"text-xs text-gray-500",children:["Reserved keys: ",fe]})]}),f&&n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{children:"MIDI Assignment"}),n.jsxs("div",{className:"text-xs text-gray-500",children:["Note: ",T??"‚Äî"," | CC: ",P??"‚Äî"]}),n.jsxs("div",{className:"flex gap-2",children:[n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:()=>O(!0),className:"flex-1",children:D?"Listening‚Ä¶":"Learn MIDI"}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:()=>{B(void 0),R(void 0),O(!1),j(null)},children:"Clear"})]}),I&&n.jsx("p",{className:"text-xs text-red-500",children:I})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsx(et,{children:"Pad Shortcuts (Keyboard/MIDI)"}),n.jsxs("div",{className:"flex items-center gap-2",children:[u&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:u,children:"Clear All Keys"}),f&&m&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:m,children:"Clear All MIDI"})]})]}),pe.length>0?n.jsxs("div",{className:"max-h-32 overflow-y-auto rounded border p-2 text-sm",children:[n.jsxs("div",{className:"grid grid-cols-[1fr_auto_auto] gap-2 text-[11px] uppercase tracking-wide text-gray-500",children:[n.jsx("div",{children:"Pad"}),n.jsx("div",{children:"Key"}),n.jsx("div",{children:"MIDI"})]}),n.jsx("div",{className:"mt-1 space-y-1",children:pe.map((e,t)=>n.jsxs("div",{className:"grid grid-cols-[1fr_auto_auto] items-center gap-2",children:[n.jsx("span",{className:"truncate",children:e.name}),n.jsx("span",{className:"rounded bg-gray-200 px-2 py-0.5 text-xs text-gray-800 dark:bg-gray-700 dark:text-gray-100",children:e.key??"‚Äî"}),n.jsx("span",{className:"rounded bg-gray-200 px-2 py-0.5 text-xs text-gray-800 dark:bg-gray-700 dark:text-gray-100",children:e.midi??"‚Äî"})]},`${e.name}-${e.key??"none"}-${e.midi??"none"}-${t}`))})]}):n.jsx("p",{className:"text-xs text-gray-500",children:"No shortcuts assigned in this bank."})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{children:"Bank Information"}),n.jsxs("div",{className:"text-sm space-y-1 "+("dark"===o?"text-gray-300":"text-gray-600"),children:[n.jsxs("div",{children:["Created: ",(ge=e.createdAt,new Intl.DateTimeFormat("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(ge))]}),n.jsxs("div",{children:["Pads: ",e.pads.length]}),n.jsxs("div",{children:["Created by: ",e.isAdminBank?n.jsx("span",{className:"text-yellow-500 font-medium",children:"ADMIN DJ V"}):e.creatorEmail?n.jsx("span",{children:e.creatorEmail}):n.jsx("span",{className:"italic text-gray-400",children:"Unknown"})]}),me&&n.jsxs("div",{children:["Description: ",(null==(y=e.bankMetadata)?void 0:y.description)?n.jsx("span",{children:e.bankMetadata.description}):n.jsx("span",{className:"italic text-gray-400",children:"No description"})]})]})]}),n.jsxs("div",{className:"flex gap-2 pt-4",children:[n.jsx(Te,{onClick:()=>{A||l({name:w,defaultColor:M,shortcutKey:C||void 0,midiNote:T,midiCC:P})},className:"flex-1",children:"Save Changes"}),n.jsx(Te,{onClick:()=>{!1!==e.exportable&&(ue&&h?V(!0):c())},variant:"outline",disabled:!1===e.exportable,className:"px-3 "+(!1===e.exportable?"opacity-50 cursor-not-allowed":""),title:!1===e.exportable?"Export disabled for this bank":ue?"Export (admin)":"Export",children:n.jsx(le,{className:"w-4 h-4"})}),n.jsx(Te,{onClick:()=>{F(!0)},variant:"destructive",className:"px-3",children:n.jsx(W,{className:"w-4 h-4"})})]})]})]})}),n.jsx(dt,{open:L,onOpenChange:F,title:"Delete Bank",description:`Are you sure you want to delete the bank "${e.name}"? This will permanently delete all pads in this bank. This action cannot be undone.`,confirmText:"Delete Bank",variant:"destructive",onConfirm:()=>{d(),F(!1)},theme:o}),n.jsx(Ke,{open:U,onOpenChange:V,children:n.jsxs(Ge,{className:"sm:max-w-md backdrop-blur-md "+("dark"===o?"bg-gray-800/90":"bg-white/90"),"aria-describedby":void 0,children:[n.jsx(Xe,{children:n.jsxs(Ye,{className:"flex items-center gap-2",children:[n.jsx(ce,{className:"w-4 h-4"}),"Export as Admin Bank"]})}),n.jsxs("div",{className:"space-y-6",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"adminTitle",children:"Bank Title"}),n.jsx(Je,{id:"adminTitle",value:$,onChange:e=>H(e.target.value),placeholder:"Enter bank title",className:"backdrop-blur-sm",maxLength:50})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"adminDescription",children:"Description"}),n.jsx("textarea",{id:"adminDescription",value:K,onChange:e=>q(e.target.value),placeholder:"Enter bank description",className:"w-full min-h-[80px] p-3 rounded-md border backdrop-blur-sm resize-none "+("dark"===o?"bg-gray-700/50 border-gray-600 text-white placeholder-gray-400":"bg-white/50 border-gray-300 text-gray-900 placeholder-gray-500"),maxLength:200})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx(et,{htmlFor:"adminTransferable",children:"Allow Pad Transfers"}),n.jsx(At,{id:"adminTransferable",checked:z,onCheckedChange:G})]}),n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx(et,{htmlFor:"adminAddToDatabase",children:"Add to Database"}),n.jsx("p",{className:"text-xs "+("dark"===o?"text-gray-400":"text-gray-500"),children:"Official bank with user access control (export automatically disabled)"})]}),n.jsx(At,{id:"adminAddToDatabase",checked:X,onCheckedChange:e=>{Y(e),e&&J(!1)}})]}),!X&&n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx(et,{htmlFor:"adminAllowExport",children:"Allow Export"}),n.jsx("p",{className:"text-xs "+("dark"===o?"text-gray-400":"text-gray-500"),children:"Users can export this bank after importing"})]}),n.jsx(At,{id:"adminAllowExport",checked:Z,onCheckedChange:J})]}),n.jsxs("div",{className:"flex gap-2 pt-4",children:[n.jsx(Te,{onClick:de,className:"flex-1",disabled:!$.trim(),children:"Export Admin Bank"}),n.jsx(Te,{onClick:()=>V(!1),variant:"outline",children:"Cancel"})]})]})]})}),n.jsx(Nt,{open:Q,onOpenChange:e=>{ee(e),e||"success"!==ne||V(!1)},title:"Exporting Admin Bank",description:"Creating encrypted bank file and updating database...",progress:te,status:ne,type:"export",theme:o,errorMessage:ie,onRetry:de})]});var ge}const nn=900;function sn({open:e,onOpenChange:t,banks:s,primaryBankId:i,secondaryBankId:r,currentBankId:o,isDualMode:l,theme:d,editMode:c,onCreateBank:u,onSetPrimaryBank:m,onSetSecondaryBank:h,onSetCurrentBank:f,onUpdateBank:p,onUpdatePad:g,onDeleteBank:b,onImportBank:v,onExportBank:y,onMoveBankUp:_,onMoveBankDown:x,onTransferPad:w,canTransferFromBank:k,onExportAdmin:M,midiEnabled:S=!1,blockedShortcutKeys:C,blockedMidiNotes:N,blockedMidiCCs:A,editBankRequest:E=null,hideShortcutLabels:I=!1}){var j,T;const[B,P]=a.useState(!1),[D,O]=a.useState(!1),[L,F]=a.useState(null),U=a.useRef(void 0),[V,$]=a.useState(""),[H,G]=a.useState(!1),[X,W]=a.useState(null),[Y,Z]=a.useState(null),[J,Q]=a.useState(!1),[ee,te]=a.useState(!1),[ae,ne]=a.useState(0),[se,ie]=a.useState(0),[re,oe]=a.useState("loading"),[le,fe]=a.useState("loading"),[pe,ge]=a.useState(""),[be,ve]=a.useState(""),[ye,_e]=a.useState(null),[xe,we]=a.useState(e),[ke,Me]=a.useState(null),[Se,Ce]=a.useState(0),[Ne,Ae]=a.useState(null),[Ee,Ie]=a.useState(!0),[je,Be]=a.useState([]),Pe=a.useCallback(e=>{const t="undefined"!=typeof crypto&&"randomUUID"in crypto?crypto.randomUUID():String(Date.now()+Math.random()),a={id:t,...e};Be(e=>[a,...e]),setTimeout(()=>{Be(e=>e.filter(e=>e.id!==t))},5e3)},[]),Re=a.useCallback(e=>{Be(t=>t.filter(t=>t.id!==e))},[]),De=a.useCallback(()=>{if(!L)return;const e=s.find(e=>e.id===L.id);if(!e)return;let t=0;e.pads.forEach(a=>{a.shortcutKey&&(t+=1,g(e.id,a.id,{...a,shortcutKey:void 0}))}),p(e.id,{disableDefaultPadShortcutLayout:!0}),Pe(t>0?{variant:"success",message:`Cleared keyboard shortcuts from ${t} pad${1===t?"":"s"}.`}:{variant:"info",message:"No pad keyboard shortcuts to clear."})},[s,L,g,p,Pe]),Oe=a.useCallback(()=>{if(!L)return;const e=s.find(e=>e.id===L.id);if(!e)return;let t=0;e.pads.forEach(a=>{"number"!=typeof a.midiNote&&"number"!=typeof a.midiCC||(t+=1,g(e.id,a.id,{...a,midiNote:void 0,midiCC:void 0}))}),Pe(t>0?{variant:"success",message:`Cleared MIDI mappings from ${t} pad${1===t?"":"s"}.`}:{variant:"info",message:"No pad MIDI mappings to clear."})},[s,L,g,Pe]),Le=a.useRef(null),{user:Fe,profile:Ue}=Qa(),Ve=a.useRef(null),$e=a.useCallback(()=>{"undefined"!=typeof window&&window.dispatchEvent(new Event("vdjv-login-request"))},[]),He=a.useCallback(()=>{"undefined"!=typeof window&&window.dispatchEvent(new Event("vdjv-open-about"))},[]),qe=Fe||Fa(),ze=(null==(j=null==Ue?void 0:Ue.display_name)?void 0:j.trim())||(null==(T=null==qe?void 0:qe.email)?void 0:T.split("@")[0])||"Guest";a.useEffect(()=>{s.length>0&&Ie(!1)},[s]),a.useEffect(()=>{if(e)return void we(!0);const t=setTimeout(()=>we(!1),200);return()=>clearTimeout(t)},[e]);const We=a.useMemo(()=>[...s].sort((e,t)=>(e.sortOrder||0)-(t.sortOrder||0)),[s]),Ze=()=>{V.trim()&&(u(V.trim(),"#3b82f6"),$(""),P(!1))},Qe=e=>{F(e),O(!0)};a.useEffect(()=>{if(!D||!L)return;const e=s.find(e=>e.id===L.id);e&&e!==L&&F(e)},[s,D,L]),a.useEffect(()=>{if(!c||!E)return;if(U.current===E.token)return;const e=s.find(e=>e.id===E.bankId);e&&(U.current=E.token,Qe(e))},[s,E,c]);const tt=a.useMemo(()=>/Android/.test(navigator.userAgent),[]),at=a.useMemo(()=>!!window.Android||navigator.userAgent.includes("wv")||navigator.userAgent.includes("WebView"),[]),nt=a.useCallback(()=>{const e=document.createElement("input");return e.type="file",e.accept=".bank,application/zip,application/x-zip-compressed,application/octet-stream,*/*",e.setAttribute("capture","none"),e.setAttribute("autocomplete","off"),e.setAttribute("autocorrect","off"),e.setAttribute("autocapitalize","off"),e.setAttribute("spellcheck","false"),e.style.position="fixed",e.style.left="-9999px",e.style.top="-9999px",e.style.opacity="0",document.body.appendChild(e),e},[]),st=a.useCallback(()=>{var e;if(!(Fe||Fa()))return $e(),void Pe({variant:"error",message:"Please sign in to import a bank."});if(tt||at){console.log("üì± Android/WebView detected, using enhanced file picker...");const e=nt(),a=async t=>{var n;const s=null==(n=t.target.files)?void 0:n[0];s?(console.log("‚úÖ File selected:",s.name,s.size,"bytes"),await it(s)):(console.warn("‚ö†Ô∏è No file selected"),Pe({variant:"error",message:"No file selected. Please try again."})),e.removeEventListener("change",a),e.parentNode&&e.remove()};e.addEventListener("change",a);const n=setTimeout(()=>{console.warn("‚ö†Ô∏è File picker timeout - no file selected within 60 seconds"),Pe({variant:"error",message:"File picker did not respond. Please try selecting the file again or use Google Drive to import."}),e.removeEventListener("change",a),e.parentNode&&e.remove()},6e4);e.addEventListener("change",()=>clearTimeout(n),{once:!0});try{e.click(),console.log("üì± Enhanced file picker triggered")}catch(t){console.error("‚ùå Failed to trigger file picker:",t),Pe({variant:"error",message:"Failed to open file picker. Please try again or use Google Drive to import."}),clearTimeout(n),e.parentNode&&e.remove()}}else null==(e=Le.current)||e.click()},[tt,at,nt,Pe,Fe,$e]);a.useEffect(()=>{const e=()=>{st()};return window.addEventListener("vdjv-import-bank",e),()=>window.removeEventListener("vdjv-import-bank",e)},[st]);const it=a.useCallback(async e=>{if(e)if(e.name.endsWith(".bank"))if(0!==e.size){console.log("üì¶ Starting import process for:",e.name,`(${(e.size/1024).toFixed(1)}KB)`),te(!0),fe("loading"),ie(0),ve(""),Ce(Date.now()),Ae(null);try{window.dispatchEvent(new Event("vdjv-import-start")),await v(e,e=>{ie(e)}),fe("success"),Pe({variant:"success",message:"Bank imported successfully!"}),Z(null)}catch(t){console.error("‚ùå Import failed:",t);const a=t instanceof Error?t.message:"Import failed";fe("error"),ve(a);const n=a.toLowerCase().includes("sign in")||a.toLowerCase().includes("login required")||a.toLowerCase().includes("please sign in");Z(n?e:null),Pe({variant:"error",message:`Import failed: ${a}`})}finally{window.dispatchEvent(new Event("vdjv-import-end"))}Le.current&&(Le.current.value="")}else Pe({variant:"error",message:"Selected file is empty."});else Pe({variant:"error",message:"Invalid file type. Please select a .bank file."});else Pe({variant:"error",message:"No file selected."})},[v,Pe]),rt=a.useCallback(async e=>{var t;const a=null==(t=e.target.files)?void 0:t[0];a&&await it(a)},[it]);a.useEffect(()=>{const e=(null==Fe?void 0:Fe.id)||null;e&&Ve.current!==e&&Y?(Ve.current=e,setTimeout(()=>{it(Y).finally(()=>{Z(null)})},100)):Ve.current=e},[Fe,Y,it]),a.useEffect(()=>{let e;if(ee&&"loading"===le&&se>0&&se<100){const t=()=>{const e=Date.now(),t=se/((e-Se)/1e3);if(t>0){let e=(100-se)/t;e<3&&se<98&&(e=5),Ae(e)}};t(),e=setInterval(t,1e3)}else"loading"!==le&&Ae(null);return()=>clearInterval(e)},[se,ee,le,Se]);const ot=se<20?{message:"Verifying your purchase...",showWarning:!0}:{message:"Extracting and processing audio files and images...",showWarning:!1},lt=async e=>{const t=Date.now();Q(!0),oe("loading"),ne(0),ge("");try{const a=await y(e,e=>{ne(e)}),n=Date.now()-t;n<nn&&await new Promise(e=>window.setTimeout(e,nn-n)),oe("success"),a&&Pe({variant:"success",message:a})}catch(a){console.error("Export failed:",a);const e=Date.now()-t;e<nn&&await new Promise(t=>window.setTimeout(t,nn-e)),oe("error"),ge(a instanceof Error?a.message:"Export failed")}},ct=e=>{e.currentTarget.contains(e.relatedTarget)||_e(null)},ut=e=>e<We.length-1,mt=e=>{const t=e.replace("#","");return(.299*parseInt(t.substr(0,2),16)+.587*parseInt(t.substr(2,2),16)+.114*parseInt(t.substr(4,2),16))/255>.5?"#000000":"#ffffff"},ht=e=>!k||k(e),pt=a.useCallback(()=>{"keys"===ke?De():"midi"===ke&&Oe(),Me(null)},[ke,De,Oe]);return n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:`fixed inset-y-0 left-0 z-50 w-64 border-r transition-transform duration-200 will-change-transform ${"dark"===d?"bg-gray-800 border-gray-700":"bg-white border-gray-200"} ${e?"translate-x-0":"-translate-x-full"}`,children:[n.jsxs("div",{className:"flex items-center gap-3 p-3 border-b "+("dark"===d?"border-gray-700":"border-gray-200"),children:[n.jsx("img",{src:"/assets/logo.png",alt:"VDJV Logo",className:"w-9 h-9 object-contain shrink-0"}),n.jsxs("div",{className:"min-w-0 flex-1",children:[n.jsx("div",{className:"text-sm font-semibold truncate "+("dark"===d?"text-white":"text-gray-900"),children:"VDJV Sampler Pad"}),n.jsx("div",{className:"text-[11px] truncate "+("dark"===d?"text-gray-400":"text-gray-500"),children:ze})]}),n.jsx(Te,{variant:"ghost",size:"sm",onClick:He,className:"dark"===d?"h-8 w-8 p-0 text-cyan-300 hover:bg-cyan-900/40 hover:text-cyan-200":"h-8 w-8 p-0 text-cyan-700 hover:bg-cyan-100 hover:text-cyan-800",title:"About & Settings",children:n.jsx(ue,{className:"w-4 h-4"})})]}),n.jsxs("div",{className:"flex items-center justify-between p-3 border-b "+("dark"===d?"border-gray-700":"border-gray-200"),children:[n.jsx("h2",{className:"text-xl font-bold "+("dark"===d?"text-white":"text-gray-900"),children:"Banks"}),n.jsx(Te,{variant:"ghost",size:"sm",onClick:()=>t(!1),className:"dark"===d?"h-8 w-8 p-0 inline-flex items-center justify-center border border-red-500/50 bg-red-900/40 text-red-300 hover:bg-red-800/60 hover:text-red-100":"h-8 w-8 p-0 inline-flex items-center justify-center border border-red-300 bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700",title:"Close Banks",children:n.jsx(K,{className:"w-4 h-4"})})]}),xe&&n.jsxs("div",{className:"p-2 max-h-[calc(100vh-80px)] overflow-y-auto",children:[n.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-1",children:[n.jsx("div",{className:"flex mb-2",children:n.jsxs(Te,{onClick:()=>P(!0),className:"flex-1 gap-0 transition-all duration-200 "+("dark"===d?"bg-blue-600 border-blue-500 text-white hover:bg-blue-500":"bg-blue-50 border-blue-300 text-blue-600 hover:bg-blue-100"),children:[n.jsx(me,{className:"w-4 h-4 mr-2"}),"New Bank"]})}),n.jsx("div",{className:"flex mb-2",children:n.jsxs(Te,{onClick:st,variant:"outline",className:"flex-1 transition-all duration-200 "+("dark"===d?"bg-gray-700 border-gray-600 text-gray-300 hover:bg-gray-600":"bg-white border-gray-300 text-gray-700 hover:bg-gray-100"),children:[n.jsx(de,{className:"w-4 h-4 mr-2"}),"Import"]})})]}),c&&n.jsx("div",{className:"mb-1 p-2 rounded-lg border "+("dark"===d?"bg-orange-900 border-orange-600 text-orange-300":"bg-orange-50 border-orange-300 text-orange-700"),children:n.jsx("p",{className:"text-xs text-center font-medium",children:"üéØ Drag sampler to transfer bank"})}),n.jsx("input",{ref:Le,type:"file",accept:".bank,application/zip,application/x-zip-compressed,application/octet-stream,*/*",onChange:rt,className:"hidden"}),n.jsx("div",{className:"space-y-2",children:Ee&&0===We.length?n.jsxs("div",{className:"flex flex-col gap-2 p-8 items-center justify-center "+("dark"===d?"text-gray-500":"text-gray-400"),children:[n.jsx(he,{className:"w-6 h-6 animate-spin"}),n.jsx("span",{className:"text-sm",children:"Loading banks..."})]}):We.map((e,t)=>{const a=(s=e.id)===i?"primary":s===r?"secondary":s===o?"current":"inactive";var s;const u="primary"===a,p="secondary"===a,g=u||p||"current"===a,b=ye===e.id,v=ft(e.shortcutKey);return n.jsxs("div",{className:`p-2 rounded-lg border-2 transition-all duration-200 relative ${b?"ring-4 ring-orange-400 scale-105 bg-orange-200":""} ${g?u?"dark"===d?"bg-gray-700 border-blue-400 text-white":"bg-white border-blue-400 text-gray-900":p?"dark"===d?"bg-gray-700 border-purple-400 text-white":"bg-white border-purple-400 text-gray-900":"dark"===d?"bg-gray-700 border-green-400 text-white":"bg-white border-green-400 text-gray-900":"dark"===d?"bg-gray-700 border-gray-600 text-gray-300 hover:bg-gray-600 cursor-pointer":"bg-white border-gray-300 text-gray-700 hover:bg-gray-50 cursor-pointer"}`,style:g?void 0:{backgroundColor:e.defaultColor,borderColor:e.defaultColor},onDragOver:t=>((e,t)=>{if(!c)return;e.preventDefault(),e.stopPropagation();let a=e.dataTransfer.getData("application/json");if(a||(a=e.dataTransfer.getData("text/plain")),a)try{const e=JSON.parse(a);console.log("Drag over bank:",t,"with data:",e),"pad-transfer"===e.type&&e.sourceBankId!==t&&ht(e.sourceBankId)&&_e(t)}catch(n){console.warn("Invalid drag data format:",n)}})(t,e.id),onDrop:t=>((e,t)=>{if(!c)return;e.preventDefault(),e.stopPropagation(),_e(null);let a=e.dataTransfer.getData("application/json");if(a||(a=e.dataTransfer.getData("text/plain")),a)try{const e=JSON.parse(a);console.log("Drop on bank:",t,"with data:",e),"pad-transfer"===e.type&&e.sourceBankId!==t&&ht(e.sourceBankId)&&(console.log("Executing pad transfer:",e.pad.id,"from",e.sourceBankId,"to",t),w(e.pad.id,e.sourceBankId,t))}catch(n){console.error("Error processing pad drop:",n)}else console.warn("No drag data found")})(t,e.id),onDragLeave:ct,children:[c&&b&&(e.id,!0)&&n.jsx("div",{className:"absolute inset-0 border-4 border-dashed border-orange-400 rounded-xl flex items-center justify-center z-10 "+("dark"===d?"bg-orange-900 text-orange-200":"bg-orange-50 text-orange-800"),children:n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"text-2xl mb-1",children:"üéØ"}),n.jsx("p",{className:"font-bold text-sm",children:"DROP PAD HERE"}),n.jsxs("p",{className:"text-xs opacity-75",children:["Transfer to ",e.name]}),g&&n.jsx("p",{className:"text-xs opacity-60 mt-1",children:u?"(Primary Bank)":p?"(Secondary Bank)":"(Current Bank)"})]})}),n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsxs("div",{className:"flex-1 min-w-0 cursor-pointer",onClick:()=>(e=>{l?e!==i&&h(e):f(e)})(e.id),children:[n.jsx("h3",{className:"font-medium text-sm truncate",title:e.name,style:g?void 0:{color:mt(e.defaultColor)},children:e.name.length>15?`${e.name.substring(0,15)}...`:e.name}),n.jsxs("p",{className:"text-xs opacity-75",style:g?void 0:{color:mt(e.defaultColor)},children:[e.pads.length," pad",1!==e.pads.length?"s":""]})]}),v&&!I&&n.jsx("span",{className:"max-w-[64px] shrink-0 rounded bg-black/20 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide truncate",style:g?void 0:{color:mt(e.defaultColor)},title:v,children:v}),n.jsxs("div",{className:"flex items-center gap-1 shrink-0",children:[n.jsxs("div",{className:"flex flex-col gap-0",children:[n.jsx(Te,{variant:"ghost",size:"sm",onClick:t=>{t.stopPropagation(),_(e.id)},disabled:(y=t,!(y>0)),className:"p-0 h-3 w-4 transition-all duration-200 "+("dark"===d?"text-gray-400 hover:text-white hover:bg-gray-600 disabled:text-gray-600":"text-gray-600 hover:text-gray-900 hover:bg-white disabled:text-gray-400"),title:"Move up",children:n.jsx(z,{className:"w-3 h-3"})}),n.jsx(Te,{variant:"ghost",size:"sm",onClick:t=>{t.stopPropagation(),x(e.id)},disabled:!ut(t),className:"p-0 h-3 w-4 transition-all duration-200 "+("dark"===d?"text-gray-400 hover:text-white hover:bg-gray-600 disabled:text-gray-600":"text-gray-600 hover:text-gray-900 hover:bg-white disabled:text-gray-400"),title:"Move down",children:n.jsx(q,{className:"w-3 h-3"})})]}),n.jsx(Te,{variant:"ghost",size:"sm",onClick:t=>{t.stopPropagation(),(e=>{m(e===i?null:e)})(e.id)},disabled:e.id===r,className:"p-1 h-6 w-6 transition-all duration-200 "+(u?"dark"===d?"bg-yellow-500 text-yellow-300 hover:bg-yellow-400":"bg-yellow-100 text-yellow-700 hover:bg-yellow-200":"dark"===d?"text-gray-400 hover:text-yellow-300 hover:bg-yellow-500":"text-gray-600 hover:text-yellow-700 hover:bg-yellow-100"),title:u?"Primary (click to exit dual mode)":"Set as Primary",children:n.jsx(ce,{className:"w-3 h-3"})}),n.jsx(Te,{variant:"ghost",size:"sm",onClick:t=>{t.stopPropagation(),Qe(e)},className:"p-1 h-6 w-6 transition-all duration-200 "+("dark"===d?"text-gray-400 hover:text-white hover:bg-gray-600":"text-gray-600 hover:text-gray-900 hover:bg-white"),children:n.jsx(ue,{className:"w-3 h-3"})})]})]})]},e.id);var y})})]})]}),n.jsx(Ke,{open:B,onOpenChange:P,children:n.jsxs(Ge,{className:""+("dark"===d?"bg-gray-800":"bg-white"),"aria-describedby":void 0,children:[n.jsx(Xe,{children:n.jsx(Ye,{children:"Create New Bank"})}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{children:[n.jsx(et,{htmlFor:"bankName",children:"Bank Name"}),n.jsx(Je,{id:"bankName",value:V,onChange:e=>{e.target.value.length<=18&&$(e.target.value)},placeholder:"Enter bank name",onKeyPress:e=>"Enter"===e.key&&Ze(),maxLength:24})]}),n.jsxs("div",{className:"flex gap-1",children:[n.jsx(Te,{onClick:Ze,className:"flex-1",children:"Create Bank"}),n.jsx(Te,{variant:"outline",onClick:()=>P(!1),children:"Cancel"})]})]})]})}),L&&n.jsx(an,{bank:L,allBanks:s,allPads:s.flatMap(e=>e.pads),open:D,onOpenChange:O,theme:d,onSave:e=>{const t={...e};void 0===e.shortcutKey&&L.shortcutKey?t.disableDefaultBankShortcutLayout=!0:"string"==typeof e.shortcutKey&&e.shortcutKey.trim().length>0&&(t.disableDefaultBankShortcutLayout=!1),p(L.id,t),O(!1)},onDelete:()=>{O(!1),b(L.id)},onExport:()=>{O(!1),lt(L.id)},onExportAdmin:M,midiEnabled:S,blockedShortcutKeys:C,blockedMidiNotes:N,blockedMidiCCs:A,onClearPadShortcuts:()=>Me("keys"),onClearPadMidi:()=>Me("midi")}),n.jsx(dt,{open:H,onOpenChange:G,title:"Delete Bank",description:`Are you sure you want to delete the bank "${null==X?void 0:X.name}"? This will permanently delete all pads in this bank. This action cannot be undone.`,confirmText:"Delete Bank",variant:"destructive",onConfirm:()=>{X&&(b(X.id),W(null))},theme:d}),n.jsx(dt,{open:null!==ke,onOpenChange:e=>{e||Me(null)},title:"midi"===ke?"Clear All MIDI":"Clear All Keys",description:"midi"===ke?`Clear all MIDI note/CC mappings for pads in "${(null==L?void 0:L.name)||"this bank"}"?`:`Clear all keyboard shortcuts for pads in "${(null==L?void 0:L.name)||"this bank"}"?`,confirmText:"midi"===ke?"Clear MIDI":"Clear Keys",onConfirm:pt,theme:d}),n.jsx(Nt,{open:J,onOpenChange:Q,title:"Exporting Bank",description:"Compressing audio files, images, and bank data...",progress:ae,status:re,type:"export",theme:d,errorMessage:pe,hideCloseButton:!0,useHistory:!1,onRetry:()=>{s.length>0&&lt(s[0].id)}}),n.jsx(Nt,{open:ee,onOpenChange:te,title:"Importing Bank",description:"",progress:se,status:le,type:"import",theme:d,errorMessage:be,statusMessage:ot.message,etaSeconds:Ne,showWarning:ot.showWarning,useHistory:!1,onRetry:()=>{st()},onLogin:()=>{$e()}}),"undefined"!=typeof document&&R.createPortal(n.jsx("div",{className:"fixed top-0 left-0 right-0 z-[2147483647] flex justify-center pointer-events-none",children:n.jsx("div",{className:"w-full max-w-xl px-3",children:je.map(e=>n.jsx(rn,{notice:e,dismiss:Re,theme:d},e.id))})}),document.body)]})}function rn({notice:e,dismiss:t,theme:s}){const[i,r]=a.useState(!1);a.useEffect(()=>{const e=setTimeout(()=>r(!0),10);return()=>clearTimeout(e)},[]);const o="success"===e.variant?"dark"===s?"bg-green-600/90 border-green-500 text-white":"bg-green-600 text-white border-green-700":"error"===e.variant?"dark"===s?"bg-red-600/90 border-red-500 text-white":"bg-red-600 text-white border-red-700":"dark"===s?"bg-gray-800/90 border-gray-700 text-white":"bg-gray-900 text-white border-gray-800";return n.jsx("div",{className:`pointer-events-auto mt-3 rounded-lg border px-4 py-2 shadow-lg transition-all duration-300 ${o} ${i?"opacity-100 translate-y-0":"opacity-0 -translate-y-3"}`,onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!0),children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx("div",{className:"flex-1 text-sm",children:e.message}),n.jsx("button",{className:"text-white/80 hover:text-white",onClick:()=>t(e.id),"aria-label":"Dismiss",children:"√ó"})]})})}function on(e){const t=(e||"").toLowerCase();return t.includes("invalid login")||t.includes("invalid email or password")||t.includes("invalid credentials")?"Invalid login credentials.":t.includes("banned")||t.includes("suspended")||t.includes("disabled")?"Your account has been banned. Please contact support in FACEBOK MESSENGER.":t.includes("email")&&t.includes("invalid")?"Email address is invalid.":t.includes("already registered")||t.includes("already exists")?"This email is already registered.":t.includes("rate limit")?"Too many attempts. Please try again later.":t.includes("no account found")||t.includes("user not found")||t.includes("no user found")?"No account found with this email address.":t.includes("please wait")&&t.includes("minute")?e:t.includes("unable to verify email")?"Unable to verify email. Please try again.":e||"Something went wrong. Please try again."}function ln({open:e,onOpenChange:t,theme:s="light",appReturnUrl:i,pushNotice:r}){const[o,l]=a.useState(""),[d,c]=a.useState(""),[u,m]=a.useState(""),[h,f]=a.useState(""),[p,g]=a.useState("signin"),[b,v]=a.useState(!1),[y,_]=a.useState(0),[x,w]=a.useState(!1),[k,M]=a.useState(!1),[S,C]=a.useState(!1),[N,A]=a.useState(!1),[E,I]=a.useState(!1),{signIn:j,signUp:T,requestPasswordReset:B,updatePassword:P,isPasswordRecovery:R,redirectError:D,clearRedirectError:O,sessionConflictReason:L,clearSessionConflictReason:F,banned:U}=Qa(),V="dark"===s?"text-white":"text-gray-900",$="sm:max-w-md "+("dark"===s?"bg-gray-800 border-gray-600":"bg-white border-gray-300");a.useEffect(()=>{Aa()},[]),a.useEffect(()=>{e||(l(""),c(""),m(""),f(""),g("signin"),_(0),M(!1),C(!1),A(!1),I(!1),U&&w(!1),D&&O())},[e,D,O,U]),a.useEffect(()=>{if(e&&o){const e=`password_reset_${o}`,t=localStorage.getItem(e);if(t){const e=Date.now(),a=3e5,n=Math.max(0,a-(e-parseInt(t)));n>0&&_(Math.ceil(n/1e3/60))}}},[e,o]),a.useEffect(()=>{if(y>0){const e=setTimeout(()=>{_(e=>Math.max(0,e-1))},6e4);return()=>clearTimeout(e)}},[y]),a.useEffect(()=>{R&&(g("reset"),e||t(!0),null==r||r({variant:"info",message:"Ready to set a new password."}))},[R,t,e,r]),a.useEffect(()=>{D&&(e||t(!0),null==r||r({variant:"error",message:"otp_expired"===D.code?"Reset link expired. Request a new one.":D.description||"Authentication error."}),g("forgot"),O())},[D,t,e,O,r]),a.useEffect(()=>{L&&(e||t(!0),null==r||r({variant:"error",message:L}),F())},[L,t,e,r,F]),a.useEffect(()=>{U||w(!1)},[U]);const H=()=>R?n.jsxs("div",{className:"p-3 rounded-lg text-xs bg-yellow-50 border border-yellow-200 text-yellow-700 mb-3",children:["If you opened this from your email in a separate tab, your app may already be ready to reset in another tab."," ",n.jsx("button",{type:"button",onClick:()=>{try{window.close()}catch{}},className:"underline",children:"Close this tab"}),i&&n.jsxs(n.Fragment,{children:[" ¬∑ ",n.jsx("a",{className:"underline",href:i,children:"Return to the app"})]})]}):null,K=a.useCallback(e=>{Ia({eventType:e.eventType,status:e.status,userId:e.userId||null,email:e.email,errorMessage:e.errorMessage||null,meta:{source:"LoginModal"}}).catch(e=>{console.warn("Failed to log auth event:",e)})},[]),q=()=>{switch(p){case"signup":return n.jsx(n.Fragment,{children:"Create Account"});case"forgot":return n.jsx(n.Fragment,{children:"Forgot Password"});case"reset":return n.jsx(n.Fragment,{children:"Reset Password"});default:return n.jsx(n.Fragment,{children:"Sign In"})}};return U&&!x?n.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/80 px-6",children:n.jsxs("div",{className:"w-full max-w-md rounded-lg border border-red-500/40 bg-gray-900 p-6 text-center text-white shadow-lg",children:[n.jsx("div",{className:"text-lg font-semibold",children:"Account Banned"}),n.jsx("p",{className:"mt-2 text-sm text-gray-300",children:"Your account has been banned. If you believe this is a mistake, please contact support in FACEBOK MESSENGER."}),n.jsx("div",{className:"mt-4",children:n.jsx(Te,{type:"button",className:"w-full",onClick:()=>{w(!0),g("signin"),c(""),f(""),t(!0)},children:"Sign in to verify"})}),i&&n.jsx("div",{className:"mt-4",children:n.jsx("a",{className:"underline text-sm",href:i,children:"Return to the app"})})]})}):n.jsx(Ke,{open:e,onOpenChange:e=>{!e&&U&&w(!1),t(e)},children:n.jsxs(Ge,{className:$,"aria-describedby":void 0,children:[n.jsx(Xe,{children:n.jsx(Ye,{className:V,children:n.jsx(q,{})})}),n.jsxs(Ze,{className:"sr-only",children:["signin"===p&&"Sign in to your account.","signup"===p&&"Create a new account.","forgot"===p&&"Request a password reset link via email.","reset"===p&&"Choose a new password for your account."]}),n.jsx(H,{}),"reset"===p?n.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),d.length<6)null==r||r({variant:"error",message:"Password must be at least 6 characters."});else if(d===h){v(!0);try{const{error:e}=await P(d);e?null==r||r({variant:"error",message:on(e.message)}):(t(!1),null==r||r({variant:"success",message:"Password updated."}))}catch{null==r||r({variant:"error",message:"Something went wrong. Please try again."})}finally{v(!1)}}else null==r||r({variant:"error",message:"Passwords do not match."})},className:"space-y-4",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"newPassword",className:V,children:"New Password"}),n.jsxs("div",{className:"relative",children:[n.jsx(Je,{id:"newPassword",type:N?"text":"password",value:d,onChange:e=>c(e.target.value),placeholder:"Enter a new password",required:!0,disabled:b,minLength:8,autoComplete:"new-password",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",className:"pr-10",onFocus:e=>{window.innerWidth<=768&&setTimeout(()=>e.target.focus(),100)}}),n.jsx("button",{type:"button",className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-800",onClick:()=>A(e=>!e),"aria-label":N?"Hide password":"Show password",children:N?n.jsx(fe,{className:"w-4 h-4"}):n.jsx(pe,{className:"w-4 h-4"})})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"confirmNewPassword",className:V,children:"Confirm New Password"}),n.jsxs("div",{className:"relative",children:[n.jsx(Je,{id:"confirmNewPassword",type:E?"text":"password",value:h,onChange:e=>f(e.target.value),placeholder:"Confirm your new password",required:!0,disabled:b,minLength:8,autoComplete:"new-password",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",className:"pr-10",onFocus:e=>{window.innerWidth<=768&&setTimeout(()=>e.target.focus(),100)}}),n.jsx("button",{type:"button",className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-800",onClick:()=>I(e=>!e),"aria-label":E?"Hide password":"Show password",children:E?n.jsx(fe,{className:"w-4 h-4"}):n.jsx(pe,{className:"w-4 h-4"})})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(Te,{type:"submit",className:"w-full",disabled:b||!d||!h,children:b?"Updating...":"Update Password"}),n.jsx(Te,{type:"button",variant:"outline",className:"w-full",onClick:()=>{g("signin")},disabled:b,children:"Back to Sign In"})]})]}):null,"forgot"===p?n.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),o){v(!0);try{const{error:e}=await B(o);if(e){if(null==r||r({variant:"error",message:on(e.message)}),e.message.includes("Please wait")){const t=e.message.match(/(\d+)/);t&&_(parseInt(t[1]))}}else null==r||r({variant:"success",message:"Password reset link sent. Check your email."}),g("signin"),_(5)}catch{null==r||r({variant:"error",message:"Something went wrong. Please try again."})}finally{v(!1)}}else null==r||r({variant:"error",message:"Please enter your email."})},className:"space-y-4",children:[n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"email",className:V,children:"Email"}),n.jsx(Je,{id:"email",type:"email",value:o,onChange:e=>l(e.target.value),placeholder:"Enter your email",required:!0,disabled:b,autoComplete:"email",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",onFocus:e=>{window.innerWidth<=768&&setTimeout(()=>e.target.focus(),100)}})]}),y>0&&n.jsxs("div",{className:"p-3 rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-700 text-sm",children:["Please wait ",y," minute",y>1?"s":""," before requesting another reset."]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(Te,{type:"submit",className:"w-full",disabled:b||!o||y>0,children:b?"Sending...":"Send reset link"}),n.jsx(Te,{type:"button",variant:"outline",className:"w-full",onClick:()=>{g("signin")},disabled:b,children:"Back to Sign In"})]})]}):null,("signin"===p||"signup"===p)&&n.jsxs("form",{onSubmit:async e=>{var a,n;e.preventDefault(),v(!0);try{if("signup"===p){if(d!==h)return void(null==r||r({variant:"error",message:"Passwords do not match."}));if(!u)return void(null==r||r({variant:"error",message:"Display name is required."}));const{error:e,data:t}=await T(o,d,u),n=(null==t?void 0:t.user)&&Array.isArray(t.user.identities)&&0===t.user.identities.length;if(e||n){K({eventType:"auth.signup",status:"failed",email:o,errorMessage:(null==e?void 0:e.message)||"This email is already registered."});const t=on((null==e?void 0:e.message)||"This email is already registered.");return void(null==r||r({variant:"error",message:t}))}return K({eventType:"auth.signup",status:"success",email:o,userId:(null==(a=null==t?void 0:t.user)?void 0:a.id)||void 0}),null==r||r({variant:"success",message:"Sign up successful. Check your email for a confirmation link."}),g("signin"),c(""),void f("")}const{error:e,data:s}=await j(o,d);e?(K({eventType:"auth.login",status:"failed",email:o,errorMessage:e.message}),null==r||r({variant:"error",message:on(e.message)})):(K({eventType:"auth.login",status:"success",email:o,userId:(null==(n=null==s?void 0:s.user)?void 0:n.id)||void 0}),null==r||r({variant:"success",message:"Logged in successfully."}),t(!1))}catch{null==r||r({variant:"error",message:"Something went wrong. Please try again."})}finally{v(!1)}},className:"space-y-4",children:["signup"===p&&n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"displayName",className:V,children:"Display Name"}),n.jsx(Je,{id:"displayName",type:"text",value:u,onChange:e=>m(e.target.value),placeholder:"Enter your display name",required:!0,disabled:b,autoComplete:"name",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",onFocus:e=>{window.innerWidth<=768&&setTimeout(()=>e.target.focus(),100)}})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"email",className:V,children:"Email"}),n.jsx(Je,{id:"email",type:"email",value:o,onChange:e=>l(e.target.value),placeholder:"Enter your email",required:!0,disabled:b,autoComplete:"email",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",onFocus:e=>{window.innerWidth<=768&&setTimeout(()=>e.target.focus(),100)}})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"password",className:V,children:"Password"}),n.jsxs("div",{className:"relative",children:[n.jsx(Je,{id:"password",type:k?"text":"password",value:d,onChange:e=>c(e.target.value),placeholder:"Enter your password",required:!0,disabled:b,minLength:6,autoComplete:"signup"===p?"new-password":"current-password",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",className:"pr-10",onFocus:e=>{window.innerWidth<=768&&setTimeout(()=>e.target.focus(),100)}}),n.jsx("button",{type:"button",className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-800",onClick:()=>M(e=>!e),"aria-label":k?"Hide password":"Show password",children:k?n.jsx(fe,{className:"w-4 h-4"}):n.jsx(pe,{className:"w-4 h-4"})})]})]}),"signup"===p&&n.jsxs("div",{className:"space-y-2",children:[n.jsx(et,{htmlFor:"confirmPassword",className:V,children:"Confirm Password"}),n.jsxs("div",{className:"relative",children:[n.jsx(Je,{id:"confirmPassword",type:S?"text":"password",value:h,onChange:e=>f(e.target.value),placeholder:"Confirm your password",required:!0,disabled:b,minLength:6,autoComplete:"new-password",autoCorrect:"off",autoCapitalize:"off",spellCheck:"false",className:"pr-10",onFocus:e=>{window.innerWidth<=768&&setTimeout(()=>e.target.focus(),100)}}),n.jsx("button",{type:"button",className:"absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-800",onClick:()=>C(e=>!e),"aria-label":S?"Hide password":"Show password",children:S?n.jsx(fe,{className:"w-4 h-4"}):n.jsx(pe,{className:"w-4 h-4"})})]})]}),n.jsx("div",{className:"flex items-center justify-between",children:n.jsx(Te,{type:"button",variant:"link",className:"px-0 text-sm",onClick:()=>{g("signin"===p?"forgot":"signin")},disabled:b,children:"Forgot password?"})}),n.jsx("div",{className:"space-y-2",children:n.jsx(Te,{type:"submit",className:"w-full",disabled:b||!o||!d||"signup"===p&&(!u||!h),children:b?"Loading...":"signup"===p?"Create Account":"Sign In"})})]})]})})}const dn={stopAll:{key:"Space"},mixer:{key:"M"},editMode:{key:"Z"},mute:{key:"X"},banksMenu:{key:"B"},nextBank:{key:"["},prevBank:{key:"]"},upload:{key:"N"},volumeUp:{key:"ArrowUp"},volumeDown:{key:"ArrowDown"},padSizeUp:{key:"="},padSizeDown:{key:"-"},importBank:{key:"V"},activateSecondary:{key:"C"},midiShift:{key:""},channelMappings:Array.from({length:8},()=>({keyUp:"",keyDown:"",keyStop:"",midiCC:void 0,midiNote:void 0})),channelCount:4,masterVolumeCC:void 0},cn={stopAll:"Stop All",mixer:"Mixer",editMode:"Edit Mode",mute:"Mute/Unmute",banksMenu:"Banks Menu",nextBank:"Next Bank",prevBank:"Previous Bank",upload:"Upload",volumeUp:"Master Volume +",volumeDown:"Master Volume -",padSizeUp:"Pad Size +",padSizeDown:"Pad Size -",importBank:"Import Bank",activateSecondary:"Activate Secondary Page",midiShift:"MIDI Shift"},un=[{name:"Red",hex:"#ff0000"},{name:"Orange",hex:"#ff5400"},{name:"Warm Yellow",hex:"#ffbd6c"},{name:"Yellow",hex:"#ffff00"},{name:"Yellow Green",hex:"#bdff2d"},{name:"Lime",hex:"#54ff00"},{name:"Green",hex:"#00ff00"},{name:"Cyan",hex:"#4cc3ff"},{name:"Blue",hex:"#0000ff"},{name:"Purple",hex:"#5400ff"},{name:"Pink",hex:"#ff00ff"},{name:"White",hex:"#ffffff"}];function mn({open:e,onOpenChange:t,displayName:s,version:i,theme:r,onToggleTheme:o,midiSupported:l,midiEnabled:d,midiAccessGranted:c,midiBackend:u,midiOutputSupported:m,midiInputs:h,midiSelectedInputId:f,midiError:p,onRequestMidiAccess:g,onSelectMidiInput:b,onToggleMidiEnabled:v,systemMappings:y,onUpdateSystemKey:_,onResetSystemKey:x,onUpdateSystemMidi:w,onUpdateSystemColor:k,onSetMasterVolumeCC:M,channelCount:S,onChangeChannelCount:C,onUpdateChannelMapping:N,padBankShortcutKeys:A,padBankMidiNotes:E,padBankMidiCCs:I,midiNoteAssignments:j,hideShortcutLabels:T,onToggleHideShortcutLabels:B,autoPadBankMapping:P,onToggleAutoPadBankMapping:R,sidePanelMode:D,onChangeSidePanelMode:O,onResetAllSystemMappings:L,onClearAllSystemMappings:F,onResetAllChannelMappings:U,onClearAllChannelMappings:V,midiDeviceProfiles:$,midiDeviceProfileId:H,onSelectMidiDeviceProfile:K,onExportMappings:q,onImportMappings:z,onExportAppBackup:G,onRestoreAppBackup:X,onRecoverMissingMediaFromBanks:W,isDualMode:Y,padSize:Z,stopMode:J,padSizeMin:Q,padSizeMax:ee,onPadSizeChange:te,onStopModeChange:ae,isAuthenticated:ne=!1,onSignOut:se}){const[ie,re]=a.useState(null),[oe,le]=a.useState("general"),[de,ce]=a.useState(null),[ue,me]=a.useState(null),[he,fe]=a.useState(null),[pe,be]=a.useState(null),[ve,ye]=a.useState(!1),[_e,xe]=a.useState(!1),[we,ke]=a.useState(!1),[Me,Se]=a.useState(!1),[Ce,Ne]=a.useState(null),[Ae,Ee]=a.useState(!1),[Ie,je]=a.useState(null),[Be,Pe]=a.useState(!1),[Re,De]=a.useState(0),[Oe,Le]=a.useState("loading"),[Fe,Ue]=a.useState("export"),[Ve,$e]=a.useState("Preparing Backup"),[He,qe]=a.useState(""),[ze,We]=a.useState(void 0),Ze=a.useRef(null),Qe=Be&&"loading"===Oe,st=a.useRef(null),it=a.useRef(null),lt=a.useRef(null),[ct,ut]=a.useState({}),mt=a.useRef(new Map),ft=a.useCallback(e=>{const t=mt.current.get(e);void 0!==t&&(window.clearTimeout(t),mt.current.delete(e)),ut(t=>{if(!t[e])return t;const a={...t};return delete a[e],a})},[]),pt=a.useCallback((e,t)=>{const a=mt.current.get(e);void 0!==a&&window.clearTimeout(a),ut(a=>({...a,[e]:t}));const n=window.setTimeout(()=>{mt.current.delete(e),ut(t=>{if(!t[e])return t;const a={...t};return delete a[e],a})},2600);mt.current.set(e,n)},[]),gt=a.useCallback(e=>ct[e]||null,[ct]);a.useEffect(()=>{e||(re(null),ce(null),me(null),fe(null),be(null),le("general"),xe(!1),ke(!1),Se(!1),Ne(null),Ee(!1),je(null),Pe(!1),De(0),We(void 0),ut({}),mt.current.forEach(e=>window.clearTimeout(e)),mt.current.clear(),null!==Ze.current&&(window.clearInterval(Ze.current),Ze.current=null))},[e]),a.useEffect(()=>{ne||"general"===oe||le("general")},[ne,oe]),a.useEffect(()=>()=>{mt.current.forEach(e=>window.clearTimeout(e)),mt.current.clear(),null!==Ze.current&&(window.clearInterval(Ze.current),Ze.current=null)},[]);const bt=y.channelMappings||[],vt=Math.max(2,Math.min(8,Math.floor(S||4))),yt=a.useMemo(()=>bt.slice(0,vt),[vt,bt]),_t=a.useMemo(()=>Array.from({length:vt},(e,t)=>bt[t]||{}),[vt,bt]),xt=a.useMemo(()=>Object.keys(cn),[]),wt=a.useMemo(()=>{const e=new Map;return j.forEach(t=>{e.has(t.note)||e.set(t.note,{type:t.type,bankName:t.bankName,padName:t.padName})}),e},[j]),kt=a.useCallback((e,t)=>{const a=wt.get(e);if(a)return"pad"===a.type?`pad "${a.padName||"Unnamed"}" in bank "${a.bankName}"`:`bank "${a.bankName}"`;const n=xt.find(a=>{var n;return a!==(null==t?void 0:t.excludeAction)&&(null==(n=y[a])?void 0:n.midiNote)===e});if(n)return`system mapping "${cn[n]}"`;const s=yt.findIndex((a,n)=>n!==(null==t?void 0:t.excludeChannelIndex)&&(null==a?void 0:a.midiNote)===e);return s>=0?`Channel ${s+1} Stop`:null},[yt,wt,xt,y]),Mt=a.useCallback((e,t)=>xt.filter(e=>e!==t).some(t=>{var a;return(null==(a=y[t])?void 0:a.key)===e}),[y,xt]),St=a.useCallback((e,t,a)=>yt.some((n,s)=>!!n&&((t!==s||!a||n[a]!==e)&&(n.keyUp===e||n.keyDown===e||n.keyStop===e))),[yt]),Ct=a.useCallback((e,t)=>xt.filter(e=>e!==t).some(t=>{var a;return(null==(a=y[t])?void 0:a.midiNote)===e}),[y,xt]),Et=a.useCallback((e,t)=>void 0!==t?xt.filter(e=>e!==t).some(t=>{var a;return(null==(a=y[t])?void 0:a.midiCC)===e}):xt.some(t=>{var a;return(null==(a=y[t])?void 0:a.midiCC)===e}),[y,xt]),It=a.useCallback((e,t)=>yt.some((a,n)=>!(!a||"number"!=typeof a.midiNote)&&(t!==n&&a.midiNote===e)),[yt]),jt=a.useCallback((e,t)=>yt.some((a,n)=>!(!a||"number"!=typeof a.midiCC)&&(t!==n&&a.midiCC===e)),[yt]);a.useEffect(()=>{if(!ie)return;const e=e=>{const t=e.detail;if(t)if("masterVolume"!==ie.type){if("system"!==ie.type){if("channel"===ie.type){if("cc"===t.type)return I.has(t.cc)||Et(t.cc)||jt(t.cc,ie.channelIndex)?(me("That MIDI CC is already assigned."),void re(null)):(N(ie.channelIndex,{midiCC:t.cc}),me(null),void re(null));if("noteon"===t.type){if(E.has(t.note)||Ct(t.note)||It(t.note,ie.channelIndex)){const e=kt(t.note,{excludeChannelIndex:ie.channelIndex});return me(e?`That MIDI note is already assigned to ${e}.`:"That MIDI note is already assigned."),void re(null)}return N(ie.channelIndex,{midiNote:t.note}),me(null),void re(null)}re(null)}}else if("noteon"===t.type){if(E.has(t.note)||It(t.note)||Ct(t.note,ie.action)){const e=kt(t.note,{excludeAction:ie.action});return ce(e?`That MIDI note is already assigned to ${e}.`:"That MIDI note is already assigned."),void re(null)}w(ie.action,t.note,void 0),ce(null),re(null)}else if("cc"===t.type){if("midiShift"===ie.action)return ce("MIDI Shift must use a MIDI note."),void re(null);if(I.has(t.cc)||jt(t.cc)||Et(t.cc,ie.action))return ce("That MIDI CC is already assigned."),void re(null);w(ie.action,void 0,t.cc),ce(null),re(null)}}else if("cc"===t.type){if(I.has(t.cc)||jt(t.cc)||Et(t.cc))return me("That MIDI CC is already assigned."),void re(null);M(t.cc),me(null),re(null)}};return window.addEventListener("vdjv-midi",e),()=>window.removeEventListener("vdjv-midi",e)},[ie,M,w,N,E,I,It,jt,Ct,Et,kt]);const Tt=e=>t=>{var a;const n=`system-${e}-key`;if("Tab"===t.key)return;if(t.preventDefault(),"Escape"===t.key)return;if("Backspace"===t.key||"Delete"===t.key)return _(e,""),ft(n),void ce(null);const s=ht(t.key,{shiftKey:t.shiftKey,ctrlKey:t.ctrlKey,altKey:t.altKey,metaKey:t.metaKey});if(s){if((null==(a=y[e])?void 0:a.key)===s)return ft(n),void ce(null);if(A.has(s)||St(s)||Mt(s,e))return void pt(n,"That key is already assigned.");_(e,s),ft(n),ce(null)}},Bt=["stopAll","mixer","editMode","banksMenu","nextBank","prevBank","upload","padSizeUp","padSizeDown","importBank","activateSecondary","midiShift"],Pt=(e,t)=>a=>{var n;const s=`channel-${e}-${t}`;if("Tab"===a.key)return;if(a.preventDefault(),"Escape"===a.key)return;if("Backspace"===a.key||"Delete"===a.key)return N(e,{[t]:""}),ft(s),void me(null);const i=ht(a.key,{shiftKey:a.shiftKey,ctrlKey:a.ctrlKey,altKey:a.altKey,metaKey:a.metaKey,code:a.code});if(i){if((null==(n=bt[e])?void 0:n[t])===i)return ft(s),void me(null);if(A.has(i)||Mt(i)||St(i,e,t))return void pt(s,"That key is already assigned.");N(e,{[t]:i}),ft(s),me(null)}},Rt=e=>t=>{var a;const n=`master-${e}-key`;if("Tab"===t.key)return;if(t.preventDefault(),"Escape"===t.key)return;if("Backspace"===t.key||"Delete"===t.key)return _(e,""),ft(n),void me(null);const s=ht(t.key,{shiftKey:t.shiftKey,ctrlKey:t.ctrlKey,altKey:t.altKey,metaKey:t.metaKey,code:t.code});if(s){if((null==(a=y[e])?void 0:a.key)===s)return ft(n),void me(null);if(A.has(s)||St(s)||Mt(s,e))return void pt(n,"That key is already assigned.");_(e,s),ft(n),me(null)}},Dt=a.useCallback(async()=>{try{const e=await q();fe({type:"success",message:e})}catch(e){const t=e instanceof Error?e.message:"Export failed.";fe({type:"error",message:t})}},[q]),Ot=a.useCallback(()=>{var e;null==(e=st.current)||e.click()},[]),Lt=a.useCallback(async e=>{var t;const a=null==(t=e.target.files)?void 0:t[0];if(e.target.value="",a)try{const e=await z(a);fe({type:"success",message:e})}catch(n){const e=n instanceof Error?n.message:"Import failed.";fe({type:"error",message:e})}},[z]),Ft=a.useCallback((e,t,a)=>{null!==Ze.current&&window.clearInterval(Ze.current),Ue(e),$e(t),qe(a),Le("loading"),We(void 0),De(8),Pe(!0),Ze.current=window.setInterval(()=>{De(e=>{if(e>=92)return e;const t=e<40?5:e<70?3:1;return Math.min(92,e+t)})},350)},[]),Ut=a.useCallback((e,t)=>{null!==Ze.current&&(window.clearInterval(Ze.current),Ze.current=null),Le(e),De(100),We(t)},[]),Vt=a.useCallback(()=>{Qe||ke(!0)},[Qe]),$t=a.useCallback(async()=>{ke(!1),Ft("export","Exporting Full Backup","Creating encrypted app backup...");try{const e=await G();be({type:"success",message:e}),Ut("success",e)}catch(e){const t=e instanceof Error?e.message:"Backup export failed.";t.includes("Not enough free storage for backup export")?(Pe(!1),Ne(t),Se(!0)):(be({type:"error",message:t}),Ut("error",t))}},[Ft,Ut,G]),Ht=a.useCallback(async()=>{Se(!1),Ft("export","Exporting Full Backup (Risk Mode)","Storage preflight is skipped. Keep the app open until export completes.");try{const e=await G({riskMode:!0});be({type:"success",message:e}),Ut("success",e),Ne(null)}catch(e){const t=e instanceof Error?e.message:"Backup export failed.";be({type:"error",message:t}),Ut("error",t)}},[Ft,Ut,G]),Kt=a.useCallback(()=>{var e;Qe||null==(e=it.current)||e.click()},[Qe]),qt=a.useCallback(async e=>{const t=Array.from(e.target.files||[]);if(e.target.value="",!t.length)return;const a=t.find(e=>e.name.toLowerCase().endsWith(".vdjvbackup"))||t.find(e=>e.name.toLowerCase().endsWith(".json"))||t[0],n=t.filter(e=>e!==a);je({manifestFile:a,companionFiles:n}),Ee(!0)},[]),zt=a.useCallback(async()=>{const e=Ie;if(Ee(!1),!e)return;const{manifestFile:t,companionFiles:a}=e,n=a.length>0?`${t.name} + ${a.length} companion file(s)`:t.name;Ft("import","Restoring Backup",`Restoring from ${n}...`);try{const e=await X(t,a);be({type:"success",message:e}),Ut("success",e)}catch(s){const e=s instanceof Error?s.message:"Backup restore failed.";be({type:"error",message:e}),Ut("error",e)}finally{je(null)}},[Ie,Ft,X,Ut]),Gt=a.useCallback(()=>{var e;Qe||null==(e=lt.current)||e.click()},[Qe]),Xt=a.useCallback(async e=>{const t=Array.from(e.target.files||[]);if(e.target.value="",!t.length)return;const a=1===t.length?t[0].name:`${t.length} bank files`;Ft("import","Recovering Missing Media",`Recovering from ${a}...`);try{const e=await W(t);be({type:"success",message:e}),Ut("success",e)}catch(n){const e=n instanceof Error?n.message:"Recovery import failed.";be({type:"error",message:e}),Ut("error",e)}},[Ft,Ut,W]),Wt=a.useCallback(async()=>{if(se&&!ve){ye(!0);try{await se(),xe(!1),t(!1)}finally{ye(!1)}}},[se,ve,t]),Yt=d,Zt=c,Jt=Zt?Yt?"sm:grid-cols-4":"sm:grid-cols-3":Yt?"sm:grid-cols-3":"sm:grid-cols-2",Qt=gt("master-volumeUp-key"),ea=gt("master-volumeDown-key"),ta=gt("master-mute-key");return n.jsxs(Ke,{open:e,onOpenChange:t,children:[n.jsxs(Ge,{className:"w-[96vw] max-h-[92vh] overflow-hidden sm:max-w-4xl backdrop-blur-md bg-white/95 border-gray-300 dark:bg-gray-800/95 dark:border-gray-600",children:[n.jsx(Xe,{className:"pb-2 border-b border-gray-200 dark:border-gray-700",children:n.jsx(Ye,{children:"Setting"})}),n.jsxs("div",{className:"space-y-3 py-2 max-h-[calc(92vh-96px)] overflow-y-auto pr-1 text-sm",children:[n.jsxs("div",{className:"grid gap-2 "+(ne?"grid-cols-2 sm:grid-cols-4":"grid-cols-1"),children:[n.jsx(Te,{type:"button",variant:"general"===oe?"default":"outline",size:"sm",onClick:()=>le("general"),children:"General"}),ne&&n.jsx(Te,{type:"button",variant:"system"===oe?"default":"outline",size:"sm",onClick:()=>le("system"),children:"System Shortcut"}),ne&&n.jsx(Te,{type:"button",variant:"channels"===oe?"default":"outline",size:"sm",onClick:()=>le("channels"),children:"Channels Shortcut"}),ne&&n.jsx(Te,{type:"button",variant:"backup"===oe?"default":"outline",size:"sm",onClick:()=>le("backup"),children:"Backup"})]}),"general"===oe&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"rounded-lg border p-3 space-y-3 bg-gray-50/60 dark:bg-gray-900/30",children:[n.jsx("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"General Settings"}),n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{className:"space-y-0.5",children:[n.jsx(et,{className:"text-xs font-medium",children:"Theme"}),n.jsx("p",{className:"text-[10px] text-gray-500",children:"Enable = Light, Disable = Dark."})]}),n.jsx(At,{checked:"light"===r,onCheckedChange:e=>{e&&"light"!==r&&o(),e||"dark"===r||o()}})]}),n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{className:"space-y-0.5",children:[n.jsx(et,{className:"text-xs font-medium",children:"Side Panel Behavior"}),n.jsx("p",{className:"text-[10px] text-gray-500",children:"Enable = Reflow, Disable = Overlay."})]}),n.jsx(At,{checked:"reflow"===D,onCheckedChange:e=>O(e?"reflow":"overlay")})]}),n.jsx("div",{className:"space-y-1",children:n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{className:"space-y-0.5",children:[n.jsx(et,{className:"text-xs font-medium",children:"Pad Size"}),n.jsx("p",{className:"text-[10px] text-gray-500",children:"Controls the number of pads visible per row."})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-8 w-8 p-0",onClick:()=>te(Math.max(Q,Z-(Y?2:1))),disabled:Z<=Q,children:"-"}),n.jsxs("span",{className:"w-16 text-center text-xs font-medium",children:[Z,"/",ee]}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-8 w-8 p-0",onClick:()=>te(Math.min(ee,Z+(Y?2:1))),disabled:Z>=ee,children:"+"})]})]})}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-xs font-medium",children:"Stop Mode"}),n.jsx("p",{className:"text-[10px] text-gray-500",children:"Choose how pads stop playback when toggled off."}),n.jsxs(tt,{value:J,onValueChange:e=>ae(e),children:[n.jsx(nt,{className:"h-8 text-xs",children:n.jsx(at,{})}),n.jsxs(rt,{children:[n.jsx(ot,{value:"instant",children:"Instant Stop"}),n.jsx(ot,{value:"fadeout",children:"Fade Out"}),n.jsx(ot,{value:"brake",children:"Brake"}),n.jsx(ot,{value:"backspin",children:"Backspin"}),n.jsx(ot,{value:"filter",children:"Filter Sweep"})]})]})]})]}),n.jsxs("div",{className:"rounded-lg border p-3 space-y-3 bg-gray-50/60 dark:bg-gray-900/30",children:[n.jsx("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Input & Mapping"}),!l&&n.jsx("p",{className:"text-xs text-red-500",children:"Web MIDI not supported in this browser."}),l&&n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{className:"space-y-0.5",children:[n.jsx(et,{className:"text-xs font-medium",children:"Enable MIDI Input"}),n.jsx("p",{className:"text-[10px] text-gray-500",children:"Turn on MIDI controller input and mapping support."})]}),n.jsx(At,{checked:d,onCheckedChange:v,disabled:!l})]}),n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{className:"space-y-0.5",children:[n.jsx(et,{className:"text-xs font-medium",children:"Hide Keyboard Shortcut"}),n.jsx("p",{className:"text-[10px] text-gray-500",children:"Hide key labels on pad buttons for a cleaner look."})]}),n.jsx(At,{checked:T,onCheckedChange:B})]}),n.jsxs("div",{className:"flex items-center justify-between gap-3",children:[n.jsxs("div",{className:"space-y-0.5",children:[n.jsx(et,{className:"text-xs font-medium",children:"Auto Pad & Bank Mapping"}),n.jsx("p",{className:"text-[10px] text-gray-500",children:"Auto-assign default keyboard mappings on new/imported content."})]}),n.jsx(At,{checked:P,onCheckedChange:R})]}),l&&d&&c&&n.jsxs("div",{className:"space-y-2 border-t pt-3 border-gray-200 dark:border-gray-700",children:[n.jsxs("div",{className:"text-[10px] text-gray-500",children:["Backend: ","native"===u?"Native MIDI":"Web MIDI",!m&&n.jsx("span",{className:"ml-2 text-red-500",children:"LED output not available"})]}),p&&n.jsx("p",{className:"text-xs text-red-500",children:p}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-xs",children:"MIDI Input"}),n.jsxs(tt,{value:f||"",onValueChange:e=>b(e||null),children:[n.jsx(nt,{children:n.jsx(at,{placeholder:"Select device"})}),n.jsxs(rt,{children:[0===h.length&&n.jsx(ot,{value:"none",disabled:!0,children:"No MIDI inputs"}),h.map(e=>n.jsx(ot,{value:e.id,children:e.name||e.id},e.id))]})]})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-xs",children:"Device Profile"}),n.jsxs(tt,{value:H||"__auto__",onValueChange:e=>K("__auto__"===e?null:e),disabled:!m,children:[n.jsx(nt,{children:n.jsx(at,{placeholder:"Auto-detect"})}),n.jsxs(rt,{children:[n.jsx(ot,{value:"__auto__",children:"Auto-detect"}),$.map(e=>n.jsx(ot,{value:e.id,children:e.name},e.id))]})]})]})]})]}),n.jsxs("div",{className:"grid gap-2 sm:grid-cols-2",children:[n.jsxs("div",{className:"rounded-lg border p-3 bg-gray-50/60 dark:bg-gray-900/30",children:[n.jsx("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"User"}),n.jsx("div",{className:"font-medium",children:s})]}),n.jsxs("div",{className:"rounded-lg border p-3 bg-gray-50/60 dark:bg-gray-900/30",children:[n.jsx("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Version"}),n.jsx("div",{className:"font-medium",children:i})]})]}),ne&&se&&n.jsxs("div",{className:"rounded-lg border border-red-300 bg-red-50/60 dark:border-red-700 dark:bg-red-900/20 p-3 space-y-2",children:[n.jsx("div",{className:"text-xs uppercase tracking-wide text-red-600 dark:text-red-300",children:"Account"}),n.jsxs(Te,{type:"button",variant:"outline",className:"w-full border-red-400 text-red-700 hover:bg-red-100 hover:text-red-800 dark:border-red-600 dark:text-red-300 dark:hover:bg-red-900/40 dark:hover:text-red-200",onClick:()=>xe(!0),disabled:ve,children:[n.jsx(ge,{className:"w-4 h-4 mr-2"}),ve?"Signing out...":"Sign Out"]})]})]}),ne&&"system"===oe&&n.jsxs("div",{className:"rounded-lg border p-3 space-y-3",children:[n.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[n.jsx("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"System Mapping"}),n.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:L,children:"Reset All"}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:F,children:"Clear All"})]})]}),de&&n.jsx("div",{className:"text-xs text-red-500",children:de}),n.jsx("div",{className:"space-y-2 sm:hidden",children:Bt.map(e=>{const t=y[e],a=void 0!==t.midiNote||void 0!==t.midiCC,s=gt(`system-${e}-key`);return n.jsxs("div",{className:"rounded-md border p-2 space-y-2",children:[n.jsx("div",{className:"text-xs font-semibold text-gray-700 dark:text-gray-200",children:cn[e]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Keyboard"}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(Je,{value:t.key||"",onKeyDown:Tt(e),placeholder:dn[e].key,readOnly:!0,className:"h-8 text-xs "+(s?"border-red-500 focus-visible:ring-red-500":"")}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-8 px-2 text-[10px]",onClick:()=>{x(e),w(e,void 0,void 0)},children:"Reset"})]}),s&&n.jsx("p",{className:"text-[10px] text-red-500",children:s})]}),Yt&&n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Color"}),n.jsxs(tt,{value:t.color||"__none__",onValueChange:t=>k(e,"__none__"===t?void 0:t),children:[n.jsx(nt,{className:"h-8 text-xs",children:n.jsx(at,{placeholder:"-"})}),n.jsxs(rt,{children:[n.jsx(ot,{value:"__none__",children:"None"}),un.map(e=>n.jsx(ot,{value:e.hex,children:e.name},e.name))]})]})]}),Zt&&n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"MIDI"}),n.jsxs("div",{className:"flex items-center gap-2",children:[!a&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-8 px-2 text-[10px]",onClick:()=>re({type:"system",action:e}),children:"system"===(null==ie?void 0:ie.type)&&ie.action===e?"Listening...":"Learn"}),a&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-8 px-2 text-[10px]",onClick:()=>{w(e,void 0,void 0),ce(null)},children:"Clear"}),n.jsx("span",{className:"text-xs text-gray-500",children:void 0!==t.midiNote?`Note ${t.midiNote}`:void 0!==t.midiCC?`CC ${t.midiCC}`:"-"})]})]})]},`mobile-${e}`)})}),n.jsxs("div",{className:`hidden sm:grid gap-2 text-xs font-medium text-gray-500 grid-cols-1 ${Jt}`,children:[n.jsx("div",{children:"Function"}),n.jsx("div",{children:"Keyboard"}),Yt&&n.jsx("div",{children:"Color"}),Zt&&n.jsx("div",{children:"MIDI"})]}),Bt.map(e=>{const t=y[e],a=void 0!==t.midiNote||void 0!==t.midiCC,s=gt(`system-${e}-key`);return n.jsxs("div",{className:`hidden sm:grid gap-2 items-center grid-cols-1 ${Jt}`,children:[n.jsx("div",{className:"text-xs text-gray-700 dark:text-gray-200",children:cn[e]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(Je,{value:t.key||"",onKeyDown:Tt(e),placeholder:dn[e].key,readOnly:!0,className:"h-7 text-xs "+(s?"border-red-500 focus-visible:ring-red-500":"")}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>{x(e),w(e,void 0,void 0)},children:"Reset"}),s&&n.jsx("p",{className:"text-[10px] text-red-500",children:s})]}),Yt&&n.jsxs(tt,{value:t.color||"__none__",onValueChange:t=>k(e,"__none__"===t?void 0:t),children:[n.jsx(nt,{className:"h-7 text-xs",children:n.jsx(at,{placeholder:"-"})}),n.jsxs(rt,{children:[n.jsx(ot,{value:"__none__",children:"None"}),un.map(e=>n.jsx(ot,{value:e.hex,children:e.name},e.name))]})]}),Zt&&n.jsxs("div",{className:"flex items-center gap-2",children:[!a&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>re({type:"system",action:e}),children:"system"===(null==ie?void 0:ie.type)&&ie.action===e?"Listening...":"Learn"}),a&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>{w(e,void 0,void 0),ce(null)},children:"Clear"}),n.jsx("span",{className:"text-xs text-gray-500",children:void 0!==t.midiNote?`Note ${t.midiNote}`:void 0!==t.midiCC?`CC ${t.midiCC}`:"-"})]})]},e)})]}),ne&&"channels"===oe&&n.jsxs("div",{className:"rounded-lg border p-3 space-y-3",children:[n.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[n.jsx("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Channel Mapping"}),n.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[n.jsxs("div",{className:"flex items-center gap-2 rounded-md border px-2 py-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Deck Channels"}),n.jsxs(tt,{value:String(vt),onValueChange:e=>C(Number(e)),children:[n.jsx(nt,{className:"h-7 w-[72px] text-xs",children:n.jsx(at,{})}),n.jsx(rt,{children:Array.from({length:7},(e,t)=>t+2).map(e=>n.jsx(ot,{value:String(e),children:e},`channel-count-${e}`))})]})]}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:U,children:"Reset All"}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:V,children:"Clear All"})]})]}),ue&&n.jsx("div",{className:"text-xs text-red-500",children:ue}),n.jsxs("div",{className:"space-y-2 sm:hidden",children:[_t.map((e,t)=>{const a=`channel-${t}-keyDown`,s=`channel-${t}-keyStop`,i=gt(`channel-${t}-keyUp`),r=gt(a),o=gt(s);return n.jsxs("div",{className:"rounded-md border p-2 space-y-2",children:[n.jsxs("div",{className:"text-xs font-semibold text-gray-700 dark:text-gray-200",children:["Channel ",t+1]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Volume Up"}),n.jsx(Je,{value:e.keyUp||"",onKeyDown:Pt(t,"keyUp"),placeholder:"-",readOnly:!0,className:"h-8 text-xs "+(i?"border-red-500 focus-visible:ring-red-500":"")}),i&&n.jsx("p",{className:"text-[10px] text-red-500",children:i})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Volume Down"}),n.jsx(Je,{value:e.keyDown||"",onKeyDown:Pt(t,"keyDown"),placeholder:"-",readOnly:!0,className:"h-8 text-xs "+(r?"border-red-500 focus-visible:ring-red-500":"")}),r&&n.jsx("p",{className:"text-[10px] text-red-500",children:r})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Stop"}),n.jsx(Je,{value:e.keyStop||"",onKeyDown:Pt(t,"keyStop"),placeholder:"-",readOnly:!0,className:"h-8 text-xs "+(o?"border-red-500 focus-visible:ring-red-500":"")}),o&&n.jsx("p",{className:"text-[10px] text-red-500",children:o})]}),Zt&&n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"MIDI Note / CC"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[void 0===e.midiNote?n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>re({type:"channel",channelIndex:t}),children:"channel"===(null==ie?void 0:ie.type)&&ie.channelIndex===t?"Listening...":"Learn Note"}):n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>{N(t,{midiNote:void 0}),me(null)},children:"Clear Note"}),void 0===e.midiCC?n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>re({type:"channel",channelIndex:t}),children:"channel"===(null==ie?void 0:ie.type)&&ie.channelIndex===t?"Listening...":"Learn CC"}):n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>{N(t,{midiCC:void 0}),me(null)},children:"Clear CC"}),n.jsxs("span",{className:"text-xs text-gray-500",children:["Note: ",e.midiNote??"-"," / CC: ",e.midiCC??"-"]})]})]})]},`mobile-channel-${t}`)}),n.jsxs("div",{className:"rounded-md border p-2 space-y-2",children:[n.jsx("div",{className:"text-xs font-semibold text-gray-700 dark:text-gray-200",children:"Master"}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Volume Up"}),n.jsx(Je,{value:y.volumeUp.key||"",onKeyDown:Rt("volumeUp"),placeholder:dn.volumeUp.key,readOnly:!0,className:"h-8 text-xs "+(Qt?"border-red-500 focus-visible:ring-red-500":"")}),Qt&&n.jsx("p",{className:"text-[10px] text-red-500",children:Qt})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Volume Down"}),n.jsx(Je,{value:y.volumeDown.key||"",onKeyDown:Rt("volumeDown"),placeholder:dn.volumeDown.key,readOnly:!0,className:"h-8 text-xs "+(ea?"border-red-500 focus-visible:ring-red-500":"")}),ea&&n.jsx("p",{className:"text-[10px] text-red-500",children:ea})]}),n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Mute"}),n.jsx(Je,{value:y.mute.key||"",onKeyDown:Rt("mute"),placeholder:dn.mute.key,readOnly:!0,className:"h-8 text-xs "+(ta?"border-red-500 focus-visible:ring-red-500":"")}),ta&&n.jsx("p",{className:"text-[10px] text-red-500",children:ta}),Zt&&n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[void 0===y.mute.midiNote?n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>re({type:"system",action:"mute"}),children:"system"===(null==ie?void 0:ie.type)&&"mute"===ie.action?"Listening...":"Learn Note"}):n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>{w("mute",void 0,void 0),me(null)},children:"Clear Note"}),n.jsxs("span",{className:"text-xs text-gray-500",children:["Note: ",y.mute.midiNote??"-"]})]})]}),Zt&&n.jsxs("div",{className:"space-y-1",children:[n.jsx(et,{className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Master Volume CC"}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[void 0===y.masterVolumeCC&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>re({type:"masterVolume"}),children:"masterVolume"===(null==ie?void 0:ie.type)?"Listening...":"Learn CC"}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>M(void 0),children:"Clear"}),n.jsxs("span",{className:"text-xs text-gray-500",children:["CC: ",y.masterVolumeCC??"-"]})]})]})]})]}),n.jsxs("div",{className:"hidden sm:grid gap-2 text-xs font-medium text-gray-500 grid-cols-1 "+(Zt?"sm:grid-cols-5":"sm:grid-cols-4"),children:[n.jsx("div",{children:"Channel"}),n.jsx("div",{children:"Vol +"}),n.jsx("div",{children:"Vol -"}),n.jsx("div",{children:"Stop"}),Zt&&n.jsx("div",{children:"MIDI CC"})]}),_t.map((e,t)=>{const a=`channel-${t}-keyDown`,s=`channel-${t}-keyStop`,i=gt(`channel-${t}-keyUp`),r=gt(a),o=gt(s);return n.jsxs("div",{className:"hidden sm:grid gap-2 items-center grid-cols-1 "+(Zt?"sm:grid-cols-5":"sm:grid-cols-4"),children:[n.jsxs("div",{className:"text-xs text-gray-700 dark:text-gray-200",children:["CH ",t+1]}),n.jsxs("div",{children:[n.jsx(Je,{value:e.keyUp||"",onKeyDown:Pt(t,"keyUp"),placeholder:"-",readOnly:!0,className:"h-7 text-xs "+(i?"border-red-500 focus-visible:ring-red-500":"")}),i&&n.jsx("p",{className:"text-[10px] text-red-500 mt-1",children:i})]}),n.jsxs("div",{children:[n.jsx(Je,{value:e.keyDown||"",onKeyDown:Pt(t,"keyDown"),placeholder:"-",readOnly:!0,className:"h-7 text-xs "+(r?"border-red-500 focus-visible:ring-red-500":"")}),r&&n.jsx("p",{className:"text-[10px] text-red-500 mt-1",children:r})]}),n.jsxs("div",{className:"flex flex-col gap-1",children:[n.jsx(Je,{value:e.keyStop||"",onKeyDown:Pt(t,"keyStop"),placeholder:"-",readOnly:!0,className:"h-6 text-[10px] px-2 "+(o?"border-red-500 focus-visible:ring-red-500":"")}),o&&n.jsx("p",{className:"text-[10px] text-red-500",children:o}),Zt&&n.jsxs("div",{className:"flex items-center gap-1",children:[void 0===e.midiNote&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-6 px-1 text-[9px]",onClick:()=>re({type:"channel",channelIndex:t}),children:"channel"===(null==ie?void 0:ie.type)&&ie.channelIndex===t?"Listening...":"Learn Note"}),void 0!==e.midiNote&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-6 px-1 text-[9px]",onClick:()=>{N(t,{midiNote:void 0}),me(null)},children:"Clear"}),n.jsx("span",{className:"text-[10px] text-gray-500",children:e.midiNote??"-"})]})]}),Zt&&n.jsx("div",{className:"flex flex-col gap-1",children:n.jsxs("div",{className:"flex items-center gap-1",children:[void 0===e.midiCC&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-6 px-1 text-[9px]",onClick:()=>re({type:"channel",channelIndex:t}),children:"channel"===(null==ie?void 0:ie.type)&&ie.channelIndex===t?"Listening...":"Learn CC"}),void 0!==e.midiCC&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-6 px-1 text-[9px]",onClick:()=>{N(t,{midiCC:void 0}),me(null)},children:"Clear"}),n.jsx("span",{className:"text-[10px] text-gray-500",children:e.midiCC??"-"})]})})]},`channel-${t}`)}),n.jsxs("div",{className:"hidden sm:grid gap-2 items-center grid-cols-1 "+(Zt?"sm:grid-cols-5":"sm:grid-cols-4"),children:[n.jsx("div",{className:"text-xs text-gray-700 dark:text-gray-200",children:"Master"}),n.jsxs("div",{children:[n.jsx(Je,{value:y.volumeUp.key||"",onKeyDown:Rt("volumeUp"),placeholder:dn.volumeUp.key,readOnly:!0,className:"h-7 text-xs "+(Qt?"border-red-500 focus-visible:ring-red-500":"")}),Qt&&n.jsx("p",{className:"text-[10px] text-red-500 mt-1",children:Qt})]}),n.jsxs("div",{children:[n.jsx(Je,{value:y.volumeDown.key||"",onKeyDown:Rt("volumeDown"),placeholder:dn.volumeDown.key,readOnly:!0,className:"h-7 text-xs "+(ea?"border-red-500 focus-visible:ring-red-500":"")}),ea&&n.jsx("p",{className:"text-[10px] text-red-500 mt-1",children:ea})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(Je,{value:y.mute.key||"",onKeyDown:Rt("mute"),placeholder:dn.mute.key,readOnly:!0,className:"h-7 text-xs "+(ta?"border-red-500 focus-visible:ring-red-500":"")}),ta&&n.jsx("p",{className:"text-[10px] text-red-500",children:ta}),Zt&&void 0===y.mute.midiNote&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>re({type:"system",action:"mute"}),children:"system"===(null==ie?void 0:ie.type)&&"mute"===ie.action?"Listening...":"Learn Note"}),Zt&&void 0!==y.mute.midiNote&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>{w("mute",void 0,void 0),me(null)},children:"Clear"}),Zt&&n.jsx("span",{className:"text-xs text-gray-500",children:y.mute.midiNote??"-"})]}),Zt&&n.jsxs("div",{className:"flex items-center gap-2",children:[void 0===y.masterVolumeCC&&n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>re({type:"masterVolume"}),children:"masterVolume"===(null==ie?void 0:ie.type)?"Listening...":"Learn CC"}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",className:"h-7 px-2 text-[10px]",onClick:()=>M(void 0),children:"Clear"}),n.jsx("span",{className:"text-xs text-gray-500",children:y.masterVolumeCC??"-"})]})]})]}),ne&&"backup"===oe&&n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{className:"rounded-lg border p-3 space-y-1 bg-gray-50/60 dark:bg-gray-900/30",children:[n.jsx("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"üéßüî• About Us - VDJV Sampler Pad üî•üéß"}),n.jsxs("div",{className:"space-y-2 text-xs text-gray-600 dark:text-gray-300",children:[n.jsx("p",{children:"Welcome, ka-Power! üí™"}),n.jsxs("p",{children:[n.jsx("strong",{children:"VDJV Sampler Pad"})," is a powerful and user-friendly DJ soundboard system designed for hosts, DJs, event organizers, content creators, and anyone who wants to level up events and performances."]}),n.jsx("p",{children:"We are an independent development team focused on practical, affordable, and professional-grade sampler pad solutions, especially tailored for the Filipino market."}),n.jsxs("div",{children:[n.jsx("p",{className:"font-semibold",children:"üéõÔ∏è What Is VDJV Sampler Pad?"}),n.jsx("p",{className:"mt-1",children:"Customizable soundboard with ready-to-use banks such as:"}),n.jsx("p",{children:"üé∂ Background Drops (Budots, Chacha, Beat Drops)"}),n.jsx("p",{children:"üòÇ Sound Effects (Laugh, Horn, DJ Voice, Anime)"}),n.jsx("p",{children:"üéÇ Birthday & Event Sounds"}),n.jsx("p",{children:"üèÜ Competition & Awarding"}),n.jsx("p",{children:"üéÆ Games & Memes"}),n.jsx("p",{children:"üéÑ Seasonal Events (Christmas, Graduation, Halloween)"}),n.jsx("p",{children:"üéµ TikTok Banks (2022-2025 Editions)"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"font-semibold",children:"Available Versions"}),n.jsx("p",{children:"üî• V1 (Android Version) - Standalone app, no laptop required"}),n.jsx("p",{children:"üî• V2 - Laptop-based version with remote control support"}),n.jsx("p",{children:"üî• V3 (Complete Pack) - Full features, complete banks, advanced effects, and remote app support"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"font-semibold",children:"üöÄ Mission"}),n.jsx("p",{children:"‚úîÔ∏è Affordable alternative to expensive DJ hardware samplers"}),n.jsx("p",{children:"‚úîÔ∏è Beginner-friendly setup"}),n.jsx("p",{children:"‚úîÔ∏è Professional tools for hosts and DJs"}),n.jsx("p",{children:"‚úîÔ∏è FREE TeamViewer installation assistance"})]}),n.jsxs("div",{children:[n.jsx("p",{className:"font-semibold",children:"ü§ù Why Choose VDJV?"}),n.jsx("p",{children:"üí° Beginner-friendly"}),n.jsx("p",{children:"üíª Professional-grade features"}),n.jsx("p",{children:"üì± Remote control via phone/tablet (V2 & V3)"}),n.jsx("p",{children:"üõ†Ô∏è FREE TeamViewer installation assistance"}),n.jsx("p",{children:"üéß Regular updates and new sound banks"})]}),n.jsx("p",{children:"üé§ At VDJV, this isn't just a sampler pad - it's a tool to make your events more dynamic, engaging, and unforgettable."}),n.jsx("p",{children:"Thank you for your support, ka-Power! ‚ö° More power! üí™üî•"})]})]}),n.jsxs("div",{className:"rounded-lg border p-3 space-y-2",children:[n.jsx("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Mapping Backup"}),he&&n.jsx("div",{className:"text-xs "+("success"===he.type?"text-green-600 dark:text-green-400":"text-red-500"),children:he.message}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:Dt,children:"Export Mappings"}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:Ot,children:"Import Mappings"}),n.jsx("input",{ref:st,type:"file",accept:"application/json",className:"hidden",onChange:Lt})]})]}),n.jsxs("div",{className:"rounded-lg border p-3 space-y-2",children:[n.jsx("div",{className:"text-xs uppercase tracking-wide text-gray-500",children:"App Backup"}),n.jsx("p",{className:"text-xs text-gray-500",children:"Encrypted account-bound full backup with banks, media, arrangement, settings, and mappings. Large exports may generate one manifest plus multiple part files."}),pe&&n.jsx("div",{className:"text-xs "+("success"===pe.type?"text-green-600 dark:text-green-400":"text-red-500"),children:pe.message}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:Vt,disabled:Qe,children:"Export Full Backup"}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:Kt,disabled:Qe,children:"Restore from Backup"}),n.jsx(Te,{type:"button",variant:"outline",size:"sm",onClick:Gt,disabled:Qe,children:"Recover Missing (.bank)"})]}),n.jsx("input",{ref:it,type:"file",accept:".vdjvbackup,.vdjvpart,.json,application/octet-stream,application/json",multiple:!0,className:"hidden",onChange:qt}),n.jsx("input",{ref:lt,type:"file",accept:".bank,application/zip,application/octet-stream,*/*",multiple:!0,className:"hidden",onChange:Xt})]})]})]})]}),n.jsx(Nt,{open:Be,onOpenChange:Pe,title:Ve,description:He,progress:Re,status:Oe,type:Fe,theme:r,errorMessage:ze,hideCloseButton:!0}),n.jsx(dt,{open:we,onOpenChange:ke,title:"Export Full Backup",description:"Export encrypted full backup now? This can take time on large libraries.",confirmText:"Export Backup",onConfirm:$t,theme:r}),n.jsx(dt,{open:Me,onOpenChange:Se,title:"Export In Risk Mode?",description:Ce?`${Ce} Continue anyway by skipping storage preflight? This may fail if the device runs out of space.`:"Continue by skipping storage preflight? This may fail if the device runs out of space.",confirmText:"Continue Risk Mode",variant:"destructive",onConfirm:Ht,theme:r}),n.jsx(dt,{open:Ae,onOpenChange:Ee,title:"Restore Backup",description:Ie?`Restore from "${Ie.manifestFile.name}"${Ie.companionFiles.length?` with ${Ie.companionFiles.length} companion file(s)`:""}? Current local data will be replaced.`:"Restore selected backup now?",confirmText:"Restore Backup",variant:"destructive",onConfirm:zt,theme:r}),n.jsx(dt,{open:_e,onOpenChange:xe,title:"Sign out",description:"Are you sure you want to sign out?",confirmText:ve?"Signing out...":"Sign out",variant:"destructive",onConfirm:Wt,theme:r})]})}function hn({notices:e,dismiss:t,theme:a}){return"undefined"==typeof document?null:R.createPortal(n.jsx("div",{className:"fixed top-0 left-0 right-0 z-[2147483647] flex justify-center pointer-events-none",children:n.jsx("div",{className:"w-full max-w-xl px-3",children:e.map(e=>n.jsx(fn,{notice:e,dismiss:t,theme:a},e.id))})}),document.body)}function fn({notice:e,dismiss:t,theme:s}){const[i,r]=a.useState(!1);a.useEffect(()=>{const e=setTimeout(()=>r(!0),10);return()=>clearTimeout(e)},[]);const o="success"===e.variant?"dark"===s?"bg-green-600/90 border-green-500 text-white":"bg-green-600 text-white border-green-700":"error"===e.variant?"dark"===s?"bg-red-600/90 border-red-500 text-white":"bg-red-600 text-white border-red-700":"dark"===s?"bg-gray-800/90 border-gray-700 text-white":"bg-gray-900 text-white border-gray-800";return n.jsx("div",{className:`pointer-events-auto mt-3 rounded-lg border px-4 py-2 shadow-lg transition-all duration-300 ${o} ${i?"opacity-100 translate-y-0":"opacity-0 -translate-y-3"}`,onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!0),children:n.jsxs("div",{className:"flex items-start gap-3",children:[n.jsx("div",{className:"flex-1 text-sm",children:e.message}),n.jsx("button",{className:"text-white/80 hover:text-white",onClick:()=>t(e.id),"aria-label":"Dismiss",children:"√ó"})]})})}function pn({primaryBank:e,secondaryBank:t,currentBank:s,isDualMode:i,padSize:r,stopMode:o,editMode:l,globalMuted:d,sideMenuOpen:c,mixerOpen:u,theme:m,windowWidth:h,onFileUpload:f,onToggleEditMode:p,onToggleMute:g,onStopAll:b,onToggleSideMenu:v,onToggleMixer:y,onToggleTheme:_,onExitDualMode:x,onPadSizeChange:w,onStopModeChange:k,midiSupported:M,midiEnabled:S,midiAccessGranted:C,midiBackend:N,midiOutputSupported:A,midiInputs:E,midiSelectedInputId:I,midiError:j,onRequestMidiAccess:T,onSelectMidiInput:B,onToggleMidiEnabled:P,systemMappings:R,onUpdateSystemKey:D,onResetSystemKey:O,onUpdateSystemMidi:L,onUpdateSystemColor:F,onSetMasterVolumeCC:V,channelCount:$,onChangeChannelCount:H,onUpdateChannelMapping:K,padBankShortcutKeys:q,padBankMidiNotes:z,padBankMidiCCs:G,midiNoteAssignments:X,hideShortcutLabels:W,onToggleHideShortcutLabels:Z,autoPadBankMapping:J,onToggleAutoPadBankMapping:Q,sidePanelMode:te,onChangeSidePanelMode:ae,onResetAllSystemMappings:ne,onClearAllSystemMappings:se,onResetAllChannelMappings:ie,onClearAllChannelMappings:re,midiDeviceProfiles:oe,midiDeviceProfileId:le,onSelectMidiDeviceProfile:ce,onExportMappings:ue,onImportMappings:me,onExportAppBackup:he,onRestoreAppBackup:fe,onRecoverMissingMediaFromBanks:pe}){var ge;const ke=a.useRef(null),{user:Me,profile:Se,loading:Ce,signOut:Ne}=Qa(),Ae="admin"===(null==Se?void 0:Se.role),[Ee,Ie]=a.useState(!1),[je,Be]=a.useState(null),[Pe,Re]=a.useState(!1),[De,Oe]=a.useState(!1);a.useEffect(()=>{Ae&&!je&&U(()=>import("./AdminAccessDialog-CsgmN8Q-.js"),__vite__mapDeps([0,1,2,3,4])).then(e=>{Be(()=>e.AdminAccessDialog)}).catch(e=>{console.error("Failed to load AdminAccessDialog:",e)})},[Ae,je]);const{notices:Le,pushNotice:Fe,dismiss:Ue}=function(){const[e,t]=a.useState([]),n=a.useCallback(e=>{const a="undefined"!=typeof crypto&&"randomUUID"in crypto?crypto.randomUUID():String(Date.now()+Math.random()),n={id:a,...e};t(e=>[n,...e]),setTimeout(()=>s(a),4e3)},[]),s=a.useCallback(e=>{t(t=>t.filter(t=>t.id!==e))},[]);return{notices:e,pushNotice:n,dismiss:s}}(),Ve=a.useRef(null);a.useEffect(()=>{const e=()=>Re(!0);return window.addEventListener("vdjv-login-request",e),()=>window.removeEventListener("vdjv-login-request",e)},[]),a.useEffect(()=>{const e=()=>Oe(!0);return window.addEventListener("vdjv-open-about",e),()=>window.removeEventListener("vdjv-open-about",e)},[]),a.useEffect(()=>{var e;const t=(null==Me?void 0:Me.id)||null;if(t&&Ve.current!==t&&Se){const t=Xe(),a=Se.display_name||(null==(e=null==Me?void 0:Me.email)?void 0:e.split("@")[0])||"User";Fe({variant:"success",message:`${t}, ${a}! Welcome back.`})}Ve.current=t},[Me,Se,Fe]);const $e=a.useCallback(async()=>{const{error:e}=await Ne();Fe(e?{variant:"error",message:e.message||"Sign out failed."}:{variant:"success",message:"Signed out."})},[Ne,Fe]),He=h<1160,Ke=Me||Fa(),qe=Boolean(Ke),ze=h<768?6:14,Ge=i?2:1,Xe=()=>{const e=(new Date).getHours();return e<12?"Good morning":e<18?"Good afternoon":"Good evening"},We=(null==Se?void 0:Se.display_name)||(null==(ge=null==Ke?void 0:Ke.email)?void 0:ge.split("@")[0])||"Guest",Ye=a.useCallback(e=>{let t=Math.max(Ge,Math.min(ze,e));i&&t%2!=0&&(t<ze?t+=1:t>Ge&&(t-=1)),w(t)},[i,ze,Ge,w]),Ze=()=>i?`${(null==e?void 0:e.name)||"None"} | ${(null==t?void 0:t.name)||"None"}`:(null==s?void 0:s.name)||"No bank selected";return n.jsxs(n.Fragment,{children:[n.jsx(hn,{notices:Le,dismiss:Ue,theme:m}),n.jsx("input",{ref:ke,type:"file",accept:"audio/*",multiple:!0,onChange:async e=>{const t=e.target.files;if(t&&t.length>0){for(let e=0;e<t.length;e++){const n=t[e];if(n.type.startsWith("audio/"))try{await f(n)}catch(a){console.error("Failed to upload file:",n.name,a)}}ke.current&&(ke.current.value="")}},className:"hidden",id:"global-audio-upload-input"}),n.jsxs("header",{className:"sticky top-0 z-40 text-center mb-2 backdrop-blur-sm "+("dark"===m?"bg-gray-900/70":"bg-white/70"),children:[n.jsx("div",{className:"mb-1 text-sm "+("dark"===m?"text-gray-300":"text-gray-600"),children:i?n.jsxs("div",{className:"flex items-center justify-center gap-2 min-w-0 px-2 whitespace-nowrap",children:[n.jsx("span",{className:"text-blue-600 font-medium shrink-0",children:"Primary:"}),n.jsx("span",{className:"min-w-0 max-w-[26vw] sm:max-w-[32vw] truncate",title:(null==e?void 0:e.name)||"None",children:(null==e?void 0:e.name)||"None"}),n.jsx("span",{className:"text-gray-400",children:"|"}),n.jsx("span",{className:"text-purple-600 font-medium shrink-0",children:"Secondary (SHIFT):"}),n.jsx("span",{className:"min-w-0 max-w-[26vw] sm:max-w-[32vw] truncate",title:(null==t?void 0:t.name)||"None",children:(null==t?void 0:t.name)||"None"})]}):n.jsxs("span",{className:"inline-block max-w-[90vw] truncate align-middle",title:Ze(),children:["Bank: ",Ze()]})}),n.jsxs("div",{className:"flex flex-wrap justify-center gap-2 mb-2",children:[n.jsxs(Te,{onClick:v,variant:"outline",size:He?"sm":"default",className:`${He?"w-10":"w-24"} transition-all duration-200 ${c?"dark"===m?"bg-indigo-500 border-indigo-400 text-indigo-300":"bg-indigo-50 border-indigo-300 text-indigo-600":"dark"===m?"bg-gray-700 border-gray-600 text-gray-300 hover:bg-indigo-500 hover:border-indigo-400 hover:text-indigo-300":"bg-white border-gray-300 text-gray-700 hover:bg-indigo-50 hover:border-indigo-300 hover:text-indigo-600"}`,children:[n.jsx(be,{className:"w-4 h-4"}),!He&&(He?"":"Banks")]}),n.jsxs(Te,{onClick:()=>{var e;null==(e=ke.current)||e.click()},variant:"outline",size:He?"sm":"default",className:`${He?"w-10":"w-24"} transition-all duration-200 ${"dark"===m?"bg-gray-700 border-gray-600 text-gray-300 hover:bg-teal-500 hover:border-teal-400 hover:text-teal-300":"bg-white border-gray-300 text-gray-700 hover:bg-teal-50 hover:border-teal-300 hover:text-teal-600"}`,children:[n.jsx(de,{className:"w-4 h-4"}),!He&&(He?"":"Upload")]}),n.jsxs(Te,{onClick:p,variant:"outline",size:He?"sm":"default",className:`${He?"w-10":"w-24"} transition-all duration-200 ${l?"dark"===m?"bg-orange-500 border-orange-400 text-orange-300":"bg-orange-50 border-orange-300 text-orange-600":"dark"===m?"bg-gray-700 border-gray-600 text-gray-300 hover:bg-orange-500 hover:border-orange-400 hover:text-orange-300":"bg-white border-gray-300 text-gray-700 hover:bg-orange-50 hover:border-orange-300 hover:text-orange-600"}`,children:[n.jsx(ve,{className:"w-4 h-4"}),!He&&(He?"":l?"Exit Edit":"Edit")]}),n.jsxs(Te,{onClick:g,variant:"outline",size:He?"sm":"default",className:`${He?"w-10":"w-24"} transition-all duration-200 ${d?"dark"===m?"bg-red-500 border-red-400 text-red-300":"bg-red-50 border-red-300 text-red-600":"dark"===m?"bg-gray-700 border-gray-600 text-gray-300 hover:bg-purple-500 hover:border-purple-400 hover:text-purple-300":"bg-white border-gray-300 text-gray-700 hover:bg-purple-50 hover:border-purple-300 hover:text-purple-600"}`,children:[d?n.jsx(ee,{className:"w-4 h-4"}):n.jsx(ye,{className:"w-4 h-4"}),!He&&(He?"":d?"Unmute":"Mute")]}),n.jsxs(Te,{onClick:b,variant:"outline",size:He?"sm":"default",className:`${He?"w-10":"w-24"} transition-all duration-200 ${"dark"===m?"bg-red-500 border-red-400 text-red-400 hover:bg-red-600":"bg-red-50 border-red-300 text-red-600 hover:bg-red-100"}`,children:[n.jsx(Y,{className:"w-4 h-4"}),!He&&(He?"":"Stop All")]}),n.jsxs(Te,{onClick:y,variant:"outline",size:He?"sm":"default",className:`${He?"w-10":"w-24"} transition-all duration-200 ${u?"dark"===m?"bg-green-500 border-green-400 text-green-300":"bg-green-50 border-green-300 text-green-600":"dark"===m?"bg-gray-700 border-gray-600 text-gray-300 hover:bg-green-500 hover:border-green-400 hover:text-green-300":"bg-white border-gray-300 text-gray-700 hover:bg-green-50 hover:border-green-300 hover:text-green-600"}`,children:[n.jsx(_e,{className:"w-4 h-4"}),!He&&(He?"":"Mixer")]}),!Ce&&!qe&&n.jsxs(Te,{onClick:()=>Re(!0),variant:"outline",size:He?"sm":"default",disabled:Ce,className:"w-24 transition-all duration-200 "+("dark"===m?"bg-blue-600/20 border-blue-500 text-blue-300 hover:bg-blue-500 hover:border-blue-400 hover:text-blue-200":"bg-blue-50 border-blue-300 text-blue-600 hover:bg-blue-100 hover:border-blue-400 hover:text-blue-700"),title:"Sign in to your account",children:[n.jsx(xe,{className:"w-4 h-4"}),n.jsx("span",{className:"ml-1",children:"Login"})]}),Ae&&n.jsxs(Te,{onClick:()=>Ie(!0),variant:"outline",size:He?"sm":"default",className:`${He?"w-10":"w-40"} transition-all duration-200 ${"dark"===m?"bg-gray-700 border-gray-600 text-gray-300 hover:bg-yellow-500 hover:border-yellow-400 hover:text-yellow-200":"bg-white border-gray-300 text-gray-700 hover:bg-yellow-50 hover:border-yellow-300 hover:text-yellow-700"}`,title:"Manage bank access",children:[n.jsx(we,{className:"w-4 h-4"}),!He&&"Admin Access"]})]})]}),Ae&&je&&n.jsx(je,{open:Ee,onOpenChange:Ie,theme:m}),n.jsx(mn,{open:De,onOpenChange:Oe,displayName:We,version:"1.02.19.26.0221",theme:m,onToggleTheme:_,midiSupported:M,midiEnabled:S,midiAccessGranted:C,midiBackend:N,midiOutputSupported:A,midiInputs:E,midiSelectedInputId:I,midiError:j,onRequestMidiAccess:T,onSelectMidiInput:B,onToggleMidiEnabled:P,systemMappings:R,onUpdateSystemKey:D,onResetSystemKey:O,onUpdateSystemMidi:L,onUpdateSystemColor:F,onSetMasterVolumeCC:V,channelCount:$,onChangeChannelCount:H,onUpdateChannelMapping:K,padBankShortcutKeys:q,padBankMidiNotes:z,padBankMidiCCs:G,midiNoteAssignments:X,hideShortcutLabels:W,onToggleHideShortcutLabels:Z,autoPadBankMapping:J,onToggleAutoPadBankMapping:Q,sidePanelMode:te,onChangeSidePanelMode:ae,onResetAllSystemMappings:ne,onClearAllSystemMappings:se,onResetAllChannelMappings:ie,onClearAllChannelMappings:re,midiDeviceProfiles:oe,midiDeviceProfileId:le,onSelectMidiDeviceProfile:ce,onExportMappings:ue,onImportMappings:me,onExportAppBackup:he,onRestoreAppBackup:fe,onRecoverMissingMediaFromBanks:pe,isDualMode:i,padSize:r,stopMode:o,padSizeMin:Ge,padSizeMax:ze,onPadSizeChange:Ye,onStopModeChange:k,isAuthenticated:qe,onSignOut:$e}),n.jsx(ln,{open:Pe,onOpenChange:Re,theme:m,pushNotice:Fe})]})}const gn=L(ke());var bn,vn,yn,_n,xn,wn,kn,Mn,Sn,Cn,Nn,An,En,In,jn,Tn,Bn,Pn,Rn,Dn,On,Ln,Fn,Un,Vn,$n,Hn,Kn,qn,zn,Gn,Xn,Wn,Yn,Zn,Jn,Qn,es,ts,as,ns,ss,is,rs,os,ls,ds,cs,us,ms,hs,fs,ps,gs,bs,vs,ys,_s,xs,ws,ks,Ms,Ss,Cs,Ns,As,Es,Is,js,Ts={};function Bs(){if(vn)return bn;function e(e){return new Int16Array(e)}function t(e){return new Int32Array(e)}function a(e){return new Float32Array(e)}vn=1;var n={fill:function(e,t,a,n){if(2==arguments.length)for(var s=0;s<e.length;s++)e[s]=arguments[1];else for(s=t;s<a;s++)e[s]=n}},s={arraycopy:function(e,t,a,n,s){for(var i=t+s;t<i;)a[n++]=e[t++]},out:{}};s.out.println=function(e){console.log(e)},s.out.printf=function(){console.log.apply(console,arguments)};var i={};function r(e){this.ordinal=e}i.SQRT2=1.4142135623730951,i.FAST_LOG10=function(e){return Math.log10(e)},i.FAST_LOG10_X=function(e,t){return Math.log10(e)*t},r.short_block_allowed=new r(0),r.short_block_coupled=new r(1),r.short_block_dispensed=new r(2),r.short_block_forced=new r(3);var o={};function l(e){this.ordinal=e}o.MAX_VALUE=34028235e31,l.vbr_off=new l(0),l.vbr_mt=new l(1),l.vbr_rh=new l(2),l.vbr_abr=new l(3),l.vbr_mtrh=new l(4),l.vbr_default=l.vbr_mtrh;return bn={System:s,VbrMode:l,Float:o,ShortBlock:r,Util:i,Arrays:n,new_array_n:function e(t){if(1==t.length)return new Array(t[0]);var a=t[0];t=t.slice(1);for(var n=[],s=0;s<a;s++)n.push(e(t));return n},new_byte:function(e){return new Int8Array(e)},new_double:function(e){return new Float64Array(e)},new_float:a,new_float_n:function e(t){if(1==t.length)return a(t[0]);var n=t[0];t=t.slice(1);for(var s=[],i=0;i<n;i++)s.push(e(t));return s},new_int:t,new_int_n:function e(a){if(1==a.length)return t(a[0]);var n=a[0];a=a.slice(1);for(var s=[],i=0;i<n;i++)s.push(e(a));return s},new_short:e,new_short_n:function t(a){if(1==a.length)return e(a[0]);var n=a[0];a=a.slice(1);for(var s=[],i=0;i<n;i++)s.push(t(a));return s},assert:function(e){}},bn}function Ps(){if(wn)return xn;wn=1;var e=Rs(),t=Bs(),a=t.System;t.VbrMode,t.Float,t.ShortBlock,t.Util,t.Arrays,t.new_array_n,t.new_byte,t.new_double;var n=t.new_float,s=t.new_float_n;return t.new_int,t.new_int_n,t.assert,xn=function(){this.l=n(e.SBMAX_l),this.s=s([e.SBMAX_s,3]);var t=this;this.assign=function(n){a.arraycopy(n.l,0,t.l,0,e.SBMAX_l);for(var s=0;s<e.SBMAX_s;s++)for(var i=0;i<3;i++)t.s[s][i]=n.s[s][i]}}}function Rs(){if(Cn)return Sn;Cn=1;var e=Bs(),t=e.System,a=e.VbrMode;e.Float,e.ShortBlock,e.Util,e.Arrays;var n=e.new_array_n;e.new_byte,e.new_double;var s=e.new_float,i=e.new_float_n,r=e.new_int;e.new_int_n;var o=e.assert;function l(){var e=function(){if(_n)return yn;_n=1;var e=Bs(),t=e.System;e.VbrMode,e.Float,e.ShortBlock;var a=e.Util,n=e.Arrays;e.new_array_n,e.new_byte,e.new_double;var s=e.new_float;e.new_float_n,e.new_int,e.new_int_n,e.assert;var i=Rs();return yn=function(){var e=[-.1482523854003001,32.308141959636465,296.40344946382766,883.1344870032432,11113.947376231741,1057.2713659324597,305.7402417275812,30.825928907280012,3.8533188138216365,59.42900443849514,709.5899960123345,5281.91112291017,-5829.66483675846,-817.6293103748613,-76.91656988279972,-4.594269939176596,.9063471690191471,.1960342806591213,-.15466694054279598,34.324387823855965,301.8067566458425,817.599602898885,11573.795901679885,1181.2520595540152,321.59731579894424,31.232021761053772,3.7107095756221318,53.650946155329365,684.167428119626,5224.56624370173,-6366.391851890084,-908.9766368219582,-89.83068876699639,-5.411397422890401,.8206787908286602,.3901806440322567,-.16070888947830023,36.147034243915876,304.11815768187864,732.7429163887613,11989.60988270091,1300.012278487897,335.28490093152146,31.48816102859945,3.373875931311736,47.232241542899175,652.7371796173471,5132.414255594984,-6909.087078780055,-1001.9990371107289,-103.62185754286375,-6.104916304710272,.7416505462720353,.5805693545089249,-.16636367662261495,37.751650073343995,303.01103387567713,627.9747488785183,12358.763425278165,1412.2779918482834,346.7496836825721,31.598286663170416,3.1598635433980946,40.57878626349686,616.1671130880391,5007.833007176154,-7454.040671756168,-1095.7960341867115,-118.24411666465777,-6.818469345853504,.6681786379192989,.7653668647301797,-.1716176790982088,39.11551877123304,298.3413246578966,503.5259106886539,12679.589408408976,1516.5821921214542,355.9850766329023,31.395241710249053,2.9164211881972335,33.79716964664243,574.8943997801362,4853.234992253242,-7997.57021486075,-1189.7624067269965,-133.6444792601766,-7.7202770609839915,.5993769336819237,.9427934736519954,-.17645823955292173,40.21879108166477,289.9982036694474,359.3226160751053,12950.259102786438,1612.1013903507662,362.85067106591504,31.045922092242872,2.822222032597987,26.988862316190684,529.8996541764288,4671.371946949588,-8535.899136645805,-1282.5898586244496,-149.58553632943463,-8.643494270763135,.5345111359507916,1.111140466039205,-.36174739330527045,41.04429910497807,277.5463268268618,195.6386023135583,13169.43812144731,1697.6433561479398,367.40983966190305,30.557037410382826,2.531473372857427,20.070154905927314,481.50208566532336,4464.970341588308,-9065.36882077239,-1373.62841526722,-166.1660487028118,-9.58289321133207,.4729647758913199,1.268786568327291,-.36970682634889585,41.393213350082036,261.2935935556502,12.935476055240873,13336.131683328815,1772.508612059496,369.76534388639965,29.751323653701338,2.4023193045459172,13.304795348228817,430.5615775526625,4237.0568611071185,-9581.931701634761,-1461.6913552409758,-183.12733958476446,-10.718010163869403,.41421356237309503,1.414213562373095,-.37677560326535325,41.619486213528496,241.05423794991074,-187.94665032361226,13450.063605744153,1836.153896465782,369.4908799925761,29.001847876923147,2.0714759319987186,6.779591200894186,377.7767837205709,3990.386575512536,-10081.709459700915,-1545.947424837898,-200.3762958015653,-11.864482073055006,.3578057213145241,1.546020906725474,-.3829366947518991,41.1516456456653,216.47684307105183,-406.1569483347166,13511.136535077321,1887.8076599260432,367.3025214564151,28.136213436723654,1.913880671464418,.3829366947518991,323.85365704338597,3728.1472257487526,-10561.233882199509,-1625.2025997821418,-217.62525175416,-13.015432208941645,.3033466836073424,1.66293922460509,-.5822628872992417,40.35639251440489,188.20071124269245,-640.2706748618148,13519.21490106562,1927.6022433578062,362.8197642637487,26.968821921868447,1.7463817695935329,-5.62650678237171,269.3016715297017,3453.386536448852,-11016.145278780888,-1698.6569643425091,-234.7658734267683,-14.16351421663124,.2504869601913055,1.76384252869671,-.5887180101749253,39.23429103868072,155.76096234403798,-889.2492977967378,13475.470561874661,1955.0535223723712,356.4450994756727,25.894952980042156,1.5695032905781554,-11.181939564328772,214.80884394039484,3169.1640829158237,-11443.321309975563,-1765.1588461316153,-251.68908574481912,-15.49755935939164,.198912367379658,1.847759065022573,-.7912582233652842,37.39369355329111,119.699486012458,-1151.0956593239027,13380.446257078214,1970.3952110853447,348.01959814116185,24.731487364283044,1.3850130831637748,-16.421408865300393,161.05030052864092,2878.3322807850063,-11838.991423510031,-1823.985884688674,-268.2854986386903,-16.81724543849939,.1483359875383474,1.913880671464418,-.7960642926861912,35.2322109610459,80.01928065061526,-1424.0212633405113,13235.794061869668,1973.804052543835,337.9908651258184,23.289159354463873,1.3934255946442087,-21.099669467133474,108.48348407242611,2583.700758091299,-12199.726194855148,-1874.2780658979746,-284.2467154529415,-18.11369784385905,.09849140335716425,1.961570560806461,-.998795456205172,32.56307803611191,36.958364584370486,-1706.075448829146,13043.287458812016,1965.3831106103316,326.43182772364605,22.175018750622293,1.198638339011324,-25.371248002043963,57.53505923036915,2288.41886619975,-12522.674544337233,-1914.8400385312243,-299.26241273417224,-19.37805630698734,.04912684976946725,1.990369453344394,.035780907*a.SQRT2*.5/2384e-9,.017876148*a.SQRT2*.5/2384e-9,.003134727*a.SQRT2*.5/2384e-9,.002457142*a.SQRT2*.5/2384e-9,971317e-9*a.SQRT2*.5/2384e-9,218868e-9*a.SQRT2*.5/2384e-9,101566e-9*a.SQRT2*.5/2384e-9,13828e-9*a.SQRT2*.5/2384e-9,12804.797818791945,1945.5515939597317,313.4244966442953,20.801593959731544,1995.1556208053692,9.000838926174497,-29.20218120805369],r=[[2382191739347913e-28,6423305872147834e-28,9400849094049688e-28,1122435026096556e-27,1183840321267481e-27,1122435026096556e-27,940084909404969e-27,6423305872147839e-28,2382191739347918e-28,5456116108943412e-27,4878985199565852e-27,4240448995017367e-27,3559909094758252e-27,2858043359288075e-27,2156177623817898e-27,1475637723558783e-27,8371015190102974e-28,2599706096327376e-28,-5456116108943412e-27,-4878985199565852e-27,-4240448995017367e-27,-3559909094758252e-27,-2858043359288076e-27,-2156177623817898e-27,-1475637723558783e-27,-8371015190102975e-28,-2599706096327376e-28,-2382191739347923e-28,-6423305872147843e-28,-9400849094049696e-28,-1122435026096556e-27,-1183840321267481e-27,-1122435026096556e-27,-9400849094049694e-28,-642330587214784e-27,-2382191739347918e-28],[2382191739347913e-28,6423305872147834e-28,9400849094049688e-28,1122435026096556e-27,1183840321267481e-27,1122435026096556e-27,9400849094049688e-28,6423305872147841e-28,2382191739347918e-28,5456116108943413e-27,4878985199565852e-27,4240448995017367e-27,3559909094758253e-27,2858043359288075e-27,2156177623817898e-27,1475637723558782e-27,8371015190102975e-28,2599706096327376e-28,-5461314069809755e-27,-4921085770524055e-27,-4343405037091838e-27,-3732668368707687e-27,-3093523840190885e-27,-2430835727329465e-27,-1734679010007751e-27,-974825365660928e-27,-2797435120168326e-28,0,0,0,0,0,0,-2283748241799531e-28,-4037858874020686e-28,-2146547464825323e-28],[.1316524975873958,.414213562373095,.7673269879789602,1.091308501069271,1.303225372841206,1.56968557711749,1.920982126971166,2.414213562373094,3.171594802363212,4.510708503662055,7.595754112725146,22.90376554843115,.984807753012208,.6427876096865394,.3420201433256688,.9396926207859084,-.1736481776669303,-.7660444431189779,.8660254037844387,.5,-.5144957554275265,-.4717319685649723,-.3133774542039019,-.1819131996109812,-.09457419252642064,-.04096558288530405,-.01419856857247115,-.003699974673760037,.8574929257125442,.8817419973177052,.9496286491027329,.9833145924917901,.9955178160675857,.9991605581781475,.999899195244447,.9999931550702802],[0,0,0,0,0,0,2283748241799531e-28,4037858874020686e-28,2146547464825323e-28,5461314069809755e-27,4921085770524055e-27,4343405037091838e-27,3732668368707687e-27,3093523840190885e-27,2430835727329466e-27,1734679010007751e-27,974825365660928e-27,2797435120168326e-28,-5456116108943413e-27,-4878985199565852e-27,-4240448995017367e-27,-3559909094758253e-27,-2858043359288075e-27,-2156177623817898e-27,-1475637723558782e-27,-8371015190102975e-28,-2599706096327376e-28,-2382191739347913e-28,-6423305872147834e-28,-9400849094049688e-28,-1122435026096556e-27,-1183840321267481e-27,-1122435026096556e-27,-9400849094049688e-28,-6423305872147841e-28,-2382191739347918e-28]],o=r[i.SHORT_TYPE],l=r[i.SHORT_TYPE],d=r[i.SHORT_TYPE],c=r[i.SHORT_TYPE],u=[0,1,16,17,8,9,24,25,4,5,20,21,12,13,28,29,2,3,18,19,10,11,26,27,6,7,22,23,14,15,30,31];function m(t,n,s){for(var i,r,o,l=10,d=n+238-14-286,c=-15;c<0;c++){var u,m,h;u=e[l+-10],m=t[d+-224]*u,h=t[n+224]*u,u=e[l+-9],m+=t[d+-160]*u,h+=t[n+160]*u,u=e[l+-8],m+=t[d+-96]*u,h+=t[n+96]*u,u=e[l+-7],m+=t[d+-32]*u,h+=t[n+32]*u,u=e[l+-6],m+=t[d+32]*u,h+=t[n+-32]*u,u=e[l+-5],m+=t[d+96]*u,h+=t[n+-96]*u,u=e[l+-4],m+=t[d+160]*u,h+=t[n+-160]*u,u=e[l+-3],m+=t[d+224]*u,h+=t[n+-224]*u,u=e[l+-2],m+=t[n+-256]*u,h-=t[d+256]*u,u=e[l+-1],m+=t[n+-192]*u,h-=t[d+192]*u,u=e[l+0],m+=t[n+-128]*u,h-=t[d+128]*u,u=e[l+1],m+=t[n+-64]*u,h-=t[d+64]*u,u=e[l+2],m+=t[n+0]*u,h-=t[d+0]*u,u=e[l+3],m+=t[n+64]*u,h-=t[d+-64]*u,u=e[l+4],m+=t[n+128]*u,h-=t[d+-128]*u,u=e[l+5],m+=t[n+192]*u,u=(h-=t[d+-192]*u)-(m*=e[l+6]),s[30+2*c]=h+m,s[31+2*c]=e[l+7]*u,l+=18,n--,d++}h=t[n+-16]*e[l+-10],m=t[n+-32]*e[l+-2],h+=(t[n+-48]-t[n+16])*e[l+-9],m+=t[n+-96]*e[l+-1],h+=(t[n+-80]+t[n+48])*e[l+-8],m+=t[n+-160]*e[l+0],h+=(t[n+-112]-t[n+80])*e[l+-7],m+=t[n+-224]*e[l+1],h+=(t[n+-144]+t[n+112])*e[l+-6],m-=t[n+32]*e[l+2],h+=(t[n+-176]-t[n+144])*e[l+-5],m-=t[n+96]*e[l+3],h+=(t[n+-208]+t[n+176])*e[l+-4],m-=t[n+160]*e[l+4],h+=(t[n+-240]-t[n+208])*e[l+-3],i=(m-=t[n+224])-h,r=m+h,h=s[14],m=s[15]-h,s[31]=r+h,s[30]=i+m,s[15]=i-m,s[14]=r-h,o=s[28]-s[0],s[0]+=s[28],s[28]=o*e[l+-36+7],o=s[29]-s[1],s[1]+=s[29],s[29]=o*e[l+-36+7],o=s[26]-s[2],s[2]+=s[26],s[26]=o*e[l+-72+7],o=s[27]-s[3],s[3]+=s[27],s[27]=o*e[l+-72+7],o=s[24]-s[4],s[4]+=s[24],s[24]=o*e[l+-108+7],o=s[25]-s[5],s[5]+=s[25],s[25]=o*e[l+-108+7],o=s[22]-s[6],s[6]+=s[22],s[22]=o*a.SQRT2,o=s[23]-s[7],s[7]+=s[23],s[23]=o*a.SQRT2-s[7],s[7]-=s[6],s[22]-=s[7],s[23]-=s[22],o=s[6],s[6]=s[31]-o,s[31]=s[31]+o,o=s[7],s[7]=s[30]-o,s[30]=s[30]+o,o=s[22],s[22]=s[15]-o,s[15]=s[15]+o,o=s[23],s[23]=s[14]-o,s[14]=s[14]+o,o=s[20]-s[8],s[8]+=s[20],s[20]=o*e[l+-180+7],o=s[21]-s[9],s[9]+=s[21],s[21]=o*e[l+-180+7],o=s[18]-s[10],s[10]+=s[18],s[18]=o*e[l+-216+7],o=s[19]-s[11],s[11]+=s[19],s[19]=o*e[l+-216+7],o=s[16]-s[12],s[12]+=s[16],s[16]=o*e[l+-252+7],o=s[17]-s[13],s[13]+=s[17],s[17]=o*e[l+-252+7],o=-s[20]+s[24],s[20]+=s[24],s[24]=o*e[l+-216+7],o=-s[21]+s[25],s[21]+=s[25],s[25]=o*e[l+-216+7],o=s[4]-s[8],s[4]+=s[8],s[8]=o*e[l+-216+7],o=s[5]-s[9],s[5]+=s[9],s[9]=o*e[l+-216+7],o=s[0]-s[12],s[0]+=s[12],s[12]=o*e[l+-72+7],o=s[1]-s[13],s[1]+=s[13],s[13]=o*e[l+-72+7],o=s[16]-s[28],s[16]+=s[28],s[28]=o*e[l+-72+7],o=-s[17]+s[29],s[17]+=s[29],s[29]=o*e[l+-72+7],o=a.SQRT2*(s[2]-s[10]),s[2]+=s[10],s[10]=o,o=a.SQRT2*(s[3]-s[11]),s[3]+=s[11],s[11]=o,o=a.SQRT2*(-s[18]+s[26]),s[18]+=s[26],s[26]=o-s[18],o=a.SQRT2*(-s[19]+s[27]),s[19]+=s[27],s[27]=o-s[19],o=s[2],s[19]-=s[3],s[3]-=o,s[2]=s[31]-o,s[31]+=o,o=s[3],s[11]-=s[19],s[18]-=o,s[3]=s[30]-o,s[30]+=o,o=s[18],s[27]-=s[11],s[19]-=o,s[18]=s[15]-o,s[15]+=o,o=s[19],s[10]-=o,s[19]=s[14]-o,s[14]+=o,o=s[10],s[11]-=o,s[10]=s[23]-o,s[23]+=o,o=s[11],s[26]-=o,s[11]=s[22]-o,s[22]+=o,o=s[26],s[27]-=o,s[26]=s[7]-o,s[7]+=o,o=s[27],s[27]=s[6]-o,s[6]+=o,o=a.SQRT2*(s[0]-s[4]),s[0]+=s[4],s[4]=o,o=a.SQRT2*(s[1]-s[5]),s[1]+=s[5],s[5]=o,o=a.SQRT2*(s[16]-s[20]),s[16]+=s[20],s[20]=o,o=a.SQRT2*(s[17]-s[21]),s[17]+=s[21],s[21]=o,o=-a.SQRT2*(s[8]-s[12]),s[8]+=s[12],s[12]=o-s[8],o=-a.SQRT2*(s[9]-s[13]),s[9]+=s[13],s[13]=o-s[9],o=-a.SQRT2*(s[25]-s[29]),s[25]+=s[29],s[29]=o-s[25],o=-a.SQRT2*(s[24]+s[28]),s[24]-=s[28],s[28]=o-s[24],o=s[24]-s[16],s[24]=o,o=s[20]-o,s[20]=o,o=s[28]-o,s[28]=o,o=s[25]-s[17],s[25]=o,o=s[21]-o,s[21]=o,o=s[29]-o,s[29]=o,o=s[17]-s[1],s[17]=o,o=s[9]-o,s[9]=o,o=s[25]-o,s[25]=o,o=s[5]-o,s[5]=o,o=s[21]-o,s[21]=o,o=s[13]-o,s[13]=o,o=s[29]-o,s[29]=o,o=s[1]-s[0],s[1]=o,o=s[16]-o,s[16]=o,o=s[17]-o,s[17]=o,o=s[8]-o,s[8]=o,o=s[9]-o,s[9]=o,o=s[24]-o,s[24]=o,o=s[25]-o,s[25]=o,o=s[4]-o,s[4]=o,o=s[5]-o,s[5]=o,o=s[20]-o,s[20]=o,o=s[21]-o,s[21]=o,o=s[12]-o,s[12]=o,o=s[13]-o,s[13]=o,o=s[28]-o,s[28]=o,o=s[29]-o,s[29]=o,o=s[0],s[0]+=s[31],s[31]-=o,o=s[1],s[1]+=s[30],s[30]-=o,o=s[16],s[16]+=s[15],s[15]-=o,o=s[17],s[17]+=s[14],s[14]-=o,o=s[8],s[8]+=s[23],s[23]-=o,o=s[9],s[9]+=s[22],s[22]-=o,o=s[24],s[24]+=s[7],s[7]-=o,o=s[25],s[25]+=s[6],s[6]-=o,o=s[4],s[4]+=s[27],s[27]-=o,o=s[5],s[5]+=s[26],s[26]-=o,o=s[20],s[20]+=s[11],s[11]-=o,o=s[21],s[21]+=s[10],s[10]-=o,o=s[12],s[12]+=s[19],s[19]-=o,o=s[13],s[13]+=s[18],s[18]-=o,o=s[28],s[28]+=s[3],s[3]-=o,o=s[29],s[29]+=s[2],s[2]-=o}function h(e,t){for(var a=0;a<3;a++){var n,s,o,l,d,c;s=(l=e[t+6]*r[i.SHORT_TYPE][0]-e[t+15])+(n=e[t+0]*r[i.SHORT_TYPE][2]-e[t+9]),o=l-n,d=(l=e[t+15]*r[i.SHORT_TYPE][0]+e[t+6])+(n=e[t+9]*r[i.SHORT_TYPE][2]+e[t+0]),c=-l+n,n=2069978111953089e-26*(e[t+3]*r[i.SHORT_TYPE][1]-e[t+12]),l=2069978111953089e-26*(e[t+12]*r[i.SHORT_TYPE][1]+e[t+3]),e[t+0]=190752519173728e-25*s+n,e[t+15]=190752519173728e-25*-d+l,o=.8660254037844387*o*1907525191737281e-26,d=.5*d*1907525191737281e-26+l,e[t+3]=o-d,e[t+6]=o+d,s=.5*s*1907525191737281e-26-n,c=.8660254037844387*c*1907525191737281e-26,e[t+9]=s+c,e[t+12]=s-c,t++}}function f(e,t,a){var n,s,i,r,o,d,c,u,m,h,f,p,g,b,v,y,_,x;i=a[17]-a[9],o=a[15]-a[11],d=a[14]-a[12],c=a[0]+a[8],u=a[1]+a[7],m=a[2]+a[6],h=a[3]+a[5],e[t+17]=c+m-h-(u-a[4]),s=(c+m-h)*l[19]+(u-a[4]),n=(i-o-d)*l[18],e[t+5]=n+s,e[t+6]=n-s,r=(a[16]-a[10])*l[18],u=u*l[19]+a[4],n=i*l[12]+r+o*l[13]+d*l[14],s=-c*l[16]+u-m*l[17]+h*l[15],e[t+1]=n+s,e[t+2]=n-s,n=i*l[13]-r-o*l[14]+d*l[12],s=-c*l[17]+u-m*l[15]+h*l[16],e[t+9]=n+s,e[t+10]=n-s,n=i*l[14]-r+o*l[12]-d*l[13],s=c*l[15]-u+m*l[16]-h*l[17],e[t+13]=n+s,e[t+14]=n-s,f=a[8]-a[0],g=a[6]-a[2],b=a[5]-a[3],v=a[17]+a[9],y=a[16]+a[10],_=a[15]+a[11],x=a[14]+a[12],e[t+0]=v+_+x+(y+a[13]),n=(v+_+x)*l[19]-(y+a[13]),s=(f-g+b)*l[18],e[t+11]=n+s,e[t+12]=n-s,p=(a[7]-a[1])*l[18],y=a[13]-y*l[19],n=v*l[15]-y+_*l[16]+x*l[17],s=f*l[14]+p+g*l[12]+b*l[13],e[t+3]=n+s,e[t+4]=n-s,n=-v*l[17]+y-_*l[15]-x*l[16],s=f*l[13]+p-g*l[14]-b*l[12],e[t+7]=n+s,e[t+8]=n-s,n=-v*l[16]+y-_*l[17]-x*l[15],s=f*l[12]-p+g*l[13]-b*l[14],e[t+15]=n+s,e[t+16]=n-s}this.mdct_sub48=function(e,a,l){for(var p=a,g=286,b=0;b<e.channels_out;b++){for(var v=0;v<e.mode_gr;v++){for(var y,_=e.l3_side.tt[v][b],x=_.xr,w=0,k=e.sb_sample[b][1-v],M=0,S=0;S<9;S++)for(m(p,g,k[M]),m(p,g+32,k[M+1]),M+=2,g+=64,y=1;y<32;y+=2)k[M-1][y]*=-1;for(y=0;y<32;y++,w+=18){var C=_.block_type,N=e.sb_sample[b][v],A=e.sb_sample[b][1-v];if(0!=_.mixed_block_flag&&y<2&&(C=0),e.amp_filter[y]<1e-12)n.fill(x,w+0,w+18,0);else{if(e.amp_filter[y]<1)for(S=0;S<18;S++)A[S][u[y]]*=e.amp_filter[y];if(C==i.SHORT_TYPE){for(S=-3;S<0;S++){var E=r[i.SHORT_TYPE][S+3];x[w+3*S+9]=N[9+S][u[y]]*E-N[8-S][u[y]],x[w+3*S+18]=N[14-S][u[y]]*E+N[15+S][u[y]],x[w+3*S+10]=N[15+S][u[y]]*E-N[14-S][u[y]],x[w+3*S+19]=A[2-S][u[y]]*E+A[3+S][u[y]],x[w+3*S+11]=A[3+S][u[y]]*E-A[2-S][u[y]],x[w+3*S+20]=A[8-S][u[y]]*E+A[9+S][u[y]]}h(x,w)}else{var I=s(18);for(S=-9;S<0;S++){var j,T;j=r[C][S+27]*A[S+9][u[y]]+r[C][S+36]*A[8-S][u[y]],T=r[C][S+9]*N[S+9][u[y]]-r[C][S+18]*N[8-S][u[y]],I[S+9]=j-T*o[3+S+9],I[S+18]=j*o[3+S+9]+T}f(x,w,I)}}if(C!=i.SHORT_TYPE&&0!=y)for(S=7;S>=0;--S){var B,P;B=x[w+S]*d[20+S]+x[w+-1-S]*c[28+S],P=x[w+S]*c[28+S]-x[w+-1-S]*d[20+S],x[w+-1-S]=B,x[w+S]=P}}}if(p=l,g=286,1==e.mode_gr)for(var R=0;R<18;R++)t.arraycopy(e.sb_sample[b][1][R],0,e.sb_sample[b][0][R],0,32)}}}}(),d=function(){if(Mn)return kn;Mn=1;var e=Ps();return kn=function(){this.thm=new e,this.en=new e}}(),c=l.FFTOFFSET,u=l.MPG_MD_MS_LR,m=null;this.psy=null;var h=null,f=null,p=null;this.setModules=function(e,t,a,n){m=e,this.psy=t,h=t,f=n,p=a};var g=new e;this.lame_encode_mp3_frame=function(e,b,v,y,_,x){var w,k=n([2,2]);k[0][0]=new d,k[0][1]=new d,k[1][0]=new d,k[1][1]=new d;var M,S=n([2,2]);S[0][0]=new d,S[0][1]=new d,S[1][0]=new d,S[1][1]=new d;var C,N,A,E=[null,null],I=e.internal_flags,j=i([2,4]),T=[.5,.5],B=[[0,0],[0,0]],P=[[0,0],[0,0]];if(E[0]=b,E[1]=v,0==I.lame_encode_frame_init&&function(e,t){var a,n,i=e.internal_flags;if(0==i.lame_encode_frame_init){var r,d,c=s(2014),u=s(2014);for(i.lame_encode_frame_init=1,r=0,d=0;r<286+576*(1+i.mode_gr);++r)r<576*i.mode_gr?(c[r]=0,2==i.channels_out&&(u[r]=0)):(c[r]=t[0][d],2==i.channels_out&&(u[r]=t[1][d]),++d);for(n=0;n<i.mode_gr;n++)for(a=0;a<i.channels_out;a++)i.l3_side.tt[n][a].block_type=l.SHORT_TYPE;g.mdct_sub48(i,c,u),o(576>=l.FFTOFFSET),o(i.mf_size>=l.BLKSIZE+e.framesize-l.FFTOFFSET),o(i.mf_size>=512+e.framesize-32)}}(e,E),I.padding=0,(I.slot_lag-=I.frac_SpF)<0&&(I.slot_lag+=e.out_samplerate,I.padding=1),0!=I.psymodel){var R=[null,null],D=0,O=r(2);for(A=0;A<I.mode_gr;A++){for(N=0;N<I.channels_out;N++)R[N]=E[N],D=576+576*A-l.FFTOFFSET;if(0!=(e.VBR==a.vbr_mtrh||e.VBR==a.vbr_mt?h.L3psycho_anal_vbr(e,R,D,A,k,S,B[A],P[A],j[A],O):h.L3psycho_anal_ns(e,R,D,A,k,S,B[A],P[A],j[A],O)))return-4;for(e.mode==MPEGMode.JOINT_STEREO&&(T[A]=j[A][2]+j[A][3],T[A]>0&&(T[A]=j[A][3]/T[A])),N=0;N<I.channels_out;N++){var L=I.l3_side.tt[A][N];L.block_type=O[N],L.mixed_block_flag=0}}}else for(A=0;A<I.mode_gr;A++)for(N=0;N<I.channels_out;N++)I.l3_side.tt[A][N].block_type=l.NORM_TYPE,I.l3_side.tt[A][N].mixed_block_flag=0,P[A][N]=B[A][N]=700;if(function(e){var t,a;if(0!=e.ATH.useAdjust)if(a=e.loudness_sq[0][0],t=e.loudness_sq[1][0],2==e.channels_out?(a+=e.loudness_sq[0][1],t+=e.loudness_sq[1][1]):(a+=a,t+=t),2==e.mode_gr&&(a=Math.max(a,t)),a*=.5,(a*=e.ATH.aaSensitivityP)>.03125)e.ATH.adjust>=1?e.ATH.adjust=1:e.ATH.adjust<e.ATH.adjustLimit&&(e.ATH.adjust=e.ATH.adjustLimit),e.ATH.adjustLimit=1;else{var n=31.98*a+625e-6;e.ATH.adjust>=n?(e.ATH.adjust*=.075*n+.925,e.ATH.adjust<n&&(e.ATH.adjust=n)):e.ATH.adjustLimit>=n?e.ATH.adjust=n:e.ATH.adjust<e.ATH.adjustLimit&&(e.ATH.adjust=e.ATH.adjustLimit),e.ATH.adjustLimit=n}else e.ATH.adjust=1}(I),g.mdct_sub48(I,E[0],E[1]),I.mode_ext=l.MPG_MD_LR_LR,e.force_ms)I.mode_ext=l.MPG_MD_MS_LR;else if(e.mode==MPEGMode.JOINT_STEREO){var F=0,U=0;for(A=0;A<I.mode_gr;A++)for(N=0;N<I.channels_out;N++)F+=P[A][N],U+=B[A][N];if(F<=1*U){var V=I.l3_side.tt[0],$=I.l3_side.tt[I.mode_gr-1];V[0].block_type==V[1].block_type&&$[0].block_type==$[1].block_type&&(I.mode_ext=l.MPG_MD_MS_LR)}}if(I.mode_ext==u?(M=S,C=P):(M=k,C=B),e.analysis&&null!=I.pinfo)for(A=0;A<I.mode_gr;A++)for(N=0;N<I.channels_out;N++)I.pinfo.ms_ratio[A]=I.ms_ratio[A],I.pinfo.ms_ener_ratio[A]=T[A],I.pinfo.blocktype[A][N]=I.l3_side.tt[A][N].block_type,I.pinfo.pe[A][N]=C[A][N],t.arraycopy(I.l3_side.tt[A][N].xr,0,I.pinfo.xr[A][N],0,576),I.mode_ext==u&&(I.pinfo.ers[A][N]=I.pinfo.ers[A][N+2],t.arraycopy(I.pinfo.energy[A][N+2],0,I.pinfo.energy[A][N],0,I.pinfo.energy[A][N].length));if(e.VBR==a.vbr_off||e.VBR==a.vbr_abr){var H,K;for(H=0;H<18;H++)I.nsPsy.pefirbuf[H]=I.nsPsy.pefirbuf[H+1];for(K=0,A=0;A<I.mode_gr;A++)for(N=0;N<I.channels_out;N++)K+=C[A][N];for(I.nsPsy.pefirbuf[18]=K,K=I.nsPsy.pefirbuf[9],H=0;H<9;H++)K+=(I.nsPsy.pefirbuf[H]+I.nsPsy.pefirbuf[18-H])*l.fircoef[H];for(K=3350*I.mode_gr*I.channels_out/K,A=0;A<I.mode_gr;A++)for(N=0;N<I.channels_out;N++)C[A][N]*=K}if(I.iteration_loop.iteration_loop(e,C,T,M),m.format_bitstream(e),w=m.copy_buffer(I,y,_,x,1),e.bWriteVbrTag&&f.addVbrFrame(e),e.analysis&&null!=I.pinfo){for(N=0;N<I.channels_out;N++){var q;for(q=0;q<c;q++)I.pinfo.pcmdata[N][q]=I.pinfo.pcmdata[N][q+e.framesize];for(q=c;q<1600;q++)I.pinfo.pcmdata[N][q]=E[N][q-c]}p.set_frame_pinfo(e,M)}return function(e){var t,a;for(o(0<=e.bitrate_index&&e.bitrate_index<16),o(0<=e.mode_ext&&e.mode_ext<4),e.bitrate_stereoMode_Hist[e.bitrate_index][4]++,e.bitrate_stereoMode_Hist[15][4]++,2==e.channels_out&&(e.bitrate_stereoMode_Hist[e.bitrate_index][e.mode_ext]++,e.bitrate_stereoMode_Hist[15][e.mode_ext]++),t=0;t<e.mode_gr;++t)for(a=0;a<e.channels_out;++a){var n=0|e.l3_side.tt[t][a].block_type;0!=e.l3_side.tt[t][a].mixed_block_flag&&(n=4),e.bitrate_blockType_Hist[e.bitrate_index][n]++,e.bitrate_blockType_Hist[e.bitrate_index][5]++,e.bitrate_blockType_Hist[15][n]++,e.bitrate_blockType_Hist[15][5]++}}(I),w}}return l.ENCDELAY=576,l.POSTDELAY=1152,l.MDCTDELAY=48,l.FFTOFFSET=224+l.MDCTDELAY,l.DECDELAY=528,l.SBLIMIT=32,l.CBANDS=64,l.SBPSY_l=21,l.SBPSY_s=12,l.SBMAX_l=22,l.SBMAX_s=13,l.PSFB21=6,l.PSFB12=6,l.BLKSIZE=1024,l.HBLKSIZE=l.BLKSIZE/2+1,l.BLKSIZE_s=256,l.HBLKSIZE_s=l.BLKSIZE_s/2+1,l.NORM_TYPE=0,l.START_TYPE=1,l.SHORT_TYPE=2,l.STOP_TYPE=3,l.MPG_MD_LR_LR=0,l.MPG_MD_LR_I=1,l.MPG_MD_MS_LR=2,l.MPG_MD_MS_I=3,l.fircoef=[-.1039435,-.1892065,5*-.0432472,-.155915,3898045e-23,.0467745*5,.50455,.756825,.187098*5],Sn=l}function Ds(){if(In)return En;In=1;var e=Bs();e.System;var t=e.VbrMode,a=e.Float,n=e.ShortBlock,s=e.Util,i=e.Arrays;e.new_array_n,e.new_byte,e.new_double;var r=e.new_float,o=e.new_float_n,l=e.new_int;e.new_int_n;var d=e.assert,c=function(){if(An)return Nn;An=1;var e=Bs();e.System,e.VbrMode,e.Float,e.ShortBlock;var t=e.Util;e.Arrays,e.new_array_n,e.new_byte,e.new_double;var a=e.new_float;e.new_float_n,e.new_int,e.new_int_n,e.assert;var n=Rs();return Nn=function(){var e=a(n.BLKSIZE),s=a(n.BLKSIZE_s/2),i=[.9238795325112867,.3826834323650898,.9951847266721969,.0980171403295606,.9996988186962042,.02454122852291229,.9999811752826011,.006135884649154475];function r(e,a,n){var s,r,o,l=0,d=a+(n<<=1);s=4;do{var c,u,m,h,f,p,g;g=s>>1,p=(f=s<<1)+(h=s),s=f<<1,o=(r=a)+g;do{k=e[r+0]-e[r+h],w=e[r+0]+e[r+h],N=e[r+f]-e[r+p],S=e[r+f]+e[r+p],e[r+f]=w-S,e[r+0]=w+S,e[r+p]=k-N,e[r+h]=k+N,k=e[o+0]-e[o+h],w=e[o+0]+e[o+h],N=t.SQRT2*e[o+p],S=t.SQRT2*e[o+f],e[o+f]=w-S,e[o+0]=w+S,e[o+p]=k-N,e[o+h]=k+N,o+=s,r+=s}while(r<d);for(u=i[l+0],c=i[l+1],m=1;m<g;m++){var b,v;b=1-2*c*c,v=2*c*u,r=a+m,o=a+h-m;do{var y,_,x,w,k,M,S,C,N,A;_=v*e[r+h]-b*e[o+h],y=b*e[r+h]+v*e[o+h],k=e[r+0]-y,w=e[r+0]+y,M=e[o+0]-_,x=e[o+0]+_,_=v*e[r+p]-b*e[o+p],y=b*e[r+p]+v*e[o+p],N=e[r+f]-y,S=e[r+f]+y,A=e[o+f]-_,C=e[o+f]+_,_=c*S-u*A,y=u*S+c*A,e[r+f]=w-y,e[r+0]=w+y,e[o+p]=M-_,e[o+h]=M+_,_=u*C-c*N,y=c*C+u*N,e[o+f]=x-y,e[o+0]=x+y,e[r+p]=k-_,e[r+h]=k+_,o+=s,r+=s}while(r<d);u=(b=u)*i[l+0]-c*i[l+1],c=b*i[l+1]+c*i[l+0]}l+=2}while(s<n)}var o=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254];this.fft_short=function(e,t,a,i,l){for(var d=0;d<3;d++){var c=n.BLKSIZE_s/2,u=65535&192*(d+1),m=n.BLKSIZE_s/8-1;do{var h,f,p,g,b,v=255&o[m<<2];f=(h=s[v]*i[a][l+v+u])-(b=s[127-v]*i[a][l+v+u+128]),h+=b,g=(p=s[v+64]*i[a][l+v+u+64])-(b=s[63-v]*i[a][l+v+u+192]),p+=b,c-=4,t[d][c+0]=h+p,t[d][c+2]=h-p,t[d][c+1]=f+g,t[d][c+3]=f-g,f=(h=s[v+1]*i[a][l+v+u+1])-(b=s[126-v]*i[a][l+v+u+129]),h+=b,g=(p=s[v+65]*i[a][l+v+u+65])-(b=s[62-v]*i[a][l+v+u+193]),p+=b,t[d][c+n.BLKSIZE_s/2+0]=h+p,t[d][c+n.BLKSIZE_s/2+2]=h-p,t[d][c+n.BLKSIZE_s/2+1]=f+g,t[d][c+n.BLKSIZE_s/2+3]=f-g}while(--m>=0);r(t[d],c,n.BLKSIZE_s/2)}},this.fft_long=function(t,a,s,i,l){var d=n.BLKSIZE/8-1,c=n.BLKSIZE/2;do{var u,m,h,f,p,g=255&o[d];m=(u=e[g]*i[s][l+g])-(p=e[g+512]*i[s][l+g+512]),u+=p,f=(h=e[g+256]*i[s][l+g+256])-(p=e[g+768]*i[s][l+g+768]),h+=p,a[0+(c-=4)]=u+h,a[c+2]=u-h,a[c+1]=m+f,a[c+3]=m-f,m=(u=e[g+1]*i[s][l+g+1])-(p=e[g+513]*i[s][l+g+513]),u+=p,f=(h=e[g+257]*i[s][l+g+257])-(p=e[g+769]*i[s][l+g+769]),h+=p,a[c+n.BLKSIZE/2+0]=u+h,a[c+n.BLKSIZE/2+2]=u-h,a[c+n.BLKSIZE/2+1]=m+f,a[c+n.BLKSIZE/2+3]=m-f}while(--d>=0);r(a,c,n.BLKSIZE/2)},this.init_fft=function(t){for(var a=0;a<n.BLKSIZE;a++)e[a]=.42-.5*Math.cos(2*Math.PI*(a+.5)/n.BLKSIZE)+.08*Math.cos(4*Math.PI*(a+.5)/n.BLKSIZE);for(a=0;a<n.BLKSIZE_s/2;a++)s[a]=.5*(1-Math.cos(2*Math.PI*(a+.5)/n.BLKSIZE_s))}}}(),u=Rs();return En=function(){var e=new c,m=2.302585092994046,h=1/217621504/(u.BLKSIZE/2),f=.3,p=21,g=.2302585093;function b(e){return e}function v(e,t){for(var a=0,n=0;n<u.BLKSIZE/2;++n)a+=e[n]*t.ATH.eql_w[n];return a*=h}function y(t,a,n,i,r,o,l,d,c,m,h){var f=t.internal_flags;if(c<2)e.fft_long(f,i[r],c,m,h),e.fft_short(f,o[l],c,m,h);else if(2==c){for(var p=u.BLKSIZE-1;p>=0;--p){var g=i[r+0][p],y=i[r+1][p];i[r+0][p]=(g+y)*s.SQRT2*.5,i[r+1][p]=(g-y)*s.SQRT2*.5}for(var _=2;_>=0;--_)for(p=u.BLKSIZE_s-1;p>=0;--p){g=o[l+0][_][p],y=o[l+1][_][p];o[l+0][_][p]=(g+y)*s.SQRT2*.5,o[l+1][_][p]=(g-y)*s.SQRT2*.5}}a[0]=i[r+0][0],a[0]*=a[0];for(p=u.BLKSIZE/2-1;p>=0;--p){var x=i[r+0][u.BLKSIZE/2-p],w=i[r+0][u.BLKSIZE/2+p];a[u.BLKSIZE/2-p]=b(.5*(x*x+w*w))}for(_=2;_>=0;--_){n[_][0]=o[l+0][_][0],n[_][0]*=n[_][0];for(p=u.BLKSIZE_s/2-1;p>=0;--p){x=o[l+0][_][u.BLKSIZE_s/2-p],w=o[l+0][_][u.BLKSIZE_s/2+p];n[_][u.BLKSIZE_s/2-p]=b(.5*(x*x+w*w))}}var k=0;for(p=11;p<u.HBLKSIZE;p++)k+=a[p];if(f.tot_ener[c]=k,t.analysis){for(p=0;p<u.HBLKSIZE;p++)f.pinfo.energy[d][c][p]=f.pinfo.energy_save[c][p],f.pinfo.energy_save[c][p]=a[p];f.pinfo.pe[d][c]=f.pe[c]}2==t.athaa_loudapprox&&c<2&&(f.loudness_sq[d][c]=f.loudness_sq_save[c],f.loudness_sq_save[c]=v(a,f))}var _,x,w,k=[1,.79433,.63096,.63096,.63096,.63096,.63096,.25119,.11749],M=[3.3246*3.3246,3.23837*3.23837,9.9500500969,9.0247369744,8.1854926609,7.0440875649,2.46209*2.46209,2.284*2.284,4.4892710641,1.96552*1.96552,1.82335*1.82335,1.69146*1.69146,2.4621061921,2.1508568964,1.37074*1.37074,1.31036*1.31036,1.5691069696,1.4555939904,1.16203*1.16203,1.2715945225,1.09428*1.09428,1.0659*1.0659,1.0779838276,1.0382591025,1],S=[1.7782755904,1.35879*1.35879,1.38454*1.38454,1.39497*1.39497,1.40548*1.40548,1.3537*1.3537,1.6999465924,1.22321*1.22321,1.3169398564,1],C=[5.5396212496,2.29259*2.29259,4.9868695969,2.12675*2.12675,2.02545*2.02545,1.87894*1.87894,1.74303*1.74303,1.61695*1.61695,2.2499700001,1.39148*1.39148,1.29083*1.29083,1.19746*1.19746,1.2339655056,1.0779838276];function N(e,t,a,n,i,r){var o;if(t>e){if(!(t<e*x))return e+t;o=t/e}else{if(e>=t*x)return e+t;o=e/t}if(d(e>=0),d(t>=0),e+=t,n+3<=6){if(o>=_)return e;var l=0|s.FAST_LOG10_X(o,16);return e*S[l]}var c,u;l=0|s.FAST_LOG10_X(o,16);return t=i.ATH.cb_l[a]*i.ATH.adjust,d(t>=0),e<w*t?e>t?(c=1,l<=13&&(c=C[l]),u=s.FAST_LOG10_X(e/t,10/15),e*((M[l]-c)*u+c)):l>13?e:e*C[l]:e*M[l]}var A=[1.7782755904,1.35879*1.35879,1.38454*1.38454,1.39497*1.39497,1.40548*1.40548,1.3537*1.3537,1.6999465924,1.22321*1.22321,1.3169398564,1];function E(e,t,a){var n;if(e<0&&(e=0),t<0&&(t=0),e<=0)return t;if(t<=0)return e;if(n=t>e?t/e:e/t,-2<=a&&a<=2){if(n>=_)return e+t;var i=0|s.FAST_LOG10_X(n,16);return(e+t)*A[i]}return n<x?e+t:(e<t&&(e=t),e)}function I(e,t,a,n,s){var i,r,o=0,l=0;for(i=r=0;i<u.SBMAX_s;++r,++i){for(var c=e.bo_s[i],m=e.npart_s,h=c<m?c:m;r<h;)d(t[r]>=0),d(a[r]>=0),o+=t[r],l+=a[r],r++;if(e.en[n].s[i][s]=o,e.thm[n].s[i][s]=l,r>=m){++i;break}d(t[r]>=0),d(a[r]>=0);var f=e.PSY.bo_s_weight[i],p=1-f;o=f*t[r],l=f*a[r],e.en[n].s[i][s]+=o,e.thm[n].s[i][s]+=l,o=p*t[r],l=p*a[r]}for(;i<u.SBMAX_s;++i)e.en[n].s[i][s]=0,e.thm[n].s[i][s]=0}function j(e,t,a,n){var s,i,r=0,o=0;for(s=i=0;s<u.SBMAX_l;++i,++s){for(var l=e.bo_l[s],c=e.npart_l,m=l<c?l:c;i<m;)d(t[i]>=0),d(a[i]>=0),r+=t[i],o+=a[i],i++;if(e.en[n].l[s]=r,e.thm[n].l[s]=o,i>=c){++s;break}d(t[i]>=0),d(a[i]>=0);var h=e.PSY.bo_l_weight[s],f=1-h;r=h*t[i],o=h*a[i],e.en[n].l[s]+=r,e.thm[n].l[s]+=o,r=f*t[i],o=f*a[i]}for(;s<u.SBMAX_l;++s)e.en[n].l[s]=0,e.thm[n].l[s]=0}function T(e,t,a,n,s,i){var r,o,l=e.internal_flags;for(o=r=0;o<l.npart_s;++o){for(var c=0,m=l.numlines_s[o],h=0;h<m;++h,++r){c+=t[i][r]}a[o]=c}for(d(o==l.npart_s),d(129==r),r=o=0;o<l.npart_s;o++){var f=l.s3ind_s[o][0],p=l.s3_ss[r++]*a[f];for(++f;f<=l.s3ind_s[o][1];)p+=l.s3_ss[r]*a[f],++r,++f;var g=2*l.nb_s1[s][o];if(n[o]=Math.min(p,g),l.blocktype_old[1&s]==u.SHORT_TYPE){g=16*l.nb_s2[s][o];var b=n[o];n[o]=Math.min(g,b)}l.nb_s2[s][o]=l.nb_s1[s][o],l.nb_s1[s][o]=p,d(n[o]>=0)}for(;o<=u.CBANDS;++o)a[o]=0,n[o]=0}function B(e,t,a){return a>=1?e:a<=0?t:t>0?Math.pow(e/t,a)*t:0}var P=[11.8,13.6,17.2,32,46.5,51.3,57.5,67.1,71.5,84.6,97.6,130];function R(e,t){for(var a=309.07,n=0;n<u.SBMAX_s-1;n++)for(var i=0;i<3;i++){var r=e.thm.s[n][i];if(d(n<P.length),r>0){var o=r*t,l=e.en.s[n][i];l>o&&(l>1e10*o?a+=P[n]*(10*m):(d(o>0),a+=P[n]*s.FAST_LOG10(l/o)))}}return a}var D=[6.8,5.8,5.8,6.4,6.5,9.9,12.1,14.4,15,18.9,21.6,26.9,34.2,40.2,46.8,56.5,60.7,73.9,85.7,93.4,126.1];function O(e,t){for(var a=281.0575,n=0;n<u.SBMAX_l-1;n++){var i=e.thm.l[n];if(d(n<D.length),i>0){var r=i*t,o=e.en.l[n];o>r&&(o>1e10*r?a+=D[n]*(10*m):(d(r>0),a+=D[n]*s.FAST_LOG10(o/r)))}}return a}function L(e,t,a,n,s){var i,r;for(i=r=0;i<e.npart_l;++i){var o,l=0,c=0;for(o=0;o<e.numlines_l[i];++o,++r){var u=t[r];d(u>=0),l+=u,c<u&&(c=u)}a[i]=l,n[i]=c,s[i]=l*e.rnumlines_l[i],d(e.rnumlines_l[i]>=0),d(l>=0),d(a[i]>=0),d(n[i]>=0),d(s[i]>=0)}}function F(e,t,a,n){var s=k.length-1,i=0,r=a[i]+a[i+1];(d(r>=0),r>0)?((o=t[i])<t[i+1]&&(o=t[i+1]),d(e.numlines_l[i]+e.numlines_l[i+1]-1>0),(l=0|(r=20*(2*o-r)/(r*(e.numlines_l[i]+e.numlines_l[i+1]-1))))>s&&(l=s),n[i]=l):n[i]=0;for(i=1;i<e.npart_l-1;i++){var o,l;if(r=a[i-1]+a[i]+a[i+1],d(r>=0),r>0)(o=t[i-1])<t[i]&&(o=t[i]),o<t[i+1]&&(o=t[i+1]),d(e.numlines_l[i-1]+e.numlines_l[i]+e.numlines_l[i+1]-1>0),(l=0|(r=20*(3*o-r)/(r*(e.numlines_l[i-1]+e.numlines_l[i]+e.numlines_l[i+1]-1))))>s&&(l=s),n[i]=l;else n[i]=0}(d(i>0),d(i==e.npart_l-1),r=a[i-1]+a[i],d(r>=0),r>0)?((o=t[i-1])<t[i]&&(o=t[i]),d(e.numlines_l[i-1]+e.numlines_l[i]-1>0),(l=0|(r=20*(2*o-r)/(r*(e.numlines_l[i-1]+e.numlines_l[i]-1))))>s&&(l=s),n[i]=l):n[i]=0;d(i==e.npart_l-1)}var U=[-1730326e-23,-.01703172,-1349528e-23,.0418072,-673278e-22,-.0876324,-30835e-21,.1863476,-1104424e-22,-.627638];function V(t,a,n,i,r,o,l,d){var c=t.internal_flags;if(i<2)e.fft_long(c,l[d],i,a,n);else if(2==i)for(var m=u.BLKSIZE-1;m>=0;--m){var h=l[d+0][m],f=l[d+1][m];l[d+0][m]=(h+f)*s.SQRT2*.5,l[d+1][m]=(h-f)*s.SQRT2*.5}o[0]=l[d+0][0],o[0]*=o[0];for(m=u.BLKSIZE/2-1;m>=0;--m){var p=l[d+0][u.BLKSIZE/2-m],g=l[d+0][u.BLKSIZE/2+m];o[u.BLKSIZE/2-m]=b(.5*(p*p+g*g))}var v=0;for(m=11;m<u.HBLKSIZE;m++)v+=o[m];if(c.tot_ener[i]=v,t.analysis){for(m=0;m<u.HBLKSIZE;m++)c.pinfo.energy[r][i][m]=c.pinfo.energy_save[i][m],c.pinfo.energy_save[i][m]=o[m];c.pinfo.pe[r][i]=c.pe[i]}}function $(t,a,n,i,r,o,l,d){var c=t.internal_flags;if(0==r&&i<2&&e.fft_short(c,l[d],i,a,n),2==i)for(var m=u.BLKSIZE_s-1;m>=0;--m){var h=l[d+0][r][m],f=l[d+1][r][m];l[d+0][r][m]=(h+f)*s.SQRT2*.5,l[d+1][r][m]=(h-f)*s.SQRT2*.5}o[r][0]=l[d+0][r][0],o[r][0]*=o[r][0];for(m=u.BLKSIZE_s/2-1;m>=0;--m){var p=l[d+0][r][u.BLKSIZE_s/2-m],g=l[d+0][r][u.BLKSIZE_s/2+m];o[r][u.BLKSIZE_s/2-m]=b(.5*(p*p+g*g))}}function H(e,t,a,n){var s=e.internal_flags;2==e.athaa_loudapprox&&a<2&&(s.loudness_sq[t][a]=s.loudness_sq_save[a],s.loudness_sq_save[a]=v(n,s))}this.L3psycho_anal_ns=function(e,a,s,c,m,h,g,b,v,_){var x,w,M,S,C,A,E,P,D,V,$=e.internal_flags,H=o([2,u.BLKSIZE]),K=o([2,3,u.BLKSIZE_s]),q=r(u.CBANDS+1),z=r(u.CBANDS+1),G=r(u.CBANDS+2),X=l(2),W=l(2),Y=o([2,576]),Z=l(u.CBANDS+2),J=l(u.CBANDS+2);for(i.fill(J,0),x=$.channels_out,e.mode==MPEGMode.JOINT_STEREO&&(x=4),D=e.VBR==t.vbr_off?0==$.ResvMax?0:$.ResvSize/$.ResvMax*.5:e.VBR==t.vbr_rh||e.VBR==t.vbr_mtrh||e.VBR==t.vbr_mt?.6:1,w=0;w<$.channels_out;w++){var Q=a[w],ee=s+576-350-p+192;for(d(10==U.length),S=0;S<576;S++){var te,ae;for(te=Q[ee+S+10],ae=0,C=0;C<9;C+=2)te+=U[C]*(Q[ee+S+C]+Q[ee+S+p-C]),ae+=U[C+1]*(Q[ee+S+C+1]+Q[ee+S+p-C-1]);Y[w][S]=te+ae}m[c][w].en.assign($.en[w]),m[c][w].thm.assign($.thm[w]),x>2&&(h[c][w].en.assign($.en[w+2]),h[c][w].thm.assign($.thm[w+2]))}for(w=0;w<x;w++){var ne,se=r(12),ie=[0,0,0,0],re=r(12),oe=1,le=r(u.CBANDS),de=r(u.CBANDS),ce=[0,0,0,0],ue=r(u.HBLKSIZE),me=o([3,u.HBLKSIZE_s]);for(d($.npart_s<=u.CBANDS),d($.npart_l<=u.CBANDS),S=0;S<3;S++)se[S]=$.nsPsy.last_en_subshort[w][S+6],d($.nsPsy.last_en_subshort[w][S+4]>0),re[S]=se[S]/$.nsPsy.last_en_subshort[w][S+4],ie[0]+=se[S];if(2==w)for(S=0;S<576;S++){var he,fe;he=Y[0][S],fe=Y[1][S],Y[0][S]=he+fe,Y[1][S]=he-fe}var pe=Y[1&w],ge=0;for(S=0;S<9;S++){for(var be=ge+64,ve=1;ge<be;ge++)ve<Math.abs(pe[ge])&&(ve=Math.abs(pe[ge]));$.nsPsy.last_en_subshort[w][S]=se[S+3]=ve,ie[1+S/3]+=ve,ve>se[S+3-2]?(d(se[S+3-2]>0),ve/=se[S+3-2]):se[S+3-2]>10*ve?(d(ve>0),ve=se[S+3-2]/(10*ve)):ve=0,re[S+3]=ve}if(e.analysis){var ye=re[0];for(S=1;S<12;S++)ye<re[S]&&(ye=re[S]);$.pinfo.ers[c][w]=$.pinfo.ers_save[w],$.pinfo.ers_save[w]=ye}for(ne=3==w?$.nsPsy.attackthre_s:$.nsPsy.attackthre,S=0;S<12;S++)0==ce[S/3]&&re[S]>ne&&(ce[S/3]=S%3+1);for(S=1;S<4;S++){var _e;ie[S-1]>ie[S]?(d(ie[S]>0),_e=ie[S-1]/ie[S]):(d(ie[S-1]>0),_e=ie[S]/ie[S-1]),_e<1.7&&(ce[S]=0,1==S&&(ce[0]=0))}for(0!=ce[0]&&0!=$.nsPsy.lastAttacks[w]&&(ce[0]=0),3!=$.nsPsy.lastAttacks[w]&&ce[0]+ce[1]+ce[2]+ce[3]==0||(oe=0,0!=ce[1]&&0!=ce[0]&&(ce[1]=0),0!=ce[2]&&0!=ce[1]&&(ce[2]=0),0!=ce[3]&&0!=ce[2]&&(ce[3]=0)),w<2?W[w]=oe:0==oe&&(W[0]=W[1]=0),v[w]=$.tot_ener[w],y(e,ue,me,H,1&w,K,1&w,c,w,a,s),L($,ue,q,le,de),F($,le,de,Z),P=0;P<3;P++){var xe,we;for(T(e,me,z,G,w,P),I($,z,G,w,P),E=0;E<u.SBMAX_s;E++){if(we=$.thm[w].s[E][P],we*=.8,ce[P]>=2||1==ce[P+1]){var ke=0!=P?P-1:2;ve=B($.thm[w].s[E][ke],we,.6*D);we=Math.min(we,ve)}if(1==ce[P]){ke=0!=P?P-1:2,ve=B($.thm[w].s[E][ke],we,f*D);we=Math.min(we,ve)}else if(0!=P&&3==ce[P-1]||0==P&&3==$.nsPsy.lastAttacks[w]){ke=2!=P?P+1:0,ve=B($.thm[w].s[E][ke],we,f*D);we=Math.min(we,ve)}xe=se[3*P+3]+se[3*P+4]+se[3*P+5],6*se[3*P+5]<xe&&(we*=.5,6*se[3*P+4]<xe&&(we*=.5)),$.thm[w].s[E][P]=we}}for($.nsPsy.lastAttacks[w]=ce[2],A=0,M=0;M<$.npart_l;M++){for(var Me=$.s3ind[M][0],Se=q[Me]*k[Z[Me]],Ce=$.s3_ll[A++]*Se;++Me<=$.s3ind[M][1];)Se=q[Me]*k[Z[Me]],Ce=N(Ce,$.s3_ll[A++]*Se,Me,Me-M,$);Ce*=.158489319246111,$.blocktype_old[1&w]==u.SHORT_TYPE?G[M]=Ce:G[M]=B(Math.min(Ce,Math.min(2*$.nb_1[w][M],16*$.nb_2[w][M])),Ce,D),$.nb_2[w][M]=$.nb_1[w][M],$.nb_1[w][M]=Ce}for(;M<=u.CBANDS;++M)q[M]=0,G[M]=0;j($,q,G,w)}(e.mode!=MPEGMode.STEREO&&e.mode!=MPEGMode.JOINT_STEREO||e.interChRatio>0&&function(e,t){var a=e.internal_flags;if(a.channels_out>1){for(var n=0;n<u.SBMAX_l;n++){var s=a.thm[0].l[n],i=a.thm[1].l[n];a.thm[0].l[n]+=i*t,a.thm[1].l[n]+=s*t}for(n=0;n<u.SBMAX_s;n++)for(var r=0;r<3;r++)s=a.thm[0].s[n][r],i=a.thm[1].s[n][r],a.thm[0].s[n][r]+=i*t,a.thm[1].s[n][r]+=s*t}}(e,e.interChRatio),e.mode==MPEGMode.JOINT_STEREO)&&(!function(e){for(var t=0;t<u.SBMAX_l;t++)if(!(e.thm[0].l[t]>1.58*e.thm[1].l[t]||e.thm[1].l[t]>1.58*e.thm[0].l[t])){var a=e.mld_l[t]*e.en[3].l[t],n=Math.max(e.thm[2].l[t],Math.min(e.thm[3].l[t],a));a=e.mld_l[t]*e.en[2].l[t];var s=Math.max(e.thm[3].l[t],Math.min(e.thm[2].l[t],a));e.thm[2].l[t]=n,e.thm[3].l[t]=s}for(t=0;t<u.SBMAX_s;t++)for(var i=0;i<3;i++)e.thm[0].s[t][i]>1.58*e.thm[1].s[t][i]||e.thm[1].s[t][i]>1.58*e.thm[0].s[t][i]||(a=e.mld_s[t]*e.en[3].s[t][i],n=Math.max(e.thm[2].s[t][i],Math.min(e.thm[3].s[t][i],a)),a=e.mld_s[t]*e.en[2].s[t][i],s=Math.max(e.thm[3].s[t][i],Math.min(e.thm[2].s[t][i],a)),e.thm[2].s[t][i]=n,e.thm[3].s[t][i]=s)}($),V=e.msfix,Math.abs(V)>0&&function(e,t,a){var n=t,s=Math.pow(10,a);t*=2,n*=2;for(var i=0;i<u.SBMAX_l;i++)m=e.ATH.cb_l[e.bm_l[i]]*s,(o=Math.min(Math.max(e.thm[0].l[i],m),Math.max(e.thm[1].l[i],m)))*t<(l=Math.max(e.thm[2].l[i],m))+(c=Math.max(e.thm[3].l[i],m))&&d((l*=h=o*n/(l+c))+(c*=h)>0),e.thm[2].l[i]=Math.min(l,e.thm[2].l[i]),e.thm[3].l[i]=Math.min(c,e.thm[3].l[i]);for(s*=u.BLKSIZE_s/u.BLKSIZE,i=0;i<u.SBMAX_s;i++)for(var r=0;r<3;r++){var o,l,c,m,h;m=e.ATH.cb_s[e.bm_s[i]]*s,(o=Math.min(Math.max(e.thm[0].s[i][r],m),Math.max(e.thm[1].s[i][r],m)))*t<(l=Math.max(e.thm[2].s[i][r],m))+(c=Math.max(e.thm[3].s[i][r],m))&&d((l*=h=o*t/(l+c))+(c*=h)>0),e.thm[2].s[i][r]=Math.min(e.thm[2].s[i][r],l),e.thm[3].s[i][r]=Math.min(e.thm[3].s[i][r],c)}}($,V,e.ATHlower*$.ATH.adjust));for(function(e,t,a,s){var i=e.internal_flags;e.short_blocks!=n.short_block_coupled||0!=t[0]&&0!=t[1]||(t[0]=t[1]=0);for(var r=0;r<i.channels_out;r++)s[r]=u.NORM_TYPE,e.short_blocks==n.short_block_dispensed&&(t[r]=1),e.short_blocks==n.short_block_forced&&(t[r]=0),0!=t[r]?(d(i.blocktype_old[r]!=u.START_TYPE),i.blocktype_old[r]==u.SHORT_TYPE&&(s[r]=u.STOP_TYPE)):(s[r]=u.SHORT_TYPE,i.blocktype_old[r]==u.NORM_TYPE&&(i.blocktype_old[r]=u.START_TYPE),i.blocktype_old[r]==u.STOP_TYPE&&(i.blocktype_old[r]=u.SHORT_TYPE)),a[r]=i.blocktype_old[r],i.blocktype_old[r]=s[r]}(e,W,_,X),w=0;w<x;w++){var Ne,Ae,Ee,Ie=0;w>1?(Ne=b,Ie=-2,Ae=u.NORM_TYPE,_[0]!=u.SHORT_TYPE&&_[1]!=u.SHORT_TYPE||(Ae=u.SHORT_TYPE),Ee=h[c][w-2]):(Ne=g,Ie=0,Ae=_[w],Ee=m[c][w]),Ae==u.SHORT_TYPE?Ne[Ie+w]=R(Ee,$.masking_lower):Ne[Ie+w]=O(Ee,$.masking_lower),e.analysis&&($.pinfo.pe[c][w]=Ne[Ie+w])}return 0};var K=[-1730326e-23,-.01703172,-1349528e-23,.0418072,-673278e-22,-.0876324,-30835e-21,.1863476,-1104424e-22,-.627638];function q(e,t,a){if(0==a)for(var n=0;n<e.npart_s;n++)e.nb_s2[t][n]=e.nb_s1[t][n],e.nb_s1[t][n]=0}function z(e,t){for(var a=0;a<e.npart_l;a++)e.nb_2[t][a]=e.nb_1[t][a],e.nb_1[t][a]=0}function G(e,t,a,n,s,i){var o,l,c,m=e.internal_flags,h=new float[u.CBANDS],f=r(u.CBANDS),p=new int[u.CBANDS];for(c=l=0;c<m.npart_s;++c){var g=0,b=0,v=m.numlines_s[c];for(o=0;o<v;++o,++l){var y=t[i][l];g+=y,b<y&&(b=y)}a[c]=g,d(g>=0),h[c]=b,d(v>0),f[c]=g/v,d(f[c]>=0)}for(d(c==m.npart_s),d(129==l);c<u.CBANDS;++c)h[c]=0,f[c]=0;for(function(e,t,a,n){var s=k.length-1,i=0,r=a[i]+a[i+1];for(d(r>=0),r>0?((o=t[i])<t[i+1]&&(o=t[i+1]),d(e.numlines_s[i]+e.numlines_s[i+1]-1>0),(l=0|(r=20*(2*o-r)/(r*(e.numlines_s[i]+e.numlines_s[i+1]-1))))>s&&(l=s),n[i]=l):n[i]=0,i=1;i<e.npart_s-1;i++){var o,l;r=a[i-1]+a[i]+a[i+1],d(i+1<e.npart_s),d(r>=0),r>0?((o=t[i-1])<t[i]&&(o=t[i]),o<t[i+1]&&(o=t[i+1]),d(e.numlines_s[i-1]+e.numlines_s[i]+e.numlines_s[i+1]-1>0),(l=0|(r=20*(3*o-r)/(r*(e.numlines_s[i-1]+e.numlines_s[i]+e.numlines_s[i+1]-1))))>s&&(l=s),n[i]=l):n[i]=0}d(i>0),d(i==e.npart_s-1),r=a[i-1]+a[i],d(r>=0),r>0?((o=t[i-1])<t[i]&&(o=t[i]),d(e.numlines_s[i-1]+e.numlines_s[i]-1>0),(l=0|(r=20*(2*o-r)/(r*(e.numlines_s[i-1]+e.numlines_s[i]-1))))>s&&(l=s),n[i]=l):n[i]=0,d(i==e.npart_s-1)}(m,h,f,p),l=c=0;c<m.npart_s;c++){var _,x,w,M,S,C=m.s3ind_s[c][0],N=m.s3ind_s[c][1];for(_=p[C],x=1,M=m.s3_ss[l]*a[C]*k[p[C]],++l,++C;C<=N;)_+=p[C],x+=1,M=E(M,w=m.s3_ss[l]*a[C]*k[p[C]],C-c),++l,++C;M*=S=.5*k[_=(1+2*_)/(2*x)],n[c]=M,m.nb_s2[s][c]=m.nb_s1[s][c],m.nb_s1[s][c]=M,w=h[c],w*=m.minval_s[c],w*=S,n[c]>w&&(n[c]=w),m.masking_lower>1&&(n[c]*=m.masking_lower),n[c]>a[c]&&(n[c]=a[c]),m.masking_lower<1&&(n[c]*=m.masking_lower),d(n[c]>=0)}for(;c<u.CBANDS;++c)a[c]=0,n[c]=0}function X(e,t,a,n,s){var i,o=r(u.CBANDS),c=r(u.CBANDS),m=l(u.CBANDS+2);L(e,t,a,o,c),F(e,o,c,m);var h=0;for(i=0;i<e.npart_l;i++){var p,g,b,v=e.s3ind[i][0],y=e.s3ind[i][1],_=0,x=0;for(_=m[v],x+=1,g=e.s3_ll[h]*a[v]*k[m[v]],++h,++v;v<=y;)_+=m[v],x+=1,g=E(g,p=e.s3_ll[h]*a[v]*k[m[v]],v-i),++h,++v;if(g*=b=.5*k[_=(1+2*_)/(2*x)],e.blocktype_old[1&s]==u.SHORT_TYPE){var w=2*e.nb_1[s][i];n[i]=w>0?Math.min(g,w):Math.min(g,a[i]*f)}else{var M=16*e.nb_2[s][i],S=2*e.nb_1[s][i];M<=0&&(M=g),S<=0&&(S=g),w=e.blocktype_old[1&s]==u.NORM_TYPE?Math.min(S,M):S,n[i]=Math.min(g,w)}e.nb_2[s][i]=e.nb_1[s][i],e.nb_1[s][i]=g,p=o[i],p*=e.minval_l[i],p*=b,n[i]>p&&(n[i]=p),e.masking_lower>1&&(n[i]*=e.masking_lower),n[i]>a[i]&&(n[i]=a[i]),e.masking_lower<1&&(n[i]*=e.masking_lower),d(n[i]>=0)}for(;i<u.CBANDS;++i)a[i]=0,n[i]=0}function W(e,t,a,n,s,i,r){for(var o,l,c=2*i,u=i>0?Math.pow(10,s):1,m=0;m<r;++m){var h=e[2][m],f=e[3][m],p=t[0][m],g=t[1][m],b=t[2][m],v=t[3][m];if(p<=1.58*g&&g<=1.58*p){var y=a[m]*f,_=a[m]*h;l=Math.max(b,Math.min(v,y)),o=Math.max(v,Math.min(b,_))}else l=b,o=v;if(i>0){var x,w,k=n[m]*u;if(x=Math.min(Math.max(p,k),Math.max(g,k)),(w=(b=Math.max(l,k))+(v=Math.max(o,k)))>0&&x*c<w){var M=x*c/w;b*=M,v*=M,d(w>0)}l=Math.min(b,l),o=Math.min(v,o)}l>h&&(l=h),o>f&&(o=f),t[2][m]=l,t[3][m]=o}}function Y(e,t){var a;return(a=e>=0?27*-e:e*t)<=-72?0:Math.exp(a*g)}function Z(e){var t,a,n=0;for(n=0;Y(n,e)>1e-20;n-=1);for(s=n,i=0;Math.abs(i-s)>1e-12;)Y(n=(i+s)/2,e)>0?i=n:s=n;t=s;var s,i;n=0;for(n=0;Y(n,e)>1e-20;n+=1);for(s=0,i=n;Math.abs(i-s)>1e-12;)Y(n=(i+s)/2,e)>0?s=n:i=n;a=i;var r,o=0,l=1e3;for(r=0;r<=l;++r){o+=Y(n=t+r*(a-t)/l,e)}return(l+1)/(o*(a-t))}function J(e){var t,a,n,s;return t=e,a=(t*=t>=0?3:1.5)>=.5&&t<=2.5?8*((s=t-.5)*s-2*s):0,(n=15.811389+7.5*(t+=.474)-17.5*Math.sqrt(1+t*t))<=-60?0:(t=Math.exp((a+n)*g),t/=.6609193)}function Q(e){return e<0&&(e=0),e*=.001,13*Math.atan(.76*e)+3.5*Math.atan(e*e/56.25)}function ee(e,t,a,n,s,i,o,c,m,h,f,p){var g,b=r(u.CBANDS+1),v=c/(p>15?1152:384),y=l(u.HBLKSIZE);c/=m;var _=0,x=0;for(g=0;g<u.CBANDS;g++){var w;for(j=Q(c*_),b[g]=c*_,w=_;Q(c*w)-j<.34&&w<=m/2;w++);for(e[g]=w-_,x=g+1;_<w;)d(_<u.HBLKSIZE),y[_++]=g;if(_>m/2){_=m/2,++g;break}}d(g<u.CBANDS),b[g]=c*_;for(var k=0;k<p;k++){var M,S,C,N,A;C=h[k],N=h[k+1],(M=0|Math.floor(.5+f*(C-.5)))<0&&(M=0),(S=0|Math.floor(.5+f*(N-.5)))>m/2&&(S=m/2),a[k]=(y[M]+y[S])/2,t[k]=y[S];var E=v*N;o[k]=(E-b[t[k]])/(b[t[k]+1]-b[t[k]]),o[k]<0?o[k]=0:o[k]>1&&(o[k]=1),A=Q(c*h[k]*f),A=Math.min(A,15.5)/15.5,i[k]=Math.pow(10,1.25*(1-Math.cos(Math.PI*A))-2.5)}_=0;for(var I=0;I<x;I++){var j,T,B=e[I];j=Q(c*_),T=Q(c*(_+B-1)),n[I]=.5*(j+T),j=Q(c*(_-.5)),T=Q(c*(_+B-.5)),s[I]=T-j,_+=B}return x}function te(e,t,a,n,s,i){var l,d=o([u.CBANDS,u.CBANDS]),c=0;if(i)for(var m=0;m<t;m++)for(l=0;l<t;l++){var h=J(a[m]-a[l])*n[l];d[m][l]=h*s[m]}else for(l=0;l<t;l++){var f=15+Math.min(21/a[l],12),p=Z(f);for(m=0;m<t;m++){h=p*Y(a[m]-a[l],f)*n[l];d[m][l]=h*s[m]}}for(m=0;m<t;m++){for(l=0;l<t&&!(d[m][l]>0);l++);for(e[m][0]=l,l=t-1;l>0&&!(d[m][l]>0);l--);e[m][1]=l,c+=e[m][1]-e[m][0]+1}var g=r(c),b=0;for(m=0;m<t;m++)for(l=e[m][0];l<=e[m][1];l++)g[b++]=d[m][l];return g}function ae(e){var t=Q(e);return t=Math.min(t,15.5)/15.5,Math.pow(10,1.25*(1-Math.cos(Math.PI*t))-2.5)}function ne(e,t){return e<-.3&&(e=3410),e/=1e3,e=Math.max(.1,e),3.64*Math.pow(e,-.8)-6.8*Math.exp(-.6*Math.pow(e-3.4,2))+6*Math.exp(-.15*Math.pow(e-8.7,2))+.001*(.6+.04*t)*Math.pow(e,4)}this.L3psycho_anal_vbr=function(e,t,a,s,i,c,m,h,f,g){var b=e.internal_flags,v=r(u.HBLKSIZE),y=o([3,u.HBLKSIZE_s]),_=o([2,u.BLKSIZE]),x=o([2,3,u.BLKSIZE_s]),w=o([4,u.CBANDS]),k=o([4,u.CBANDS]),M=o([4,3]),S=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],C=l(2),N=e.mode==MPEGMode.JOINT_STEREO?4:b.channels_out;!function(e,t,a,n,s,i,l,c,u,m){for(var h=o([2,576]),f=e.internal_flags,g=f.channels_out,b=e.mode==MPEGMode.JOINT_STEREO?4:g,v=0;v<g;v++){firbuf=t[v];var y=a+576-350-p+192;d(10==K.length);for(var _=0;_<576;_++){var x,w;x=firbuf[y+_+10],w=0;for(var k=0;k<9;k+=2)x+=K[k]*(firbuf[y+_+k]+firbuf[y+_+p-k]),w+=K[k+1]*(firbuf[y+_+k+1]+firbuf[y+_+p-k-1]);h[v][_]=x+w}s[n][v].en.assign(f.en[v]),s[n][v].thm.assign(f.thm[v]),b>2&&(i[n][v].en.assign(f.en[v+2]),i[n][v].thm.assign(f.thm[v+2]))}for(v=0;v<b;v++){var M=r(12),S=r(12),C=[0,0,0,0],N=h[1&v],A=0,E=3==v?f.nsPsy.attackthre_s:f.nsPsy.attackthre,I=1;if(2==v)for(_=0,k=576;k>0;++_,--k){var j=h[0][_],T=h[1][_];h[0][_]=j+T,h[1][_]=j-T}for(_=0;_<3;_++)S[_]=f.nsPsy.last_en_subshort[v][_+6],d(f.nsPsy.last_en_subshort[v][_+4]>0),M[_]=S[_]/f.nsPsy.last_en_subshort[v][_+4],C[0]+=S[_];for(_=0;_<9;_++){for(var B=A+64,P=1;A<B;A++)P<Math.abs(N[A])&&(P=Math.abs(N[A]));f.nsPsy.last_en_subshort[v][_]=S[_+3]=P,C[1+_/3]+=P,P>S[_+3-2]?(d(S[_+3-2]>0),P/=S[_+3-2]):S[_+3-2]>10*P?(d(P>0),P=S[_+3-2]/(10*P)):P=0,M[_+3]=P}for(_=0;_<3;++_){var R=S[3*_+3]+S[3*_+4]+S[3*_+5],D=1;6*S[3*_+5]<R&&(D*=.5,6*S[3*_+4]<R&&(D*=.5)),c[v][_]=D}if(e.analysis){var O=M[0];for(_=1;_<12;_++)O<M[_]&&(O=M[_]);f.pinfo.ers[n][v]=f.pinfo.ers_save[v],f.pinfo.ers_save[v]=O}for(_=0;_<12;_++)0==u[v][_/3]&&M[_]>E&&(u[v][_/3]=_%3+1);for(_=1;_<4;_++){var L=C[_-1],F=C[_];Math.max(L,F)<4e4&&L<1.7*F&&F<1.7*L&&(1==_&&u[v][0]<=u[v][_]&&(u[v][0]=0),u[v][_]=0)}u[v][0]<=f.nsPsy.lastAttacks[v]&&(u[v][0]=0),3!=f.nsPsy.lastAttacks[v]&&u[v][0]+u[v][1]+u[v][2]+u[v][3]==0||(I=0,0!=u[v][1]&&0!=u[v][0]&&(u[v][1]=0),0!=u[v][2]&&0!=u[v][1]&&(u[v][2]=0),0!=u[v][3]&&0!=u[v][2]&&(u[v][3]=0)),v<2?m[v]=I:0==I&&(m[0]=m[1]=0),l[v]=f.tot_ener[v]}}(e,t,a,s,i,c,f,M,S,C),function(e,t){var a=e.internal_flags;e.short_blocks!=n.short_block_coupled||0!=t[0]&&0!=t[1]||(t[0]=t[1]=0);for(var s=0;s<a.channels_out;s++)e.short_blocks==n.short_block_dispensed&&(t[s]=1),e.short_blocks==n.short_block_forced&&(t[s]=0)}(e,C);for(var A=0;A<N;A++){V(e,t,a,A,s,v,_,T=1&A),H(e,s,A,v),0!=C[T]?X(b,v,w[A],k[A],A):z(b,A)}C[0]+C[1]==2&&e.mode==MPEGMode.JOINT_STEREO&&W(w,k,b.mld_cb_l,b.ATH.cb_l,e.ATHlower*b.ATH.adjust,e.msfix,b.npart_l);for(A=0;A<N;A++){0!=C[T=1&A]&&j(b,w[A],k[A],A)}for(var E=0;E<3;E++){for(A=0;A<N;++A){0!=C[T=1&A]?q(b,A,E):($(e,t,a,A,E,y,x,T),G(e,y,w[A],k[A],A,E))}C[0]+C[1]==0&&e.mode==MPEGMode.JOINT_STEREO&&W(w,k,b.mld_cb_s,b.ATH.cb_s,e.ATHlower*b.ATH.adjust,e.msfix,b.npart_s);for(A=0;A<N;++A){0==C[T=1&A]&&I(b,w[A],k[A],A,E)}}for(A=0;A<N;A++){var T;if(0==C[T=1&A])for(var P=0;P<u.SBMAX_s;P++){var D=r(3);for(E=0;E<3;E++){var L=b.thm[A].s[P][E];if(L*=.8,S[A][E]>=2||1==S[A][E+1]){var F=0!=E?E-1:2,U=B(b.thm[A].s[P][F],L,.36);L=Math.min(L,U)}else if(1==S[A][E]){F=0!=E?E-1:2,U=B(b.thm[A].s[P][F],L,.18);L=Math.min(L,U)}else if(0!=E&&3==S[A][E-1]||0==E&&3==b.nsPsy.lastAttacks[A]){F=2!=E?E+1:0,U=B(b.thm[A].s[P][F],L,.18);L=Math.min(L,U)}L*=M[A][E],D[E]=L}for(E=0;E<3;E++)b.thm[A].s[P][E]=D[E]}}for(A=0;A<N;A++)b.nsPsy.lastAttacks[A]=S[A][2];!function(e,t,a){for(var n=e.internal_flags,s=0;s<n.channels_out;s++){var i=u.NORM_TYPE;0!=t[s]?(d(n.blocktype_old[s]!=u.START_TYPE),n.blocktype_old[s]==u.SHORT_TYPE&&(i=u.STOP_TYPE)):(i=u.SHORT_TYPE,n.blocktype_old[s]==u.NORM_TYPE&&(n.blocktype_old[s]=u.START_TYPE),n.blocktype_old[s]==u.STOP_TYPE&&(n.blocktype_old[s]=u.SHORT_TYPE)),a[s]=n.blocktype_old[s],n.blocktype_old[s]=i}}(e,C,g);for(A=0;A<N;A++){var Y,Z,J,Q;A>1?(Y=h,Z=-2,J=u.NORM_TYPE,g[0]!=u.SHORT_TYPE&&g[1]!=u.SHORT_TYPE||(J=u.SHORT_TYPE),Q=c[s][A-2]):(Y=m,Z=0,J=g[A],Q=i[s][A]),J==u.SHORT_TYPE?Y[Z+A]=R(Q,b.masking_lower):Y[Z+A]=O(Q,b.masking_lower),e.analysis&&(b.pinfo.pe[s][A]=Y[Z+A])}return 0},this.psymodel_init=function(n){var s,i=n.internal_flags,o=!0,l=13,c=24,h=0,f=0,p=-8.25,g=-4.5,b=r(u.CBANDS),v=r(u.CBANDS),y=r(u.CBANDS),k=n.out_samplerate;switch(n.experimentalZ){default:case 0:o=!0;break;case 1:o=n.VBR!=t.vbr_mtrh&&n.VBR!=t.vbr_mt;break;case 2:o=!1;break;case 3:l=8,h=-1.75,f=-.0125,p=-8.25,g=-2.25}for(i.ms_ener_ratio_old=.25,i.blocktype_old[0]=i.blocktype_old[1]=u.NORM_TYPE,s=0;s<4;++s){for(var M=0;M<u.CBANDS;++M)i.nb_1[s][M]=1e20,i.nb_2[s][M]=1e20,i.nb_s1[s][M]=i.nb_s2[s][M]=1;for(var S=0;S<u.SBMAX_l;S++)i.en[s].l[S]=1e20,i.thm[s].l[S]=1e20;for(M=0;M<3;++M){for(S=0;S<u.SBMAX_s;S++)i.en[s].s[S][M]=1e20,i.thm[s].s[S][M]=1e20;i.nsPsy.lastAttacks[s]=0}for(M=0;M<9;M++)i.nsPsy.last_en_subshort[s][M]=10}for(i.loudness_sq_save[0]=i.loudness_sq_save[1]=0,i.npart_l=ee(i.numlines_l,i.bo_l,i.bm_l,b,v,i.mld_l,i.PSY.bo_l_weight,k,u.BLKSIZE,i.scalefac_band.l,u.BLKSIZE/1152,u.SBMAX_l),d(i.npart_l<u.CBANDS),s=0;s<i.npart_l;s++){var C=h;b[s]>=l&&(C=f*(b[s]-l)/(c-l)+h*(c-b[s])/(c-l)),y[s]=Math.pow(10,C/10),i.numlines_l[s]>0?i.rnumlines_l[s]=1/i.numlines_l[s]:i.rnumlines_l[s]=0}i.s3_ll=te(i.s3ind,i.npart_l,b,v,y,o);var N;M=0;for(s=0;s<i.npart_l;s++){I=a.MAX_VALUE;for(var A=0;A<i.numlines_l[s];A++,M++){var E=k*M/(1e3*u.BLKSIZE);j=this.ATHformula(1e3*E,n)-20,j=Math.pow(10,.1*j),I>(j*=i.numlines_l[s])&&(I=j)}i.ATH.cb_l[s]=I,(I=20*b[s]/10-20)>6&&(I=100),I<-15&&(I=-15),I-=8,i.minval_l[s]=Math.pow(10,I/10)*i.numlines_l[s]}for(i.npart_s=ee(i.numlines_s,i.bo_s,i.bm_s,b,v,i.mld_s,i.PSY.bo_s_weight,k,u.BLKSIZE_s,i.scalefac_band.s,u.BLKSIZE_s/384,u.SBMAX_s),d(i.npart_s<u.CBANDS),M=0,s=0;s<i.npart_s;s++){var I;C=p;b[s]>=l&&(C=g*(b[s]-l)/(c-l)+p*(c-b[s])/(c-l)),y[s]=Math.pow(10,C/10),I=a.MAX_VALUE;for(A=0;A<i.numlines_s[s];A++,M++){var j;E=k*M/(1e3*u.BLKSIZE_s);j=this.ATHformula(1e3*E,n)-20,j=Math.pow(10,.1*j),I>(j*=i.numlines_s[s])&&(I=j)}i.ATH.cb_s[s]=I,I=7*b[s]/12-7,b[s]>12&&(I*=1+3.1*Math.log(1+I)),b[s]<12&&(I*=1+2.3*Math.log(1-I)),I<-15&&(I=-15),I-=8,i.minval_s[s]=Math.pow(10,I/10)*i.numlines_s[s]}i.s3_ss=te(i.s3ind_s,i.npart_s,b,v,y,o),_=Math.pow(10,9/16),x=Math.pow(10,1.5),w=Math.pow(10,1.5),e.init_fft(i),i.decay=Math.exp(-1*m/(.01*k/192)),N=3.5,2&n.exp_nspsytune&&(N=1),Math.abs(n.msfix)>0&&(N=n.msfix),n.msfix=N;for(var T=0;T<i.npart_l;T++)i.s3ind[T][1]>i.npart_l-1&&(i.s3ind[T][1]=i.npart_l-1);var B=576*i.mode_gr/k;if(i.ATH.decay=Math.pow(10,-1.2*B),i.ATH.adjust=.01,i.ATH.adjustLimit=1,d(i.bo_l[u.SBMAX_l-1]<=i.npart_l),d(i.bo_s[u.SBMAX_s-1]<=i.npart_s),-1!=n.ATHtype){var P=n.out_samplerate/u.BLKSIZE,R=0;for(E=0,s=0;s<u.BLKSIZE/2;++s)E+=P,i.ATH.eql_w[s]=1/Math.pow(10,this.ATHformula(E,n)/10),R+=i.ATH.eql_w[s];for(R=1/R,s=u.BLKSIZE/2;--s>=0;)i.ATH.eql_w[s]*=R}for(T=M=0;T<i.npart_s;++T)for(s=0;s<i.numlines_s[T];++s)++M;d(129==M);for(T=M=0;T<i.npart_l;++T)for(s=0;s<i.numlines_l[T];++s)++M;for(d(513==M),M=0,s=0;s<i.npart_l;s++){E=k*(M+i.numlines_l[s]/2)/(1*u.BLKSIZE);i.mld_cb_l[s]=ae(E),M+=i.numlines_l[s]}for(;s<u.CBANDS;++s)i.mld_cb_l[s]=1;for(M=0,s=0;s<i.npart_s;s++){E=k*(M+i.numlines_s[s]/2)/(1*u.BLKSIZE_s);i.mld_cb_s[s]=ae(E),M+=i.numlines_s[s]}for(;s<u.CBANDS;++s)i.mld_cb_s[s]=1;return 0},this.ATHformula=function(e,t){var a;switch(t.ATHtype){case 0:a=ne(e,9);break;case 1:a=ne(e,-1);break;case 2:default:a=ne(e,0);break;case 3:a=ne(e,1)+6;break;case 4:a=ne(e,t.ATHcurve)}return a}},En}function Os(){if(Tn)return jn;function e(e){var t=e;this.ordinal=function(){return t}}return Tn=1,e.STEREO=new e(0),e.JOINT_STEREO=new e(1),e.DUAL_CHANNEL=new e(2),e.MONO=new e(3),e.NOT_SET=new e(4),jn=e}function Ls(){if(Dn)return Rn;Dn=1;var e=Rs(),t={};return t.SFBMAX=3*e.SBMAX_s,Rn=t}function Fs(){if(Ln)return On;Ln=1;var e=Bs();e.System,e.VbrMode,e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n,e.new_byte,e.new_double;var t=e.new_float;e.new_float_n;var a=e.new_int;e.new_int_n,e.assert;var n=Ls();return On=function(){this.xr=t(576),this.l3_enc=a(576),this.scalefac=a(n.SFBMAX),this.xrpow_max=0,this.part2_3_length=0,this.big_values=0,this.count1=0,this.global_gain=0,this.scalefac_compress=0,this.block_type=0,this.mixed_block_flag=0,this.table_select=a(3),this.subblock_gain=a(4),this.region0_count=0,this.region1_count=0,this.preflag=0,this.scalefac_scale=0,this.count1table_select=0,this.part2_length=0,this.sfb_lmax=0,this.sfb_smin=0,this.psy_lmax=0,this.sfbmax=0,this.psymax=0,this.sfbdivide=0,this.width=a(n.SFBMAX),this.window=a(n.SFBMAX),this.count1bits=0,this.sfb_partition_table=null,this.slen=a(4),this.max_nonzero_coeff=0;var e=this;function s(e){return new Int32Array(e)}this.assign=function(t){var a;e.xr=(a=t.xr,new Float32Array(a)),e.l3_enc=s(t.l3_enc),e.scalefac=s(t.scalefac),e.xrpow_max=t.xrpow_max,e.part2_3_length=t.part2_3_length,e.big_values=t.big_values,e.count1=t.count1,e.global_gain=t.global_gain,e.scalefac_compress=t.scalefac_compress,e.block_type=t.block_type,e.mixed_block_flag=t.mixed_block_flag,e.table_select=s(t.table_select),e.subblock_gain=s(t.subblock_gain),e.region0_count=t.region0_count,e.region1_count=t.region1_count,e.preflag=t.preflag,e.scalefac_scale=t.scalefac_scale,e.count1table_select=t.count1table_select,e.part2_length=t.part2_length,e.sfb_lmax=t.sfb_lmax,e.sfb_smin=t.sfb_smin,e.psy_lmax=t.psy_lmax,e.sfbmax=t.sfbmax,e.psymax=t.psymax,e.sfbdivide=t.sfbdivide,e.width=s(t.width),e.window=s(t.window),e.count1bits=t.count1bits,e.sfb_partition_table=t.sfb_partition_table.slice(0),e.slen=s(t.slen),e.max_nonzero_coeff=t.max_nonzero_coeff}}}function Us(){if($n)return Vn;$n=1;var e=Bs(),t=e.System;e.VbrMode,e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n,e.new_byte,e.new_double,e.new_float,e.new_float_n;var a=e.new_int;e.new_int_n,e.assert;var n=Rs();return Vn=function(e,s,i,r){this.l=a(1+n.SBMAX_l),this.s=a(1+n.SBMAX_s),this.psfb21=a(1+n.PSFB21),this.psfb12=a(1+n.PSFB12);var o=this.l,l=this.s;4==arguments.length&&(this.arrL=arguments[0],this.arrS=arguments[1],this.arr21=arguments[2],this.arr12=arguments[3],t.arraycopy(this.arrL,0,o,0,Math.min(this.arrL.length,this.l.length)),t.arraycopy(this.arrS,0,l,0,Math.min(this.arrS.length,this.s.length)),t.arraycopy(this.arr21,0,this.psfb21,0,Math.min(this.arr21.length,this.psfb21.length)),t.arraycopy(this.arr12,0,this.psfb12,0,Math.min(this.arr12.length,this.psfb12.length)))},Vn}function Vs(){if(Xn)return Gn;Xn=1;var e=Bs();e.System,e.VbrMode,e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n;var t=e.new_byte,a=e.new_double,n=e.new_float,s=e.new_float_n,i=e.new_int,r=e.new_int_n;e.assert;var o=function(){if(Un)return Fn;Un=1;var e=Bs();e.System,e.VbrMode,e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n,e.new_byte,e.new_double,e.new_float,e.new_float_n;var t=e.new_int;e.new_int_n,e.assert;var a=Fs();return Fn=function(){this.tt=[[null,null],[null,null]],this.main_data_begin=0,this.private_bits=0,this.resvDrain_pre=0,this.resvDrain_post=0,this.scfsi=[t(4),t(4)];for(var e=0;e<2;e++)for(var n=0;n<2;n++)this.tt[e][n]=new a}}(),l=Us(),d=function(){if(Kn)return Hn;Kn=1;var e=Bs();e.System,e.VbrMode,e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n,e.new_byte,e.new_double;var t=e.new_float,a=e.new_float_n,n=e.new_int;e.new_int_n,e.assert;var s=Rs();return Hn=function(){this.last_en_subshort=a([4,9]),this.lastAttacks=n(4),this.pefirbuf=t(19),this.longfact=t(s.SBMAX_l),this.shortfact=t(s.SBMAX_s),this.attackthre=0,this.attackthre_s=0}}(),c=zn?qn:(zn=1,qn=function(){this.sum=0,this.seen=0,this.want=0,this.pos=0,this.size=0,this.bag=null,this.nVbrNumFrames=0,this.nBytesWritten=0,this.TotalFrameSize=0}),u=Ps(),m=Rs(),h=Ls();function f(){function e(){this.write_timing=0,this.ptr=0,this.buf=t(40)}this.Class_ID=0,this.lame_encode_frame_init=0,this.iteration_init_init=0,this.fill_buffer_resample_init=0,this.mfbuf=s([2,f.MFSIZE]),this.mode_gr=0,this.channels_in=0,this.channels_out=0,this.resample_ratio=0,this.mf_samples_to_encode=0,this.mf_size=0,this.VBR_min_bitrate=0,this.VBR_max_bitrate=0,this.bitrate_index=0,this.samplerate_index=0,this.mode_ext=0,this.lowpass1=0,this.lowpass2=0,this.highpass1=0,this.highpass2=0,this.noise_shaping=0,this.noise_shaping_amp=0,this.substep_shaping=0,this.psymodel=0,this.noise_shaping_stop=0,this.subblock_gain=0,this.use_best_huffman=0,this.full_outer_loop=0,this.l3_side=new o,this.ms_ratio=n(2),this.padding=0,this.frac_SpF=0,this.slot_lag=0,this.tag_spec=null,this.nMusicCRC=0,this.OldValue=i(2),this.CurrentStep=i(2),this.masking_lower=0,this.bv_scf=i(576),this.pseudohalf=i(h.SFBMAX),this.sfb21_extra=!1,this.inbuf_old=new Array(2),this.blackfilt=new Array(2*f.BPC+1),this.itime=a(2),this.sideinfo_len=0,this.sb_sample=s([2,2,18,m.SBLIMIT]),this.amp_filter=n(32),this.header=new Array(f.MAX_HEADER_BUF),this.h_ptr=0,this.w_ptr=0,this.ancillary_flag=0,this.ResvSize=0,this.ResvMax=0,this.scalefac_band=new l,this.minval_l=n(m.CBANDS),this.minval_s=n(m.CBANDS),this.nb_1=s([4,m.CBANDS]),this.nb_2=s([4,m.CBANDS]),this.nb_s1=s([4,m.CBANDS]),this.nb_s2=s([4,m.CBANDS]),this.s3_ss=null,this.s3_ll=null,this.decay=0,this.thm=new Array(4),this.en=new Array(4),this.tot_ener=n(4),this.loudness_sq=s([2,2]),this.loudness_sq_save=n(2),this.mld_l=n(m.SBMAX_l),this.mld_s=n(m.SBMAX_s),this.bm_l=i(m.SBMAX_l),this.bo_l=i(m.SBMAX_l),this.bm_s=i(m.SBMAX_s),this.bo_s=i(m.SBMAX_s),this.npart_l=0,this.npart_s=0,this.s3ind=r([m.CBANDS,2]),this.s3ind_s=r([m.CBANDS,2]),this.numlines_s=i(m.CBANDS),this.numlines_l=i(m.CBANDS),this.rnumlines_l=n(m.CBANDS),this.mld_cb_l=n(m.CBANDS),this.mld_cb_s=n(m.CBANDS),this.numlines_s_num1=0,this.numlines_l_num1=0,this.pe=n(4),this.ms_ratio_s_old=0,this.ms_ratio_l_old=0,this.ms_ener_ratio_old=0,this.blocktype_old=i(2),this.nsPsy=new d,this.VBR_seek_table=new c,this.ATH=null,this.PSY=null,this.nogap_total=0,this.nogap_current=0,this.decode_on_the_fly=!0,this.findReplayGain=!0,this.findPeakSample=!0,this.PeakSample=0,this.RadioGain=0,this.AudiophileGain=0,this.rgdata=null,this.noclipGainChange=0,this.noclipScale=0,this.bitrate_stereoMode_Hist=r([16,5]),this.bitrate_blockType_Hist=r([16,6]),this.pinfo=null,this.hip=null,this.in_buffer_nsamples=0,this.in_buffer_0=null,this.in_buffer_1=null,this.iteration_loop=null;for(var p=0;p<this.en.length;p++)this.en[p]=new u;for(p=0;p<this.thm.length;p++)this.thm[p]=new u;for(p=0;p<this.header.length;p++)this.header[p]=new e}return f.MFSIZE=3456+m.ENCDELAY-m.MDCTDELAY,f.MAX_HEADER_BUF=256,f.MAX_BITS_PER_CHANNEL=4095,f.MAX_BITS_PER_GRANULE=7680,f.BPC=320,Gn=f}function $s(){if(Jn)return Zn;Jn=1;var e=Bs(),t=e.System;e.VbrMode,e.Float,e.ShortBlock,e.Util;var a=e.Arrays;function n(){n.YULE_ORDER;n.MAX_SAMP_FREQ;var e=n.RMS_WINDOW_TIME_NUMERATOR,s=n.RMS_WINDOW_TIME_DENOMINATOR;n.MAX_SAMPLES_PER_WINDOW;var i=[[.038575994352,-3.84664617118067,-.02160367184185,7.81501653005538,-.00123395316851,-11.34170355132042,-9291677959e-14,13.05504219327545,-.01655260341619,-12.28759895145294,.02161526843274,9.4829380631979,-.02074045215285,-5.87257861775999,.00594298065125,2.75465861874613,.00306428023191,-.86984376593551,.00012025322027,.13919314567432,.00288463683916],[.0541865640643,-3.47845948550071,-.02911007808948,6.36317777566148,-.00848709379851,-8.54751527471874,-.00851165645469,9.4769360780128,-.00834990904936,-8.81498681370155,.02245293253339,6.85401540936998,-.02596338512915,-4.39470996079559,.01624864962975,2.19611684890774,-.00240879051584,-.75104302451432,.00674613682247,.13149317958808,-.00187763777362],[.15457299681924,-2.37898834973084,-.09331049056315,2.84868151156327,-.06247880153653,-2.64577170229825,.02163541888798,2.23697657451713,-.05588393329856,-1.67148153367602,.04781476674921,1.00595954808547,.00222312597743,-.45953458054983,.03174092540049,.16378164858596,-.01390589421898,-.05032077717131,.00651420667831,.0234789740702,-.00881362733839],[.30296907319327,-1.61273165137247,-.22613988682123,1.0797749225997,-.08587323730772,-.2565625775407,.03282930172664,-.1627671912044,-.00915702933434,-.22638893773906,-.02364141202522,.39120800788284,-.00584456039913,-.22138138954925,.06276101321749,.04500235387352,-828086748e-14,.02005851806501,.00205861885564,.00302439095741,-.02950134983287],[.33642304856132,-1.49858979367799,-.2557224142557,.87350271418188,-.11828570177555,.12205022308084,.11921148675203,-.80774944671438,-.07834489609479,.47854794562326,-.0046997791438,-.12453458140019,-.0058950022444,-.04067510197014,.05724228140351,.08333755284107,.00832043980773,-.04237348025746,-.0163538138454,.02977207319925,-.0176017656815],[.4491525660845,-.62820619233671,-.14351757464547,.29661783706366,-.22784394429749,-.372563729424,-.01419140100551,.00213767857124,.04078262797139,-.42029820170918,-.12398163381748,.22199650564824,.04097565135648,.00613424350682,.10478503600251,.06747620744683,-.01863887810927,.05784820375801,-.03193428438915,.03222754072173,.00541907748707],[.56619470757641,-1.04800335126349,-.75464456939302,.29156311971249,.1624213774223,-.26806001042947,.16744243493672,.00819999645858,-.18901604199609,.45054734505008,.3093178284183,-.33032403314006,-.27562961986224,.0673936833311,.00647310677246,-.04784254229033,.08647503780351,.01639907836189,-.0378898455484,.01807364323573,-.00588215443421],[.58100494960553,-.51035327095184,-.53174909058578,-.31863563325245,-.14289799034253,-.20256413484477,.17520704835522,.1472815413433,.02377945217615,.38952639978999,.15558449135573,-.23313271880868,-.25344790059353,-.05246019024463,.01628462406333,-.02505961724053,.06920467763959,.02442357316099,-.03721611395801,.01818801111503,-.00749618797172],[.53648789255105,-.2504987195602,-.42163034350696,-.43193942311114,-.00275953611929,-.03424681017675,.04267842219415,-.04678328784242,-.10214864179676,.26408300200955,.14590772289388,.15113130533216,-.02459864859345,-.17556493366449,-.11202315195388,-.18823009262115,-.04060034127,.05477720428674,.0478866554818,.0470440968812,-.02217936801134]],r=[[.98621192462708,-1.97223372919527,-1.97242384925416,.97261396931306,.98621192462708],[.98500175787242,-1.96977855582618,-1.97000351574484,.9702284756635,.98500175787242],[.97938932735214,-1.95835380975398,-1.95877865470428,.95920349965459,.97938932735214],[.97531843204928,-1.95002759149878,-1.95063686409857,.95124613669835,.97531843204928],[.97316523498161,-1.94561023566527,-1.94633046996323,.94705070426118,.97316523498161],[.96454515552826,-1.92783286977036,-1.92909031105652,.93034775234268,.96454515552826],[.96009142950541,-1.91858953033784,-1.92018285901082,.92177618768381,.96009142950541],[.95856916599601,-1.9154210807478,-1.91713833199203,.91885558323625,.95856916599601],[.94597685600279,-1.88903307939452,-1.89195371200558,.89487434461664,.94597685600279]];function o(e,t,a,n,s,i){for(;0!=s--;)a[n]=1e-10+e[t+0]*i[0]-a[n-1]*i[1]+e[t-1]*i[2]-a[n-2]*i[3]+e[t-2]*i[4]-a[n-3]*i[5]+e[t-3]*i[6]-a[n-4]*i[7]+e[t-4]*i[8]-a[n-5]*i[9]+e[t-5]*i[10]-a[n-6]*i[11]+e[t-6]*i[12]-a[n-7]*i[13]+e[t-7]*i[14]-a[n-8]*i[15]+e[t-8]*i[16]-a[n-9]*i[17]+e[t-9]*i[18]-a[n-10]*i[19]+e[t-10]*i[20],++n,++t}function l(e,t,a,n,s,i){for(;0!=s--;)a[n]=e[t+0]*i[0]-a[n-1]*i[1]+e[t-1]*i[2]-a[n-2]*i[3]+e[t-2]*i[4],++n,++t}function d(e){return e*e}this.InitGainAnalysis=function(t,n){return function(t,n){for(var i=0;i<MAX_ORDER;i++)t.linprebuf[i]=t.lstepbuf[i]=t.loutbuf[i]=t.rinprebuf[i]=t.rstepbuf[i]=t.routbuf[i]=0;switch(0|n){case 48e3:t.reqindex=0;break;case 44100:t.reqindex=1;break;case 32e3:t.reqindex=2;break;case 24e3:t.reqindex=3;break;case 22050:t.reqindex=4;break;case 16e3:t.reqindex=5;break;case 12e3:t.reqindex=6;break;case 11025:t.reqindex=7;break;case 8e3:t.reqindex=8;break;default:return INIT_GAIN_ANALYSIS_ERROR}return t.sampleWindow=0|(n*e+s-1)/s,t.lsum=0,t.rsum=0,t.totsamp=0,a.ill(t.A,0),INIT_GAIN_ANALYSIS_OK}(t,n)!=INIT_GAIN_ANALYSIS_OK?INIT_GAIN_ANALYSIS_ERROR:(t.linpre=MAX_ORDER,t.rinpre=MAX_ORDER,t.lstep=MAX_ORDER,t.rstep=MAX_ORDER,t.lout=MAX_ORDER,t.rout=MAX_ORDER,a.fill(t.B,0),INIT_GAIN_ANALYSIS_OK)},this.AnalyzeSamples=function(e,a,s,c,u,m,h){var f,p,g,b,v,y,_;if(0==m)return GAIN_ANALYSIS_OK;switch(_=0,v=m,h){case 1:c=a,u=s;break;case 2:break;default:return GAIN_ANALYSIS_ERROR}for(m<MAX_ORDER?(t.arraycopy(a,s,e.linprebuf,MAX_ORDER,m),t.arraycopy(c,u,e.rinprebuf,MAX_ORDER,m)):(t.arraycopy(a,s,e.linprebuf,MAX_ORDER,MAX_ORDER),t.arraycopy(c,u,e.rinprebuf,MAX_ORDER,MAX_ORDER));v>0;){y=v>e.sampleWindow-e.totsamp?e.sampleWindow-e.totsamp:v,_<MAX_ORDER?(f=e.linpre+_,p=e.linprebuf,g=e.rinpre+_,b=e.rinprebuf,y>MAX_ORDER-_&&(y=MAX_ORDER-_)):(f=s+_,p=a,g=u+_,b=c),o(p,f,e.lstepbuf,e.lstep+e.totsamp,y,i[e.reqindex]),o(b,g,e.rstepbuf,e.rstep+e.totsamp,y,i[e.reqindex]),l(e.lstepbuf,e.lstep+e.totsamp,e.loutbuf,e.lout+e.totsamp,y,r[e.reqindex]),l(e.rstepbuf,e.rstep+e.totsamp,e.routbuf,e.rout+e.totsamp,y,r[e.reqindex]),f=e.lout+e.totsamp,p=e.loutbuf,g=e.rout+e.totsamp,b=e.routbuf;for(var x=y%8;0!=x--;)e.lsum+=d(p[f++]),e.rsum+=d(b[g++]);for(x=y/8;0!=x--;)e.lsum+=d(p[f+0])+d(p[f+1])+d(p[f+2])+d(p[f+3])+d(p[f+4])+d(p[f+5])+d(p[f+6])+d(p[f+7]),f+=8,e.rsum+=d(b[g+0])+d(b[g+1])+d(b[g+2])+d(b[g+3])+d(b[g+4])+d(b[g+5])+d(b[g+6])+d(b[g+7]),g+=8;if(v-=y,_+=y,e.totsamp+=y,e.totsamp==e.sampleWindow){var w=10*n.STEPS_per_dB*Math.log10((e.lsum+e.rsum)/e.totsamp*.5+1e-37),k=w<=0?0:0|w;k>=e.A.length&&(k=e.A.length-1),e.A[k]++,e.lsum=e.rsum=0,t.arraycopy(e.loutbuf,e.totsamp,e.loutbuf,0,MAX_ORDER),t.arraycopy(e.routbuf,e.totsamp,e.routbuf,0,MAX_ORDER),t.arraycopy(e.lstepbuf,e.totsamp,e.lstepbuf,0,MAX_ORDER),t.arraycopy(e.rstepbuf,e.totsamp,e.rstepbuf,0,MAX_ORDER),e.totsamp=0}if(e.totsamp>e.sampleWindow)return GAIN_ANALYSIS_ERROR}return m<MAX_ORDER?(t.arraycopy(e.linprebuf,m,e.linprebuf,0,MAX_ORDER-m),t.arraycopy(e.rinprebuf,m,e.rinprebuf,0,MAX_ORDER-m),t.arraycopy(a,s,e.linprebuf,MAX_ORDER-m,m),t.arraycopy(c,u,e.rinprebuf,MAX_ORDER-m,m)):(t.arraycopy(a,s+m-MAX_ORDER,e.linprebuf,0,MAX_ORDER),t.arraycopy(c,u+m-MAX_ORDER,e.rinprebuf,0,MAX_ORDER)),GAIN_ANALYSIS_OK},this.GetTitleGain=function(e){for(var t=function(e,t){var a,s=0;for(a=0;a<t;a++)s+=e[a];if(0==s)return GAIN_NOT_ENOUGH_SAMPLES;var i=0|Math.ceil(s*(1-.95));for(a=t;a-- >0&&!((i-=e[a])<=0););return 64.82-a/n.STEPS_per_dB}(e.A,e.A.length),a=0;a<e.A.length;a++)e.B[a]+=e.A[a],e.A[a]=0;for(a=0;a<MAX_ORDER;a++)e.linprebuf[a]=e.lstepbuf[a]=e.loutbuf[a]=e.rinprebuf[a]=e.rstepbuf[a]=e.routbuf[a]=0;return e.totsamp=0,e.lsum=e.rsum=0,t}}return e.new_array_n,e.new_byte,e.new_double,e.new_float,e.new_float_n,e.new_int,e.new_int_n,e.assert,n.STEPS_per_dB=100,n.MAX_dB=120,n.GAIN_NOT_ENOUGH_SAMPLES=-24601,n.GAIN_ANALYSIS_ERROR=0,n.GAIN_ANALYSIS_OK=1,n.INIT_GAIN_ANALYSIS_ERROR=0,n.INIT_GAIN_ANALYSIS_OK=1,n.YULE_ORDER=10,n.MAX_ORDER=n.YULE_ORDER,n.MAX_SAMP_FREQ=48e3,n.RMS_WINDOW_TIME_NUMERATOR=1,n.RMS_WINDOW_TIME_DENOMINATOR=20,n.MAX_SAMPLES_PER_WINDOW=n.MAX_SAMP_FREQ*n.RMS_WINDOW_TIME_NUMERATOR/n.RMS_WINDOW_TIME_DENOMINATOR+1,Zn=n}function Hs(){if(as)return ts;return as=1,ts=function(e){this.bits=e}}function Ks(){if(rs)return is;function e(e,t,a,n){this.xlen=e,this.linmax=t,this.table=a,this.hlen=n}rs=1;var t={t1HB:[1,1,1,0],t2HB:[1,2,1,3,1,1,3,2,0],t3HB:[3,2,1,1,1,1,3,2,0],t5HB:[1,2,6,5,3,1,4,4,7,5,7,1,6,1,1,0],t6HB:[7,3,5,1,6,2,3,2,5,4,4,1,3,3,2,0],t7HB:[1,2,10,19,16,10,3,3,7,10,5,3,11,4,13,17,8,4,12,11,18,15,11,2,7,6,9,14,3,1,6,4,5,3,2,0],t8HB:[3,4,6,18,12,5,5,1,2,16,9,3,7,3,5,14,7,3,19,17,15,13,10,4,13,5,8,11,5,1,12,4,4,1,1,0],t9HB:[7,5,9,14,15,7,6,4,5,5,6,7,7,6,8,8,8,5,15,6,9,10,5,1,11,7,9,6,4,1,14,4,6,2,6,0],t10HB:[1,2,10,23,35,30,12,17,3,3,8,12,18,21,12,7,11,9,15,21,32,40,19,6,14,13,22,34,46,23,18,7,20,19,33,47,27,22,9,3,31,22,41,26,21,20,5,3,14,13,10,11,16,6,5,1,9,8,7,8,4,4,2,0],t11HB:[3,4,10,24,34,33,21,15,5,3,4,10,32,17,11,10,11,7,13,18,30,31,20,5,25,11,19,59,27,18,12,5,35,33,31,58,30,16,7,5,28,26,32,19,17,15,8,14,14,12,9,13,14,9,4,1,11,4,6,6,6,3,2,0],t12HB:[9,6,16,33,41,39,38,26,7,5,6,9,23,16,26,11,17,7,11,14,21,30,10,7,17,10,15,12,18,28,14,5,32,13,22,19,18,16,9,5,40,17,31,29,17,13,4,2,27,12,11,15,10,7,4,1,27,12,8,12,6,3,1,0],t13HB:[1,5,14,21,34,51,46,71,42,52,68,52,67,44,43,19,3,4,12,19,31,26,44,33,31,24,32,24,31,35,22,14,15,13,23,36,59,49,77,65,29,40,30,40,27,33,42,16,22,20,37,61,56,79,73,64,43,76,56,37,26,31,25,14,35,16,60,57,97,75,114,91,54,73,55,41,48,53,23,24,58,27,50,96,76,70,93,84,77,58,79,29,74,49,41,17,47,45,78,74,115,94,90,79,69,83,71,50,59,38,36,15,72,34,56,95,92,85,91,90,86,73,77,65,51,44,43,42,43,20,30,44,55,78,72,87,78,61,46,54,37,30,20,16,53,25,41,37,44,59,54,81,66,76,57,54,37,18,39,11,35,33,31,57,42,82,72,80,47,58,55,21,22,26,38,22,53,25,23,38,70,60,51,36,55,26,34,23,27,14,9,7,34,32,28,39,49,75,30,52,48,40,52,28,18,17,9,5,45,21,34,64,56,50,49,45,31,19,12,15,10,7,6,3,48,23,20,39,36,35,53,21,16,23,13,10,6,1,4,2,16,15,17,27,25,20,29,11,17,12,16,8,1,1,0,1],t15HB:[7,12,18,53,47,76,124,108,89,123,108,119,107,81,122,63,13,5,16,27,46,36,61,51,42,70,52,83,65,41,59,36,19,17,15,24,41,34,59,48,40,64,50,78,62,80,56,33,29,28,25,43,39,63,55,93,76,59,93,72,54,75,50,29,52,22,42,40,67,57,95,79,72,57,89,69,49,66,46,27,77,37,35,66,58,52,91,74,62,48,79,63,90,62,40,38,125,32,60,56,50,92,78,65,55,87,71,51,73,51,70,30,109,53,49,94,88,75,66,122,91,73,56,42,64,44,21,25,90,43,41,77,73,63,56,92,77,66,47,67,48,53,36,20,71,34,67,60,58,49,88,76,67,106,71,54,38,39,23,15,109,53,51,47,90,82,58,57,48,72,57,41,23,27,62,9,86,42,40,37,70,64,52,43,70,55,42,25,29,18,11,11,118,68,30,55,50,46,74,65,49,39,24,16,22,13,14,7,91,44,39,38,34,63,52,45,31,52,28,19,14,8,9,3,123,60,58,53,47,43,32,22,37,24,17,12,15,10,2,1,71,37,34,30,28,20,17,26,21,16,10,6,8,6,2,0],t16HB:[1,5,14,44,74,63,110,93,172,149,138,242,225,195,376,17,3,4,12,20,35,62,53,47,83,75,68,119,201,107,207,9,15,13,23,38,67,58,103,90,161,72,127,117,110,209,206,16,45,21,39,69,64,114,99,87,158,140,252,212,199,387,365,26,75,36,68,65,115,101,179,164,155,264,246,226,395,382,362,9,66,30,59,56,102,185,173,265,142,253,232,400,388,378,445,16,111,54,52,100,184,178,160,133,257,244,228,217,385,366,715,10,98,48,91,88,165,157,148,261,248,407,397,372,380,889,884,8,85,84,81,159,156,143,260,249,427,401,392,383,727,713,708,7,154,76,73,141,131,256,245,426,406,394,384,735,359,710,352,11,139,129,67,125,247,233,229,219,393,743,737,720,885,882,439,4,243,120,118,115,227,223,396,746,742,736,721,712,706,223,436,6,202,224,222,218,216,389,386,381,364,888,443,707,440,437,1728,4,747,211,210,208,370,379,734,723,714,1735,883,877,876,3459,865,2,377,369,102,187,726,722,358,711,709,866,1734,871,3458,870,434,0,12,10,7,11,10,17,11,9,13,12,10,7,5,3,1,3],t24HB:[15,13,46,80,146,262,248,434,426,669,653,649,621,517,1032,88,14,12,21,38,71,130,122,216,209,198,327,345,319,297,279,42,47,22,41,74,68,128,120,221,207,194,182,340,315,295,541,18,81,39,75,70,134,125,116,220,204,190,178,325,311,293,271,16,147,72,69,135,127,118,112,210,200,188,352,323,306,285,540,14,263,66,129,126,119,114,214,202,192,180,341,317,301,281,262,12,249,123,121,117,113,215,206,195,185,347,330,308,291,272,520,10,435,115,111,109,211,203,196,187,353,332,313,298,283,531,381,17,427,212,208,205,201,193,186,177,169,320,303,286,268,514,377,16,335,199,197,191,189,181,174,333,321,305,289,275,521,379,371,11,668,184,183,179,175,344,331,314,304,290,277,530,383,373,366,10,652,346,171,168,164,318,309,299,287,276,263,513,375,368,362,6,648,322,316,312,307,302,292,284,269,261,512,376,370,364,359,4,620,300,296,294,288,282,273,266,515,380,374,369,365,361,357,2,1033,280,278,274,267,264,259,382,378,372,367,363,360,358,356,0,43,20,19,17,15,13,11,9,7,6,4,7,5,3,1,3],t32HB:[1,10,8,20,12,20,16,32,14,12,24,0,28,16,24,16],t33HB:[15,28,26,48,22,40,36,64,14,24,20,32,12,16,8,0],t1l:[1,4,3,5],t2l:[1,4,7,4,5,7,6,7,8],t3l:[2,3,7,4,4,7,6,7,8],t5l:[1,4,7,8,4,5,8,9,7,8,9,10,8,8,9,10],t6l:[3,4,6,8,4,4,6,7,5,6,7,8,7,7,8,9],t7l:[1,4,7,9,9,10,4,6,8,9,9,10,7,7,9,10,10,11,8,9,10,11,11,11,8,9,10,11,11,12,9,10,11,12,12,12],t8l:[2,4,7,9,9,10,4,4,6,10,10,10,7,6,8,10,10,11,9,10,10,11,11,12,9,9,10,11,12,12,10,10,11,11,13,13],t9l:[3,4,6,7,9,10,4,5,6,7,8,10,5,6,7,8,9,10,7,7,8,9,9,10,8,8,9,9,10,11,9,9,10,10,11,11],t10l:[1,4,7,9,10,10,10,11,4,6,8,9,10,11,10,10,7,8,9,10,11,12,11,11,8,9,10,11,12,12,11,12,9,10,11,12,12,12,12,12,10,11,12,12,13,13,12,13,9,10,11,12,12,12,13,13,10,10,11,12,12,13,13,13],t11l:[2,4,6,8,9,10,9,10,4,5,6,8,10,10,9,10,6,7,8,9,10,11,10,10,8,8,9,11,10,12,10,11,9,10,10,11,11,12,11,12,9,10,11,12,12,13,12,13,9,9,9,10,11,12,12,12,9,9,10,11,12,12,12,12],t12l:[4,4,6,8,9,10,10,10,4,5,6,7,9,9,10,10,6,6,7,8,9,10,9,10,7,7,8,8,9,10,10,10,8,8,9,9,10,10,10,11,9,9,10,10,10,11,10,11,9,9,9,10,10,11,11,12,10,10,10,11,11,11,11,12],t13l:[1,5,7,8,9,10,10,11,10,11,12,12,13,13,14,14,4,6,8,9,10,10,11,11,11,11,12,12,13,14,14,14,7,8,9,10,11,11,12,12,11,12,12,13,13,14,15,15,8,9,10,11,11,12,12,12,12,13,13,13,13,14,15,15,9,9,11,11,12,12,13,13,12,13,13,14,14,15,15,16,10,10,11,12,12,12,13,13,13,13,14,13,15,15,16,16,10,11,12,12,13,13,13,13,13,14,14,14,15,15,16,16,11,11,12,13,13,13,14,14,14,14,15,15,15,16,18,18,10,10,11,12,12,13,13,14,14,14,14,15,15,16,17,17,11,11,12,12,13,13,13,15,14,15,15,16,16,16,18,17,11,12,12,13,13,14,14,15,14,15,16,15,16,17,18,19,12,12,12,13,14,14,14,14,15,15,15,16,17,17,17,18,12,13,13,14,14,15,14,15,16,16,17,17,17,18,18,18,13,13,14,15,15,15,16,16,16,16,16,17,18,17,18,18,14,14,14,15,15,15,17,16,16,19,17,17,17,19,18,18,13,14,15,16,16,16,17,16,17,17,18,18,21,20,21,18],t15l:[3,5,6,8,8,9,10,10,10,11,11,12,12,12,13,14,5,5,7,8,9,9,10,10,10,11,11,12,12,12,13,13,6,7,7,8,9,9,10,10,10,11,11,12,12,13,13,13,7,8,8,9,9,10,10,11,11,11,12,12,12,13,13,13,8,8,9,9,10,10,11,11,11,11,12,12,12,13,13,13,9,9,9,10,10,10,11,11,11,11,12,12,13,13,13,14,10,9,10,10,10,11,11,11,11,12,12,12,13,13,14,14,10,10,10,11,11,11,11,12,12,12,12,12,13,13,13,14,10,10,10,11,11,11,11,12,12,12,12,13,13,14,14,14,10,10,11,11,11,11,12,12,12,13,13,13,13,14,14,14,11,11,11,11,12,12,12,12,12,13,13,13,13,14,15,14,11,11,11,11,12,12,12,12,13,13,13,13,14,14,14,15,12,12,11,12,12,12,13,13,13,13,13,13,14,14,15,15,12,12,12,12,12,13,13,13,13,14,14,14,14,14,15,15,13,13,13,13,13,13,13,13,14,14,14,14,15,15,14,15,13,13,13,13,13,13,13,14,14,14,14,14,15,15,15,15],t16_5l:[1,5,7,9,10,10,11,11,12,12,12,13,13,13,14,11,4,6,8,9,10,11,11,11,12,12,12,13,14,13,14,11,7,8,9,10,11,11,12,12,13,12,13,13,13,14,14,12,9,9,10,11,11,12,12,12,13,13,14,14,14,15,15,13,10,10,11,11,12,12,13,13,13,14,14,14,15,15,15,12,10,10,11,11,12,13,13,14,13,14,14,15,15,15,16,13,11,11,11,12,13,13,13,13,14,14,14,14,15,15,16,13,11,11,12,12,13,13,13,14,14,15,15,15,15,17,17,13,11,12,12,13,13,13,14,14,15,15,15,15,16,16,16,13,12,12,12,13,13,14,14,15,15,15,15,16,15,16,15,14,12,13,12,13,14,14,14,14,15,16,16,16,17,17,16,13,13,13,13,13,14,14,15,16,16,16,16,16,16,15,16,14,13,14,14,14,14,15,15,15,15,17,16,16,16,16,18,14,15,14,14,14,15,15,16,16,16,18,17,17,17,19,17,14,14,15,13,14,16,16,15,16,16,17,18,17,19,17,16,14,11,11,11,12,12,13,13,13,14,14,14,14,14,14,14,12],t16l:[1,5,7,9,10,10,11,11,12,12,12,13,13,13,14,10,4,6,8,9,10,11,11,11,12,12,12,13,14,13,14,10,7,8,9,10,11,11,12,12,13,12,13,13,13,14,14,11,9,9,10,11,11,12,12,12,13,13,14,14,14,15,15,12,10,10,11,11,12,12,13,13,13,14,14,14,15,15,15,11,10,10,11,11,12,13,13,14,13,14,14,15,15,15,16,12,11,11,11,12,13,13,13,13,14,14,14,14,15,15,16,12,11,11,12,12,13,13,13,14,14,15,15,15,15,17,17,12,11,12,12,13,13,13,14,14,15,15,15,15,16,16,16,12,12,12,12,13,13,14,14,15,15,15,15,16,15,16,15,13,12,13,12,13,14,14,14,14,15,16,16,16,17,17,16,12,13,13,13,13,14,14,15,16,16,16,16,16,16,15,16,13,13,14,14,14,14,15,15,15,15,17,16,16,16,16,18,13,15,14,14,14,15,15,16,16,16,18,17,17,17,19,17,13,14,15,13,14,16,16,15,16,16,17,18,17,19,17,16,13,10,10,10,11,11,12,12,12,13,13,13,13,13,13,13,10],t24l:[4,5,7,8,9,10,10,11,11,12,12,12,12,12,13,10,5,6,7,8,9,10,10,11,11,11,12,12,12,12,12,10,7,7,8,9,9,10,10,11,11,11,11,12,12,12,13,9,8,8,9,9,10,10,10,11,11,11,11,12,12,12,12,9,9,9,9,10,10,10,10,11,11,11,12,12,12,12,13,9,10,9,10,10,10,10,11,11,11,11,12,12,12,12,12,9,10,10,10,10,10,11,11,11,11,12,12,12,12,12,13,9,11,10,10,10,11,11,11,11,12,12,12,12,12,13,13,10,11,11,11,11,11,11,11,11,11,12,12,12,12,13,13,10,11,11,11,11,11,11,11,12,12,12,12,12,13,13,13,10,12,11,11,11,11,12,12,12,12,12,12,13,13,13,13,10,12,12,11,11,11,12,12,12,12,12,12,13,13,13,13,10,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,10,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,10,13,12,12,12,12,12,12,13,13,13,13,13,13,13,13,10,9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,6],t32l:[1,5,5,7,5,8,7,9,5,7,7,9,7,9,9,10],t33l:[4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8]};return t.ht=[new e(0,0,null,null),new e(2,0,t.t1HB,t.t1l),new e(3,0,t.t2HB,t.t2l),new e(3,0,t.t3HB,t.t3l),new e(0,0,null,null),new e(4,0,t.t5HB,t.t5l),new e(4,0,t.t6HB,t.t6l),new e(6,0,t.t7HB,t.t7l),new e(6,0,t.t8HB,t.t8l),new e(6,0,t.t9HB,t.t9l),new e(8,0,t.t10HB,t.t10l),new e(8,0,t.t11HB,t.t11l),new e(8,0,t.t12HB,t.t12l),new e(16,0,t.t13HB,t.t13l),new e(0,0,null,t.t16_5l),new e(16,0,t.t15HB,t.t15l),new e(1,1,t.t16HB,t.t16l),new e(2,3,t.t16HB,t.t16l),new e(3,7,t.t16HB,t.t16l),new e(4,15,t.t16HB,t.t16l),new e(6,63,t.t16HB,t.t16l),new e(8,255,t.t16HB,t.t16l),new e(10,1023,t.t16HB,t.t16l),new e(13,8191,t.t16HB,t.t16l),new e(4,15,t.t24HB,t.t24l),new e(5,31,t.t24HB,t.t24l),new e(6,63,t.t24HB,t.t24l),new e(7,127,t.t24HB,t.t24l),new e(8,255,t.t24HB,t.t24l),new e(9,511,t.t24HB,t.t24l),new e(11,2047,t.t24HB,t.t24l),new e(13,8191,t.t24HB,t.t24l),new e(0,0,t.t32HB,t.t32l),new e(0,0,t.t33HB,t.t33l)],t.largetbl=[65540,327685,458759,589832,655369,655370,720906,720907,786443,786444,786444,851980,851980,851980,917517,655370,262149,393222,524295,589832,655369,720906,720906,720907,786443,786443,786444,851980,917516,851980,917516,655370,458759,524295,589832,655369,720905,720906,786442,786443,851979,786443,851979,851980,851980,917516,917517,720905,589832,589832,655369,720905,720906,786442,786442,786443,851979,851979,917515,917516,917516,983052,983052,786441,655369,655369,720905,720906,786442,786442,851978,851979,851979,917515,917516,917516,983052,983052,983053,720905,655370,655369,720906,720906,786442,851978,851979,917515,851979,917515,917516,983052,983052,983052,1048588,786441,720906,720906,720906,786442,851978,851979,851979,851979,917515,917516,917516,917516,983052,983052,1048589,786441,720907,720906,786442,786442,851979,851979,851979,917515,917516,983052,983052,983052,983052,1114125,1114125,786442,720907,786443,786443,851979,851979,851979,917515,917515,983051,983052,983052,983052,1048588,1048589,1048589,786442,786443,786443,786443,851979,851979,917515,917515,983052,983052,983052,983052,1048588,983053,1048589,983053,851978,786444,851979,786443,851979,917515,917516,917516,917516,983052,1048588,1048588,1048589,1114125,1114125,1048589,786442,851980,851980,851979,851979,917515,917516,983052,1048588,1048588,1048588,1048588,1048589,1048589,983053,1048589,851978,851980,917516,917516,917516,917516,983052,983052,983052,983052,1114124,1048589,1048589,1048589,1048589,1179661,851978,983052,917516,917516,917516,983052,983052,1048588,1048588,1048589,1179661,1114125,1114125,1114125,1245197,1114125,851978,917517,983052,851980,917516,1048588,1048588,983052,1048589,1048589,1114125,1179661,1114125,1245197,1114125,1048589,851978,655369,655369,655369,720905,720905,786441,786441,786441,851977,851977,851977,851978,851978,851978,851978,655366],t.table23=[65538,262147,458759,262148,327684,458759,393222,458759,524296],t.table56=[65539,262148,458758,524296,262148,327684,524294,589831,458757,524294,589831,655368,524295,524295,589832,655369],t.bitrate_table=[[0,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1],[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],[0,8,16,24,32,40,48,56,64,-1,-1,-1,-1,-1,-1,-1]],t.samplerate_table=[[22050,24e3,16e3,-1],[44100,48e3,32e3,-1],[11025,12e3,8e3,-1]],t.scfsi_band=[0,6,11,16,21],is=t}function qs(){if(ls)return os;ls=1;var e=Us(),t=Bs();t.System;var a=t.VbrMode,n=t.Float;t.ShortBlock;var s=t.Util;t.Arrays,t.new_array_n,t.new_byte,t.new_double;var i=t.new_float;t.new_float_n;var r=t.new_int;t.new_int_n;var o=t.assert,l=Rs(),d=Hs(),c=Vs();function u(){var t=null,m=null,h=null;function f(e){return o(0<=e+u.Q_MAX2&&e<u.Q_MAX),_[e+u.Q_MAX2]}this.setModules=function(e,a,n){t=e,m=a,h=n},this.IPOW20=function(e){return o(0<=e&&e<u.Q_MAX),x[e]};var p=2220446049250313e-31,g=u.IXMAX_VAL+2,b=u.Q_MAX,v=u.Q_MAX2;u.LARGE_BITS;this.nr_of_sfb_block=[[[6,5,5,5],[9,9,9,9],[6,9,9,9]],[[6,5,7,3],[9,9,12,6],[6,9,12,6]],[[11,10,0,0],[18,18,0,0],[15,18,0,0]],[[7,7,7,0],[12,12,12,0],[6,15,12,0]],[[6,6,6,3],[12,9,9,6],[6,12,9,6]],[[8,8,5,0],[15,12,9,0],[6,18,9,0]]];var y=[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,3,3,3,2,0];this.pretab=y,this.sfBandIndex=[new e([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0,4,8,12,18,24,32,42,56,74,100,132,174,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new e([0,6,12,18,24,30,36,44,54,66,80,96,114,136,162,194,232,278,332,394,464,540,576],[0,4,8,12,18,26,36,48,62,80,104,136,180,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new e([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0,4,8,12,18,26,36,48,62,80,104,134,174,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new e([0,4,8,12,16,20,24,30,36,44,52,62,74,90,110,134,162,196,238,288,342,418,576],[0,4,8,12,16,22,30,40,52,66,84,106,136,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new e([0,4,8,12,16,20,24,30,36,42,50,60,72,88,106,128,156,190,230,276,330,384,576],[0,4,8,12,16,22,28,38,50,64,80,100,126,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new e([0,4,8,12,16,20,24,30,36,44,54,66,82,102,126,156,194,240,296,364,448,550,576],[0,4,8,12,16,22,30,42,58,78,104,138,180,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new e([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0,4,8,12,18,26,36,48,62,80,104,134,174,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new e([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0,4,8,12,18,26,36,48,62,80,104,134,174,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new e([0,12,24,36,48,60,72,88,108,132,160,192,232,280,336,400,476,566,568,570,572,574,576],[0,8,16,24,36,52,72,96,124,160,162,164,166,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0])];var _=i(b+v+1),x=i(b),w=i(g),k=i(g);function M(e,t){var a=h.ATHformula(t,e);return a-=100,a=Math.pow(10,a/10+e.ATHlower)}function S(e){this.s=e}this.adj43=k,this.iteration_init=function(e){var a,s=e.internal_flags,i=s.l3_side;if(0==s.iteration_init_init){for(s.iteration_init_init=1,i.main_data_begin=0,function(e){for(var t=e.internal_flags.ATH.l,a=e.internal_flags.ATH.psfb21,s=e.internal_flags.ATH.s,i=e.internal_flags.ATH.psfb12,r=e.internal_flags,o=e.out_samplerate,d=0;d<l.SBMAX_l;d++){var c=r.scalefac_band.l[d],u=r.scalefac_band.l[d+1];t[d]=n.MAX_VALUE;for(var m=c;m<u;m++){var h=M(e,m*o/1152);t[d]=Math.min(t[d],h)}}for(d=0;d<l.PSFB21;d++)for(c=r.scalefac_band.psfb21[d],u=r.scalefac_band.psfb21[d+1],a[d]=n.MAX_VALUE,m=c;m<u;m++)h=M(e,m*o/1152),a[d]=Math.min(a[d],h);for(d=0;d<l.SBMAX_s;d++){for(c=r.scalefac_band.s[d],u=r.scalefac_band.s[d+1],s[d]=n.MAX_VALUE,m=c;m<u;m++)h=M(e,m*o/384),s[d]=Math.min(s[d],h);s[d]*=r.scalefac_band.s[d+1]-r.scalefac_band.s[d]}for(d=0;d<l.PSFB12;d++){for(c=r.scalefac_band.psfb12[d],u=r.scalefac_band.psfb12[d+1],i[d]=n.MAX_VALUE,m=c;m<u;m++)h=M(e,m*o/384),i[d]=Math.min(i[d],h);i[d]*=r.scalefac_band.s[13]-r.scalefac_band.s[12]}if(e.noATH){for(d=0;d<l.SBMAX_l;d++)t[d]=1e-20;for(d=0;d<l.PSFB21;d++)a[d]=1e-20;for(d=0;d<l.SBMAX_s;d++)s[d]=1e-20;for(d=0;d<l.PSFB12;d++)i[d]=1e-20}r.ATH.floor=10*Math.log10(M(e,-1))}(e),w[0]=0,a=1;a<g;a++)w[a]=Math.pow(a,4/3);for(a=0;a<g-1;a++)k[a]=a+1-Math.pow(.5*(w[a]+w[a+1]),.75);for(k[a]=.5,a=0;a<b;a++)x[a]=Math.pow(2,-.1875*(a-210));for(a=0;a<=b+v;a++)_[a]=Math.pow(2,.25*(a-210-v));var r,o,d,c;for(t.huffman_init(s),(a=e.exp_nspsytune>>2&63)>=32&&(a-=64),r=Math.pow(10,a/4/10),(a=e.exp_nspsytune>>8&63)>=32&&(a-=64),o=Math.pow(10,a/4/10),(a=e.exp_nspsytune>>14&63)>=32&&(a-=64),d=Math.pow(10,a/4/10),(a=e.exp_nspsytune>>20&63)>=32&&(a-=64),c=d*Math.pow(10,a/4/10),a=0;a<l.SBMAX_l;a++){u=a<=6?r:a<=13?o:a<=20?d:c,s.nsPsy.longfact[a]=u}for(a=0;a<l.SBMAX_s;a++){var u;u=a<=5?r:a<=10?o:a<=11?d:c,s.nsPsy.shortfact[a]=u}}},this.on_pe=function(e,t,a,n,s,i){var l,u,h=e.internal_flags,f=0,p=r(2),g=new d(f),b=m.ResvMaxBits(e,n,g,i),v=(f=g.bits)+b;for(v>c.MAX_BITS_PER_GRANULE&&(v=c.MAX_BITS_PER_GRANULE),l=0,u=0;u<h.channels_out;++u)a[u]=Math.min(c.MAX_BITS_PER_CHANNEL,f/h.channels_out),p[u]=0|a[u]*t[s][u]/700-a[u],p[u]>3*n/4&&(p[u]=3*n/4),p[u]<0&&(p[u]=0),p[u]+a[u]>c.MAX_BITS_PER_CHANNEL&&(p[u]=Math.max(0,c.MAX_BITS_PER_CHANNEL-a[u])),l+=p[u];if(l>b)for(u=0;u<h.channels_out;++u)p[u]=b*p[u]/l;for(u=0;u<h.channels_out;++u)a[u]+=p[u],b-=p[u];for(l=0,u=0;u<h.channels_out;++u)l+=a[u];if(l>c.MAX_BITS_PER_GRANULE){var y=0;for(u=0;u<h.channels_out;++u)a[u]*=c.MAX_BITS_PER_GRANULE,a[u]/=l,y+=a[u];o(y<=c.MAX_BITS_PER_GRANULE)}return v},this.reduce_side=function(e,t,a,n){o(n<=c.MAX_BITS_PER_GRANULE),o(e[0]+e[1]<=c.MAX_BITS_PER_GRANULE);var s=.33*(.5-t)/.5;s<0&&(s=0),s>.5&&(s=.5);var i=0|.5*s*(e[0]+e[1]);i>c.MAX_BITS_PER_CHANNEL-e[0]&&(i=c.MAX_BITS_PER_CHANNEL-e[0]),i<0&&(i=0),e[1]>=125&&(e[1]-i>125?(e[0]<a&&(e[0]+=i),e[1]-=i):(e[0]+=e[1]-125,e[1]=125)),(i=e[0]+e[1])>n&&(e[0]=n*e[0]/i,e[1]=n*e[1]/i),o(e[0]<=c.MAX_BITS_PER_CHANNEL),o(e[1]<=c.MAX_BITS_PER_CHANNEL),o(e[0]+e[1]<=c.MAX_BITS_PER_GRANULE)},this.athAdjust=function(e,t,a){var n=90.30873362,i=s.FAST_LOG10_X(t,10),r=e*e,o=0;return i-=a,r>1e-20&&(o=1+s.FAST_LOG10_X(r,10/n)),o<0&&(o=0),i*=o,i+=a+n-94.82444863,Math.pow(10,.1*i)},this.calc_xmin=function(e,t,n,s){var i,r=0,o=e.internal_flags,d=0,c=0,u=o.ATH,m=n.xr,h=e.VBR==a.vbr_mtrh?1:0,f=o.masking_lower;for(e.VBR!=a.vbr_mtrh&&e.VBR!=a.vbr_mt||(f=1),i=0;i<n.psy_lmax;i++){k=(w=e.VBR==a.vbr_rh||e.VBR==a.vbr_mtrh?athAdjust(u.adjust,u.l[i],u.floor):u.adjust*u.l[i])/(y=n.width[i]),M=p,A=y>>1,N=0;do{N+=E=m[d]*m[d],M+=E<k?E:k,N+=I=m[++d]*m[d],M+=I<k?I:k,d++}while(--A>0);if(N>w&&c++,i==l.SBPSY_l)M<(C=w*o.nsPsy.longfact[i])&&(M=C);if(0!=h&&(w=M),!e.ATHonly)if((S=t.en.l[i])>0)C=N*t.thm.l[i]*f/S,0!=h&&(C*=o.nsPsy.longfact[i]),w<C&&(w=C);s[r++]=0!=h?w:w*o.nsPsy.longfact[i]}var g=575;if(n.block_type!=l.SHORT_TYPE)for(var b=576;0!=b--&&BitStream.EQ(m[b],0);)g=b;n.max_nonzero_coeff=g;for(var v=n.sfb_smin;i<n.psymax;v++,i+=3){var y,_,x;for(x=e.VBR==a.vbr_rh||e.VBR==a.vbr_mtrh?athAdjust(u.adjust,u.s[v],u.floor):u.adjust*u.s[v],y=n.width[i],_=0;_<3;_++){var w,k,M,S,C,N=0,A=y>>1;k=x/y,M=p;do{var E,I;N+=E=m[d]*m[d],M+=E<k?E:k,N+=I=m[++d]*m[d],M+=I<k?I:k,d++}while(--A>0);if(N>x&&c++,v==l.SBPSY_s)M<(C=x*o.nsPsy.shortfact[v])&&(M=C);if(w=0!=h?M:x,!e.ATHonly&&!e.ATHshort)if((S=t.en.s[v][_])>0)C=N*t.thm.s[v][_]*f/S,0!=h&&(C*=o.nsPsy.shortfact[v]),w<C&&(w=C);s[r++]=0!=h?w:w*o.nsPsy.shortfact[v]}e.useTemporal&&(s[r-3]>s[r-3+1]&&(s[r-3+1]+=(s[r-3]-s[r-3+1])*o.decay),s[r-3+1]>s[r-3+2]&&(s[r-3+2]+=(s[r-3+1]-s[r-3+2])*o.decay))}return c},this.calc_noise_core=function(e,t,a,n){var s=0,r=t.s,o=e.l3_enc;if(r>e.count1)for(;0!=a--;){d=e.xr[r],r++,s+=d*d,d=e.xr[r],r++,s+=d*d}else if(r>e.big_values){var l=i(2);for(l[0]=0,l[1]=n;0!=a--;){d=Math.abs(e.xr[r])-l[o[r]],r++,s+=d*d,d=Math.abs(e.xr[r])-l[o[r]],r++,s+=d*d}}else for(;0!=a--;){var d;d=Math.abs(e.xr[r])-w[o[r]]*n,r++,s+=d*d,d=Math.abs(e.xr[r])-w[o[r]]*n,r++,s+=d*d}return t.s=r,s},this.calc_noise=function(e,t,a,n,i){var r,o,l=0,d=0,c=0,u=0,m=0,h=-20,p=0,g=e.scalefac,b=0;for(n.over_SSD=0,r=0;r<e.psymax;r++){var v,_=e.global_gain-(g[b++]+(0!=e.preflag?y[r]:0)<<e.scalefac_scale+1)-8*e.subblock_gain[e.window[r]],x=0;if(null!=i&&i.step[r]==_)x=i.noise[r],p+=e.width[r],a[l++]=x/t[d++],x=i.noise_log[r];else{var w,k=f(_);if(o=e.width[r]>>1,p+e.width[r]>e.max_nonzero_coeff)o=(w=e.max_nonzero_coeff-p+1)>0?w>>1:0;var M=new S(p);x=this.calc_noise_core(e,M,o,k),p=M.s,null!=i&&(i.step[r]=_,i.noise[r]=x),x=a[l++]=x/t[d++],x=s.FAST_LOG10(Math.max(x,1e-20)),null!=i&&(i.noise_log[r]=x)}if(null!=i&&(i.global_gain=e.global_gain),m+=x,x>0)v=Math.max(0|10*x+.5,1),n.over_SSD+=v*v,c++,u+=x;h=Math.max(h,x)}return n.over_count=c,n.tot_noise=m,n.over_noise=u,n.max_noise=h,c},this.set_pinfo=function(e,t,a,n,s){var r,d,c,u,m,h=e.internal_flags,f=0==t.scalefac_scale?.5:1,p=t.scalefac,g=i(L3Side.SFBMAX),b=i(L3Side.SFBMAX),v=new CalcNoiseResult;calc_xmin(e,a,t,g),calc_noise(t,g,b,v,null);var _=0;for(d=t.sfb_lmax,t.block_type!=l.SHORT_TYPE&&0==t.mixed_block_flag&&(d=22),r=0;r<d;r++){var x=h.scalefac_band.l[r],w=(k=h.scalefac_band.l[r+1])-x;for(u=0;_<k;_++)u+=t.xr[_]*t.xr[_];u/=w,m=1e15,h.pinfo.en[n][s][r]=m*u,h.pinfo.xfsf[n][s][r]=m*g[r]*b[r]/w,a.en.l[r]>0&&!e.ATHonly?u/=a.en.l[r]:u=0,h.pinfo.thr[n][s][r]=m*Math.max(u*a.thm.l[r],h.ATH.l[r]),h.pinfo.LAMEsfb[n][s][r]=0,0!=t.preflag&&r>=11&&(h.pinfo.LAMEsfb[n][s][r]=-f*y[r]),r<l.SBPSY_l&&(o(p[r]>=0),h.pinfo.LAMEsfb[n][s][r]-=f*p[r])}if(t.block_type==l.SHORT_TYPE)for(d=r,r=t.sfb_smin;r<l.SBMAX_s;r++){x=h.scalefac_band.s[r],w=(k=h.scalefac_band.s[r+1])-x;for(var k,M=0;M<3;M++){for(u=0,c=x;c<k;c++)u+=t.xr[_]*t.xr[_],_++;u=Math.max(u/w,1e-20),m=1e15,h.pinfo.en_s[n][s][3*r+M]=m*u,h.pinfo.xfsf_s[n][s][3*r+M]=m*g[d]*b[d]/w,a.en.s[r][M]>0?u/=a.en.s[r][M]:u=0,(e.ATHonly||e.ATHshort)&&(u=0),h.pinfo.thr_s[n][s][3*r+M]=m*Math.max(u*a.thm.s[r][M],h.ATH.s[r]),h.pinfo.LAMEsfb_s[n][s][3*r+M]=-2*t.subblock_gain[M],r<l.SBPSY_s&&(h.pinfo.LAMEsfb_s[n][s][3*r+M]-=f*p[d]),d++}}h.pinfo.LAMEqss[n][s]=t.global_gain,h.pinfo.LAMEmainbits[n][s]=t.part2_3_length+t.part2_length,h.pinfo.LAMEsfbits[n][s]=t.part2_length,h.pinfo.over[n][s]=v.over_count,h.pinfo.max_noise[n][s]=10*v.max_noise,h.pinfo.over_noise[n][s]=10*v.over_noise,h.pinfo.tot_noise[n][s]=10*v.tot_noise,h.pinfo.over_SSD[n][s]=v.over_SSD}}return u.Q_MAX=257,u.Q_MAX2=116,u.LARGE_BITS=1e5,u.IXMAX_VAL=8206,os=u}function zs(){if(cs)return ds;cs=1;var e=Bs(),t=e.System;e.VbrMode,e.Float,e.ShortBlock,e.Util;var a=e.Arrays;e.new_array_n,e.new_byte,e.new_double,e.new_float,e.new_float_n;var n=e.new_int;e.new_int_n;var s=e.assert,i=Rs(),r=Ks(),o=Fs(),l=qs();return ds=function e(){var d=null;function c(e){this.bits=0|e}this.qupvt=null,this.setModules=function(e){this.qupvt=e,d=e};var u=[[0,0],[0,0],[0,0],[0,0],[0,0],[0,1],[1,1],[1,1],[1,2],[2,2],[2,3],[2,3],[3,4],[3,4],[3,4],[4,5],[4,5],[4,6],[5,6],[5,6],[5,7],[6,7],[6,7]];function m(e,t,a,n,i,r){var o=.5946/t;for(s(e>0),e>>=1;0!=e--;)i[r++]=o>a[n++]?0:1,i[r++]=o>a[n++]?0:1}function h(e,t,a,n,i,r){s(e>0);var o=(e>>=1)%2;for(e>>=1;0!=e--;){var l,c,u,m,h,f,p,g;l=a[n++]*t,c=a[n++]*t,h=0|l,u=a[n++]*t,f=0|c,m=a[n++]*t,p=0|u,l+=d.adj43[h],g=0|m,c+=d.adj43[f],i[r++]=0|l,u+=d.adj43[p],i[r++]=0|c,m+=d.adj43[g],i[r++]=0|u,i[r++]=0|m}0!=o&&(h=0|(l=a[n++]*t),f=0|(c=a[n++]*t),l+=d.adj43[h],c+=d.adj43[f],i[r++]=0|l,i[r++]=0|c)}var f=[1,2,5,7,7,10,10,13,13,13,13,13,13,13,13];function p(e,t,a,n){var s=function(e,t,a){var n=0,s=0;do{var i=e[t++],r=e[t++];n<i&&(n=i),s<r&&(s=r)}while(t<a);return n<s&&(n=s),n}(e,t,a);switch(s){case 0:return s;case 1:return function(e,t,a,n){var s=0,i=r.ht[1].hlen;do{var o=2*e[t+0]+e[t+1];t+=2,s+=i[o]}while(t<a);return n.bits+=s,1}(e,t,a,n);case 2:case 3:return function(e,t,a,n,s){var i,o,l=0,d=r.ht[n].xlen;o=2==n?r.table23:r.table56;do{var c=e[t+0]*d+e[t+1];t+=2,l+=o[c]}while(t<a);return i=65535&l,(l>>=16)>i&&(l=i,n++),s.bits+=l,n}(e,t,a,f[s-1],n);case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:return function(e,t,a,n,s){var i=0,o=0,l=0,d=r.ht[n].xlen,c=r.ht[n].hlen,u=r.ht[n+1].hlen,m=r.ht[n+2].hlen;do{var h=e[t+0]*d+e[t+1];t+=2,i+=c[h],o+=u[h],l+=m[h]}while(t<a);var f=n;return i>o&&(i=o,f++),i>l&&(i=l,f=n+2),s.bits+=i,f}(e,t,a,f[s-1],n);default:if(s>l.IXMAX_VAL)return n.bits=l.LARGE_BITS,-1;var i,o;for(s-=15,i=24;i<32&&!(r.ht[i].linmax>=s);i++);for(o=i-8;o<24&&!(r.ht[o].linmax>=s);o++);return function(e,t,a,n,s,i){var o,l=65536*r.ht[n].xlen+r.ht[s].xlen,d=0;do{var c=e[t++],u=e[t++];0!=c&&(c>14&&(c=15,d+=l),c*=16),0!=u&&(u>14&&(u=15,d+=l),c+=u),d+=r.largetbl[c]}while(t<a);return o=65535&d,(d>>=16)>o&&(d=o,n=s),i.bits+=d,n}(e,t,a,o,i,n)}}function g(e,t,a,n,s,r,o,l){for(var d=t.big_values,u=2;u<i.SBMAX_l+1;u++){var m=e.scalefac_band.l[u];if(m>=d)break;var h=s[u-2]+t.count1bits;if(a.part2_3_length<=h)break;var f=new c(h),g=p(n,m,d,f);h=f.bits,a.part2_3_length<=h||(a.assign(t),a.part2_3_length=h,a.region0_count=r[u-2],a.region1_count=u-2-r[u-2],a.table_select[0]=o[u-2],a.table_select[1]=l[u-2],a.table_select[2]=g)}}this.noquant_count_bits=function(e,t,a){var n=t.l3_enc,o=Math.min(576,t.max_nonzero_coeff+2>>1<<1);for(null!=a&&(a.sfb_count1=0);o>1&&0==(n[o-1]|n[o-2]);o-=2);t.count1=o;for(var l=0,d=0;o>3;o-=4){var u;if((2147483647&(n[o-1]|n[o-2]|n[o-3]|n[o-4]))>1)break;u=2*(2*(2*n[o-4]+n[o-3])+n[o-2])+n[o-1],l+=r.t32l[u],d+=r.t33l[u]}var m=l;if(t.count1table_select=0,l>d&&(m=d,t.count1table_select=1),t.count1bits=m,t.big_values=o,0==o)return m;if(t.block_type==i.SHORT_TYPE)(l=3*e.scalefac_band.s[3])>t.big_values&&(l=t.big_values),d=t.big_values;else if(t.block_type==i.NORM_TYPE){if(s(o<=576),l=t.region0_count=e.bv_scf[o-2],d=t.region1_count=e.bv_scf[o-1],s(l+d+2<i.SBPSY_l),d=e.scalefac_band.l[l+d+2],l=e.scalefac_band.l[l+1],d<o){var h=new c(m);t.table_select[2]=p(n,d,o,h),m=h.bits}}else t.region0_count=7,t.region1_count=i.SBMAX_l-1-7-1,(l=e.scalefac_band.l[8])>(d=o)&&(l=d);if(l=Math.min(l,o),d=Math.min(d,o),s(l>=0),s(d>=0),0<l){h=new c(m);t.table_select[0]=p(n,0,l,h),m=h.bits}if(l<d){h=new c(m);t.table_select[1]=p(n,l,d,h),m=h.bits}if(2==e.use_best_huffman&&(t.part2_3_length=m,best_huffman_divide(e,t),m=t.part2_3_length),null!=a&&t.block_type==i.NORM_TYPE){for(var f=0;e.scalefac_band.l[f]<t.big_values;)f++;a.sfb_count1=f}return m},this.count_bits=function(e,t,n,r){var o=n.l3_enc,c=l.IXMAX_VAL/d.IPOW20(n.global_gain);if(n.xrpow_max>c)return l.LARGE_BITS;if(function(e,t,n,r,o){var l,c,u,f=0,p=0,g=0,b=0,v=t,y=0,_=v,x=0,w=e,k=0;for(u=null!=o&&r.global_gain==o.global_gain,c=r.block_type==i.SHORT_TYPE?38:21,l=0;l<=c;l++){var M=-1;if((u||r.block_type==i.NORM_TYPE)&&(M=r.global_gain-(r.scalefac[l]+(0!=r.preflag?d.pretab[l]:0)<<r.scalefac_scale+1)-8*r.subblock_gain[r.window[l]]),s(r.width[l]>=0),u&&o.step[l]==M)0!=p&&(h(p,n,w,k,_,x),p=0),0!=g&&(m(g,n,w,k,_,x),g=0);else{var S,C=r.width[l];if(f+r.width[l]>r.max_nonzero_coeff&&(S=r.max_nonzero_coeff-f+1,a.fill(t,r.max_nonzero_coeff,576,0),(C=S)<0&&(C=0),l=c+1),0==p&&0==g&&(_=v,x=y,w=e,k=b),null!=o&&o.sfb_count1>0&&l>=o.sfb_count1&&o.step[l]>0&&M>=o.step[l]?(0!=p&&(h(p,n,w,k,_,x),p=0,_=v,x=y,w=e,k=b),g+=C):(0!=g&&(m(g,n,w,k,_,x),g=0,_=v,x=y,w=e,k=b),p+=C),C<=0){0!=g&&(m(g,n,w,k,_,x),g=0),0!=p&&(h(p,n,w,k,_,x),p=0);break}}l<=c&&(y+=r.width[l],b+=r.width[l],f+=r.width[l])}0!=p&&(h(p,n,w,k,_,x),p=0),0!=g&&(m(g,n,w,k,_,x),g=0)}(t,o,d.IPOW20(n.global_gain),n,r),2&e.substep_shaping)for(var u=0,f=n.global_gain+n.scalefac_scale,p=.634521682242439/d.IPOW20(f),g=0;g<n.sfbmax;g++){var b,v=n.width[g];if(s(v>=0),0==e.pseudohalf[g])u+=v;else for(b=u,u+=v;b<u;++b)o[b]=t[b]>=p?o[b]:0}return this.noquant_count_bits(e,n,r)},this.best_huffman_divide=function(e,t){var a=new o,d=t.l3_enc,u=n(23),m=n(23),h=n(23),f=n(23);if(t.block_type!=i.SHORT_TYPE||1!=e.mode_gr){a.assign(t),t.block_type==i.NORM_TYPE&&(!function(e,t,a,n,s,i,r){for(var o=t.big_values,d=0;d<=22;d++)n[d]=l.LARGE_BITS;for(d=0;d<16;d++){var u=e.scalefac_band.l[d+1];if(u>=o)break;var m=0,h=new c(m),f=p(a,0,u,h);m=h.bits;for(var g=0;g<8;g++){var b=e.scalefac_band.l[d+g+2];if(b>=o)break;var v=m,y=p(a,u,b,h=new c(v));v=h.bits,n[d+g]>v&&(n[d+g]=v,s[d+g]=d,i[d+g]=f,r[d+g]=y)}}}(e,t,d,u,m,h,f),g(e,a,t,d,u,m,h,f));var b=a.big_values;if(!(0==b||(d[b-2]|d[b-1])>1||(b=t.count1+2)>576)){a.assign(t),a.count1=b;var v=0,y=0;for(s(b<=576);b>a.big_values;b-=4){var _=2*(2*(2*d[b-4]+d[b-3])+d[b-2])+d[b-1];v+=r.t32l[_],y+=r.t33l[_]}if(a.big_values=b,a.count1table_select=0,v>y&&(v=y,a.count1table_select=1),a.count1bits=v,a.block_type==i.NORM_TYPE)g(e,a,t,d,u,m,h,f);else{if(a.part2_3_length=v,(v=e.scalefac_band.l[8])>b&&(v=b),v>0){var x=new c(a.part2_3_length);a.table_select[0]=p(d,0,v,x),a.part2_3_length=x.bits}if(b>v){x=new c(a.part2_3_length);a.table_select[1]=p(d,v,b,x),a.part2_3_length=x.bits}t.part2_3_length>a.part2_3_length&&t.assign(a)}}}};var b=[1,1,1,1,8,2,2,2,4,4,4,8,8,8,16,16],v=[1,2,4,8,1,2,4,8,2,4,8,2,4,8,4,8],y=[0,0,0,0,3,1,1,1,2,2,2,3,3,3,4,4],_=[0,1,2,3,0,1,2,3,1,2,3,1,2,3,2,3];e.slen1_tab=y,e.slen2_tab=_,this.best_scalefac_store=function(e,t,a,n){var o,l,c,u,m=n.tt[t][a],h=0;for(c=0,o=0;o<m.sfbmax;o++){var f=m.width[o];for(s(f>=0),c+=f,u=-f;u<0&&0==m.l3_enc[u+c];u++);0==u&&(m.scalefac[o]=h=-2)}if(0==m.scalefac_scale&&0==m.preflag){var p=0;for(o=0;o<m.sfbmax;o++)m.scalefac[o]>0&&(p|=m.scalefac[o]);if(!(1&p)&&0!=p){for(o=0;o<m.sfbmax;o++)m.scalefac[o]>0&&(m.scalefac[o]>>=1);m.scalefac_scale=h=1}}if(0==m.preflag&&m.block_type!=i.SHORT_TYPE&&2==e.mode_gr){for(o=11;o<i.SBPSY_l&&!(m.scalefac[o]<d.pretab[o]&&-2!=m.scalefac[o]);o++);if(o==i.SBPSY_l){for(o=11;o<i.SBPSY_l;o++)m.scalefac[o]>0&&(m.scalefac[o]-=d.pretab[o]);m.preflag=h=1}}for(l=0;l<4;l++)n.scfsi[a][l]=0;for(2==e.mode_gr&&1==t&&n.tt[0][a].block_type!=i.SHORT_TYPE&&n.tt[1][a].block_type!=i.SHORT_TYPE&&(!function(e,t){for(var a,n=t.tt[1][e],s=t.tt[0][e],o=0;o<r.scfsi_band.length-1;o++){for(a=r.scfsi_band[o];a<r.scfsi_band[o+1]&&!(s.scalefac[a]!=n.scalefac[a]&&n.scalefac[a]>=0);a++);if(a==r.scfsi_band[o+1]){for(a=r.scfsi_band[o];a<r.scfsi_band[o+1];a++)n.scalefac[a]=-1;t.scfsi[e][o]=1}}var l=0,d=0;for(a=0;a<11;a++)-1!=n.scalefac[a]&&(d++,l<n.scalefac[a]&&(l=n.scalefac[a]));for(var c=0,u=0;a<i.SBPSY_l;a++)-1!=n.scalefac[a]&&(u++,c<n.scalefac[a]&&(c=n.scalefac[a]));for(o=0;o<16;o++)if(l<b[o]&&c<v[o]){var m=y[o]*d+_[o]*u;n.part2_length>m&&(n.part2_length=m,n.scalefac_compress=o)}}(a,n),h=0),o=0;o<m.sfbmax;o++)-2==m.scalefac[o]&&(m.scalefac[o]=0);0!=h&&(2==e.mode_gr?this.scale_bitcount(m):this.scale_bitcount_lsf(e,m))};var x=[0,18,36,54,54,36,54,72,54,72,90,72,90,108,108,126],w=[0,18,36,54,51,35,53,71,52,70,88,69,87,105,104,122],k=[0,10,20,30,33,21,31,41,32,42,52,43,53,63,64,74];this.scale_bitcount=function(e){var t,a,n,r=0,o=0,c=e.scalefac;if(s(function(e,t){for(var a=0;a<t;++a)if(e[a]<0)return!1;return!0}(c,e.sfbmax)),e.block_type==i.SHORT_TYPE)n=x,0!=e.mixed_block_flag&&(n=w);else if(n=k,0==e.preflag){for(a=11;a<i.SBPSY_l&&!(c[a]<d.pretab[a]);a++);if(a==i.SBPSY_l)for(e.preflag=1,a=11;a<i.SBPSY_l;a++)c[a]-=d.pretab[a]}for(a=0;a<e.sfbdivide;a++)r<c[a]&&(r=c[a]);for(;a<e.sfbmax;a++)o<c[a]&&(o=c[a]);for(e.part2_length=l.LARGE_BITS,t=0;t<16;t++)r<b[t]&&o<v[t]&&e.part2_length>n[t]&&(e.part2_length=n[t],e.scalefac_compress=t);return e.part2_length==l.LARGE_BITS};var M=[[15,15,7,7],[15,15,7,0],[7,3,0,0],[15,31,31,0],[7,7,7,0],[3,3,0,0]];this.scale_bitcount_lsf=function(e,a){var r,o,l,c,u,m,h,f,p=n(4),g=a.scalefac;for(r=0!=a.preflag?2:0,h=0;h<4;h++)p[h]=0;if(a.block_type==i.SHORT_TYPE){o=1;var b=d.nr_of_sfb_block[r][o];for(f=0,l=0;l<4;l++)for(c=b[l]/3,h=0;h<c;h++,f++)for(u=0;u<3;u++)g[3*f+u]>p[l]&&(p[l]=g[3*f+u])}else{o=0;b=d.nr_of_sfb_block[r][o];for(f=0,l=0;l<4;l++)for(c=b[l],h=0;h<c;h++,f++)g[f]>p[l]&&(p[l]=g[f])}for(m=!1,l=0;l<4;l++)p[l]>M[r][l]&&(m=!0);if(!m){var v,y,_,x;for(a.sfb_partition_table=d.nr_of_sfb_block[r][o],l=0;l<4;l++)a.slen[l]=S[p[l]];switch(v=a.slen[0],y=a.slen[1],_=a.slen[2],x=a.slen[3],r){case 0:a.scalefac_compress=(5*v+y<<4)+(_<<2)+x;break;case 1:a.scalefac_compress=400+(5*v+y<<2)+_;break;case 2:a.scalefac_compress=500+3*v+y;break;default:t.err.printf("intensity stereo not implemented yet\n")}}if(!m)for(s(null!=a.sfb_partition_table),a.part2_length=0,l=0;l<4;l++)a.part2_length+=a.slen[l]*a.sfb_partition_table[l];return m};var S=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4];this.huffman_init=function(e){for(var t=2;t<=576;t+=2){for(var a,n=0;e.scalefac_band.l[++n]<t;);for(a=u[n][0];e.scalefac_band.l[a+1]>t;)a--;for(a<0&&(a=u[n][0]),e.bv_scf[t-2]=a,a=u[n][1];e.scalefac_band.l[a+e.bv_scf[t-2]+2]>t;)a--;a<0&&(a=u[n][1]),e.bv_scf[t-1]=a}}},ds}function Gs(){if(ms)return us;ms=1;var e=Bs(),t=e.System;e.VbrMode,e.Float,e.ShortBlock,e.Util;var a=e.Arrays;e.new_array_n;var n=e.new_byte;e.new_double,e.new_float;var s=e.new_float_n,i=e.new_int;e.new_int_n;var r=e.assert,o=zs(),l=Ks(),d=Rs(),c=Vs();function u(){var e=this,u=32,m=null,h=null,f=null,p=null;this.setModules=function(e,t,a,n){m=e,h=t,f=a,p=n};var g=null,b=0,v=0,y=0;function _(e){t.arraycopy(e.header[e.w_ptr].buf,0,g,v,e.sideinfo_len),v+=e.sideinfo_len,b+=8*e.sideinfo_len,e.w_ptr=e.w_ptr+1&c.MAX_HEADER_BUF-1}function x(e,t,a){for(r(a<30);a>0;){var n;0==y&&(y=8,v++,r(v<Lame.LAME_MAXMP3BUFFER),r(e.header[e.w_ptr].write_timing>=b),e.header[e.w_ptr].write_timing==b&&_(e),g[v]=0),n=Math.min(a,y),y-=n,r((a-=n)<u),r(y<u),g[v]|=t>>a<<y,b+=n}}function w(e,t,a){for(r(a<30);a>0;){var n;0==y&&(y=8,v++,r(v<Lame.LAME_MAXMP3BUFFER),g[v]=0),n=Math.min(a,y),y-=n,r((a-=n)<u),r(y<u),g[v]|=t>>a<<y,b+=n}}function k(e,t){var a,n=e.internal_flags;if(r(t>=0),t>=8&&(x(n,76,8),t-=8),t>=8&&(x(n,65,8),t-=8),t>=8&&(x(n,77,8),t-=8),t>=8&&(x(n,69,8),t-=8),t>=32){var s=f.getLameShortVersion();if(t>=32)for(a=0;a<s.length&&t>=8;++a)t-=8,x(n,s.charAt(a),8)}for(;t>=1;t-=1)x(n,n.ancillary_flag,1),n.ancillary_flag^=e.disable_reservoir?0:1;r(0==t)}function M(e,t,a){for(var n=e.header[e.h_ptr].ptr;a>0;){var s=Math.min(a,8-(7&n));r((a-=s)<u),e.header[e.h_ptr].buf[n>>3]|=t>>a<<8-(7&n)-s,n+=s}e.header[e.h_ptr].ptr=n}function S(e,t){e<<=8;for(var a=0;a<8;a++)65536&((t<<=1)^(e<<=1))&&(t^=32773);return t}function C(e,t){var a,n=l.ht[t.count1table_select+32],s=0,i=t.big_values,o=t.big_values;for(r(t.count1table_select<2),a=(t.count1-t.big_values)/4;a>0;--a){var d,c=0,u=0;0!=(d=t.l3_enc[i+0])&&(u+=8,t.xr[o+0]<0&&c++,r(d<=1)),0!=(d=t.l3_enc[i+1])&&(u+=4,c*=2,t.xr[o+1]<0&&c++,r(d<=1)),0!=(d=t.l3_enc[i+2])&&(u+=2,c*=2,t.xr[o+2]<0&&c++,r(d<=1)),0!=(d=t.l3_enc[i+3])&&(u++,c*=2,t.xr[o+3]<0&&c++,r(d<=1)),i+=4,o+=4,x(e,c+n.table[u],n.hlen[u]),s+=n.hlen[u]}return s}function N(e,t,a,n,s){var i=l.ht[t],o=0;if(r(t<32),0==t)return o;for(var d=a;d<n;d+=2){var c=0,m=0,h=i.xlen,f=i.xlen,p=0,g=s.l3_enc[d],b=s.l3_enc[d+1];if(0!=g&&(s.xr[d]<0&&p++,c--),t>15){if(g>14){var v=g-15;r(v<=i.linmax),p|=v<<1,m=h,g=15}if(b>14){var y=b-15;r(y<=i.linmax),p<<=h,p|=y,m+=h,b=15}f=16}0!=b&&(p<<=1,s.xr[d+1]<0&&p++,c--),r((g|b)<16),g=g*f+b,m-=c,c+=i.hlen[g],r(c<=u),r(m<=u),x(e,i.table[g],c),x(e,p,m),o+=c+m}return o}function A(e,t){var a=3*e.scalefac_band.s[3];a>t.big_values&&(a=t.big_values);var n=N(e,t.table_select[0],0,a,t);return n+=N(e,t.table_select[1],a,t.big_values,t)}function E(e,t){var a,n,s,i;a=t.big_values,r(0<=a&&a<=576);var o=t.region0_count+1;return r(0<=o),r(o<e.scalefac_band.l.length),s=e.scalefac_band.l[o],o+=t.region1_count+1,r(0<=o),r(o<e.scalefac_band.l.length),s>a&&(s=a),(i=e.scalefac_band.l[o])>a&&(i=a),n=N(e,t.table_select[0],0,s,t),n+=N(e,t.table_select[1],s,i,t),n+=N(e,t.table_select[2],i,a,t)}function I(){this.total=0}function j(a,n){var s,i,r,o,l,d=a.internal_flags;return l=d.w_ptr,-1==(o=d.h_ptr-1)&&(o=c.MAX_HEADER_BUF-1),s=d.header[o].write_timing-b,n.total=s,s>=0&&(i=1+o-l,o<l&&(i=1+o-l+c.MAX_HEADER_BUF),s-=8*i*d.sideinfo_len),s+=r=e.getframebits(a),n.total+=r,n.total%8!=0?n.total=1+n.total/8:n.total=n.total/8,n.total+=v+1,s<0&&t.err.println("strange error flushing buffer ... \n"),s}this.getframebits=function(e){var t,a=e.internal_flags;return t=0!=a.bitrate_index?l.bitrate_table[e.version][a.bitrate_index]:e.brate,r(8<=t&&t<=640),8*(0|72e3*(e.version+1)*t/e.out_samplerate+a.padding)},this.CRC_writeheader=function(e,t){var a=65535;a=S(255&t[2],a),a=S(255&t[3],a);for(var n=6;n<e.sideinfo_len;n++)a=S(255&t[n],a);t[4]=byte(a>>8),t[5]=byte(255&a)},this.flush_bitstream=function(e){var t,a,n=e.internal_flags,s=n.h_ptr-1;if(-1==s&&(s=c.MAX_HEADER_BUF-1),t=n.l3_side,!((a=j(e,new I))<0)){if(k(e,a),r(n.header[s].write_timing+this.getframebits(e)==b),n.ResvSize=0,t.main_data_begin=0,n.findReplayGain){var i=m.GetTitleGain(n.rgdata);r(NEQ(i,GainAnalysis.GAIN_NOT_ENOUGH_SAMPLES)),n.RadioGain=0|Math.floor(10*i+.5)}n.findPeakSample&&(n.noclipGainChange=0|Math.ceil(20*Math.log10(n.PeakSample/32767)*10),n.noclipGainChange>0&&(EQ(e.scale,1)||EQ(e.scale,0))?n.noclipScale=Math.floor(32767/n.PeakSample*100)/100:n.noclipScale=-1)}},this.add_dummy_byte=function(e,t,a){for(var n,s=e.internal_flags;a-- >0;)for(w(0,t,8),n=0;n<c.MAX_HEADER_BUF;++n)s.header[n].write_timing+=8},this.format_bitstream=function(e){var n,s=e.internal_flags;n=s.l3_side;var i=this.getframebits(e);k(e,n.resvDrain_pre),function(e,n){var s,i,o,l=e.internal_flags;if(s=l.l3_side,l.header[l.h_ptr].ptr=0,a.fill(l.header[l.h_ptr].buf,0,l.sideinfo_len,0),e.out_samplerate<16e3?M(l,4094,12):M(l,4095,12),M(l,e.version,1),M(l,1,2),M(l,e.error_protection?0:1,1),M(l,l.bitrate_index,4),M(l,l.samplerate_index,2),M(l,l.padding,1),M(l,e.extension,1),M(l,e.mode.ordinal(),2),M(l,l.mode_ext,2),M(l,e.copyright,1),M(l,e.original,1),M(l,e.emphasis,2),e.error_protection&&M(l,0,16),1==e.version){for(r(s.main_data_begin>=0),M(l,s.main_data_begin,9),2==l.channels_out?M(l,s.private_bits,3):M(l,s.private_bits,5),o=0;o<l.channels_out;o++){var u;for(u=0;u<4;u++)M(l,s.scfsi[o][u],1)}for(i=0;i<2;i++)for(o=0;o<l.channels_out;o++)M(l,(m=s.tt[i][o]).part2_3_length+m.part2_length,12),M(l,m.big_values/2,9),M(l,m.global_gain,8),M(l,m.scalefac_compress,4),m.block_type!=d.NORM_TYPE?(M(l,1,1),M(l,m.block_type,2),M(l,m.mixed_block_flag,1),14==m.table_select[0]&&(m.table_select[0]=16),M(l,m.table_select[0],5),14==m.table_select[1]&&(m.table_select[1]=16),M(l,m.table_select[1],5),M(l,m.subblock_gain[0],3),M(l,m.subblock_gain[1],3),M(l,m.subblock_gain[2],3)):(M(l,0,1),14==m.table_select[0]&&(m.table_select[0]=16),M(l,m.table_select[0],5),14==m.table_select[1]&&(m.table_select[1]=16),M(l,m.table_select[1],5),14==m.table_select[2]&&(m.table_select[2]=16),M(l,m.table_select[2],5),r(0<=m.region0_count&&m.region0_count<16),r(0<=m.region1_count&&m.region1_count<8),M(l,m.region0_count,4),M(l,m.region1_count,3)),M(l,m.preflag,1),M(l,m.scalefac_scale,1),M(l,m.count1table_select,1)}else for(r(s.main_data_begin>=0),M(l,s.main_data_begin,8),M(l,s.private_bits,l.channels_out),i=0,o=0;o<l.channels_out;o++){var m;M(l,(m=s.tt[i][o]).part2_3_length+m.part2_length,12),M(l,m.big_values/2,9),M(l,m.global_gain,8),M(l,m.scalefac_compress,9),m.block_type!=d.NORM_TYPE?(M(l,1,1),M(l,m.block_type,2),M(l,m.mixed_block_flag,1),14==m.table_select[0]&&(m.table_select[0]=16),M(l,m.table_select[0],5),14==m.table_select[1]&&(m.table_select[1]=16),M(l,m.table_select[1],5),M(l,m.subblock_gain[0],3),M(l,m.subblock_gain[1],3),M(l,m.subblock_gain[2],3)):(M(l,0,1),14==m.table_select[0]&&(m.table_select[0]=16),M(l,m.table_select[0],5),14==m.table_select[1]&&(m.table_select[1]=16),M(l,m.table_select[1],5),14==m.table_select[2]&&(m.table_select[2]=16),M(l,m.table_select[2],5),r(0<=m.region0_count&&m.region0_count<16),r(0<=m.region1_count&&m.region1_count<8),M(l,m.region0_count,4),M(l,m.region1_count,3)),M(l,m.scalefac_scale,1),M(l,m.count1table_select,1)}e.error_protection&&CRC_writeheader(l,l.header[l.h_ptr].buf);var h=l.h_ptr;r(l.header[h].ptr==8*l.sideinfo_len),l.h_ptr=h+1&c.MAX_HEADER_BUF-1,l.header[l.h_ptr].write_timing=l.header[h].write_timing+n,l.h_ptr==l.w_ptr&&t.err.println("Error: MAX_HEADER_BUF too small in bitstream.c \n")}(e,i);var l=8*s.sideinfo_len;if(l+=function(e){var t,a,n,s,i=0,l=e.internal_flags,c=l.l3_side;if(1==e.version)for(t=0;t<2;t++)for(a=0;a<l.channels_out;a++){var u=c.tt[t][a],m=o.slen1_tab[u.scalefac_compress],h=o.slen2_tab[u.scalefac_compress];for(s=0,n=0;n<u.sfbdivide;n++)-1!=u.scalefac[n]&&(x(l,u.scalefac[n],m),s+=m);for(;n<u.sfbmax;n++)-1!=u.scalefac[n]&&(x(l,u.scalefac[n],h),s+=h);r(s==u.part2_length),u.block_type==d.SHORT_TYPE?s+=A(l,u):s+=E(l,u),s+=C(l,u),r(s==u.part2_3_length+u.part2_length),i+=s}else for(t=0,a=0;a<l.channels_out;a++){u=c.tt[t][a];var f,p,g=0;if(r(null!=u.sfb_partition_table),s=0,n=0,p=0,u.block_type==d.SHORT_TYPE){for(;p<4;p++){var b=u.sfb_partition_table[p]/3,v=u.slen[p];for(f=0;f<b;f++,n++)x(l,Math.max(u.scalefac[3*n+0],0),v),x(l,Math.max(u.scalefac[3*n+1],0),v),x(l,Math.max(u.scalefac[3*n+2],0),v),g+=3*v}s+=A(l,u)}else{for(;p<4;p++)for(b=u.sfb_partition_table[p],v=u.slen[p],f=0;f<b;f++,n++)x(l,Math.max(u.scalefac[n],0),v),g+=v;s+=E(l,u)}s+=C(l,u),r(s==u.part2_3_length),r(g==u.part2_length),i+=g+s}return i}(e),k(e,n.resvDrain_post),l+=n.resvDrain_post,n.main_data_begin+=(i-l)/8,j(e,new I)!=s.ResvSize&&t.err.println("Internal buffer inconsistency. flushbits <> ResvSize"),8*n.main_data_begin!=s.ResvSize&&(t.err.printf("bit reservoir error: \nl3_side.main_data_begin: %d \nResvoir size:             %d \nresv drain (post)         %d \nresv drain (pre)          %d \nheader and sideinfo:      %d \ndata bits:                %d \ntotal bits:               %d (remainder: %d) \nbitsperframe:             %d \n",8*n.main_data_begin,s.ResvSize,n.resvDrain_post,n.resvDrain_pre,8*s.sideinfo_len,l-n.resvDrain_post-8*s.sideinfo_len,l,l%8,i),t.err.println("This is a fatal error.  It has several possible causes:"),t.err.println("90%%  LAME compiled with buggy version of gcc using advanced optimizations"),t.err.println(" 9%%  Your system is overclocked"),t.err.println(" 1%%  bug in LAME encoding library"),s.ResvSize=8*n.main_data_begin),r(b%8==0),b>1e9){var u;for(u=0;u<c.MAX_HEADER_BUF;++u)s.header[u].write_timing-=b;b=0}return 0},this.copy_buffer=function(e,a,n,o,l){var d=v+1;if(d<=0)return 0;if(0!=o&&d>o)return-1;if(t.arraycopy(g,0,a,n,d),v=-1,y=0,0!=l){var c=i(1);if(c[0]=e.nMusicCRC,p.updateMusicCRC(c,a,n,d),e.nMusicCRC=c[0],d>0&&(e.VBR_seek_table.nBytesWritten+=d),e.decode_on_the_fly)for(var u,f=s([2,1152]),b=d,_=-1;0!=_;)if(_=h.hip_decode1_unclipped(e.hip,a,n,b,f[0],f[1]),b=0,-1==_&&(_=0),_>0){if(r(_<=1152),e.findPeakSample){for(u=0;u<_;u++)f[0][u]>e.PeakSample?e.PeakSample=f[0][u]:-f[0][u]>e.PeakSample&&(e.PeakSample=-f[0][u]);if(e.channels_out>1)for(u=0;u<_;u++)f[1][u]>e.PeakSample?e.PeakSample=f[1][u]:-f[1][u]>e.PeakSample&&(e.PeakSample=-f[1][u])}if(e.findReplayGain&&m.AnalyzeSamples(e.rgdata,f[0],0,f[1],0,_,e.channels_out)==GainAnalysis.GAIN_ANALYSIS_ERROR)return-6}}return d},this.init_bit_stream_w=function(e){g=n(Lame.LAME_MAXMP3BUFFER),e.h_ptr=e.w_ptr=0,e.header[e.h_ptr].write_timing=0,v=-1,y=0,b=0}}return u.EQ=function(e,t){return Math.abs(e)>Math.abs(t)?Math.abs(e-t)<=1e-6*Math.abs(e):Math.abs(e-t)<=1e-6*Math.abs(t)},u.NEQ=function(e,t){return!u.EQ(e,t)},us=u}function Xs(){if(fs)return hs;fs=1;var e=Bs(),t=e.System,a=e.VbrMode;e.Float;var n=e.ShortBlock;e.Util,e.Arrays,e.new_array_n,e.new_byte,e.new_double;var s=e.new_float;e.new_float_n,e.new_int;var i=e.new_int_n,r=e.new_short_n,o=e.assert,l=Ds(),d=function(){if(Pn)return Bn;Pn=1;var e=Os();return Bn=function(){this.class_id=0,this.num_samples=0,this.num_channels=0,this.in_samplerate=0,this.out_samplerate=0,this.scale=0,this.scale_left=0,this.scale_right=0,this.analysis=!1,this.bWriteVbrTag=!1,this.decode_only=!1,this.quality=0,this.mode=e.STEREO,this.force_ms=!1,this.free_format=!1,this.findReplayGain=!1,this.decode_on_the_fly=!1,this.write_id3tag_automatic=!1,this.brate=0,this.compression_ratio=0,this.copyright=0,this.original=0,this.extension=0,this.emphasis=0,this.error_protection=0,this.strict_ISO=!1,this.disable_reservoir=!1,this.quant_comp=0,this.quant_comp_short=0,this.experimentalY=!1,this.experimentalZ=0,this.exp_nspsytune=0,this.preset=0,this.VBR=null,this.VBR_q_frac=0,this.VBR_q=0,this.VBR_mean_bitrate_kbps=0,this.VBR_min_bitrate_kbps=0,this.VBR_max_bitrate_kbps=0,this.VBR_hard_min=0,this.lowpassfreq=0,this.highpassfreq=0,this.lowpasswidth=0,this.highpasswidth=0,this.maskingadjust=0,this.maskingadjust_short=0,this.ATHonly=!1,this.ATHshort=!1,this.noATH=!1,this.ATHtype=0,this.ATHcurve=0,this.ATHlower=0,this.athaa_type=0,this.athaa_loudapprox=0,this.athaa_sensitivity=0,this.short_blocks=null,this.useTemporal=!1,this.interChRatio=0,this.msfix=0,this.tune=!1,this.tune_value_a=0,this.version=0,this.encoder_delay=0,this.encoder_padding=0,this.framesize=0,this.frameNum=0,this.lame_allocated_gfp=0,this.internal_flags=null}}(),c=Vs(),u=function(){if(Yn)return Wn;Yn=1;var e=Bs();e.System,e.VbrMode,e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n,e.new_byte,e.new_double;var t=e.new_float;e.new_float_n,e.new_int,e.new_int_n,e.assert;var a=Rs();return Wn=function(){this.useAdjust=0,this.aaSensitivityP=0,this.adjust=0,this.adjustLimit=0,this.decay=0,this.floor=0,this.l=t(a.SBMAX_l),this.s=t(a.SBMAX_s),this.psfb21=t(a.PSFB21),this.psfb12=t(a.PSFB12),this.cb_l=t(a.CBANDS),this.cb_s=t(a.CBANDS),this.eql_w=t(a.BLKSIZE/2)}}(),m=function(){if(es)return Qn;es=1;var e=Bs();e.System,e.VbrMode,e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n,e.new_byte,e.new_double;var t=e.new_float;e.new_float_n;var a=e.new_int;e.new_int_n,e.assert;var n=$s();return Qn=function(){this.linprebuf=t(2*n.MAX_ORDER),this.linpre=0,this.lstepbuf=t(n.MAX_SAMPLES_PER_WINDOW+n.MAX_ORDER),this.lstep=0,this.loutbuf=t(n.MAX_SAMPLES_PER_WINDOW+n.MAX_ORDER),this.lout=0,this.rinprebuf=t(2*n.MAX_ORDER),this.rinpre=0,this.rstepbuf=t(n.MAX_SAMPLES_PER_WINDOW+n.MAX_ORDER),this.rstep=0,this.routbuf=t(n.MAX_SAMPLES_PER_WINDOW+n.MAX_ORDER),this.rout=0,this.sampleWindow=0,this.totsamp=0,this.lsum=0,this.rsum=0,this.freqindex=0,this.first=0,this.A=a(0|n.STEPS_per_dB*n.MAX_dB),this.B=a(0|n.STEPS_per_dB*n.MAX_dB)}}(),h=function(){if(ss)return ns;ss=1;var e=Bs();e.System,e.VbrMode,e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n,e.new_byte,e.new_double;var t=e.new_float;e.new_float_n;var a=e.new_int;e.new_int_n;var n=e.assert,s=Hs(),i=Rs(),r=Ls(),o=Vs();return ns=function(e){var l=e;this.quantize=l,this.iteration_loop=function(e,l,d,c){var u,m=e.internal_flags,h=t(r.SFBMAX),f=t(576),p=a(2),g=0,b=m.l3_side,v=new s(g);this.quantize.rv.ResvFrameBegin(e,v),g=v.bits;for(var y=0;y<m.mode_gr;y++){u=this.quantize.qupvt.on_pe(e,l,p,g,y,y),m.mode_ext==i.MPG_MD_MS_LR&&(this.quantize.ms_convert(m.l3_side,y),this.quantize.qupvt.reduce_side(p,d[y],g,u));for(var _=0;_<m.channels_out;_++){var x,w,k=b.tt[y][_];k.block_type!=i.SHORT_TYPE?(x=0,w=m.PSY.mask_adjust-x):(x=0,w=m.PSY.mask_adjust_short-x),m.masking_lower=Math.pow(10,.1*w),this.quantize.init_outer_loop(m,k),this.quantize.init_xrpow(m,k,f)&&(this.quantize.qupvt.calc_xmin(e,c[y][_],k,h),this.quantize.outer_loop(e,k,h,f,_,p[_])),this.quantize.iteration_finish_one(m,y,_),n(k.part2_3_length<=o.MAX_BITS_PER_CHANNEL),n(k.part2_3_length<=p[_])}}this.quantize.rv.ResvFrameEnd(m,g)}}}(),f=Gs(),p=Ks(),g=Rs();return hs=function e(){var b,v,y,_,x,w=this;e.V9=410,e.V8=420,e.V7=430,e.V6=440,e.V5=450,e.V4=460,e.V3=470,e.V2=480,e.V1=490,e.V0=500,e.R3MIX=1e3,e.STANDARD=1001,e.EXTREME=1002,e.INSANE=1003,e.STANDARD_FAST=1004,e.EXTREME_FAST=1005,e.MEDIUM=1006,e.MEDIUM_FAST=1007,e.LAME_MAXMP3BUFFER=147456;var k,M,S,C=new l;function N(){this.mask_adjust=0,this.mask_adjust_short=0,this.bo_l_weight=s(g.SBMAX_l),this.bo_s_weight=s(g.SBMAX_s)}function A(){this.lowerlimit=0}function E(e,t){this.lowpass=t}this.enc=new g,this.setModules=function(e,t,a,n,s,i,r,o,l){b=e,v=t,y=a,_=n,x=s,k=i,M=o,S=l,this.enc.setModules(v,C,_,k)};var I=4294479419;function j(e){return e>1?0:e<=0?1:Math.cos(Math.PI/2*e)}function T(e,t){switch(e){case 44100:return t.version=1,0;case 48e3:return t.version=1,1;case 32e3:return t.version=1,2;case 22050:case 11025:return t.version=0,0;case 24e3:case 12e3:return t.version=0,1;case 16e3:case 8e3:return t.version=0,2;default:return t.version=0,-1}}function B(e,t,a){a<16e3&&(t=2);for(var n=p.bitrate_table[t][1],s=2;s<=14;s++)p.bitrate_table[t][s]>0&&Math.abs(p.bitrate_table[t][s]-e)<Math.abs(n-e)&&(n=p.bitrate_table[t][s]);return n}function P(e,t,a){a<16e3&&(t=2);for(var n=0;n<=14;n++)if(p.bitrate_table[t][n]>0&&p.bitrate_table[t][n]==e)return n;return-1}function R(e,t){var a=[new E(8,2e3),new E(16,3700),new E(24,3900),new E(32,5500),new E(40,7e3),new E(48,7500),new E(56,1e4),new E(64,11e3),new E(80,13500),new E(96,15100),new E(112,15600),new E(128,17e3),new E(160,17500),new E(192,18600),new E(224,19400),new E(256,19700),new E(320,20500)],n=w.nearestBitrateFullIndex(t);e.lowerlimit=a[n].lowpass}function D(e){var t=g.BLKSIZE+e.framesize-g.FFTOFFSET;return t=Math.max(t,512+e.framesize-32),o(c.MFSIZE>=t),t}function O(e,t,a,n,s,i){var r=w.enc.lame_encode_mp3_frame(e,t,a,n,s,i);return e.frameNum++,r}function L(){this.n_in=0,this.n_out=0}function F(){this.num_used=0}function U(e,t){return 0!=t?U(t,e%t):e}function V(e,t,a){var n=Math.PI*t;(e/=a)<0&&(e=0),e>1&&(e=1);var s=e-.5,i=.42-.5*Math.cos(2*e*Math.PI)+.08*Math.cos(4*e*Math.PI);return Math.abs(s)<1e-9?n/Math.PI:i*Math.sin(a*n*s)/(Math.PI*a*s)}function $(e,t,a,n,i,r,l,d,u){var m,h,f=e.internal_flags,p=0,g=e.out_samplerate/U(e.out_samplerate,e.in_samplerate);g>c.BPC&&(g=c.BPC);var b=Math.abs(f.resample_ratio-Math.floor(.5+f.resample_ratio))<1e-4?1:0,v=1/f.resample_ratio;v>1&&(v=1);var y=31;0==y%2&&--y;var _=(y+=b)+1;if(0==f.fill_buffer_resample_init){for(f.inbuf_old[0]=s(_),f.inbuf_old[1]=s(_),m=0;m<=2*g;++m)f.blackfilt[m]=s(_);for(f.itime[0]=0,f.itime[1]=0,p=0;p<=2*g;p++){var x=0,w=(p-g)/(2*g);for(m=0;m<=y;m++)x+=f.blackfilt[p][m]=V(m-w,v,y);for(m=0;m<=y;m++)f.blackfilt[p][m]/=x}f.fill_buffer_resample_init=1}var k=f.inbuf_old[u];for(h=0;h<n;h++){var M,S;if(M=h*f.resample_ratio,y+(p=0|Math.floor(M-f.itime[u]))-y/2>=l)break;w=M-f.itime[u]-(p+y%2*.5);o(Math.abs(w)<=.501),S=0|Math.floor(2*w*g+g+.5);var C=0;for(m=0;m<=y;++m){var N=0|m+p-y/2;o(N<l),o(N+_>=0),C+=(N<0?k[_+N]:i[r+N])*f.blackfilt[S][m]}t[a+h]=C}if(d.num_used=Math.min(l,y+p-y/2),f.itime[u]+=d.num_used-h*f.resample_ratio,d.num_used>=_)for(m=0;m<_;m++)k[m]=i[r+d.num_used+m-_];else{var A=_-d.num_used;for(m=0;m<A;++m)k[m]=k[m+d.num_used];for(p=0;m<_;++m,++p)k[m]=i[r+p];o(p==d.num_used)}return h}function H(e,t,a,n,s,i){var r=e.internal_flags;if(r.resample_ratio<.9999||r.resample_ratio>1.0001)for(var o=0;o<r.channels_out;o++){var l=new F;i.n_out=$(e,t[o],r.mf_size,e.framesize,a[o],n,s,l,o),i.n_in=l.num_used}else{i.n_out=Math.min(e.framesize,s),i.n_in=i.n_out;for(var d=0;d<i.n_out;++d)t[0][r.mf_size+d]=a[0][n+d],2==r.channels_out&&(t[1][r.mf_size+d]=a[1][n+d])}}this.lame_init=function(){var e=new d;return function(e){var t;e.class_id=I,t=e.internal_flags=new c,e.mode=MPEGMode.NOT_SET,e.original=1,e.in_samplerate=44100,e.num_channels=2,e.num_samples=-1,e.bWriteVbrTag=!0,e.quality=-1,e.short_blocks=null,t.subblock_gain=-1,e.lowpassfreq=0,e.highpassfreq=0,e.lowpasswidth=-1,e.highpasswidth=-1,e.VBR=a.vbr_off,e.VBR_q=4,e.ATHcurve=-1,e.VBR_mean_bitrate_kbps=128,e.VBR_min_bitrate_kbps=0,e.VBR_max_bitrate_kbps=0,e.VBR_hard_min=0,t.VBR_min_bitrate=1,t.VBR_max_bitrate=13,e.quant_comp=-1,e.quant_comp_short=-1,e.msfix=-1,t.resample_ratio=1,t.OldValue[0]=180,t.OldValue[1]=180,t.CurrentStep[0]=4,t.CurrentStep[1]=4,t.masking_lower=1,t.nsPsy.attackthre=-1,t.nsPsy.attackthre_s=-1,e.scale=-1,e.athaa_type=-1,e.ATHtype=-1,e.athaa_loudapprox=-1,e.athaa_sensitivity=0,e.useTemporal=null,e.interChRatio=-1,t.mf_samples_to_encode=g.ENCDELAY+g.POSTDELAY,e.encoder_padding=0,t.mf_size=g.ENCDELAY-g.MDCTDELAY,e.findReplayGain=!1,e.decode_on_the_fly=!1,t.decode_on_the_fly=!1,t.findReplayGain=!1,t.findPeakSample=!1,t.RadioGain=0,t.AudiophileGain=0,t.noclipGainChange=0,t.noclipScale=-1,e.preset=0,e.write_id3tag_automatic=!0}(e),e.lame_allocated_gfp=1,e},this.nearestBitrateFullIndex=function(e){var t=[8,16,24,32,40,48,56,64,80,96,112,128,160,192,224,256,320],a=0,n=0,s=0,i=0;i=t[16],s=16,n=t[16],a=16;for(var r=0;r<16;r++)if(Math.max(e,t[r+1])!=e){i=t[r+1],s=r+1,n=t[r],a=r;break}return i-e>e-n?a:s},this.lame_init_params=function(e){var s,r,d,c=e.internal_flags;if(c.Class_ID=0,null==c.ATH&&(c.ATH=new u),null==c.PSY&&(c.PSY=new N),null==c.rgdata&&(c.rgdata=new m),c.channels_in=e.num_channels,1==c.channels_in&&(e.mode=MPEGMode.MONO),c.channels_out=e.mode==MPEGMode.MONO?1:2,c.mode_ext=g.MPG_MD_MS_LR,e.mode==MPEGMode.MONO&&(e.force_ms=!1),e.VBR==a.vbr_off&&128!=e.VBR_mean_bitrate_kbps&&0==e.brate&&(e.brate=e.VBR_mean_bitrate_kbps),e.VBR==a.vbr_off||e.VBR==a.vbr_mtrh||e.VBR==a.vbr_mt||(e.free_format=!1),e.VBR==a.vbr_off&&0==e.brate&&f.EQ(e.compression_ratio,0)&&(e.compression_ratio=11.025),e.VBR==a.vbr_off&&e.compression_ratio>0&&(0==e.out_samplerate&&(e.out_samplerate=map2MP3Frequency(int(.97*e.in_samplerate))),e.brate=0|16*e.out_samplerate*c.channels_out/(1e3*e.compression_ratio),c.samplerate_index=T(e.out_samplerate,e),e.free_format||(e.brate=B(e.brate,e.version,e.out_samplerate))),0!=e.out_samplerate&&(e.out_samplerate<16e3?(e.VBR_mean_bitrate_kbps=Math.max(e.VBR_mean_bitrate_kbps,8),e.VBR_mean_bitrate_kbps=Math.min(e.VBR_mean_bitrate_kbps,64)):e.out_samplerate<32e3?(e.VBR_mean_bitrate_kbps=Math.max(e.VBR_mean_bitrate_kbps,8),e.VBR_mean_bitrate_kbps=Math.min(e.VBR_mean_bitrate_kbps,160)):(e.VBR_mean_bitrate_kbps=Math.max(e.VBR_mean_bitrate_kbps,32),e.VBR_mean_bitrate_kbps=Math.min(e.VBR_mean_bitrate_kbps,320))),0==e.lowpassfreq){var w=16e3;switch(e.VBR){case a.vbr_off:R(E=new A,e.brate),w=E.lowerlimit;break;case a.vbr_abr:var E;R(E=new A,e.VBR_mean_bitrate_kbps),w=E.lowerlimit;break;case a.vbr_rh:var D=[19500,19e3,18600,18e3,17500,16e3,15600,14900,12500,1e4,3950];if(0<=e.VBR_q&&e.VBR_q<=9){var O=D[e.VBR_q],L=D[e.VBR_q+1],F=e.VBR_q_frac;w=linear_int(O,L,F)}else w=19500;break;default:D=[19500,19e3,18500,18e3,17500,16500,15500,14500,12500,9500,3950];if(0<=e.VBR_q&&e.VBR_q<=9){O=D[e.VBR_q],L=D[e.VBR_q+1],F=e.VBR_q_frac;w=linear_int(O,L,F)}else w=19500}e.mode!=MPEGMode.MONO||e.VBR!=a.vbr_off&&e.VBR!=a.vbr_abr||(w*=1.5),e.lowpassfreq=0|w}if(0==e.out_samplerate&&(2*e.lowpassfreq>e.in_samplerate&&(e.lowpassfreq=e.in_samplerate/2),e.out_samplerate=(s=0|e.lowpassfreq,r=e.in_samplerate,d=44100,r>=48e3?d=48e3:r>=44100?d=44100:r>=32e3?d=32e3:r>=24e3?d=24e3:r>=22050?d=22050:r>=16e3?d=16e3:r>=12e3?d=12e3:r>=11025?d=11025:r>=8e3&&(d=8e3),-1==s?d:(s<=15960&&(d=44100),s<=15250&&(d=32e3),s<=11220&&(d=24e3),s<=9970&&(d=22050),s<=7230&&(d=16e3),s<=5420&&(d=12e3),s<=4510&&(d=11025),s<=3970&&(d=8e3),r<d?r>44100?48e3:r>32e3?44100:r>24e3?32e3:r>22050?24e3:r>16e3?22050:r>12e3?16e3:r>11025?12e3:r>8e3?11025:8e3:d))),e.lowpassfreq=Math.min(20500,e.lowpassfreq),e.lowpassfreq=Math.min(e.out_samplerate/2,e.lowpassfreq),e.VBR==a.vbr_off&&(e.compression_ratio=16*e.out_samplerate*c.channels_out/(1e3*e.brate)),e.VBR==a.vbr_abr&&(e.compression_ratio=16*e.out_samplerate*c.channels_out/(1e3*e.VBR_mean_bitrate_kbps)),e.bWriteVbrTag||(e.findReplayGain=!1,e.decode_on_the_fly=!1,c.findPeakSample=!1),c.findReplayGain=e.findReplayGain,c.decode_on_the_fly=e.decode_on_the_fly,c.decode_on_the_fly&&(c.findPeakSample=!0),c.findReplayGain&&b.InitGainAnalysis(c.rgdata,e.out_samplerate)==GainAnalysis.INIT_GAIN_ANALYSIS_ERROR)return e.internal_flags=null,-6;switch(c.decode_on_the_fly&&!e.decode_only&&(null!=c.hip&&S.hip_decode_exit(c.hip),c.hip=S.hip_decode_init()),c.mode_gr=e.out_samplerate<=24e3?1:2,e.framesize=576*c.mode_gr,e.encoder_delay=g.ENCDELAY,c.resample_ratio=e.in_samplerate/e.out_samplerate,e.VBR){case a.vbr_mt:case a.vbr_rh:case a.vbr_mtrh:e.compression_ratio=[5.7,6.5,7.3,8.2,10,11.9,13,14,15,16.5][e.VBR_q];break;case a.vbr_abr:e.compression_ratio=16*e.out_samplerate*c.channels_out/(1e3*e.VBR_mean_bitrate_kbps);break;default:e.compression_ratio=16*e.out_samplerate*c.channels_out/(1e3*e.brate)}if(e.mode==MPEGMode.NOT_SET&&(e.mode=MPEGMode.JOINT_STEREO),e.highpassfreq>0?(c.highpass1=2*e.highpassfreq,e.highpasswidth>=0?c.highpass2=2*(e.highpassfreq+e.highpasswidth):c.highpass2=2*e.highpassfreq,c.highpass1/=e.out_samplerate,c.highpass2/=e.out_samplerate):(c.highpass1=0,c.highpass2=0),e.lowpassfreq>0?(c.lowpass2=2*e.lowpassfreq,e.lowpasswidth>=0?(c.lowpass1=2*(e.lowpassfreq-e.lowpasswidth),c.lowpass1<0&&(c.lowpass1=0)):c.lowpass1=2*e.lowpassfreq,c.lowpass1/=e.out_samplerate,c.lowpass2/=e.out_samplerate):(c.lowpass1=0,c.lowpass2=0),function(e){var a=e.internal_flags,n=32,s=-1;if(a.lowpass1>0){for(var i=999,r=0;r<=31;r++)(c=r/31)>=a.lowpass2&&(n=Math.min(n,r)),a.lowpass1<c&&c<a.lowpass2&&(i=Math.min(i,r));a.lowpass1=999==i?(n-.75)/31:(i-.75)/31,a.lowpass2=n/31}if(a.highpass2>0&&a.highpass2<.75/31*.9&&(a.highpass1=0,a.highpass2=0,t.err.println("Warning: highpass filter disabled.  highpass frequency too small\n")),a.highpass2>0){var o=-1;for(r=0;r<=31;r++)(c=r/31)<=a.highpass1&&(s=Math.max(s,r)),a.highpass1<c&&c<a.highpass2&&(o=Math.max(o,r));a.highpass1=s/31,a.highpass2=-1==o?(s+.75)/31:(o+.75)/31}for(r=0;r<32;r++){var l,d,c=r/31;l=a.highpass2>a.highpass1?j((a.highpass2-c)/(a.highpass2-a.highpass1+1e-20)):1,d=a.lowpass2>a.lowpass1?j((c-a.lowpass1)/(a.lowpass2-a.lowpass1+1e-20)):1,a.amp_filter[r]=l*d}}(e),c.samplerate_index=T(e.out_samplerate,e),c.samplerate_index<0)return e.internal_flags=null,-1;if(e.VBR==a.vbr_off){if(e.free_format)c.bitrate_index=0;else if(e.brate=B(e.brate,e.version,e.out_samplerate),c.bitrate_index=P(e.brate,e.version,e.out_samplerate),c.bitrate_index<=0)return e.internal_flags=null,-1}else c.bitrate_index=1;e.analysis&&(e.bWriteVbrTag=!1),null!=c.pinfo&&(e.bWriteVbrTag=!1),v.init_bit_stream_w(c);for(var U,V=c.samplerate_index+3*e.version+6*(e.out_samplerate<16e3?1:0),$=0;$<g.SBMAX_l+1;$++)c.scalefac_band.l[$]=_.sfBandIndex[V].l[$];for($=0;$<g.PSFB21+1;$++){var H=(c.scalefac_band.l[22]-c.scalefac_band.l[21])/g.PSFB21,K=c.scalefac_band.l[21]+$*H;c.scalefac_band.psfb21[$]=K}c.scalefac_band.psfb21[g.PSFB21]=576;for($=0;$<g.SBMAX_s+1;$++)c.scalefac_band.s[$]=_.sfBandIndex[V].s[$];for($=0;$<g.PSFB12+1;$++){H=(c.scalefac_band.s[13]-c.scalefac_band.s[12])/g.PSFB12,K=c.scalefac_band.s[12]+$*H;c.scalefac_band.psfb12[$]=K}for(c.scalefac_band.psfb12[g.PSFB12]=192,1==e.version?c.sideinfo_len=1==c.channels_out?21:36:c.sideinfo_len=1==c.channels_out?13:21,e.error_protection&&(c.sideinfo_len+=2),function(e){var t=e.internal_flags;e.frameNum=0,e.write_id3tag_automatic&&M.id3tag_write_v2(e),t.bitrate_stereoMode_Hist=i([16,5]),t.bitrate_blockType_Hist=i([16,6]),t.PeakSample=0,e.bWriteVbrTag&&k.InitVbrTag(e)}(e),c.Class_ID=I,U=0;U<19;U++)c.nsPsy.pefirbuf[U]=700*c.mode_gr*c.channels_out;switch(-1==e.ATHtype&&(e.ATHtype=4),o(e.VBR_q<=9),o(e.VBR_q>=0),e.VBR){case a.vbr_mt:e.VBR=a.vbr_mtrh;case a.vbr_mtrh:null==e.useTemporal&&(e.useTemporal=!1),y.apply_preset(e,500-10*e.VBR_q,0),e.quality<0&&(e.quality=LAME_DEFAULT_QUALITY),e.quality<5&&(e.quality=0),e.quality>5&&(e.quality=5),c.PSY.mask_adjust=e.maskingadjust,c.PSY.mask_adjust_short=e.maskingadjust_short,e.experimentalY?c.sfb21_extra=!1:c.sfb21_extra=e.out_samplerate>44e3,c.iteration_loop=new VBRNewIterationLoop(x);break;case a.vbr_rh:y.apply_preset(e,500-10*e.VBR_q,0),c.PSY.mask_adjust=e.maskingadjust,c.PSY.mask_adjust_short=e.maskingadjust_short,e.experimentalY?c.sfb21_extra=!1:c.sfb21_extra=e.out_samplerate>44e3,e.quality>6&&(e.quality=6),e.quality<0&&(e.quality=LAME_DEFAULT_QUALITY),c.iteration_loop=new VBROldIterationLoop(x);break;default:var q;c.sfb21_extra=!1,e.quality<0&&(e.quality=LAME_DEFAULT_QUALITY),(q=e.VBR)==a.vbr_off&&(e.VBR_mean_bitrate_kbps=e.brate),y.apply_preset(e,e.VBR_mean_bitrate_kbps,0),e.VBR=q,c.PSY.mask_adjust=e.maskingadjust,c.PSY.mask_adjust_short=e.maskingadjust_short,q==a.vbr_off?c.iteration_loop=new h(x):c.iteration_loop=new ABRIterationLoop(x)}if(o(e.scale>=0),e.VBR!=a.vbr_off){if(c.VBR_min_bitrate=1,c.VBR_max_bitrate=14,e.out_samplerate<16e3&&(c.VBR_max_bitrate=8),0!=e.VBR_min_bitrate_kbps&&(e.VBR_min_bitrate_kbps=B(e.VBR_min_bitrate_kbps,e.version,e.out_samplerate),c.VBR_min_bitrate=P(e.VBR_min_bitrate_kbps,e.version,e.out_samplerate),c.VBR_min_bitrate<0))return-1;if(0!=e.VBR_max_bitrate_kbps&&(e.VBR_max_bitrate_kbps=B(e.VBR_max_bitrate_kbps,e.version,e.out_samplerate),c.VBR_max_bitrate=P(e.VBR_max_bitrate_kbps,e.version,e.out_samplerate),c.VBR_max_bitrate<0))return-1;e.VBR_min_bitrate_kbps=p.bitrate_table[e.version][c.VBR_min_bitrate],e.VBR_max_bitrate_kbps=p.bitrate_table[e.version][c.VBR_max_bitrate],e.VBR_mean_bitrate_kbps=Math.min(p.bitrate_table[e.version][c.VBR_max_bitrate],e.VBR_mean_bitrate_kbps),e.VBR_mean_bitrate_kbps=Math.max(p.bitrate_table[e.version][c.VBR_min_bitrate],e.VBR_mean_bitrate_kbps)}return e.tune&&(c.PSY.mask_adjust+=e.tune_value_a,c.PSY.mask_adjust_short+=e.tune_value_a),function(e){var t=e.internal_flags;switch(e.quality){default:case 9:t.psymodel=0,t.noise_shaping=0,t.noise_shaping_amp=0,t.noise_shaping_stop=0,t.use_best_huffman=0,t.full_outer_loop=0;break;case 8:e.quality=7;case 7:t.psymodel=1,t.noise_shaping=0,t.noise_shaping_amp=0,t.noise_shaping_stop=0,t.use_best_huffman=0,t.full_outer_loop=0;break;case 6:case 5:t.psymodel=1,0==t.noise_shaping&&(t.noise_shaping=1),t.noise_shaping_amp=0,t.noise_shaping_stop=0,-1==t.subblock_gain&&(t.subblock_gain=1),t.use_best_huffman=0,t.full_outer_loop=0;break;case 4:t.psymodel=1,0==t.noise_shaping&&(t.noise_shaping=1),t.noise_shaping_amp=0,t.noise_shaping_stop=0,-1==t.subblock_gain&&(t.subblock_gain=1),t.use_best_huffman=1,t.full_outer_loop=0;break;case 3:t.psymodel=1,0==t.noise_shaping&&(t.noise_shaping=1),t.noise_shaping_amp=1,t.noise_shaping_stop=1,-1==t.subblock_gain&&(t.subblock_gain=1),t.use_best_huffman=1,t.full_outer_loop=0;break;case 2:t.psymodel=1,0==t.noise_shaping&&(t.noise_shaping=1),0==t.substep_shaping&&(t.substep_shaping=2),t.noise_shaping_amp=1,t.noise_shaping_stop=1,-1==t.subblock_gain&&(t.subblock_gain=1),t.use_best_huffman=1,t.full_outer_loop=0;break;case 1:case 0:t.psymodel=1,0==t.noise_shaping&&(t.noise_shaping=1),0==t.substep_shaping&&(t.substep_shaping=2),t.noise_shaping_amp=2,t.noise_shaping_stop=1,-1==t.subblock_gain&&(t.subblock_gain=1),t.use_best_huffman=1,t.full_outer_loop=0}}(e),o(e.scale>=0),e.athaa_type<0?c.ATH.useAdjust=3:c.ATH.useAdjust=e.athaa_type,c.ATH.aaSensitivityP=Math.pow(10,e.athaa_sensitivity/-10),null==e.short_blocks&&(e.short_blocks=n.short_block_allowed),e.short_blocks!=n.short_block_allowed||e.mode!=MPEGMode.JOINT_STEREO&&e.mode!=MPEGMode.STEREO||(e.short_blocks=n.short_block_coupled),e.quant_comp<0&&(e.quant_comp=1),e.quant_comp_short<0&&(e.quant_comp_short=0),e.msfix<0&&(e.msfix=0),e.exp_nspsytune=1|e.exp_nspsytune,e.internal_flags.nsPsy.attackthre<0&&(e.internal_flags.nsPsy.attackthre=l.NSATTACKTHRE),e.internal_flags.nsPsy.attackthre_s<0&&(e.internal_flags.nsPsy.attackthre_s=l.NSATTACKTHRE_S),o(e.scale>=0),e.scale<0&&(e.scale=1),e.ATHtype<0&&(e.ATHtype=4),e.ATHcurve<0&&(e.ATHcurve=4),e.athaa_loudapprox<0&&(e.athaa_loudapprox=2),e.interChRatio<0&&(e.interChRatio=0),null==e.useTemporal&&(e.useTemporal=!0),c.slot_lag=c.frac_SpF=0,e.VBR==a.vbr_off&&(c.slot_lag=c.frac_SpF=72e3*(e.version+1)*e.brate%e.out_samplerate|0),_.iteration_init(e),C.psymodel_init(e),o(e.scale>=0),0},this.lame_encode_flush=function(e,t,a,n){var s,i,o,l,d=e.internal_flags,c=r([2,1152]),u=0,m=d.mf_samples_to_encode-g.POSTDELAY,h=D(e);if(d.mf_samples_to_encode<1)return 0;for(s=0,e.in_samplerate!=e.out_samplerate&&(m+=16*e.out_samplerate/e.in_samplerate),(o=e.framesize-m%e.framesize)<576&&(o+=e.framesize),e.encoder_padding=o,l=(m+o)/e.framesize;l>0&&u>=0;){var f=h-d.mf_size,p=e.frameNum;f*=e.in_samplerate,(f/=e.out_samplerate)>1152&&(f=1152),f<1&&(f=1),i=n-s,0==n&&(i=0),a+=u=this.lame_encode_buffer(e,c[0],c[1],f,t,a,i),s+=u,l-=p!=e.frameNum?1:0}if(d.mf_samples_to_encode=0,u<0)return u;if(i=n-s,0==n&&(i=0),v.flush_bitstream(e),(u=v.copy_buffer(d,t,a,i,1))<0)return u;if(a+=u,i=n-(s+=u),0==n&&(i=0),e.write_id3tag_automatic){if(M.id3tag_write_v1(e),(u=v.copy_buffer(d,t,a,i,0))<0)return u;s+=u}return s},this.lame_encode_buffer=function(e,t,a,n,i,r,l){var d=e.internal_flags,u=[null,null];if(d.Class_ID!=I)return-3;if(0==n)return 0;!function(e,t){(null==e.in_buffer_0||e.in_buffer_nsamples<t)&&(e.in_buffer_0=s(t),e.in_buffer_1=s(t),e.in_buffer_nsamples=t)}(d,n),u[0]=d.in_buffer_0,u[1]=d.in_buffer_1;for(var m=0;m<n;m++)u[0][m]=t[m],d.channels_in>1&&(u[1][m]=a[m]);return function(e,t,a,n,s,i,r){var l,d,u,m,h,p=e.internal_flags,y=0,_=[null,null],x=[null,null];if(p.Class_ID!=I)return-3;if(0==n)return 0;if(h=v.copy_buffer(p,s,i,r,0),h<0)return h;if(i+=h,y+=h,x[0]=t,x[1]=a,f.NEQ(e.scale,0)&&f.NEQ(e.scale,1))for(d=0;d<n;++d)x[0][d]*=e.scale,2==p.channels_out&&(x[1][d]*=e.scale);if(f.NEQ(e.scale_left,0)&&f.NEQ(e.scale_left,1))for(d=0;d<n;++d)x[0][d]*=e.scale_left;if(f.NEQ(e.scale_right,0)&&f.NEQ(e.scale_right,1))for(d=0;d<n;++d)x[1][d]*=e.scale_right;if(2==e.num_channels&&1==p.channels_out)for(d=0;d<n;++d)x[0][d]=.5*(x[0][d]+x[1][d]),x[1][d]=0;m=D(e),_[0]=p.mfbuf[0],_[1]=p.mfbuf[1];var w=0;for(;n>0;){var k=[null,null],M=0,S=0;k[0]=x[0],k[1]=x[1];var C=new L;if(H(e,_,k,w,n,C),M=C.n_in,S=C.n_out,p.findReplayGain&&!p.decode_on_the_fly&&b.AnalyzeSamples(p.rgdata,_[0],p.mf_size,_[1],p.mf_size,S,p.channels_out)==GainAnalysis.GAIN_ANALYSIS_ERROR)return-6;if(n-=M,w+=M,p.channels_out,p.mf_size+=S,o(p.mf_size<=c.MFSIZE),p.mf_samples_to_encode<1&&(p.mf_samples_to_encode=g.ENCDELAY+g.POSTDELAY),p.mf_samples_to_encode+=S,p.mf_size>=m){var N=r-y;if(0==r&&(N=0),(l=O(e,_[0],_[1],s,i,N))<0)return l;for(i+=l,y+=l,p.mf_size-=e.framesize,p.mf_samples_to_encode-=e.framesize,u=0;u<p.channels_out;u++)for(d=0;d<p.mf_size;d++)_[u][d]=_[u][d+e.framesize]}}return o(0==n),y}(e,u[0],u[1],n,i,r,l)}},hs}function Ws(){if(Ms)return ks;Ms=1;var e=Bs(),t=e.System,a=e.VbrMode;e.Float,e.ShortBlock;var n=e.Util,s=e.Arrays;e.new_array_n,e.new_byte,e.new_double;var i=e.new_float;e.new_float_n,e.new_int,e.new_int_n;var r=e.assert,o=vs?bs:(vs=1,bs=function(){this.setModules=function(e,t){}}),l=_s?ys:(_s=1,ys=function(){this.over_noise=0,this.tot_noise=0,this.max_noise=0,this.over_count=0,this.over_SSD=0,this.bits=0}),d=function(){if(ws)return xs;ws=1;var e=Bs(),t=e.new_float,a=e.new_int;return e.assert,xs=function(){this.global_gain=0,this.sfb_count1=0,this.step=a(39),this.noise=t(39),this.noise_log=t(39)}}(),c=Rs(),u=Fs(),m=Ls();return ks=function(){var e,h,f;this.rv=null,this.qupvt=null;var p,g=new o;function b(e){this.ordinal=e}function v(e){for(var t=0;t<e.sfbmax;t++)if(e.scalefac[t]+e.subblock_gain[e.window[t]]==0)return!1;return!0}function y(e){return n.FAST_LOG10(.368+.632*e*e*e)}function _(e,t,a,n,s){var i;switch(e){default:case 9:t.over_count>0?(i=a.over_SSD<=t.over_SSD,a.over_SSD==t.over_SSD&&(i=a.bits<t.bits)):i=a.max_noise<0&&10*a.max_noise+a.bits<=10*t.max_noise+t.bits;break;case 0:i=a.over_count<t.over_count||a.over_count==t.over_count&&a.over_noise<t.over_noise||a.over_count==t.over_count&&BitStream.EQ(a.over_noise,t.over_noise)&&a.tot_noise<t.tot_noise;break;case 8:a.max_noise=function(e,t){for(var a=1e-37,n=0;n<t.psymax;n++)a+=y(e[n]);return Math.max(1e-20,a)}(s,n);case 1:i=a.max_noise<t.max_noise;break;case 2:i=a.tot_noise<t.tot_noise;break;case 3:i=a.tot_noise<t.tot_noise&&a.max_noise<t.max_noise;break;case 4:i=a.max_noise<=0&&t.max_noise>.2||a.max_noise<=0&&t.max_noise<0&&t.max_noise>a.max_noise-.2&&a.tot_noise<t.tot_noise||a.max_noise<=0&&t.max_noise>0&&t.max_noise>a.max_noise-.2&&a.tot_noise<t.tot_noise+t.over_noise||a.max_noise>0&&t.max_noise>-.05&&t.max_noise>a.max_noise-.1&&a.tot_noise+a.over_noise<t.tot_noise+t.over_noise||a.max_noise>0&&t.max_noise>-.1&&t.max_noise>a.max_noise-.15&&a.tot_noise+a.over_noise+a.over_noise<t.tot_noise+t.over_noise+t.over_noise;break;case 5:i=a.over_noise<t.over_noise||BitStream.EQ(a.over_noise,t.over_noise)&&a.tot_noise<t.tot_noise;break;case 6:i=a.over_noise<t.over_noise||BitStream.EQ(a.over_noise,t.over_noise)&&(a.max_noise<t.max_noise||BitStream.EQ(a.max_noise,t.max_noise)&&a.tot_noise<=t.tot_noise);break;case 7:i=a.over_count<t.over_count||a.over_noise<t.over_noise}return 0==t.over_count&&(i=i&&a.bits<t.bits),i}function x(e,t,a,n,i){var o=e.internal_flags;!function(e,t,a,n,s){var i,r=e.internal_flags;i=0==t.scalefac_scale?1.2968395546510096:1.6817928305074292;for(var o=0,l=0;l<t.sfbmax;l++)o<a[l]&&(o=a[l]);var d=r.noise_shaping_amp;switch(3==d&&(d=s?2:1),d){case 2:break;case 1:o>1?o=Math.pow(o,.5):o*=.95;break;default:o>1?o=1:o*=.95}var c=0;for(l=0;l<t.sfbmax;l++){var u,m=t.width[l];if(c+=m,!(a[l]<o)){if(2&r.substep_shaping&&(r.pseudohalf[l]=0==r.pseudohalf[l]?1:0,0==r.pseudohalf[l]&&2==r.noise_shaping_amp))return;for(t.scalefac[l]++,u=-m;u<0;u++)n[c+u]*=i,n[c+u]>t.xrpow_max&&(t.xrpow_max=n[c+u]);if(2==r.noise_shaping_amp)return}}}(e,t,a,n,i);var l=v(t);return!l&&(!(l=2==o.mode_gr?p.scale_bitcount(t):p.scale_bitcount_lsf(o,t))||(o.noise_shaping>1&&(s.fill(o.pseudohalf,0),0==t.scalefac_scale?(!function(e,t){for(var a=0,n=0;n<e.sfbmax;n++){var s=e.width[n],i=e.scalefac[n];if(0!=e.preflag&&(i+=f.pretab[n]),a+=s,1&i){i++;for(var r=-s;r<0;r++)t[a+r]*=1.2968395546510096,t[a+r]>e.xrpow_max&&(e.xrpow_max=t[a+r])}e.scalefac[n]=i>>1}e.preflag=0,e.scalefac_scale=1}(t,n),l=!1):t.block_type==c.SHORT_TYPE&&o.subblock_gain>0&&(l=function(e,t,a){var n,s=t.scalefac;for(n=0;n<t.sfb_lmax;n++)if(s[n]>=16)return!0;for(var i=0;i<3;i++){var o=0,l=0;for(n=t.sfb_lmax+i;n<t.sfbdivide;n+=3)o<s[n]&&(o=s[n]);for(;n<t.sfbmax;n+=3)l<s[n]&&(l=s[n]);if(!(o<16&&l<8)){if(t.subblock_gain[i]>=7)return!0;t.subblock_gain[i]++;var d=e.scalefac_band.l[t.sfb_lmax];for(n=t.sfb_lmax+i;n<t.sfbmax;n+=3){var c=t.width[n],u=s[n];if(r(u>=0),(u-=4>>t.scalefac_scale)>=0)s[n]=u,d+=3*c;else{s[n]=0;var m=210+(u<<t.scalefac_scale+1);p=f.IPOW20(m),d+=c*(i+1);for(var h=-c;h<0;h++)a[d+h]*=p,a[d+h]>t.xrpow_max&&(t.xrpow_max=a[d+h]);d+=c*(3-i-1)}}var p=f.IPOW20(202);for(d+=t.width[n]*(i+1),h=-t.width[n];h<0;h++)a[d+h]*=p,a[d+h]>t.xrpow_max&&(t.xrpow_max=a[d+h])}}return!1}(o,t,n)||v(t))),l||(l=2==o.mode_gr?p.scale_bitcount(t):p.scale_bitcount_lsf(o,t)),!l))}this.setModules=function(t,a,n,s){e=t,h=a,this.rv=a,f=n,this.qupvt=n,p=s,g.setModules(f,p)},this.ms_convert=function(e,t){for(var a=0;a<576;++a){var s=e.tt[t][0].xr[a],i=e.tt[t][1].xr[a];e.tt[t][0].xr[a]=(s+i)*(.5*n.SQRT2),e.tt[t][1].xr[a]=(s-i)*(.5*n.SQRT2)}},this.init_xrpow=function(e,t,a){var n=0,i=0|t.max_nonzero_coeff;if(r(null!=a),t.xrpow_max=0,r(0<=i&&i<=575),s.fill(a,i,576,0),n=function(e,t,a,n){n=0;for(var s=0;s<=a;++s){var i=Math.abs(e.xr[s]);n+=i,t[s]=Math.sqrt(i*Math.sqrt(i)),t[s]>e.xrpow_max&&(e.xrpow_max=t[s])}return n}(t,a,i,n),n>1e-20){var o=0;2&e.substep_shaping&&(o=1);for(var l=0;l<t.psymax;l++)e.pseudohalf[l]=o;return!0}return s.fill(t.l3_enc,0,576,0),!1},this.init_outer_loop=function(e,a){a.part2_3_length=0,a.big_values=0,a.count1=0,a.global_gain=210,a.scalefac_compress=0,a.table_select[0]=0,a.table_select[1]=0,a.table_select[2]=0,a.subblock_gain[0]=0,a.subblock_gain[1]=0,a.subblock_gain[2]=0,a.subblock_gain[3]=0,a.region0_count=0,a.region1_count=0,a.preflag=0,a.scalefac_scale=0,a.count1table_select=0,a.part2_length=0,a.sfb_lmax=c.SBPSY_l,a.sfb_smin=c.SBPSY_s,a.psy_lmax=e.sfb21_extra?c.SBMAX_l:c.SBPSY_l,a.psymax=a.psy_lmax,a.sfbmax=a.sfb_lmax,a.sfbdivide=11;for(var n=0;n<c.SBMAX_l;n++)a.width[n]=e.scalefac_band.l[n+1]-e.scalefac_band.l[n],a.window[n]=3;if(a.block_type==c.SHORT_TYPE){var r=i(576);a.sfb_smin=0,a.sfb_lmax=0,0!=a.mixed_block_flag&&(a.sfb_smin=3,a.sfb_lmax=2*e.mode_gr+4),a.psymax=a.sfb_lmax+3*((e.sfb21_extra?c.SBMAX_s:c.SBPSY_s)-a.sfb_smin),a.sfbmax=a.sfb_lmax+3*(c.SBPSY_s-a.sfb_smin),a.sfbdivide=a.sfbmax-18,a.psy_lmax=a.sfb_lmax;var o=e.scalefac_band.l[a.sfb_lmax];t.arraycopy(a.xr,0,r,0,576);for(n=a.sfb_smin;n<c.SBMAX_s;n++)for(var l=e.scalefac_band.s[n],d=e.scalefac_band.s[n+1],u=0;u<3;u++)for(var m=l;m<d;m++)a.xr[o++]=r[3*m+u];var h=a.sfb_lmax;for(n=a.sfb_smin;n<c.SBMAX_s;n++)a.width[h]=a.width[h+1]=a.width[h+2]=e.scalefac_band.s[n+1]-e.scalefac_band.s[n],a.window[h]=0,a.window[h+1]=1,a.window[h+2]=2,h+=3}a.count1bits=0,a.sfb_partition_table=f.nr_of_sfb_block[0][0],a.slen[0]=0,a.slen[1]=0,a.slen[2]=0,a.slen[3]=0,a.max_nonzero_coeff=575,s.fill(a.scalefac,0),function(e,t){var a=e.ATH,n=t.xr;if(t.block_type!=c.SHORT_TYPE)for(var s=!1,i=c.PSFB21-1;i>=0&&!s;i--){var r=e.scalefac_band.psfb21[i],o=e.scalefac_band.psfb21[i+1],l=f.athAdjust(a.adjust,a.psfb21[i],a.floor);e.nsPsy.longfact[21]>1e-12&&(l*=e.nsPsy.longfact[21]);for(var d=o-1;d>=r;d--){if(!(Math.abs(n[d])<l)){s=!0;break}n[d]=0}}else for(var u=0;u<3;u++)for(s=!1,i=c.PSFB12-1;i>=0&&!s;i--){o=(r=3*e.scalefac_band.s[12]+(e.scalefac_band.s[13]-e.scalefac_band.s[12])*u+(e.scalefac_band.psfb12[i]-e.scalefac_band.psfb12[0]))+(e.scalefac_band.psfb12[i+1]-e.scalefac_band.psfb12[i]);var m=f.athAdjust(a.adjust,a.psfb12[i],a.floor);for(e.nsPsy.shortfact[12]>1e-12&&(m*=e.nsPsy.shortfact[12]),d=o-1;d>=r;d--){if(!(Math.abs(n[d])<m)){s=!0;break}n[d]=0}}}(e,a)},b.BINSEARCH_NONE=new b(0),b.BINSEARCH_UP=new b(1),b.BINSEARCH_DOWN=new b(2),this.trancate_smallspectrums=function(e,t,a,n){var r=i(m.SFBMAX);if((4&e.substep_shaping||t.block_type!=c.SHORT_TYPE)&&!(128&e.substep_shaping)){f.calc_noise(t,a,r,new l,null);for(var o=0;o<576;o++){var d=0;0!=t.l3_enc[o]&&(d=Math.abs(t.xr[o])),n[o]=d}o=0;var u=8;t.block_type==c.SHORT_TYPE&&(u=6);do{var h,g,b,v,y=t.width[u];if(o+=y,!(r[u]>=1||(s.sort(n,o-y,y),BitStream.EQ(n[o-1],0)))){h=(1-r[u])*a[u],g=0,v=0;do{var _;for(b=1;v+b<y&&!BitStream.NEQ(n[v+o-y],n[v+o+b-y]);b++);if(h<(_=n[v+o-y]*n[v+o-y]*b)){0!=v&&(g=n[v+o-y-1]);break}h-=_,v+=b}while(v<y);if(!BitStream.EQ(g,0))do{Math.abs(t.xr[o-y])<=g&&(t.l3_enc[o-y]=0)}while(--y>0)}}while(++u<t.psymax);t.part2_3_length=p.noquant_count_bits(e,t,null)}},this.outer_loop=function(e,n,s,o,h,g){var v=e.internal_flags,y=new u,w=i(576),k=i(m.SFBMAX),M=new l,S=new d,C=9999999,N=!1,A=!1,E=0;if(function(e,t,a,n,s){var i,o=e.CurrentStep[n],l=!1,d=e.OldValue[n],c=b.BINSEARCH_NONE;for(t.global_gain=d,a-=t.part2_length,r(0!=o);;){var u;if(i=p.count_bits(e,s,t,null),1==o||i==a)break;i>a?(c==b.BINSEARCH_DOWN&&(l=!0),l&&(o/=2),c=b.BINSEARCH_UP,u=o):(c==b.BINSEARCH_UP&&(l=!0),l&&(o/=2),c=b.BINSEARCH_DOWN,u=-o),t.global_gain+=u,t.global_gain<0&&(t.global_gain=0,l=!0),t.global_gain>255&&(t.global_gain=255,l=!0)}for(r(t.global_gain>=0),r(t.global_gain<256);i>a&&t.global_gain<255;)t.global_gain++,i=p.count_bits(e,s,t,null);e.CurrentStep[n]=d-t.global_gain>=4?4:2,e.OldValue[n]=t.global_gain,t.part2_3_length=i}(v,n,g,h,o),0==v.noise_shaping)return 100;f.calc_noise(n,s,k,M,S),M.bits=n.part2_3_length,y.assign(n);var I=0;for(t.arraycopy(o,0,w,0,576);!N;){do{var j,T=new l,B=255;if(j=2&v.substep_shaping?20:3,v.sfb21_extra){if(k[y.sfbmax]>1)break;if(y.block_type==c.SHORT_TYPE&&(k[y.sfbmax+1]>1||k[y.sfbmax+2]>1))break}if(!x(e,y,k,o,A))break;0!=y.scalefac_scale&&(B=254);var P=g-y.part2_length;if(P<=0)break;for(;(y.part2_3_length=p.count_bits(v,o,y,S))>P&&y.global_gain<=B;)y.global_gain++;if(y.global_gain>B)break;if(0==M.over_count){for(;(y.part2_3_length=p.count_bits(v,o,y,S))>C&&y.global_gain<=B;)y.global_gain++;if(y.global_gain>B)break}if(f.calc_noise(y,s,k,T,S),T.bits=y.part2_3_length,0!=(_(n.block_type!=c.SHORT_TYPE?e.quant_comp:e.quant_comp_short,M,T,y,k)?1:0))C=n.part2_3_length,M=T,n.assign(y),I=0,t.arraycopy(o,0,w,0,576);else if(0==v.full_outer_loop){if(++I>j&&0==M.over_count)break;if(3==v.noise_shaping_amp&&A&&I>30)break;if(3==v.noise_shaping_amp&&A&&y.global_gain-E>15)break}}while(y.global_gain+y.scalefac_scale<255);3==v.noise_shaping_amp?A?N=!0:(y.assign(n),t.arraycopy(w,0,o,0,576),I=0,E=y.global_gain,A=!0):N=!0}return r(n.global_gain+n.scalefac_scale<=255),e.VBR==a.vbr_rh||e.VBR==a.vbr_mtrh?t.arraycopy(w,0,o,0,576):1&v.substep_shaping&&trancate_smallspectrums(v,n,s,o),M.over_count},this.iteration_finish_one=function(e,t,a){var n=e.l3_side,s=n.tt[t][a];p.best_scalefac_store(e,t,a,n),1==e.use_best_huffman&&p.best_huffman_divide(e,s),h.ResvAdjust(e,s)},this.VBR_encode_granule=function(e,a,n,o,l,d,c){var m,h=e.internal_flags,f=new u,p=i(576),g=c,b=c+1,v=(c+d)/2,y=0,_=h.sfb21_extra;r(g<=LameInternalFlags.MAX_BITS_PER_CHANNEL),s.fill(f.l3_enc,0);do{r(v>=d),r(v<=c),r(d<=c),h.sfb21_extra=!(v>g-42)&&_,outer_loop(e,a,n,o,l,v)<=0?(y=1,b=a.part2_3_length,f.assign(a),t.arraycopy(o,0,p,0,576),m=(c=b-32)-d,v=(c+d)/2):(m=c-(d=v+32),v=(c+d)/2,0!=y&&(y=2,a.assign(f),t.arraycopy(p,0,o,0,576)))}while(m>12);h.sfb21_extra=_,2==y&&t.arraycopy(f.l3_enc,0,a.l3_enc,0,576),r(a.part2_3_length<=g)},this.get_framebits=function(t,a){var n=t.internal_flags;n.bitrate_index=n.VBR_min_bitrate;var s=e.getframebits(t);n.bitrate_index=1,s=e.getframebits(t);for(var i=1;i<=n.VBR_max_bitrate;i++){n.bitrate_index=i;var r=new MeanBits(s);a[i]=h.ResvFrameBegin(t,r),s=r.bits}},this.VBR_old_prepare=function(e,t,a,n,s,i,r,o,l){var d,u=e.internal_flags,m=0,p=1,g=0;u.bitrate_index=u.VBR_max_bitrate;var b=h.ResvFrameBegin(e,new MeanBits(0))/u.mode_gr;get_framebits(e,i);for(var v=0;v<u.mode_gr;v++){var y=f.on_pe(e,t,o[v],b,v,0);u.mode_ext==c.MPG_MD_MS_LR&&(ms_convert(u.l3_side,v),f.reduce_side(o[v],a[v],b,y));for(var _=0;_<u.channels_out;++_){var x=u.l3_side.tt[v][_];x.block_type!=c.SHORT_TYPE?(m=1.28/(1+Math.exp(3.5-t[v][_]/300))-.05,d=u.PSY.mask_adjust-m):(m=2.56/(1+Math.exp(3.5-t[v][_]/300))-.14,d=u.PSY.mask_adjust_short-m),u.masking_lower=Math.pow(10,.1*d),init_outer_loop(u,x),l[v][_]=f.calc_xmin(e,n[v][_],x,s[v][_]),0!=l[v][_]&&(p=0),r[v][_]=126,g+=o[v][_]}}for(v=0;v<u.mode_gr;v++)for(_=0;_<u.channels_out;_++)g>i[u.VBR_max_bitrate]&&(o[v][_]*=i[u.VBR_max_bitrate],o[v][_]/=g),r[v][_]>o[v][_]&&(r[v][_]=o[v][_]);return p},this.bitpressure_strategy=function(e,t,a,n){for(var s=0;s<e.mode_gr;s++)for(var i=0;i<e.channels_out;i++){for(var r=e.l3_side.tt[s][i],o=t[s][i],l=0,d=0;d<r.psy_lmax;d++)o[l++]*=1+.029*d*d/c.SBMAX_l/c.SBMAX_l;if(r.block_type==c.SHORT_TYPE)for(d=r.sfb_smin;d<c.SBMAX_s;d++)o[l++]*=1+.029*d*d/c.SBMAX_s/c.SBMAX_s,o[l++]*=1+.029*d*d/c.SBMAX_s/c.SBMAX_s,o[l++]*=1+.029*d*d/c.SBMAX_s/c.SBMAX_s;n[s][i]=0|Math.max(a[s][i],.9*n[s][i])}},this.VBR_new_prepare=function(e,t,a,n,s,i){var r,o=e.internal_flags,l=1,d=0,u=0;if(e.free_format){o.bitrate_index=0;m=new MeanBits(d);r=h.ResvFrameBegin(e,m),d=m.bits,s[0]=r}else{o.bitrate_index=o.VBR_max_bitrate;var m=new MeanBits(d);h.ResvFrameBegin(e,m),d=m.bits,get_framebits(e,s),r=s[o.VBR_max_bitrate]}for(var p=0;p<o.mode_gr;p++){f.on_pe(e,t,i[p],d,p,0),o.mode_ext==c.MPG_MD_MS_LR&&ms_convert(o.l3_side,p);for(var g=0;g<o.channels_out;++g){var b=o.l3_side.tt[p][g];o.masking_lower=Math.pow(10,.1*o.PSY.mask_adjust),init_outer_loop(o,b),0!=f.calc_xmin(e,a[p][g],b,n[p][g])&&(l=0),u+=i[p][g]}}for(p=0;p<o.mode_gr;p++)for(g=0;g<o.channels_out;g++)u>r&&(i[p][g]*=r,i[p][g]/=u);return l},this.calc_target_bits=function(t,a,n,s,i,r){var o,l,d,u,m=t.internal_flags,p=m.l3_side,g=0;m.bitrate_index=m.VBR_max_bitrate;var b=new MeanBits(g);for(r[0]=h.ResvFrameBegin(t,b),g=b.bits,m.bitrate_index=1,g=e.getframebits(t)-8*m.sideinfo_len,i[0]=g/(m.mode_gr*m.channels_out),g=t.VBR_mean_bitrate_kbps*t.framesize*1e3,1&m.substep_shaping&&(g*=1.09),g/=t.out_samplerate,g-=8*m.sideinfo_len,g/=m.mode_gr*m.channels_out,(o=.93+.07*(11-t.compression_ratio)/5.5)<.9&&(o=.9),o>1&&(o=1),l=0;l<m.mode_gr;l++){var v=0;for(d=0;d<m.channels_out;d++){if(s[l][d]=int(o*g),a[l][d]>700){var y=int((a[l][d]-700)/1.4),_=p.tt[l][d];s[l][d]=int(o*g),_.block_type==c.SHORT_TYPE&&y<g/2&&(y=g/2),y>3*g/2?y=3*g/2:y<0&&(y=0),s[l][d]+=y}s[l][d]>LameInternalFlags.MAX_BITS_PER_CHANNEL&&(s[l][d]=LameInternalFlags.MAX_BITS_PER_CHANNEL),v+=s[l][d]}if(v>LameInternalFlags.MAX_BITS_PER_GRANULE)for(d=0;d<m.channels_out;++d)s[l][d]*=LameInternalFlags.MAX_BITS_PER_GRANULE,s[l][d]/=v}if(m.mode_ext==c.MPG_MD_MS_LR)for(l=0;l<m.mode_gr;l++)f.reduce_side(s[l],n[l],g*m.channels_out,LameInternalFlags.MAX_BITS_PER_GRANULE);for(u=0,l=0;l<m.mode_gr;l++)for(d=0;d<m.channels_out;d++)s[l][d]>LameInternalFlags.MAX_BITS_PER_CHANNEL&&(s[l][d]=LameInternalFlags.MAX_BITS_PER_CHANNEL),u+=s[l][d];if(u>r[0])for(l=0;l<m.mode_gr;l++)for(d=0;d<m.channels_out;d++)s[l][d]*=r[0],s[l][d]/=u}}}function Ys(){if(Is)return Es;Is=1;var e=Bs(),t=e.System,a=e.VbrMode;e.Float;var n=e.ShortBlock;e.Util;var s=e.Arrays;e.new_array_n;var i=e.new_byte;e.new_double,e.new_float,e.new_float_n,e.new_int,e.new_int_n;var r=e.assert;function o(){var e,l,d;this.setModules=function(t,a,n){e=t,l=a,d=n};var c=o.NUMTOCENTRIES,u=o.MAXFRAMESIZE,m=c+4+4+4+4+4+9+1+1+8+1+1+3+1+1+2+4+2+2,h="Xing",f="Info",p=[0,49345,49537,320,49921,960,640,49729,50689,1728,1920,51009,1280,50625,50305,1088,52225,3264,3456,52545,3840,53185,52865,3648,2560,51905,52097,2880,51457,2496,2176,51265,55297,6336,6528,55617,6912,56257,55937,6720,7680,57025,57217,8e3,56577,7616,7296,56385,5120,54465,54657,5440,55041,6080,5760,54849,53761,4800,4992,54081,4352,53697,53377,4160,61441,12480,12672,61761,13056,62401,62081,12864,13824,63169,63361,14144,62721,13760,13440,62529,15360,64705,64897,15680,65281,16320,16e3,65089,64001,15040,15232,64321,14592,63937,63617,14400,10240,59585,59777,10560,60161,11200,10880,59969,60929,11968,12160,61249,11520,60865,60545,11328,58369,9408,9600,58689,9984,59329,59009,9792,8704,58049,58241,9024,57601,8640,8320,57409,40961,24768,24960,41281,25344,41921,41601,25152,26112,42689,42881,26432,42241,26048,25728,42049,27648,44225,44417,27968,44801,28608,28288,44609,43521,27328,27520,43841,26880,43457,43137,26688,30720,47297,47489,31040,47873,31680,31360,47681,48641,32448,32640,48961,32e3,48577,48257,31808,46081,29888,30080,46401,30464,47041,46721,30272,29184,45761,45953,29504,45313,29120,28800,45121,20480,37057,37249,20800,37633,21440,21120,37441,38401,22208,22400,38721,21760,38337,38017,21568,39937,23744,23936,40257,24320,40897,40577,24128,23040,39617,39809,23360,39169,22976,22656,38977,34817,18624,18816,35137,19200,35777,35457,19008,19968,36545,36737,20288,36097,19904,19584,35905,17408,33985,34177,17728,34561,18368,18048,34369,33281,17088,17280,33601,16640,33217,32897,16448];function g(e,t){var a=255&e[t+0];return a<<=8,a|=255&e[t+1],a<<=8,a|=255&e[t+2],a<<=8,a|=255&e[t+3]}function b(e,t,a){e[t+0]=255&a>>24,e[t+1]=255&a>>16,e[t+2]=255&a>>8,e[t+3]=255&a}function v(e,t,a){e[t+0]=255&a>>8,e[t+1]=255&a}function y(e,t,a){return 255&(e<<t|a&~(-1<<t))}function _(t,n){var s=t.internal_flags;n[0]=y(n[0],8,255),n[1]=y(n[1],3,7),n[1]=y(n[1],1,t.out_samplerate<16e3?0:1),n[1]=y(n[1],1,t.version),n[1]=y(n[1],2,1),n[1]=y(n[1],1,t.error_protection?0:1),n[2]=y(n[2],4,s.bitrate_index),n[2]=y(n[2],2,s.samplerate_index),n[2]=y(n[2],1,0),n[2]=y(n[2],1,t.extension),n[3]=y(n[3],2,t.mode.ordinal()),n[3]=y(n[3],2,s.mode_ext),n[3]=y(n[3],1,t.copyright),n[3]=y(n[3],1,t.original),n[3]=y(n[3],2,t.emphasis),n[0]=255;var i,r,o=241&n[1];i=1==t.version?128:t.out_samplerate<16e3?32:64,t.VBR==a.vbr_off&&(i=t.brate),r=t.free_format?0:255&16*e.BitrateIndex(i,t.version,t.out_samplerate),1==t.version?(n[1]=255&o|10,o=13&n[2],n[2]=255&(r|o)):(n[1]=255&o|2,o=13&n[2],n[2]=255&(r|o))}function x(e,t){return t=t>>8^p[255&(t^e)]}this.addVbrFrame=function(e){var t=e.internal_flags,a=Tables.bitrate_table[e.version][t.bitrate_index];r(null!=t.VBR_seek_table.bag),function(e,t){if(e.nVbrNumFrames++,e.sum+=t,e.seen++,!(e.seen<e.want)&&(e.pos<e.size&&(e.bag[e.pos]=e.sum,e.pos++,e.seen=0),e.pos==e.size)){for(var a=1;a<e.size;a+=2)e.bag[a/2]=e.bag[a];e.want*=2,e.pos/=2}}(t.VBR_seek_table,a)},this.getVbrTag=function(e){var t=new VBRTagData,a=0;t.flags=0;var n=e[a+1]>>3&1,s=e[a+2]>>2&3,i=e[a+3]>>6&3,r=e[a+2]>>4&15;if(r=Tables.bitrate_table[n][r],e[a+1]>>4==14?t.samprate=Tables.samplerate_table[2][s]:t.samprate=Tables.samplerate_table[n][s],!function(e,t){return new String(e,t,4(),null).equals(h)||new String(e,t,4(),null).equals(f)}(e,a+=0!=n?3!=i?36:21:3!=i?21:13))return null;a+=4,t.hId=n;var o=t.flags=g(e,a);if(a+=4,1&o&&(t.frames=g(e,a),a+=4),2&o&&(t.bytes=g(e,a),a+=4),4&o){if(null!=t.toc)for(var l=0;l<c;l++)t.toc[l]=e[a+l];a+=c}t.vbrScale=-1,8&o&&(t.vbrScale=g(e,a),a+=4),t.headersize=72e3*(n+1)*r/t.samprate;var d=e[(a+=21)+0]<<4;d+=e[a+1]>>4;var u=(15&e[a+1])<<8;return(d<0||d>3e3)&&(d=-1),((u+=255&e[a+2])<0||u>3e3)&&(u=-1),t.encDelay=d,t.encPadding=u,t},this.InitVbrTag=function(e){var t,n=e.internal_flags;t=1==e.version?128:e.out_samplerate<16e3?32:64,e.VBR==a.vbr_off&&(t=e.brate);var s=72e3*(e.version+1)*t/e.out_samplerate,r=n.sideinfo_len+m;if(n.VBR_seek_table.TotalFrameSize=s,s<r||s>u)e.bWriteVbrTag=!1;else{n.VBR_seek_table.nVbrNumFrames=0,n.VBR_seek_table.nBytesWritten=0,n.VBR_seek_table.sum=0,n.VBR_seek_table.seen=0,n.VBR_seek_table.want=1,n.VBR_seek_table.pos=0,null==n.VBR_seek_table.bag&&(n.VBR_seek_table.bag=new int[400],n.VBR_seek_table.size=400);var o=i(u);_(e,o);for(var d=n.VBR_seek_table.TotalFrameSize,c=0;c<d;++c)l.add_dummy_byte(e,255&o[c],1)}},this.updateMusicCRC=function(e,t,a,n){for(var s=0;s<n;++s)e[0]=x(t[a+s],e[0])},this.getLameTagFrame=function(e,r){var o=e.internal_flags;if(!e.bWriteVbrTag)return 0;if(o.Class_ID!=Lame.LAME_ID)return 0;if(o.VBR_seek_table.pos<=0)return 0;if(r.length<o.VBR_seek_table.TotalFrameSize)return o.VBR_seek_table.TotalFrameSize;s.fill(r,0,o.VBR_seek_table.TotalFrameSize,0),_(e,r);var u=i(c);if(e.free_format)for(var m=1;m<c;++m)u[m]=255&255*m/100;else!function(e,t){if(!(e.pos<=0))for(var a=1;a<c;++a){var n=a/c,s=0|Math.floor(n*e.pos);s>e.pos-1&&(s=e.pos-1);var i=0|256*e.bag[s]/e.sum;i>255&&(i=255),t[a]=255&i}}(o.VBR_seek_table,u);var p=o.sideinfo_len;e.error_protection&&(p-=2),e.VBR==a.vbr_off?(r[p++]=255&f.charAt(0),r[p++]=255&f.charAt(1),r[p++]=255&f.charAt(2),r[p++]=255&f.charAt(3)):(r[p++]=255&h.charAt(0),r[p++]=255&h.charAt(1),r[p++]=255&h.charAt(2),r[p++]=255&h.charAt(3)),b(r,p,15),b(r,p+=4,o.VBR_seek_table.nVbrNumFrames),p+=4;var g=o.VBR_seek_table.nBytesWritten+o.VBR_seek_table.TotalFrameSize;b(r,p,0|g),p+=4,t.arraycopy(u,0,r,p,u.length),p+=u.length,e.error_protection&&l.CRC_writeheader(o,r);var y=0;for(m=0;m<p;m++)y=x(r[m],y);return p+=function(e,t,a,s,i){var r,o,l,c,u,m=e.internal_flags,h=0,f=e.encoder_delay,p=e.encoder_padding,g=100-10*e.VBR_q-e.quality,y=d.getLameVeryShortVersion(),_=[1,5,3,2,4,0,3],w=0|(e.lowpassfreq/100+.5>255?255:e.lowpassfreq/100+.5),k=0,M=0,S=e.internal_flags.noise_shaping,C=0,N=0,A=0,E=!!(1&e.exp_nspsytune),I=!!(2&e.exp_nspsytune),j=!1,T=!1,B=e.internal_flags.nogap_total,P=e.internal_flags.nogap_current,R=e.ATHtype;switch(e.VBR){case vbr_abr:u=e.VBR_mean_bitrate_kbps;break;case vbr_off:u=e.brate;break;default:u=e.VBR_min_bitrate_kbps}switch(r=0+(e.VBR.ordinal()<_.length?_[e.VBR.ordinal()]:0),m.findReplayGain&&(m.RadioGain>510&&(m.RadioGain=510),m.RadioGain<-510&&(m.RadioGain=-510),M=8192,M|=3072,m.RadioGain>=0?M|=m.RadioGain:(M|=512,M|=-m.RadioGain)),m.findPeakSample&&(k=Math.abs(0|m.PeakSample/32767*Math.pow(2,23)+.5)),-1!=B&&(P>0&&(T=!0),P<B-1&&(j=!0)),c=R+((E?1:0)<<4)+((I?1:0)<<5)+((j?1:0)<<6)+((T?1:0)<<7),g<0&&(g=0),e.mode){case MONO:C=0;break;case STEREO:C=1;break;case DUAL_CHANNEL:C=2;break;case JOINT_STEREO:C=e.force_ms?4:3;break;case NOT_SET:default:C=7}A=e.in_samplerate<=32e3?0:48e3==e.in_samplerate?2:e.in_samplerate>48e3?3:1,(e.short_blocks==n.short_block_forced||e.short_blocks==n.short_block_dispensed||-1==e.lowpassfreq&&-1==e.highpassfreq||e.scale_left<e.scale_right||e.scale_left>e.scale_right||e.disable_reservoir&&e.brate<320||e.noATH||e.ATHonly||0==R||e.in_samplerate<=32e3)&&(N=1),o=S+(C<<2)+(N<<5)+(A<<6),l=m.nMusicCRC,b(a,s+h,g),h+=4;for(var D=0;D<9;D++)a[s+h+D]=255&y.charAt(D);a[s+(h+=9)]=255&r,a[s+ ++h]=255&w,b(a,s+ ++h,k),v(a,s+(h+=4),M),v(a,s+(h+=2),0),a[s+(h+=2)]=255&c,a[s+ ++h]=u>=255?255:255&u,a[s+ ++h]=255&f>>4,a[s+h+1]=255&(f<<4)+(p>>8),a[s+h+2]=255&p,a[s+(h+=3)]=255&o,h++,a[s+h++]=0,v(a,s+h,e.preset),b(a,s+(h+=2),t),v(a,s+(h+=4),l),h+=2;for(var O=0;O<h;O++)i=x(a[s+O],i);return v(a,s+h,i),h+2}(e,g,r,p,y),o.VBR_seek_table.TotalFrameSize},this.putVbrTag=function(e,t){if(e.internal_flags.VBR_seek_table.pos<=0)return-1;if(t.seek(t.length()),0==t.length())return-1;var a=function(e){e.seek(0);var t=i(10);return e.readFully(t),new String(t,"ISO-8859-1").startsWith("ID3")?0:((127&t[6])<<21|(127&t[7])<<14|(127&t[8])<<7|127&t[9])+t.length}(t);t.seek(a);var n=i(u),s=getLameTagFrame(e,n);return s>n.length?-1:(s<1||t.write(n,0,s),0)}}return o.NUMTOCENTRIES=100,o.MAXFRAMESIZE=2880,Es=o}const Zs=L(function(){if(js)return Ts;js=1;var e=Bs();e.System,e.VbrMode,e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n;var t=e.new_byte;e.new_double,e.new_float,e.new_float_n,e.new_int,e.new_int_n;var a=e.assert,n=Xs(),s=function(){if(gs)return ps;gs=1;var e=Bs();e.System;var t=e.VbrMode;return e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n,e.new_byte,e.new_double,e.new_float,e.new_float_n,e.new_int,e.new_int_n,e.assert,ps=function(){function e(e,t,a,n,s,i,r,o,l,d,c,u,m,h,f){this.vbr_q=e,this.quant_comp=t,this.quant_comp_s=a,this.expY=n,this.st_lrm=s,this.st_s=i,this.masking_adj=r,this.masking_adj_short=o,this.ath_lower=l,this.ath_curve=d,this.ath_sensitivity=c,this.interch=u,this.safejoint=m,this.sfb21mod=h,this.msfix=f}function a(e,t,a,n,s,i,r,o,l,d,c,u,m,h){this.quant_comp=t,this.quant_comp_s=a,this.safejoint=n,this.nsmsfix=s,this.st_lrm=i,this.st_s=r,this.nsbass=o,this.scale=l,this.masking_adj=d,this.ath_lower=c,this.ath_curve=u,this.interch=m,this.sfscale=h}var n;this.setModules=function(e){n=e};var s=[new e(0,9,9,0,5.2,125,-4.2,-6.3,4.8,1,0,0,2,21,.97),new e(1,9,9,0,5.3,125,-3.6,-5.6,4.5,1.5,0,0,2,21,1.35),new e(2,9,9,0,5.6,125,-2.2,-3.5,2.8,2,0,0,2,21,1.49),new e(3,9,9,1,5.8,130,-1.8,-2.8,2.6,3,-4,0,2,20,1.64),new e(4,9,9,1,6,135,-.7,-1.1,1.1,3.5,-8,0,2,0,1.79),new e(5,9,9,1,6.4,140,.5,.4,-7.5,4,-12,2e-4,0,0,1.95),new e(6,9,9,1,6.6,145,.67,.65,-14.7,6.5,-19,4e-4,0,0,2.3),new e(7,9,9,1,6.6,145,.8,.75,-19.7,8,-22,6e-4,0,0,2.7),new e(8,9,9,1,6.6,145,1.2,1.15,-27.5,10,-23,7e-4,0,0,0),new e(9,9,9,1,6.6,145,1.6,1.6,-36,11,-25,8e-4,0,0,0),new e(10,9,9,1,6.6,145,2,2,-36,12,-25,8e-4,0,0,0)],i=[new e(0,9,9,0,4.2,25,-7,-4,7.5,1,0,0,2,26,.97),new e(1,9,9,0,4.2,25,-5.6,-3.6,4.5,1.5,0,0,2,21,1.35),new e(2,9,9,0,4.2,25,-4.4,-1.8,2,2,0,0,2,18,1.49),new e(3,9,9,1,4.2,25,-3.4,-1.25,1.1,3,-4,0,2,15,1.64),new e(4,9,9,1,4.2,25,-2.2,.1,0,3.5,-8,0,2,0,1.79),new e(5,9,9,1,4.2,25,-1,1.65,-7.7,4,-12,2e-4,0,0,1.95),new e(6,9,9,1,4.2,25,-0,2.47,-7.7,6.5,-19,4e-4,0,0,2),new e(7,9,9,1,4.2,25,.5,2,-14.5,8,-22,6e-4,0,0,2),new e(8,9,9,1,4.2,25,1,2.4,-22,10,-23,7e-4,0,0,2),new e(9,9,9,1,4.2,25,1.5,2.95,-30,11,-25,8e-4,0,0,2),new e(10,9,9,1,4.2,25,2,2.95,-36,12,-30,8e-4,0,0,2)];function r(e,a,n){var r=e.VBR==t.vbr_rh?s:i,o=e.VBR_q_frac,l=r[a],d=r[a+1],c=l;l.st_lrm=l.st_lrm+o*(d.st_lrm-l.st_lrm),l.st_s=l.st_s+o*(d.st_s-l.st_s),l.masking_adj=l.masking_adj+o*(d.masking_adj-l.masking_adj),l.masking_adj_short=l.masking_adj_short+o*(d.masking_adj_short-l.masking_adj_short),l.ath_lower=l.ath_lower+o*(d.ath_lower-l.ath_lower),l.ath_curve=l.ath_curve+o*(d.ath_curve-l.ath_curve),l.ath_sensitivity=l.ath_sensitivity+o*(d.ath_sensitivity-l.ath_sensitivity),l.interch=l.interch+o*(d.interch-l.interch),l.msfix=l.msfix+o*(d.msfix-l.msfix),function(e,t){0>t&&(t=0),9<t&&(t=9),e.VBR_q=t,e.VBR_q_frac=0}(e,c.vbr_q),0!=n?e.quant_comp=c.quant_comp:Math.abs(e.quant_comp- -1)>0||(e.quant_comp=c.quant_comp),0!=n?e.quant_comp_short=c.quant_comp_s:Math.abs(e.quant_comp_short- -1)>0||(e.quant_comp_short=c.quant_comp_s),0!=c.expY&&(e.experimentalY=0!=c.expY),0!=n?e.internal_flags.nsPsy.attackthre=c.st_lrm:Math.abs(e.internal_flags.nsPsy.attackthre- -1)>0||(e.internal_flags.nsPsy.attackthre=c.st_lrm),0!=n?e.internal_flags.nsPsy.attackthre_s=c.st_s:Math.abs(e.internal_flags.nsPsy.attackthre_s- -1)>0||(e.internal_flags.nsPsy.attackthre_s=c.st_s),0!=n?e.maskingadjust=c.masking_adj:Math.abs(e.maskingadjust-0)>0||(e.maskingadjust=c.masking_adj),0!=n?e.maskingadjust_short=c.masking_adj_short:Math.abs(e.maskingadjust_short-0)>0||(e.maskingadjust_short=c.masking_adj_short),0!=n?e.ATHlower=-c.ath_lower/10:Math.abs(10*-e.ATHlower-0)>0||(e.ATHlower=-c.ath_lower/10),0!=n?e.ATHcurve=c.ath_curve:Math.abs(e.ATHcurve- -1)>0||(e.ATHcurve=c.ath_curve),0!=n?e.athaa_sensitivity=c.ath_sensitivity:Math.abs(e.athaa_sensitivity- -1)>0||(e.athaa_sensitivity=c.ath_sensitivity),c.interch>0&&(0!=n?e.interChRatio=c.interch:Math.abs(e.interChRatio- -1)>0||(e.interChRatio=c.interch)),c.safejoint>0&&(e.exp_nspsytune=e.exp_nspsytune|c.safejoint),c.sfb21mod>0&&(e.exp_nspsytune=e.exp_nspsytune|c.sfb21mod<<20),0!=n?e.msfix=c.msfix:Math.abs(e.msfix- -1)>0||(e.msfix=c.msfix),0==n&&(e.VBR_q=a,e.VBR_q_frac=o)}var o=[new a(8,9,9,0,0,6.6,145,0,.95,0,-30,11,.0012,1),new a(16,9,9,0,0,6.6,145,0,.95,0,-25,11,.001,1),new a(24,9,9,0,0,6.6,145,0,.95,0,-20,11,.001,1),new a(32,9,9,0,0,6.6,145,0,.95,0,-15,11,.001,1),new a(40,9,9,0,0,6.6,145,0,.95,0,-10,11,9e-4,1),new a(48,9,9,0,0,6.6,145,0,.95,0,-10,11,9e-4,1),new a(56,9,9,0,0,6.6,145,0,.95,0,-6,11,8e-4,1),new a(64,9,9,0,0,6.6,145,0,.95,0,-2,11,8e-4,1),new a(80,9,9,0,0,6.6,145,0,.95,0,0,8,7e-4,1),new a(96,9,9,0,2.5,6.6,145,0,.95,0,1,5.5,6e-4,1),new a(112,9,9,0,2.25,6.6,145,0,.95,0,2,4.5,5e-4,1),new a(128,9,9,0,1.95,6.4,140,0,.95,0,3,4,2e-4,1),new a(160,9,9,1,1.79,6,135,0,.95,-2,5,3.5,0,1),new a(192,9,9,1,1.49,5.6,125,0,.97,-4,7,3,0,0),new a(224,9,9,1,1.25,5.2,125,0,.98,-6,9,2,0,0),new a(256,9,9,1,.97,5.2,125,0,1,-8,10,1,0,0),new a(320,9,9,1,.9,5.2,125,0,1,-10,12,0,0,0)];function l(e,a,s){var i=a,r=n.nearestBitrateFullIndex(a);if(e.VBR=t.vbr_abr,e.VBR_mean_bitrate_kbps=i,e.VBR_mean_bitrate_kbps=Math.min(e.VBR_mean_bitrate_kbps,320),e.VBR_mean_bitrate_kbps=Math.max(e.VBR_mean_bitrate_kbps,8),e.brate=e.VBR_mean_bitrate_kbps,e.VBR_mean_bitrate_kbps>320&&(e.disable_reservoir=!0),o[r].safejoint>0&&(e.exp_nspsytune=2|e.exp_nspsytune),o[r].sfscale>0&&(e.internal_flags.noise_shaping=2),Math.abs(o[r].nsbass)>0){var l=int(4*o[r].nsbass);l<0&&(l+=64),e.exp_nspsytune=e.exp_nspsytune|l<<2}return 0!=s?e.quant_comp=o[r].quant_comp:Math.abs(e.quant_comp- -1)>0||(e.quant_comp=o[r].quant_comp),0!=s?e.quant_comp_short=o[r].quant_comp_s:Math.abs(e.quant_comp_short- -1)>0||(e.quant_comp_short=o[r].quant_comp_s),0!=s?e.msfix=o[r].nsmsfix:Math.abs(e.msfix- -1)>0||(e.msfix=o[r].nsmsfix),0!=s?e.internal_flags.nsPsy.attackthre=o[r].st_lrm:Math.abs(e.internal_flags.nsPsy.attackthre- -1)>0||(e.internal_flags.nsPsy.attackthre=o[r].st_lrm),0!=s?e.internal_flags.nsPsy.attackthre_s=o[r].st_s:Math.abs(e.internal_flags.nsPsy.attackthre_s- -1)>0||(e.internal_flags.nsPsy.attackthre_s=o[r].st_s),0!=s?e.scale=o[r].scale:Math.abs(e.scale- -1)>0||(e.scale=o[r].scale),0!=s?e.maskingadjust=o[r].masking_adj:Math.abs(e.maskingadjust-0)>0||(e.maskingadjust=o[r].masking_adj),o[r].masking_adj>0?0!=s?e.maskingadjust_short=.9*o[r].masking_adj:Math.abs(e.maskingadjust_short-0)>0||(e.maskingadjust_short=.9*o[r].masking_adj):0!=s?e.maskingadjust_short=1.1*o[r].masking_adj:Math.abs(e.maskingadjust_short-0)>0||(e.maskingadjust_short=1.1*o[r].masking_adj),0!=s?e.ATHlower=-o[r].ath_lower/10:Math.abs(10*-e.ATHlower-0)>0||(e.ATHlower=-o[r].ath_lower/10),0!=s?e.ATHcurve=o[r].ath_curve:Math.abs(e.ATHcurve- -1)>0||(e.ATHcurve=o[r].ath_curve),0!=s?e.interChRatio=o[r].interch:Math.abs(e.interChRatio- -1)>0||(e.interChRatio=o[r].interch),a}this.apply_preset=function(e,a,n){switch(a){case Lame.R3MIX:a=Lame.V3,e.VBR=t.vbr_mtrh;break;case Lame.MEDIUM:a=Lame.V4,e.VBR=t.vbr_rh;break;case Lame.MEDIUM_FAST:a=Lame.V4,e.VBR=t.vbr_mtrh;break;case Lame.STANDARD:a=Lame.V2,e.VBR=t.vbr_rh;break;case Lame.STANDARD_FAST:a=Lame.V2,e.VBR=t.vbr_mtrh;break;case Lame.EXTREME:a=Lame.V0,e.VBR=t.vbr_rh;break;case Lame.EXTREME_FAST:a=Lame.V0,e.VBR=t.vbr_mtrh;break;case Lame.INSANE:return a=320,e.preset=a,l(e,a,n),e.VBR=t.vbr_off,a}switch(e.preset=a,a){case Lame.V9:return r(e,9,n),a;case Lame.V8:return r(e,8,n),a;case Lame.V7:return r(e,7,n),a;case Lame.V6:return r(e,6,n),a;case Lame.V5:return r(e,5,n),a;case Lame.V4:return r(e,4,n),a;case Lame.V3:return r(e,3,n),a;case Lame.V2:return r(e,2,n),a;case Lame.V1:return r(e,1,n),a;case Lame.V0:return r(e,0,n),a}return 8<=a&&a<=320?l(e,a,n):(e.preset=0,a)}}}(),i=$s(),r=qs(),o=Ws(),l=zs(),d=function(){if(Cs)return Ss;Cs=1;var e=Bs().assert;return Ss=function(){var t;this.setModules=function(e){t=e},this.ResvFrameBegin=function(a,n){var s,i=a.internal_flags,r=i.l3_side,o=t.getframebits(a);n.bits=(o-8*i.sideinfo_len)/i.mode_gr;var l=2048*i.mode_gr-8;a.brate>320?s=8*int(1e3*a.brate/(a.out_samplerate/1152)/8+.5):(s=11520,a.strict_ISO&&(s=8*int(32e4/(a.out_samplerate/1152)/8+.5))),i.ResvMax=s-o,i.ResvMax>l&&(i.ResvMax=l),(i.ResvMax<0||a.disable_reservoir)&&(i.ResvMax=0);var d=n.bits*i.mode_gr+Math.min(i.ResvSize,i.ResvMax);return d>s&&(d=s),e(0==i.ResvMax%8),e(i.ResvMax>=0),r.resvDrain_pre=0,null!=i.pinfo&&(i.pinfo.mean_bits=n.bits/2,i.pinfo.resvsize=i.ResvSize),d},this.ResvMaxBits=function(e,t,a,n){var s,i=e.internal_flags,r=i.ResvSize,o=i.ResvMax;0!=n&&(r+=t),1&i.substep_shaping&&(o*=.9),a.bits=t,10*r>9*o?(s=r-9*o/10,a.bits+=s,i.substep_shaping|=128):(s=0,i.substep_shaping&=127,e.disable_reservoir||1&i.substep_shaping||(a.bits-=.1*t));var l=r<6*i.ResvMax/10?r:6*i.ResvMax/10;return(l-=s)<0&&(l=0),l},this.ResvAdjust=function(e,t){e.ResvSize-=t.part2_3_length+t.part2_length},this.ResvFrameEnd=function(t,a){var n,s=t.l3_side;t.ResvSize+=a*t.mode_gr;var i=0;s.resvDrain_post=0,s.resvDrain_pre=0,0!=(n=t.ResvSize%8)&&(i+=n),(n=t.ResvSize-i-t.ResvMax)>0&&(e(0==n%8),e(n>=0),i+=n);var r=Math.min(8*s.main_data_begin,i)/8;s.resvDrain_pre+=8*r,i-=8*r,t.ResvSize-=8*r,s.main_data_begin-=r,s.resvDrain_post+=i,t.ResvSize-=i}}}(),c=Os(),u=Gs();Rs();var m=As?Ns:(As=1,Ns=function(){this.getLameVersion=function(){return"3.98.4"},this.getLameShortVersion=function(){return"3.98.4"},this.getLameVeryShortVersion=function(){return"LAME3.98r"},this.getPsyVersion=function(){return"0.93"},this.getLameUrl=function(){return"http://www.mp3dev.org/"},this.getLameOsBitness=function(){return"32bits"}}),h=Ys();function f(){this.setModules=function(e,t){}}function p(){this.setModules=function(e,t,a){}}function g(){}function b(){this.setModules=function(e,t){}}function v(){this.dataOffset=0,this.dataLen=0,this.channels=0,this.sampleRate=0}function y(e){return e.charCodeAt(0)<<24|e.charCodeAt(1)<<16|e.charCodeAt(2)<<8|e.charCodeAt(3)}return v.RIFF=y("RIFF"),v.WAVE=y("WAVE"),v.fmt_=y("fmt "),v.data=y("data"),v.readHeader=function(e){var t=new v,a=e.getUint32(0,!1);if(v.RIFF==a&&(e.getUint32(4,!0),v.WAVE==e.getUint32(8,!1)&&v.fmt_==e.getUint32(12,!1))){var n=e.getUint32(16,!0),s=20;switch(n){case 16:case 18:t.channels=e.getUint16(s+2,!0),t.sampleRate=e.getUint32(s+4,!0);break;default:throw"extended fmt chunk not implemented"}s+=n;for(var i=v.data,r=0;i!=a&&(a=e.getUint32(s,!1),r=e.getUint32(s+4,!0),i!=a);)s+=r+8;return t.dataLen=r,t.dataOffset=s+8,t}},Ts.Mp3Encoder=function(e,v,y){3!=arguments.length&&(console.error("WARN: Mp3Encoder(channels, samplerate, kbps) not specified"),e=1,v=44100,y=128);var _=new n,x=new f,w=new i,k=new u,M=new s,S=new r,C=new o,N=new h,A=new m,E=new b,I=new d,j=new l,T=new p,B=new g;_.setModules(w,k,M,S,C,N,A,E,B),k.setModules(w,B,A,N),E.setModules(k,A),M.setModules(_),C.setModules(k,I,S,j),S.setModules(j,I,_.enc.psy),I.setModules(k),j.setModules(S),N.setModules(_,k,A),x.setModules(T,B),T.setModules(A,E,M);var P=_.lame_init();P.num_channels=e,P.in_samplerate=v,P.brate=y,P.mode=c.STEREO,P.quality=3,P.bWriteVbrTag=!1,P.disable_reservoir=!0,P.write_id3tag_automatic=!1;var R=_.lame_init_params(P);a(0==R);var D=1152,O=0|1.25*D+7200,L=t(O);this.encodeBuffer=function(n,s){1==e&&(s=n),a(n.length==s.length),n.length>D&&(D=n.length,L=t(O=0|1.25*D+7200));var i=_.lame_encode_buffer(P,n,s,n.length,L,0,O);return new Int8Array(L.subarray(0,i))},this.flush=function(){var e=_.lame_encode_flush(P,L,0,O);return new Int8Array(L.subarray(0,e))}},Ts.WavHeader=v,Ts}()),Js=()=>{var e;if("undefined"==typeof window)return!1;const t=navigator.userAgent,a=/Android/.test(t),n=window.Capacitor;return a&&!0===(null==(e=null==n?void 0:n.isNativePlatform)?void 0:e.call(n))},Qs=()=>{var e;if("undefined"==typeof window)return!1;const t=window.Capacitor;return!0===(null==(e=null==t?void 0:t.isNativePlatform)?void 0:e.call(t))},ei="VDJV-Export",ti="/storage/emulated/0/Download",ai=`${ei}/_media`,ni=`${ei}/logs`,si=".vdjvpart",ii="vdjv-backup-manifest-v1",ri=209715200,oi=734003200,li=1782579200,di="Cannot read the selected file. Android denied storage access. Please import via the in-app picker and allow file access when prompted.",ci="Cannot read the selected backup file. Please pick it again from the in-app file picker and allow file access.",ui=new Set,mi=(e,t)=>{const a=e.trim().toLowerCase(),n=t.map(e=>e.trim().toLowerCase()).join("|");return`sig:${(e=>{let t=2166136261;for(let a=0;a<e.length;a++)t^=e.charCodeAt(a),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,"0")})(`${a}::${t.length}::${n}`)}:${t.length}`},hi=e=>{const t="string"==typeof(null==e?void 0:e.name)?e.name:"",a=Array.isArray(null==e?void 0:e.pads)?e.pads:[];if(!t||!a.length)return null;const n=a.map(e=>"string"==typeof(null==e?void 0:e.name)?e.name:"");return mi(t,n)},fi=()=>"undefined"!=typeof navigator&&/Android|iPhone|iPad|iPod/i.test(navigator.userAgent),pi=()=>Qs()?67108864:fi()?1073741824:268435456,gi=e=>`vdjv-full-backup-${e}`,bi=e=>`${gi(e)}.vdjvbackup`,vi=async e=>{if(e.size>8388608)return null;try{if(!(await e.slice(0,128).text()).trimStart().startsWith("{"))return null}catch{return null}try{const t=JSON.parse(await e.text());return(e=>{if(!e||"object"!=typeof e)return!1;const t=e;return t.schema===ii&&!!Array.isArray(t.parts)&&!("string"!=typeof t.userId||!t.userId.trim())&&t.parts.every(e=>e&&"number"==typeof e.index&&Number.isFinite(e.index)&&"string"==typeof e.fileName&&e.fileName.trim().length>0&&"number"==typeof e.size&&e.size>=0)})(t)?t:null}catch{return null}},yi=async e=>{if(!Qs())return null;try{const{Filesystem:t,Directory:a}=await U(async()=>{const{Filesystem:e,Directory:t}=await import("./index-DcmRPkj8.js");return{Filesystem:e,Directory:t}},__vite__mapDeps([5,4,2,1,3])),n=async(t,a)=>{try{const a=await t();if(a.data instanceof Blob)return new File([a.data],e,{type:"application/octet-stream"});const n=Ui(String(a.data||""));if(!n)return null;const s=atob(n),i=new Uint8Array(s.length);for(let e=0;e<s.length;e+=1)i[e]=s.charCodeAt(e);return new File([i],e,{type:"application/octet-stream"})}catch(n){return null}};if(Js()){const a=`${ti}/${ei}/${e}`,s=await n(()=>t.readFile({path:a}),"android-download");if(s)return s}const s=await n(()=>t.readFile({path:`${ei}/${e}`,directory:a.Documents}),"documents");if(s)return s}catch{return null}return null},_i=(e,t)=>({operationId:`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,operation:e,startedAt:(new Date).toISOString(),platform:"undefined"==typeof window?"unknown":Qs()?Js()?"capacitor-android":"capacitor-ios":window.navigator.userAgent.includes("Electron")?"electron":"web",isCapacitorNative:Qs(),isElectron:"undefined"!=typeof window&&window.navigator.userAgent.includes("Electron"),userId:t||null,stages:[],metrics:{}}),xi=(e,t,a)=>{e.stages.push({stage:t,at:(new Date).toISOString(),details:a})},wi=e=>{const t=(e=>e instanceof Error?`${e.name} ${e.message}`.toLowerCase():String(e||"").toLowerCase())(e);return t.includes("permission to access file")||t.includes("notreadableerror")||t.includes("requested file could not be read")||t.includes("securityerror")||t.includes("permission denied")||t.includes("not allowed to read local resource")||t.includes("operation not permitted")},ki=async()=>{if(!Js())return;const{Filesystem:e}=await U(async()=>{const{Filesystem:e}=await import("./index-DcmRPkj8.js");return{Filesystem:e}},__vite__mapDeps([5,4,2,1,3]));if("granted"===(await e.checkPermissions()).publicStorage)return;if("granted"!==(await e.requestPermissions()).publicStorage)throw new Error("Storage permission was denied. Please allow storage access and try again.")},Mi=async(e,t,a=ei)=>{const n=a.replace(/\\/g,"/").replace(/^\/+|\/+$/g,"");if(Qs()){try{await ki()}catch(s){return{success:!1,message:s instanceof Error?s.message:"Storage permission denied."}}try{const{Filesystem:a,Directory:s}=await U(async()=>{const{Filesystem:e,Directory:t}=await import("./index-DcmRPkj8.js");return{Filesystem:e,Directory:t}},__vite__mapDeps([5,4,2,1,3])),r=async(t,n)=>{const s=n?{path:t,directory:n,recursive:!0}:{path:t,recursive:!0};if(e.size<=524288){const t=await Vi(e);return void(await a.writeFile({...s,data:t}))}let i=0,r=!0;for(;i<e.size;){const o=Math.min(e.size,i+262144),l=e.slice(i,o),d=await Vi(l);r?(await a.writeFile({...s,data:d}),r=!1):n?await a.appendFile({path:t,directory:n,data:d}):await a.appendFile({path:t,data:d}),i=o,i<e.size&&await new Promise(e=>setTimeout(e,0))}};if(Js()){const e=`Download/${n}/${t}`,a=`${ti}/${n}/${t}`;try{return await r(a),{success:!0,message:`Successfully saved to ${e}`,savedPath:e}}catch(i){console.warn("Download folder write failed, falling back to Documents:",i)}}return await r(`${n}/${t}`,s.Documents),{success:!0,message:`Successfully saved to Documents/${n}/${t}`,savedPath:`Documents/${n}/${t}`}}catch(s){return{success:!1,message:s instanceof Error?s.message:"Failed to save file."}}}try{const a=URL.createObjectURL(e),n=document.createElement("a");n.href=a,n.download=t,n.rel="noopener",n.style.display="none",fi()&&(n.target="_blank"),document.body.appendChild(n);try{n.click()}catch(r){window.open(a,"_blank","noopener,noreferrer")}const s=fi()?12e4:15e3;return window.setTimeout(()=>{try{URL.revokeObjectURL(a),n.parentNode&&n.parentNode.removeChild(n)}catch{}},s),{success:!0,message:`Successfully downloaded ${t}`,savedPath:t}}catch(s){return{success:!1,message:s instanceof Error?s.message:"Failed to trigger download."}}},Si=async(e,t)=>{try{e.endedAt=(new Date).toISOString(),e.error=(e=>e instanceof Error?{message:e.message,stack:e.stack?e.stack.slice(0,4e3):void 0}:{message:String(e)})(t);const a=JSON.stringify(e,null,2),n=`vdjv-${e.operation}-${e.operationId}.json`,s=await Mi(new Blob([a],{type:"application/json"}),n,ni);return s.success?s.savedPath||n:null}catch{return null}},Ci="vdjv-sampler-banks",Ni="vdjv-sampler-state",Ai="vdjv-default-bank-source",Ei="vdjv-hide-protected-banks",Ii="vdjv-hidden-protected-banks-by-user",ji="vdjv-export-disabled-2024-secure",Ti=e=>{if("string"!=typeof e)return null;const t=e.trim().toLowerCase();return t.length>0?t:null},Bi=e=>{var t;if((e=>"Default Bank"===e.name||e.sourceBankId===Ai)(e))return`default:${Ai}`;const a=Ti(e.sourceBankId);if(a)return`source:${a}`;const n=Ti(null==(t=e.bankMetadata)?void 0:t.bankId);return n?`meta:${n}`:null},Pi=e=>{const t=new Map;e.forEach(e=>{const a=Bi(e);if(!a)return;const n=t.get(a)||[];n.push(e),t.set(a,n)});const a=new Map;return t.forEach(e=>{if(e.length<=1)return;const t=(e=>[...e].sort((e,t)=>{var a,n;const s=((null==(a=t.pads)?void 0:a.length)||0)-((null==(n=e.pads)?void 0:n.length)||0);return 0!==s?s:(e.sortOrder||0)-(t.sortOrder||0)})[0])(e);e.forEach(e=>{e.id!==t.id&&a.set(e.id,t.id)})}),0===a.size?{banks:e,removedIdToKeptId:a}:{banks:e.filter(e=>!a.has(e.id)),removedIdToKeptId:a}},Ri=e=>{if("undefined"==typeof window)return null;try{return localStorage.getItem(e)}catch(t){return console.warn(`localStorage.getItem failed for key "${e}"`,t),null}},Di=(e,t)=>{if("undefined"==typeof window)return!1;try{return localStorage.setItem(e,t),!0}catch(a){return console.warn(`localStorage.setItem failed for key "${e}"`,a),!1}},Oi=e=>({...e,pads:(e.pads||[]).map((e,t)=>((e,t)=>({...e,audioUrl:null,imageUrl:null,imageData:void 0,fadeInMs:e.fadeInMs||0,fadeOutMs:e.fadeOutMs||0,startTimeMs:e.startTimeMs||0,endTimeMs:e.endTimeMs||0,pitch:e.pitch||0,savedHotcuesMs:Array.isArray(e.savedHotcuesMs)?e.savedHotcuesMs.slice(0,4):[null,null,null,null],position:e.position??t}))(e,t))}),Li=(e,t)=>({...e,createdAt:(null==e?void 0:e.createdAt)?new Date(e.createdAt):new Date,sortOrder:(null==e?void 0:e.sortOrder)??t,pads:Array.isArray(null==e?void 0:e.pads)?e.pads.map((e,t)=>((e,t)=>({...e,fadeInMs:e.fadeInMs||0,fadeOutMs:e.fadeOutMs||0,startTimeMs:e.startTimeMs||0,endTimeMs:e.endTimeMs||0,pitch:e.pitch||0,savedHotcuesMs:Array.isArray(e.savedHotcuesMs)?e.savedHotcuesMs.slice(0,4):[null,null,null,null],position:e.position??t}))(e,t)):[]}),Fi=()=>{if("undefined"==typeof window)return{};try{const e=localStorage.getItem(Ii);if(!e)return{};const t=JSON.parse(e),a={};return Object.entries(t||{}).forEach(([e,t])=>{Array.isArray(t)&&e&&(a[e]=t.map((e,t)=>Li(e,t)))}),a}catch{return{}}},Ui=e=>{const t=e.indexOf(",");return t>=0?e.slice(t+1):e},Vi=e=>new Promise((t,a)=>{const n=new FileReader;n.onloadend=()=>{try{t(Ui(String(n.result||"")))}catch(e){a(e)}},n.onerror=a,n.readAsDataURL(e)}),$i=(e,t)=>{const a=e.toLowerCase();return"audio"===t?"mp3"===a?"audio/mpeg":"wav"===a?"audio/wav":"ogg"===a?"audio/ogg":"aac"===a?"audio/aac":"m4a"===a?"audio/mp4":"application/octet-stream":"png"===a?"image/png":"jpg"===a||"jpeg"===a?"image/jpeg":"webp"===a?"image/webp":"gif"===a?"image/gif":"application/octet-stream"},Hi=e=>{const t=e.lastIndexOf(".");return t<0?"bin":e.slice(t+1)},Ki=e=>"string"!=typeof e?"":e.trim().toLowerCase(),qi=(e,t)=>"number"==typeof e.position&&Number.isFinite(e.position)&&e.position>=0?Math.floor(e.position):t,zi=e=>Boolean(!0===e.hasImageAsset||e.imageStorageKey||e.imageData||"string"==typeof e.imageUrl&&e.imageUrl.trim().length>0||"native"===e.imageBackend),Gi=async(e,t)=>{var a;const n="bank import"===t||"backup restore"===t?3221225472:471859200;if("undefined"!=typeof navigator&&"function"==typeof(null==(a=navigator.storage)?void 0:a.estimate))try{const a=await navigator.storage.estimate();if(!a.quota||!a.usage)return;const n=a.quota-a.usage;if(n<e+ri){const a=Math.floor(n/1048576),s=Math.ceil((e+ri)/1048576);throw new Error(`Not enough free storage for ${t}. Free: ${a}MB, required: at least ${s}MB.`)}}catch(s){if(s instanceof Error&&s.message.includes("Not enough free storage"))throw s}else if(e>n){const a=Math.ceil(e/1048576);throw new Error(`Unable to verify free storage for ${t}. Operation is too large (${a}MB) without quota support.`)}},Xi=()=>new Promise(e=>setTimeout(e,0)),Wi=async(e,t)=>{if(!Qs())return null;try{const a=await Yi(e);if(a)try{const n=await fetch(a,{cache:"no-store"});if(n.ok){const a=await n.blob();if(a.size>0)return a.type?a:new Blob([a],{type:$i(Hi(e),t)})}}catch{}if(await Zi(e)>6291456)return null;const{Filesystem:n,Directory:s}=await U(async()=>{const{Filesystem:e,Directory:t}=await import("./index-DcmRPkj8.js");return{Filesystem:e,Directory:t}},__vite__mapDeps([5,4,2,1,3])),i=await n.readFile({path:`${ai}/${e}`,directory:s.Data}),r=Ui(String(i.data||"")),o=atob(r),l=new Uint8Array(o.length);for(let e=0;e<o.length;e+=1)l[e]=o.charCodeAt(e);return new Blob([l],{type:$i(Hi(e),t)})}catch{return null}},Yi=async e=>{if(!Qs())return null;try{const{Filesystem:t,Directory:a}=await U(async()=>{const{Filesystem:e,Directory:t}=await import("./index-DcmRPkj8.js");return{Filesystem:e,Directory:t}},__vite__mapDeps([5,4,2,1,3])),n=await t.getUri({path:`${ai}/${e}`,directory:a.Data}),s=window.Capacitor,i=null==s?void 0:s.convertFileSrc;return i?i(n.uri):n.uri}catch{return null}},Zi=async e=>{if(!Qs()||!e)return 0;try{const{Filesystem:t,Directory:a}=await U(async()=>{const{Filesystem:e,Directory:t}=await import("./index-DcmRPkj8.js");return{Filesystem:e,Directory:t}},__vite__mapDeps([5,4,2,1,3])),n=await t.stat({path:`${ai}/${e}`,directory:a.Data});return Number(n.size||0)}catch{return 0}},Ji=async e=>{if(Qs()&&e)try{const{Filesystem:t,Directory:a}=await U(async()=>{const{Filesystem:e,Directory:t}=await import("./index-DcmRPkj8.js");return{Filesystem:e,Directory:t}},__vite__mapDeps([5,4,2,1,3]));await t.deleteFile({path:`${ai}/${e}`,directory:a.Data})}catch{}},Qi=()=>"undefined"!=typeof window&&"showOpenFilePicker"in window&&"FileSystemFileHandle"in window,er=async()=>new Promise((e,t)=>{if("undefined"==typeof window||!("indexedDB"in window))return void t(new Error("IndexedDB is unavailable in this browser context"));let a;try{a=window.indexedDB.open("vdjv-file-storage",4)}catch(n){return void t(n)}a.onupgradeneeded=e=>{const t=a.result;t.objectStoreNames.contains("file-handles")||t.createObjectStore("file-handles",{keyPath:"id"}),t.objectStoreNames.contains("blobs")||t.createObjectStore("blobs",{keyPath:"id"}),t.objectStoreNames.contains("image-handles")||t.createObjectStore("image-handles",{keyPath:"id"}),t.objectStoreNames.contains("quota-info")||t.createObjectStore("quota-info",{keyPath:"type"})},a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)}),tr=52428800,ar=async e=>{if(0!==e.length)try{const t=await er();let a=0;if(e.forEach(e=>{"image"===e.type&&(a+=e.blob.size)}),a>0){if(await nr()+a>tr)throw new Error("Pad image storage is full. Delete some pad images before adding another.")}return new Promise((n,s)=>{const i=t.transaction(["blobs","quota-info"],"readwrite"),r=i.objectStore("blobs"),o=i.objectStore("quota-info");if(e.forEach(e=>{const t=`${e.type}_${e.id}`;r.put({id:t,blob:e.blob,timestamp:Date.now()})}),a>0){const e=o.get("images");e.onsuccess=()=>{var t;const n=(null==(t=e.result)?void 0:t.usage)||0;o.put({type:"images",usage:n+a})}}i.oncomplete=()=>n(),i.onerror=()=>s(i.error)})}catch(t){throw console.error("Failed to save batch blobs:",t),t}},nr=async()=>{try{const e=await er();return new Promise(t=>{const a=e.transaction("quota-info","readonly").objectStore("quota-info").get("images");a.onsuccess=()=>{var e;return t((null==(e=a.result)?void 0:e.usage)||0)},a.onerror=()=>t(0)})}catch(e){return 0}},sr=async(e,t="audio")=>{try{const a=await er(),n="image"===t?"image-handles":"file-handles";return new Promise(t=>{const s=a.transaction(n,"readonly").objectStore(n).get(e);s.onsuccess=()=>t(s.result?s.result.handle:null),s.onerror=()=>t(null)})}catch(a){return null}},ir=async(e,t="audio")=>{try{const a=await er(),n="image"===t?"image-handles":"file-handles";a.transaction(n,"readwrite").objectStore(n).delete(e)}catch(a){}},rr=async e=>{try{const t=await er();return new Promise(a=>{const n=t.transaction("blobs","readonly").objectStore("blobs").get(e);n.onsuccess=()=>a(n.result?n.result.blob:null),n.onerror=()=>a(null)})}catch(t){return null}},or=async(e,t=!1)=>{try{const a=(await er()).transaction(["blobs","quota-info"],"readwrite"),n=a.objectStore("blobs");if(t){const t=n.get(e);t.onsuccess=()=>{var s,i;const r=(null==(i=null==(s=t.result)?void 0:s.blob)?void 0:i.size)||0;if(n.delete(e),r>0){const e=a.objectStore("quota-info"),t=e.get("images");t.onsuccess=()=>{var a;return e.put({type:"images",usage:Math.max(0,((null==(a=t.result)?void 0:a.usage)||0)-r)})}}}}else n.delete(e)}catch(a){}},lr=e=>{var t;const a=e.split(","),n=(null==(t=a[0].match(/:(.*?);/))?void 0:t[1])||"image/png",s=atob(a[1]);let i=s.length;const r=new Uint8Array(i);for(;i--;)r[i]=s.charCodeAt(i);return new Blob([r],{type:n})},dr=()=>Date.now().toString(36)+Math.random().toString(36).substr(2),cr=e=>{const t=e.type.toLowerCase();return t.includes("mp3")||t.includes("mpeg")?"mp3":t.includes("wav")||t.includes("wave")?"wav":t.includes("ogg")?"ogg":"unknown"},ur=e=>{const t=e.numberOfChannels,a=e.sampleRate,n=2*t,s=a*n,i=e.length*n,r=44+i,o=new ArrayBuffer(r),l=new DataView(o),d=(e,t)=>{for(let a=0;a<t.length;a++)l.setUint8(e+a,t.charCodeAt(a))};d(0,"RIFF"),l.setUint32(4,r-8,!0),d(8,"WAVE"),d(12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,t,!0),l.setUint32(24,a,!0),l.setUint32(28,s,!0),l.setUint16(32,n,!0),l.setUint16(34,16,!0),d(36,"data"),l.setUint32(40,i,!0);const c=[];for(let m=0;m<t;m++)c.push(e.getChannelData(m));let u=44;for(let m=0;m<e.length;m++)for(let e=0;e<t;e++){const t=Math.max(-1,Math.min(1,c[e][m])),a=t<0?32768*t:32767*t;l.setInt16(u,a,!0),u+=2}return new Blob([o],{type:"audio/wav"})},mr=async(e,t,a,n)=>{console.log(`[audio] trimAudio startMs=${t} endMs=${a} format=${n}`);const s=(await e.arrayBuffer()).slice(0),i=new(window.AudioContext||window.webkitAudioContext);try{const e=await i.decodeAudioData(s),r=(e.duration,e.sampleRate),o=Math.floor(t/1e3*r),l=Math.min(Math.floor(a/1e3*r),e.length)-o;if(l<=0)throw new Error(`Invalid trim range: trimmedLength=${l}`);const d=i.createBuffer(e.numberOfChannels,l,r);for(let t=0;t<e.numberOfChannels;t++){const a=e.getChannelData(t),n=d.getChannelData(t);for(let e=0;e<l;e++)n[e]=a[o+e]}const c=l/r*1e3;let u;if("mp3"===n){const e=((e,t=128)=>{const a=e.numberOfChannels,n=e.sampleRate;try{const s=e.getChannelData(0),i=a>1?e.getChannelData(1):s,r=e=>{const t=new Int16Array(e.length);for(let a=0;a<e.length;a++){const n=Math.max(-1,Math.min(1,e[a]));t[a]=n<0?32768*n:32767*n}return t},o=r(s),l=r(i),d=new Zs.Mp3Encoder(a,n,t),c=[],u=1152;for(let e=0;e<o.length;e+=u){const t=o.subarray(e,e+u),n=l.subarray(e,e+u);let s;s=1===a?d.encodeBuffer(t):d.encodeBuffer(t,n),s.length>0&&c.push(s)}const m=d.flush();m.length>0&&c.push(m);const h=c.reduce((e,t)=>e+t.length,0),f=new Uint8Array(h);let p=0;for(const e of c)f.set(e,p),p+=e.length;return console.log("[audio] MP3 encoding successful"),{blob:new Blob([f],{type:"audio/mp3"}),format:"mp3"}}catch(s){return console.warn("[audio] MP3 encoding failed, falling back to WAV:",s),{blob:ur(e),format:"wav"}}})(d);u=e.blob}else u=ur(d);return{blob:u,newDurationMs:c}}finally{await i.close()}},hr=async(e,t,a,n)=>{var s;const i=`${"image"===t?"image":"audio"}_${e}`;if(Qs()&&a){const e=await Wi(a,t);if(e)return{url:URL.createObjectURL(e),storageKey:a,backend:"native"}}if(Qi())try{const e=await sr(i,t);if(e){if("granted"===await(null==(s=e.queryPermission)?void 0:s.call(e))){const t=await e.getFile();return{url:URL.createObjectURL(t),storageKey:a,backend:"idb"}}}}catch{}try{const e=await rr(i);if(e)return{url:URL.createObjectURL(e),storageKey:a,backend:"idb"}}catch{}if(Qs()&&(!a||"native"===n)){const n=[];a&&n.push(a);("audio"===t?["mp3","wav","ogg","aac","m4a","bin"]:["png","jpg","jpeg","webp","gif","bin"]).forEach(a=>n.push(`${t}/${e}.${a}`));for(const e of n){const a=await Wi(e,t);if(a)return{url:URL.createObjectURL(a),storageKey:e,backend:"native"}}}return{url:null,storageKey:a,backend:n||(a?"native":"idb")}},fr=async(e,t,a)=>{if(Qs()){const n=await(async(e,t,a)=>{if(!Qs())return null;const n="audio"===a?8388608:4194304;if(t.size>n)return ui.has(a)||(ui.add(a),console.warn(`[storage] Native ${a} write fallback enabled for large blobs (> ${Math.round(n/1048576)}MB). Using IndexedDB for stability.`)),null;try{const{Filesystem:n,Directory:s}=await U(async()=>{const{Filesystem:e,Directory:t}=await import("./index-DcmRPkj8.js");return{Filesystem:e,Directory:t}},__vite__mapDeps([5,4,2,1,3])),i=((e,t)=>{const a=(e||"").toLowerCase();return"audio"===t?a.includes("mpeg")||a.includes("mp3")?"mp3":a.includes("wav")?"wav":a.includes("ogg")?"ogg":a.includes("aac")?"aac":a.includes("mp4")||a.includes("m4a")?"m4a":"bin":a.includes("png")?"png":a.includes("jpeg")||a.includes("jpg")?"jpg":a.includes("webp")?"webp":a.includes("gif")?"gif":"bin"})(t.type,a),r=`${a}/${e}.${i}`,o=await Vi(t);return await n.writeFile({path:`${ai}/${r}`,data:o,directory:s.Data,recursive:!0}),r}catch(s){return console.warn(`Failed writing native ${a} media for pad ${e}:`,s),null}})(e,t,a);if(n)return{storageKey:n,backend:"native"}}const n=`${"image"===a?"image":"audio"}_${e}`;return await(async(e,t,a=!1)=>{try{const n=await er();if(a&&await nr()+t.size>tr)throw new Error("Storage full");return new Promise((s,i)=>{const r=n.transaction(["blobs","quota-info"],"readwrite");if(r.objectStore("blobs").put({id:e,blob:t,timestamp:Date.now()}),a){const e=r.objectStore("quota-info"),a=e.get("images");a.onsuccess=()=>{var n;return e.put({type:"images",usage:((null==(n=a.result)?void 0:n.usage)||0)+t.size})}}r.oncomplete=()=>s(),r.onerror=()=>i(r.error)})}catch(n){throw n}})(n,t,"image"===a),{backend:"idb"}},pr=async(e,t)=>{var a;const n=`${t}_${e.id}`,s="audio"===t?e.audioStorageKey:e.imageStorageKey;if(s){const e=await Wi(s,t);if(e)return e}if(Qi())try{const e=await sr(n,t);if(e&&"granted"===await(null==(a=e.queryPermission)?void 0:a.call(e))){return await e.getFile()}}catch{}try{const e=await rr(n);if(e)return e}catch{}const i="audio"===t?e.audioUrl:e.imageUrl;if(i)try{return await(await fetch(i)).blob()}catch{}return null},gr=async(e,t)=>{const a=await pr(e,t);if(a)return a;const n="audio"===t?e.audioUrl:e.imageUrl;if(!n)return null;try{const e=await fetch(n);return e.ok?await e.blob():null}catch{return null}},br=async(e,t)=>{var a;const n=`${t}_${e.id}`,s="audio"===t?e.audioStorageKey:e.imageStorageKey;if(s){const e=await Zi(s);if(e>0)return e}if(Qi())try{const e=await sr(n,t);if(e&&"granted"===await(null==(a=e.queryPermission)?void 0:a.call(e))){const t=await e.getFile();if(null==t?void 0:t.size)return t.size}}catch{}try{const e=await rr(n);if(e)return e.size}catch{}const i="audio"===t?e.audioUrl:e.imageUrl;if(i)try{return(await(await fetch(i)).blob()).size}catch{}return 0},vr=async e=>{let t=0;for(const a of e.pads)t+=await br(a,"audio"),t+=await br(a,"image");return t},yr=e=>e.startTimeMs>50&&e.endTimeMs>e.startTimeMs;function _r(){const{user:e,profile:t,loading:n,sessionConflictReason:s}=Qa(),[i,r]=a.useState([]),o=a.useRef([]),[l,d]=a.useState(!1),[c,u]=a.useState(null),[m,h]=a.useState(null),[f,p]=a.useState(null),g=a.useMemo(()=>i.find(e=>e.id===c)||null,[i,c]),b=a.useMemo(()=>i.find(e=>e.id===m)||null,[i,m]),v=a.useMemo(()=>i.find(e=>e.id===f)||null,[i,f]),y=a.useMemo(()=>null!==c,[c]),_=a.useRef({}),x=a.useRef([]),w=a.useRef(null),k=a.useRef(null),M=a.useRef(null),S=a.useCallback((e,t)=>{if(e){const a=t.map(e=>Oi(e));t.length?_.current[e]=a:delete _.current[e];const n=Fi();return a.length?n[e]=a:delete n[e],void(e=>{if("undefined"!=typeof window)try{localStorage.setItem(Ii,JSON.stringify(e))}catch(t){console.warn("Failed to persist hidden protected banks cache:",t)}})(n)}x.current=t},[]),C=a.useCallback(e=>{if(e){const t=_.current[e];if(null==t?void 0:t.length)return t;const a=Fi()[e]||[];return a.length&&(_.current[e]=a),a}return x.current},[]),N=a.useCallback(()=>{if("undefined"==typeof window)return!1;try{return"1"===localStorage.getItem(Ei)}catch{return!1}},[]);a.useEffect(()=>{"undefined"!=typeof window&&Di(Ni,JSON.stringify({primaryBankId:c,secondaryBankId:m,currentBankId:f}))},[c,m,f]),a.useEffect(()=>{Aa()},[]),a.useEffect(()=>{(null==e?void 0:e.id)&&(w.current=e.id)},[null==e?void 0:e.id]),a.useEffect(()=>{o.current=i},[i]);const A=a.useCallback(t=>{const a=e||Fa();Ia({eventType:"bank.export",status:t.status,userId:(null==a?void 0:a.id)||null,email:(null==a?void 0:a.email)||"unknown",bankId:t.bankId||null,bankName:t.bankName,padCount:t.padNames.length,padNames:t.padNames,errorMessage:t.errorMessage||null,meta:{source:"useSamplerStore.exportBank",includePadList:!0}}).catch(e=>{console.warn("Failed to log export activity:",e)})},[e]),E=a.useCallback(t=>{const a=e||Fa();Ia({eventType:"bank.import",status:t.status,userId:(null==a?void 0:a.id)||null,email:(null==a?void 0:a.email)||"unknown",bankId:t.bankId||null,bankName:t.bankName,padCount:t.padNames.length,padNames:t.includePadList?t.padNames:[],errorMessage:t.errorMessage||null,meta:{source:"useSamplerStore.importBank",includePadList:t.includePadList}}).catch(e=>{console.warn("Failed to log import activity:",e)})},[e]),I=a.useCallback(()=>{r(t=>{var a;const n=ea(t);if(n.length===t.length)return t;const s=(null==e?void 0:e.id)||(null==(a=Fa())?void 0:a.id)||w.current||null,i=new Set(n.map(e=>e.id));S(s,t.filter(e=>!i.has(e.id)));const r=new Set(n.map(e=>e.id));return u(e=>e&&r.has(e)?e:null),h(e=>e&&r.has(e)?e:null),p(e=>{var t;return e&&r.has(e)?e:(null==(t=n[0])?void 0:t.id)||null}),n})},[null==e?void 0:e.id,S]),j=a.useCallback(e=>{const t=C(e);t.length&&r(a=>{const n=new Set(a.map(e=>e.id)),s=new Set(a.map(e=>e.sourceBankId).filter(e=>Boolean(e))),i=new Set(a.map(e=>{var t;return null==(t=e.bankMetadata)?void 0:t.bankId}).filter(e=>Boolean(e))),r=a.some(e=>e.sourceBankId===Ai||"Default Bank"===e.name),o=t.filter(e=>{var t;return!n.has(e.id)&&((!e.sourceBankId||!s.has(e.sourceBankId))&&((!(null==(t=e.bankMetadata)?void 0:t.bankId)||!i.has(e.bankMetadata.bankId))&&(!r||e.sourceBankId!==Ai&&"Default Bank"!==e.name)))});return o.length?(S(e,[]),[...a,...o].sort((e,t)=>(e.sortOrder||0)-(t.sortOrder||0))):(S(e,[]),a)})},[C,S]),T=a.useCallback(async()=>{var e;if(d(!1),"undefined"==typeof window)return;const t=Ri(Ci),a=Ri(Ni);if(!t){const e={id:dr(),name:"Default Bank",defaultColor:"#3b82f6",pads:[],createdAt:new Date,sortOrder:0};return r([e]),p(e.id),void d(!0)}try{const{banks:n}=JSON.parse(t);let s={primaryBankId:null,secondaryBankId:null,currentBankId:null};if(a)try{s=JSON.parse(a)}catch{}const i=e=>{r(e),u(s.primaryBankId),h(s.secondaryBankId),s.currentBankId&&e.find(e=>e.id===s.currentBankId)?p(s.currentBankId):e.length>0&&p(e[0].id),d(!0)},o=e=>{let t=0,a=0;const n=new Set;e.forEach(e=>{e.pads.forEach(s=>{s.audioUrl||(t+=1,n.add(e.name));zi(s)&&!s.imageUrl&&(a+=1,n.add(e.name))})}),(t>0||a>0)&&window.dispatchEvent(new CustomEvent("vdjv-missing-media-detected",{detail:{missingAudio:t,missingImages:a,affectedBanks:Array.from(n).slice(0,20)}}))};let l=n.map((e,t)=>({...e,createdAt:new Date(e.createdAt),sortOrder:e.sortOrder??t,pads:(e.pads||[]).map((e,t)=>({...e,audioUrl:null,imageUrl:null,audioBackend:e.audioBackend||(e.audioStorageKey?"native":"idb"),imageBackend:e.imageBackend||(e.imageStorageKey?"native":void 0),hasImageAsset:"boolean"==typeof e.hasImageAsset?e.hasImageAsset:Boolean(e.imageStorageKey||e.imageData||"string"==typeof e.imageUrl&&e.imageUrl.length>0),fadeInMs:e.fadeInMs||0,fadeOutMs:e.fadeOutMs||0,startTimeMs:e.startTimeMs||0,endTimeMs:e.endTimeMs||0,pitch:e.pitch||0,savedHotcuesMs:Array.isArray(e.savedHotcuesMs)?e.savedHotcuesMs.slice(0,4):[null,null,null,null],position:e.position??t}))}));l=Pi(l).banks;if("undefined"!=typeof window&&"1"===localStorage.getItem(Ei)){const t=(null==(e=Fa())?void 0:e.id)||w.current||null,a=ea(l);S(t,l.filter(e=>!a.some(t=>t.id===e.id))),l=a}l.sort((e,t)=>(e.sortOrder||0)-(t.sortOrder||0));const c=l.reduce((e,t)=>e+t.pads.length,0);if(c>(Qs()?320:1200))return o(l),void i(l);l=await Promise.all(l.map(async e=>{const t=await Promise.all(e.pads.map(async e=>{const t={...e,savedHotcuesMs:Array.isArray(e.savedHotcuesMs)?e.savedHotcuesMs.slice(0,4):[null,null,null,null]};try{const a=await hr(e.id,"audio",e.audioStorageKey,e.audioBackend);a.url&&(t.audioUrl=a.url),a.storageKey&&(t.audioStorageKey=a.storageKey),t.audioBackend=a.backend}catch{}try{const a=await hr(e.id,"image",e.imageStorageKey,e.imageBackend);if(a.url&&(t.imageUrl=a.url),a.storageKey&&(t.imageStorageKey=a.storageKey),t.imageBackend=a.backend,a.url&&(t.hasImageAsset=!0),!t.imageUrl&&e.imageData)try{t.imageUrl=URL.createObjectURL(lr(e.imageData)),t.imageBackend="idb",t.hasImageAsset=!0}catch{}}catch{}return t}));return{...e,pads:t}})),o(l),i(l)}catch(n){const e={id:dr(),name:"Default Bank",defaultColor:"#3b82f6",pads:[],createdAt:new Date,sortOrder:0};r([e]),p(e.id),d(!0)}},[S]);a.useEffect(()=>{T()},[T]),a.useEffect(()=>{n||e||I()},[null==e?void 0:e.id,n,I]),a.useEffect(()=>{n||e&&(N()||j(e.id))},[null==e?void 0:e.id,n,N,j]),a.useEffect(()=>{s&&I()},[s,I]),a.useEffect(()=>{if("undefined"==typeof window)return;const e=e=>{"vdjv-session-enforcement-event"===e.key&&e.newValue&&I()};return window.addEventListener("storage",e),()=>window.removeEventListener("storage",e)},[I]),a.useEffect(()=>{if("undefined"!=typeof window&&i.length>0){if(N())return;try{const e={banks:i.map(e=>({...e,pads:e.pads.map(e=>({...e,audioUrl:void 0,imageUrl:void 0,imageData:void 0}))}))},t=JSON.stringify(e);if(t.length>4194304){const e={banks:i.map(e=>({...e,pads:e.pads.map(e=>({id:e.id,name:e.name,audioStorageKey:e.audioStorageKey,audioBackend:e.audioBackend,imageStorageKey:e.imageStorageKey,imageBackend:e.imageBackend,hasImageAsset:e.hasImageAsset,color:e.color,shortcutKey:e.shortcutKey,midiNote:e.midiNote,midiCC:e.midiCC,triggerMode:e.triggerMode,playbackMode:e.playbackMode,volume:e.volume,fadeInMs:e.fadeInMs,fadeOutMs:e.fadeOutMs,startTimeMs:e.startTimeMs,endTimeMs:e.endTimeMs,pitch:e.pitch,position:e.position,ignoreChannel:e.ignoreChannel,savedHotcuesMs:Array.isArray(e.savedHotcuesMs)?e.savedHotcuesMs.slice(0,4):[null,null,null,null]}))}))};localStorage.setItem(Ci,JSON.stringify(e))}else localStorage.setItem(Ci,t)}catch(e){}}},[i]);const B=a.useCallback(e=>e||(y&&m?m:y&&c?c:f),[y,c,m,f]),P=a.useCallback(e=>e.slice(0,32),[]),R=a.useCallback(async(e,t)=>{const a=B(t);if(!a)return;const n=i.find(e=>e.id===a);if(n)try{await Gi(e.size,"audio upload");const t=dr(),s=URL.createObjectURL(e),i=await fr(t,e,"audio"),o=n.pads.length>0?Math.max(...n.pads.map(e=>e.position||0)):-1,l={id:t,name:P(e.name.replace(/\.[^/.]+$/,"")),audioUrl:s,audioStorageKey:i.storageKey,audioBackend:i.backend,hasImageAsset:!1,color:n.defaultColor,triggerMode:"toggle",playbackMode:"once",volume:1,fadeInMs:0,fadeOutMs:0,startTimeMs:0,endTimeMs:0,pitch:0,position:o+1,ignoreChannel:!1,savedHotcuesMs:[null,null,null,null]},d=new Audio(s);d.addEventListener("loadedmetadata",()=>{l.endTimeMs=1e3*d.duration,r(e=>e.map(e=>e.id===a?{...e,pads:[...e.pads,l]}:e))}),setTimeout(()=>{0===l.endTimeMs&&(l.endTimeMs=3e4,r(e=>e.map(e=>e.id===a?{...e,pads:[...e.pads,l]}:e)))},1e3)}catch(s){throw s}},[i,B,P]),D=a.useCallback(async(e,t)=>{const a=B(t);if(!a)return;const n=i.find(e=>e.id===a);if(n)try{const t=e.filter(e=>e.type.startsWith("audio/"));if(0===t.length)return;const s=[],i=[];let o=n.pads.length>0?Math.max(...n.pads.map(e=>e.position||0)):-1;for(const e of t){if(e.size>52428800)continue;await Gi(e.size,"batch audio upload");const t=dr(),a=URL.createObjectURL(e);let l,d="idb";if(Qs()){const a=await fr(t,e,"audio");l=a.storageKey,d=a.backend}else s.push({id:t,blob:e,type:"audio"});o++;const c={id:t,name:P(e.name.replace(/\.[^/.]+$/,"")),audioUrl:a,audioStorageKey:l,audioBackend:d,hasImageAsset:!1,color:n.defaultColor,triggerMode:"toggle",playbackMode:"once",volume:1,fadeInMs:0,fadeOutMs:0,startTimeMs:0,endTimeMs:0,pitch:0,position:o,ignoreChannel:!1,savedHotcuesMs:[null,null,null,null]};i.push(c);const u=new Audio(a);u.addEventListener("loadedmetadata",()=>{c.endTimeMs=1e3*u.duration,r(e=>[...e])})}!Qs()&&s.length>0&&await ar(s),r(e=>e.map(e=>e.id===a?{...e,pads:[...e.pads,...i]}:e))}catch(s){throw s}},[i,B,P]),O=a.useCallback(async(e,t,a)=>{const n=i.find(t=>t.id===e),s=null==n?void 0:n.pads.find(e=>e.id===t),o=Boolean((null==s?void 0:s.imageUrl)||(null==s?void 0:s.imageData));if(a.imageData&&a.imageData.startsWith("data:"))try{const e=lr(a.imageData);await Gi(e.size,"pad image save"),a.imageUrl&&a.imageUrl.startsWith("blob:")&&URL.revokeObjectURL(a.imageUrl),a.imageUrl=URL.createObjectURL(e);const n=await fr(t,new File([e],"image",{type:e.type}),"image");n.storageKey&&(a.imageStorageKey=n.storageKey),a.imageBackend=n.backend,a.imageData=void 0,a.hasImageAsset=!0}catch(l){}if(o&&(!a.imageUrl||0===a.imageUrl.trim().length)&&(!a.imageData||0===a.imageData.trim().length)){try{await Promise.all([or(`image_${t}`,!0),ir(`image_${t}`,"image"),Ji(null==s?void 0:s.imageStorageKey)])}catch{}a.imageStorageKey=void 0,a.imageBackend=void 0,a.hasImageAsset=!1}else a.hasImageAsset=zi(a)||Boolean(null==s?void 0:s.hasImageAsset);r(n=>n.map(n=>{if(n.id!==e)return n;const s=n.pads.find(e=>e.id===t),i=Boolean(null==s?void 0:s.shortcutKey)&&!a.shortcutKey;return{...n,disableDefaultPadShortcutLayout:!!i||n.disableDefaultPadShortcutLayout,pads:n.pads.map(e=>e.id===t?a:e)}}))},[i]),L=a.useCallback(async(e,t)=>{const a=i.find(t=>t.id===e),n=null==a?void 0:a.pads.find(e=>e.id===t);try{await Promise.all([or(`audio_${t}`,!1),or(`image_${t}`,!0),ir(`audio_${t}`,"audio"),ir(`image_${t}`,"image"),Ji(null==n?void 0:n.audioStorageKey),Ji(null==n?void 0:n.imageStorageKey)])}catch(s){}r(a=>a.map(a=>a.id===e?{...a,pads:a.pads.filter(e=>{var a,n;return e.id===t&&((null==(a=e.audioUrl)?void 0:a.startsWith("blob:"))&&URL.revokeObjectURL(e.audioUrl),(null==(n=e.imageUrl)?void 0:n.startsWith("blob:"))&&URL.revokeObjectURL(e.imageUrl)),e.id!==t})}:a))},[i]),F=a.useCallback((e,t,a)=>{r(n=>n.map(n=>{if(n.id!==e)return n;const s=[...n.pads].sort((e,t)=>(e.position||0)-(t.position||0)),[i]=s.splice(t,1);return s.splice(a,0,i),{...n,pads:s.map((e,t)=>({...e,position:t}))}}))},[]),V=a.useCallback((e,t)=>{const a=i.length>0?Math.max(...i.map(e=>e.sortOrder||0)):-1,n={id:dr(),name:e,defaultColor:t,pads:[],createdAt:new Date,sortOrder:a+1};r(e=>[...e,n]),f||y||p(n.id)},[i,f,y]),$=a.useCallback(e=>{r(t=>{const a=[...t].sort((e,t)=>(e.sortOrder||0)-(t.sortOrder||0)).map((e,t)=>({...e,sortOrder:t})),n=a.findIndex(t=>t.id===e);return n<=0?t:([a[n-1],a[n]]=[a[n],a[n-1]],a.map((e,t)=>({...e,sortOrder:t})))})},[]),H=a.useCallback(e=>{r(t=>{const a=[...t].sort((e,t)=>(e.sortOrder||0)-(t.sortOrder||0)).map((e,t)=>({...e,sortOrder:t})),n=a.findIndex(t=>t.id===e);return-1===n||n>=a.length-1?t:([a[n],a[n+1]]=[a[n+1],a[n]],a.map((e,t)=>({...e,sortOrder:t})))})},[]),K=a.useCallback((e,t,a)=>{r(n=>{const s=n.find(e=>e.id===t),i=n.find(e=>e.id===a);if(!s||!i)return n;const r=s.pads.find(t=>t.id===e);if(!r)return n;const o=i.pads.length>0?Math.max(...i.pads.map(e=>e.position||0)):-1,l={...r,position:o+1,color:i.defaultColor};return n.map(n=>n.id===t?{...n,pads:n.pads.filter(t=>t.id!==e)}:n.id===a?{...n,pads:[...n.pads,l]}:n)})},[]),q=a.useCallback(e=>{null===e?(c&&p(c),u(null),h(null)):e===c?(p(c),u(null),h(null)):(u(e),e===m&&h(null),f&&f!==e&&h(f),p(null))},[c,m,f]),z=a.useCallback(e=>{c&&e!==c&&h(e)},[c]),G=a.useCallback(e=>{y||p(e)},[y]),X=a.useCallback((e,t)=>{r(a=>a.map(a=>{if(a.id!==e)return a;const n={...a,...t};return a.shortcutKey&&void 0===t.shortcutKey?n.disableDefaultBankShortcutLayout=!0:"string"==typeof t.shortcutKey&&t.shortcutKey.trim().length>0&&(n.disableDefaultBankShortcutLayout=!1),n}))},[]),W=a.useCallback(async e=>{r(t=>{const a=t.find(t=>t.id===e);a&&a.pads.forEach(async e=>{var t,a;try{await Promise.all([or(`audio_${e.id}`,!1),or(`image_${e.id}`,!0),Ji(e.audioStorageKey),Ji(e.imageStorageKey)]),(null==(t=e.audioUrl)?void 0:t.startsWith("blob:"))&&URL.revokeObjectURL(e.audioUrl),(null==(a=e.imageUrl)?void 0:a.startsWith("blob:"))&&URL.revokeObjectURL(e.imageUrl)}catch(n){}});const n=t.filter(t=>t.id!==e);if(e===c?(u(null),h(null),n.length>0&&p(n[0].id)):e===m?h(null):e===f&&p(n.length>0?n[0].id:null),0===n.length){const e={id:dr(),name:"Default Bank",defaultColor:"#3b82f6",pads:[],createdAt:new Date,sortOrder:0};return p(e.id),[e]}return n})},[c,m,f]),Y=a.useCallback(async(t,a)=>{const n=i.find(e=>e.id===t);if(!n)throw new Error("Bank not found");if(!1===n.exportable)throw new Error("Export is disabled for this bank");const s=e||Fa(),r=_i("bank_export",(null==s?void 0:s.id)||null);xi(r,"start",{bankId:n.id,bankName:n.name,padCount:n.pads.length});try{null==a||a(5),await ki();const e=await vr(n);if(r.metrics.estimatedBytes=e,xi(r,"preflight",{estimatedBytes:e}),Qs()&&e>oi)throw new Error(`Bank export is too large for mobile export (${Math.ceil(e/1048576)}MB). Reduce bank size and try again.`);await Gi(Math.ceil(.35*e),"bank export");const t=new gn,i=t.folder("audio"),l=t.folder("images");if(!i||!l)throw new Error("Unable to create bank archive folders.");const d=Math.max(1,n.pads.reduce((e,t)=>e+(t.audioUrl?1:0)+(zi(t)?1:0),0));let c=0,u=0,m=0,h=0;const f=n.pads.map(e=>({...e,audioUrl:void 0,imageUrl:void 0})),p=new Map(f.map(e=>[e.id,e]));for(const s of n.pads){if(s.audioUrl){const e=p.get(s.id),t=await pr(s,"audio");if(t){let a=t;if(yr(s))try{const n=await mr(t,s.startTimeMs,s.endTimeMs,cr(t));a=n.blob,e&&(e.startTimeMs=0,e.endTimeMs=n.newDurationMs),xi(r,"audio-trimmed",{padId:s.id,padName:s.name||"Untitled Pad",originalBytes:t.size,trimmedBytes:a.size})}catch(o){xi(r,"audio-trim-fallback",{padId:s.id,padName:s.name||"Untitled Pad",reason:o instanceof Error?o.message:String(o)})}if(i.file(`${s.id}.audio`,a),e&&(e.audioUrl=`audio/${s.id}.audio`),u+=1,h+=a.size,Qs()&&h>oi)throw new Error("Bank export exceeded mobile size limit during packaging.")}c+=1,null==a||a(10+c/d*60),c%8==0&&await Xi()}if(zi(s)){const e=p.get(s.id),t=await pr(s,"image");if(t&&(l.file(`${s.id}.image`,t),e&&(e.imageUrl=`images/${s.id}.image`),m+=1,h+=t.size,Qs()&&h>oi))throw new Error("Bank export exceeded mobile size limit during packaging.");c+=1,null==a||a(10+c/d*60),c%8==0&&await Xi()}}r.metrics.processedBytes=h,r.metrics.exportedAudio=u,r.metrics.exportedImages=m;const g={...n,createdAt:n.createdAt.toISOString(),pads:f,creatorEmail:(null==s?void 0:s.email)||void 0};t.file("bank.json",JSON.stringify(g,null,2)),xi(r,"archive-generate"),null==a||a(75);const b=Qs()?2:9,v=await t.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:b}},e=>null==a?void 0:a(75+.2*e.percent)),y=`${n.name.replace(/[^a-z0-9]/gi,"_")}.bank`,_=await Mi(v,y);if(!_.success)throw new Error(_.message||"Failed to save exported bank.");return xi(r,"saved",{path:_.savedPath||y}),null==a||a(100),A({status:"success",bankName:n.name,bankId:n.id,padNames:n.pads.map(e=>e.name||"Untitled Pad")}),_.message||"Bank exported successfully."}catch(l){const e=l instanceof Error?l.message:String(l),t=await Si(r,l);throw A({status:"failed",bankName:n.name,bankId:n.id,padNames:n.pads.map(e=>e.name||"Untitled Pad"),errorMessage:t?`${e} (diagnostics: ${t})`:e}),new Error(t?`${e} (Diagnostics log: ${t})`:e)}},[i,A,e]),Z=a.useCallback(async(t,a,n)=>{const s=e||Fa();let o=(null==t?void 0:t.name)||"unknown.bank",l=[],d=!1;try{if(!t||0===t.size)throw new Error("Invalid file: File is empty or not accessible");if(!t.name.endsWith(".bank"))throw new Error("Invalid file type: File must have .bank extension");try{await t.slice(0,64).arrayBuffer()}catch(c){if(wi(c))throw new Error(di);throw c}await Gi(Math.ceil(1.2*t.size),"bank import");const m=async(e,t,a)=>{let n=null;const s=new Promise((e,s)=>{n=setTimeout(()=>s(new Error(`${a} timeout after ${Math.round(t/1e3)}s`)),t)});try{return await Promise.race([e,s])}finally{n&&clearTimeout(n)}},h=async(e,t)=>{try{return await m((new gn).loadAsync(e),v,t)}catch(a){const n=await e.arrayBuffer();return await m((new gn).loadAsync(n),v,t)}},f=6e4,p=6e4,g=6e5,b=Math.max(1,Math.ceil(t.size/104857600)),v=Math.min(g,f+b*p),y=await(async e=>{try{const t=new Uint8Array(await e.slice(0,4).arrayBuffer());return!(t.length<4)&&(!(80!==t[0]||75!==t[1])&&(3===t[2]&&4===t[3]||5===t[2]&&6===t[3]||7===t[2]&&8===t[3]))}catch{return!1}})(t);let _;a&&a(10);try{if(!y)throw new Error("zip_magic_mismatch");_=await h(t,"Zip load"),console.log("[import] Bank file loaded successfully (unencrypted)")}catch(c){if(wi(c))throw new Error(di);y||console.log("[import] Encrypted bank detected, skipping plain ZIP parse"),console.log("[import] Attempting to decrypt bank file...");let a=!1,n=null;try{if(!(await m(Gt(t,ji),Math.min(v,1e4),"Header check")))throw new Error("Shared password mismatch");{const e=await m(qt(t,ji),v,"Decrypt");_=await h(e,"Zip load"),a=!0,console.log("[import] Decrypted using shared password (export-disabled encryption)")}}catch(u){if(wi(u))throw new Error(di);n=u instanceof Error?u:new Error(String(u)),console.log("[import] Shared password decryption failed; trying user-specific keys...")}if(!a){if(console.log("[import] Auth check:",{user:!!e,cachedUser:!!Fa(),effectiveUser:!!s}),!s)throw new Error("Login required to import encrypted banks. Please sign in and try again.");const i=`${s.id}-`,r=Array.from(Bt.entries()).filter(([e])=>e.startsWith(i)).map(([,e])=>e),o=Object.values(Ut(s.id,{allowStale:!0})||{}),l=Array.from(new Set([...r,...o]));for(const e of l)try{if(await m(Gt(t,e),Math.min(v,1e4),"Header check")){const n=await m(qt(t,e),v,"Decrypt");_=await h(n,"Zip load"),a=!0,console.log("[import] Decrypted using cached key");break}}catch(u){if(wi(u))throw new Error(di);n=u instanceof Error?u:new Error(String(u)),console.warn("Decryption attempt failed with cached key:",u)}if(!a){const e=Yt(t.name);if(e)try{const n=await Xt(e,s.id);if(n){if(!(await m(Gt(t,n),Math.min(v,1e4),"Header check")))throw new Error("Hinted ID password mismatch");{const e=await m(qt(t,n),v,"Decrypt");_=await h(e,"Zip load"),a=!0,console.log("[import] Decrypted using hinted bank ID")}}}catch(u){if(wi(u))throw new Error(di);n=u instanceof Error?u:new Error(String(u)),console.warn("Decryption attempt failed with hinted ID:",u)}}if(!a)try{const e=await async function(e){const t=Lt(e),a=Lt(e,{allowStale:!0});if("undefined"!=typeof navigator&&!navigator.onLine)return a||t||[];try{const{data:n,error:s}=await jt.from("user_bank_access").select("bank_id").eq("user_id",e);if(s||!n)return a||t||[];const i=n.map(e=>e.bank_id);return Ft(e,i),Jt(e,i),i}catch(c){return console.error("Error listing accessible banks:",c),a||t||[]}}(s.id);console.log(`[import] Trying ${e.length} accessible banks...`);const n=await Promise.all(e.map(async e=>({bankId:e,key:await Xt(e,s.id)})));for(const{bankId:s,key:i}of n)try{if(i){if(await m(Gt(t,i),Math.min(v,1e4),"Header check")){const e=await m(qt(t,i),v,"Decrypt");_=await h(e,"Zip load"),a=!0,console.log("[import] Decrypted using accessible bank ID:",s);break}}}catch(u){if(wi(u))throw new Error(di)}}catch(u){console.error("Error checking accessible banks:",u)}}if(!a){if(n&&wi(n))throw new Error(di);const e=(null==n?void 0:n.message)||"Unknown decryption error";throw new Error(`Cannot decrypt bank file. ${e}. Please ensure you have access to this bank.`)}}a&&a(20);const x=_.file("bank.json");if(!x)throw new Error("Invalid bank file: bank.json not found. This may not be a valid bank file.");let w;try{const e=await m(x.async("string"),v,"Bank JSON load");if(w=JSON.parse(e),!w||"object"!=typeof w)throw new Error("Invalid bank data structure");if(!w.name||!Array.isArray(w.pads))throw new Error("Invalid bank file format: Missing required fields");console.log("[import] Bank data parsed:",{name:w.name,padCount:w.pads.length}),o=w.name,l=w.pads.map(e=>(null==e?void 0:e.name)||"Untitled Pad")}catch(c){if(c instanceof SyntaxError)throw new Error("Invalid bank file: bank.json is corrupted or invalid JSON");throw c}const k="string"==typeof(null==w?void 0:w.id)&&w.id.trim().length>0?w.id.trim():void 0,M=hi(w);let S=await async function(e){try{const t=e.file("metadata.json");if(!t)return null;const a=await t.async("string");return JSON.parse(a)}catch(c){return console.error("Error extracting metadata:",c),null}}(_);S&&(S={password:S.password??!1,transferable:S.transferable??!0,exportable:S.exportable,bankId:S.bankId,title:S.title,description:S.description,color:S.color});const C=(null==S?void 0:S.bankId)||Yt(t.name)||void 0;C&&!(null==S?void 0:S.bankId)&&(S={password:(null==S?void 0:S.password)??!1,transferable:(null==S?void 0:S.transferable)??!0,exportable:null==S?void 0:S.exportable,bankId:C,title:null==S?void 0:S.title,description:null==S?void 0:S.description,color:null==S?void 0:S.color}),d=!(!0===(null==S?void 0:S.password)||C);const N=new Set,A=e=>{const t=Ti(e);t&&N.add(t)};if(A(k),A(C),A(M),!(null==n?void 0:n.allowDuplicateImport)&&N.size>0){if(i.some(e=>{var t;const a=hi(e);return[e.id,e.sourceBankId,null==(t=e.bankMetadata)?void 0:t.bankId,a].some(e=>{const t=Ti(e);return!!t&&N.has(t)})}))throw new Error("This bank is already imported.")}const I=!0===(null==S?void 0:S.password),j=(null==S?void 0:S.transferable)??!0;let T=w.name,B="string"==typeof w.defaultColor?w.defaultColor:"#3b82f6";if(C){const e=await async function(e){if(!e)return null;if(Ot.has(e))return Ot.get(e);try{if("undefined"!=typeof navigator&&!navigator.onLine)return null;const{data:t,error:a}=await jt.from("banks").select("title, description, color").eq("id",e).maybeSingle();if(a||!(null==t?void 0:t.title))return null;const n={title:String(t.title),description:String(t.description||""),color:"string"==typeof t.color?t.color:void 0};return Ot.set(e,n),n}catch(c){return console.warn("Failed to resolve admin bank metadata:",c),null}}(C);e?(T=e.title,S={password:(null==S?void 0:S.password)??!1,transferable:(null==S?void 0:S.transferable)??!0,exportable:null==S?void 0:S.exportable,bankId:C,title:e.title,description:e.description,color:e.color||(null==S?void 0:S.color)},o=e.title,e.color&&(B=e.color)):(null==S?void 0:S.color)&&(B=S.color)}else(null==S?void 0:S.color)&&(B=S.color);const P=e||Fa();if(I&&!P)throw new Error("Login required");if(I&&P&&C&&!(await async function(e,t){const a=Lt(e),n=Lt(e,{allowStale:!0});if("undefined"!=typeof navigator&&!navigator.onLine)return!!n&&n.includes(t);try{const{data:s,error:i}=await jt.from("user_bank_access").select("id").eq("user_id",e).eq("bank_id",t).maybeSingle();return i?n?n.includes(t):!!a&&a.includes(t):!!s}catch(c){return n?n.includes(t):!!a&&a.includes(t)}}(P.id,C)))throw new Error("Access denied");a&&a(30);const R=i.length>0?Math.max(...i.map(e=>e.sortOrder||0)):-1,D={...w,id:dr(),name:T,defaultColor:B,createdAt:w.createdAt?new Date(w.createdAt):new Date,sortOrder:R+1,pads:[],sourceBankId:C||k||M,isAdminBank:I,transferable:j,exportable:(null==S?void 0:S.exportable)??!0,bankMetadata:S},O=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,L=async e=>{if(!O)return URL.createObjectURL(e);try{const t=URL.createObjectURL(e);return await new Promise(e=>{const a=new Audio,n=setTimeout(()=>{a.src="",e()},50);a.oncanplaythrough=()=>{clearTimeout(n),e()},a.onerror=()=>{clearTimeout(n),e()},a.src=t}),t}catch(u){return URL.createObjectURL(e)}},F=[],U=w.pads.length,V=Qs(),$=V?1:4,H=[];let K=0;const q=async()=>{if(V||0===H.length)return;const e=H.splice(0,H.length);K=0;try{await m(ar(e),v,"Save batch")}catch(u){throw console.error("[import] Failed to save batch files to database:",u),new Error(`Failed to save files to storage: ${u instanceof Error?u.message:String(u)}`)}},z=async(e,t)=>{try{const a=dr(),n=_.file(`audio/${e.id}.audio`),s=_.file(`images/${e.id}.image`);let i,r,o=null,l=null,d="idb",c="idb",h=!1;if(n)try{const t=await m(n.async("blob"),v,"Audio load");if(t&&0!==t.size){if(V){const e=await fr(a,new File([t],`${a}.audio`,{type:t.type||"application/octet-stream"}),"audio");i=e.storageKey,d=e.backend,e.storageKey&&(o=await Yi(e.storageKey))}else H.push({id:a,blob:t,type:"audio"}),K+=t.size;o||(o=await L(t))}else console.warn(`[import] Audio file for pad "${e.name||e.id}" is empty`)}catch(u){console.error(`[import] Failed to load audio for pad "${e.name||e.id}":`,u)}if(s)try{const t=await m(s.async("blob"),v,"Image load");if(t&&0!==t.size){if(h=!0,V){const e=await fr(a,new File([t],`${a}.image`,{type:t.type||"application/octet-stream"}),"image");r=e.storageKey,c=e.backend,e.storageKey&&(l=await Yi(e.storageKey))}else H.push({id:a,blob:t,type:"image"}),K+=t.size;l||(l=await L(t))}else console.warn(`[import] Image file for pad "${e.name||e.id}" is empty`)}catch(u){console.error(`[import] Failed to load image for pad "${e.name||e.id}":`,u)}return o?{...e,id:a,audioUrl:o,imageUrl:l,audioStorageKey:i,audioBackend:d,imageStorageKey:r,imageBackend:c,hasImageAsset:h,imageData:void 0,shortcutKey:e.shortcutKey||void 0,midiNote:"number"==typeof e.midiNote?e.midiNote:void 0,midiCC:"number"==typeof e.midiCC?e.midiCC:void 0,ignoreChannel:!!e.ignoreChannel,fadeInMs:e.fadeInMs||0,fadeOutMs:e.fadeOutMs||0,startTimeMs:e.startTimeMs||0,endTimeMs:e.endTimeMs||0,pitch:e.pitch||0,savedHotcuesMs:Array.isArray(e.savedHotcuesMs)?e.savedHotcuesMs.slice(0,4):[null,null,null,null],position:e.position??t}:(console.warn(`[import] Skipping pad "${e.name||e.id}" - no audio file found`),null)}catch(u){const a=u instanceof Error?u.message:String(u);return console.error(`[import] Pad import error at index ${t}:`,a),null}};for(let e=0;e<U;e+=$){const t=w.pads.slice(e,e+$);for(let n=0;n<t.length;n+=1){const s=e+n,i=await z(t[n],s);i&&F.push(i),!V&&(H.length>=12||K>=50331648)&&await q();const r=30+(s+1)/U*60;a&&a(Math.min(95,r)),await Xi()}}if(await q(),0===F.length)throw console.warn("[import] No valid pads were imported from the bank file"),new Error("No valid pads found in bank file. The bank may be corrupted or empty.");D.pads=F;let G=D;return r(e=>{const t=Pi([...e,D]),a=t.removedIdToKeptId.get(D.id);if(a){const t=e.find(e=>e.id===a);t&&(G=t)}return t.banks}),a&&a(100),console.log(`[import] Import complete: ${F.length} pads loaded from "${G.name}"`),(null==n?void 0:n.skipActivityLog)||E({status:"success",bankName:o,bankId:G.sourceBankId||G.id,padNames:l,includePadList:d}),G}catch(u){const e=u instanceof Error?u.message:"Unknown import error";if(console.error("[import] Import failed:",e,u),(null==n?void 0:n.skipActivityLog)||E({status:"failed",bankName:o,padNames:l,includePadList:d,errorMessage:e}),wi(u)||e.toLowerCase().includes("cannot read the selected file"))throw new Error(di);if(e.includes("timeout"))throw new Error("Import timed out. The file may be too large or corrupted. Please try again.");if(e.includes("decrypt")||e.includes("encryption"))throw new Error("Cannot decrypt bank file. Please ensure you have access to this bank and are signed in.");if(e.includes("Invalid bank"))throw new Error("Invalid bank file format. Please ensure you selected a valid .bank file.");if(e.includes("Login required"))throw new Error("Please sign in to import this bank file.");throw new Error(`Import failed: ${e}`)}},[i,e,E]),J=a.useCallback(async(a,n,s,r,o,l,d)=>{if(!e||"admin"!==(null==t?void 0:t.role))throw new Error("Admin only");const c=i.find(e=>e.id===a);if(!c)throw new Error("Bank not found");const u=_i("admin_bank_export",e.id);xi(u,"start",{bankId:c.id,bankName:c.name,padCount:c.pads.length,addToDatabase:o,allowExport:l,transferable:r});try{null==d||d(5),await ki();const t=await vr(c);if(u.metrics.estimatedBytes=t,xi(u,"preflight",{estimatedBytes:t}),Qs()&&t>oi)throw new Error(`Admin bank export is too large for mobile export (${Math.ceil(t/1048576)}MB). Reduce bank size and try again.`);await Gi(Math.ceil(.35*t),"admin bank export");const a=new gn,i=a.folder("audio"),f=a.folder("images");if(!i||!f)throw new Error("Unable to create bank archive folders.");const p=Math.max(1,c.pads.reduce((e,t)=>e+(t.audioUrl?1:0)+(zi(t)?1:0),0));let g=0,b=0,v=0,y=0;const _=c.pads.map(e=>({...e,audioUrl:void 0,imageUrl:void 0})),x=new Map(_.map(e=>[e.id,e]));for(const e of c.pads){if(e.audioUrl){const t=x.get(e.id),a=await pr(e,"audio");if(a){let n=a;if(yr(e))try{const s=await mr(a,e.startTimeMs,e.endTimeMs,cr(a));n=s.blob,t&&(t.startTimeMs=0,t.endTimeMs=s.newDurationMs),xi(u,"audio-trimmed",{padId:e.id,padName:e.name||"Untitled Pad",originalBytes:a.size,trimmedBytes:n.size})}catch(m){xi(u,"audio-trim-fallback",{padId:e.id,padName:e.name||"Untitled Pad",reason:m instanceof Error?m.message:String(m)})}if(i.file(`${e.id}.audio`,n),t&&(t.audioUrl=`audio/${e.id}.audio`),v+=1,b+=n.size,Qs()&&b>oi)throw new Error("Admin bank export exceeded mobile size limit during packaging.")}g+=1,null==d||d(10+g/p*45),g%8==0&&await Xi()}if(zi(e)){const t=x.get(e.id),a=await pr(e,"image");if(a&&(f.file(`${e.id}.image`,a),t&&(t.imageUrl=`images/${e.id}.image`),y+=1,b+=a.size,Qs()&&b>oi))throw new Error("Admin bank export exceeded mobile size limit during packaging.");g+=1,null==d||d(10+g/p*45),g%8==0&&await Xi()}}u.metrics.processedBytes=b,u.metrics.exportedAudio=v,u.metrics.exportedImages=y;const w={...c,createdAt:c.createdAt.toISOString(),pads:_};a.file("bank.json",JSON.stringify(w,null,2));const k=`${(n||c.name||"Bank").trim().replace(/[^a-z0-9]/gi,"_")}.bank`;let M;if(o){xi(u,"db-create");const{createAdminBankWithDerivedKey:t}=await U(async()=>{const{createAdminBankWithDerivedKey:e}=await import("./admin-bank-utils-fkyDaT_B.js");return{createAdminBankWithDerivedKey:e}},__vite__mapDeps([6,1,2,4,3])),i=await t(n,s,e.id,c.defaultColor);if(!i)throw new Error("Failed to create admin bank metadata entry.");Wt(a,{password:!0,transferable:r,exportable:!1,title:n,description:s,color:c.defaultColor,bankId:i.id});try{const{supabase:t}=await U(async()=>{const{supabase:e}=await Promise.resolve().then(()=>Tt);return{supabase:e}},void 0);await t.from("user_bank_access").upsert({user_id:e.id,bank_id:i.id},{onConflict:"user_id,bank_id"})}catch(h){xi(u,"db-access-upsert-warning",{reason:h instanceof Error?h.message:String(h)})}null==d||d(65),M=await Kt(a,i.derived_key),null==d||d(88)}else if(Wt(a,{password:!l,transferable:r,exportable:l,title:n,description:s,color:c.defaultColor}),l){xi(u,"archive-generate"),null==d||d(65);const e=Qs()?2:9;M=await a.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:e}},e=>null==d?void 0:d(65+.23*e.percent))}else null==d||d(65),M=await Kt(a,ji),null==d||d(88);const S=await Mi(M,k);if(!S.success)throw new Error(S.message||"Failed to save admin bank export.");return xi(u,"saved",{path:S.savedPath||k}),null==d||d(100),S.message||"Admin bank exported successfully."}catch(f){const e=f instanceof Error?f.message:String(f),t=await Si(u,f);throw new Error(t?`${e} (Diagnostics log: ${t})`:e)}},[i,e,t]),Q=a.useCallback(e=>{const t=i.find(t=>t.id===e);return!!t&&("boolean"==typeof t.transferable?t.transferable:!t.bankMetadata||"boolean"!=typeof t.bankMetadata.transferable||t.bankMetadata.transferable)},[i]),ee=a.useCallback(async e=>{await Promise.all(e.pads.map(async e=>{try{await Promise.all([or(`audio_${e.id}`,!1),or(`image_${e.id}`,!0),Ji(e.audioStorageKey),Ji(e.imageStorageKey)])}catch{}}))},[]),te=a.useCallback(async(t,a)=>{const n=e||Fa();if(!(null==n?void 0:n.id))throw new Error("Please sign in before creating a backup.");const s=_i("app_backup_export",n.id);xi(s,"start",{bankCount:i.length});const r=!0===(null==a?void 0:a.riskMode);try{await ki();let e=0;for(const t of i)e+=await vr(t);if(s.metrics.estimatedBytes=e,s.metrics.bankCount=i.length,Qs()&&e>li)throw new Error(`Full backup is too large for reliable mobile export (${Math.ceil(e/1048576)}MB). Use desktop full backup or export banks individually.`);const a=Math.ceil(.45*Math.max(e,1));xi(s,"preflight",{estimatedBytes:e,requiredBytes:a,riskMode:r}),r?xi(s,"preflight-skipped",{reason:"risk-mode-enabled"}):await Gi(a,"backup export");const o=new gn,l=[];let d=0,c=0;const u=i.reduce((e,t)=>e+t.pads.length,0);for(const t of i){const e={...t,createdAt:t.createdAt instanceof Date?t.createdAt.toISOString():t.createdAt,pads:[]};for(const a of t.pads){const n={...a,audioUrl:void 0,imageUrl:void 0,imageData:void 0,audioPath:null,imagePath:null,audioBackend:a.audioBackend||(a.audioStorageKey?"native":"idb"),imageBackend:a.imageBackend||(a.imageStorageKey?"native":"idb")},s=await pr(a,"audio");if(s){const e=`media/audio/${t.id}/${a.id}.audio`;o.file(e,s),n.audioPath=e,d+=s.size}const i=zi(a)?await pr(a,"image"):null;if(i){const e=`media/images/${t.id}/${a.id}.image`;o.file(e,i),n.imagePath=e,d+=i.size}if(Qs()&&d>li)throw new Error("Backup exceeded reliable mobile size limit during packaging. Use desktop full backup or export banks individually.");e.pads.push(n),c+=1,c%8==0&&await Xi()}l.push(e)}s.metrics.processedBytes=d,s.metrics.padCount=u,o.file("backup.json",JSON.stringify({version:2,exportedAt:(new Date).toISOString(),userId:n.id,manifest:{schema:"vdjv-backup",mediaPolicy:"hybrid",hasBackendHints:!0,restoreMode:"non-destructive-legacy"},state:t.state,settings:t.settings,mappings:t.mappings,banks:l},null,2)),xi(s,"encrypt");const m=await Ht(`backup-${n.id}`),h=await Kt(o,m),f=(new Date).toISOString().replace(/[:.]/g,"-"),p=((e,t,a)=>{const n=Math.max(1,t),s=Math.max(1,Math.ceil(e.size/n));if(s>200)throw new Error(`Backup requires ${s} parts, exceeding supported limit (200). Reduce library size and try again.`);const i=Math.max(3,String(s).length),r=[];for(let o=0;o<s;o+=1){const t=o*n,s=e.slice(t,Math.min(e.size,t+n)),l=`${gi(a)}.part-${String(o+1).padStart(i,"0")}${si}`;r.push({fileName:l,blob:s,index:o,offset:t})}return r})(h,pi(),f);if(xi(s,"split",{encryptedBytes:h.size,partCount:p.length,partSizeBytes:pi()}),p.length<=1){const e=bi(f),t=await Mi(h,e);if(!t.success)throw new Error(t.message||"Failed to save backup file.");return xi(s,"saved",{path:t.savedPath||e,mode:"legacy-single-file"}),t.message||"Backup exported successfully."}for(const t of p){const e=await Mi(t.blob,t.fileName);if(!e.success)throw new Error(e.message||`Failed to save backup part ${t.fileName}.`);xi(s,"save-part",{fileName:t.fileName,size:t.blob.size,path:e.savedPath||t.fileName}),await Xi()}const g={schema:ii,manifestVersion:1,backupVersion:2,backupId:f,exportedAt:(new Date).toISOString(),userId:n.id,encryptedSize:h.size,partSize:pi(),parts:p.map(e=>({index:e.index,fileName:e.fileName,size:e.blob.size,offset:e.offset}))},b=bi(f),v=await Mi(new Blob([JSON.stringify(g,null,2)],{type:"application/octet-stream"}),b);if(!v.success)throw new Error(v.message||"Failed to save backup manifest file.");return xi(s,"saved",{path:v.savedPath||b,mode:"manifest+parts",partCount:p.length}),`Backup exported in ${p.length} parts. Restore using "${b}" with all "${si}" files.`}catch(o){const e=o instanceof Error?o.message:String(o),t=await Si(s,o);throw new Error(t?`${e} (Diagnostics log: ${t})`:e)}},[i,e]),ae=a.useCallback(async(t,a=[])=>{var n,s;const o=e||Fa();if(!(null==o?void 0:o.id))throw new Error("Please sign in before restoring a backup.");const l=_i("app_backup_restore",o.id);xi(l,"start",{inputBytes:t.size,bankCount:i.length,companionFiles:a.length});try{await ki();let e=t,c=null;const m=await vi(t);if(m){if(m.userId!==o.id)throw new Error("This backup manifest belongs to a different account.");const n=await(async(e,t,a,n)=>{const s=new Map;[t,...a].forEach(e=>{s.set(e.name.toLowerCase(),e)});const i=[],r=[],o=[...e.parts].sort((e,t)=>e.index-t.index);for(const d of o){let e=s.get(d.fileName.toLowerCase())||null;if(e||(e=await yi(d.fileName),e&&s.set(d.fileName.toLowerCase(),e)),e){if("number"==typeof d.size&&d.size>=0&&e.size!==d.size)throw new Error(`Backup part "${d.fileName}" size mismatch. Expected ${d.size} bytes, got ${e.size} bytes.`);r.push({entry:d,file:e})}else i.push(d.fileName)}if(i.length>0)return{encryptedBlob:new Blob,resolvedParts:r.length,missingParts:i};n&&xi(n,"resolve-backup-parts",{manifest:t.name,expectedParts:o.length,resolvedParts:r.length});const l=r.sort((e,t)=>e.entry.index-t.entry.index).map(e=>e.file);return{encryptedBlob:new Blob(l,{type:"application/octet-stream"}),resolvedParts:l.length,missingParts:[]}})(m,t,a,l);if(n.missingParts.length>0){const e=n.missingParts.slice(0,6).join(", "),a=Math.max(0,n.missingParts.length-6),s=a>0?` and ${a} more`:"";throw new Error(`Missing backup part files: ${e}${s}. Select "${t.name}" together with all "${si}" files.`)}e=n.encryptedBlob,c=m,xi(l,"manifest-resolved",{manifest:t.name,resolvedParts:n.resolvedParts,encryptedBytes:e.size})}await Gi(Math.ceil(1.2*e.size),"backup restore");try{await e.slice(0,64).arrayBuffer()}catch(d){if(wi(d))throw new Error(ci);throw d}const f=await Ht(`backup-${o.id}`),g=await qt(e,f),b=await(new gn).loadAsync(await g.arrayBuffer()),v=b.file("backup.json");if(!v)throw new Error("Invalid backup: backup.json missing.");const y=JSON.parse(await v.async("string"));if(!y||2!==y.version&&1!==y.version)throw new Error("Unsupported backup version.");if(y.userId!==o.id)throw new Error("This backup belongs to a different account.");xi(l,"clear-existing-media",{existingBanks:i.length});for(const t of i)await ee(t);const _=[];let x=0;for(const t of y.banks||[]){const e=[];for(const a of t.pads||[]){let t,n,s,i="",r=a.audioBackend||(a.audioStorageKey?"native":"idb"),o=a.imageBackend||(a.imageStorageKey?"native":void 0),l=Boolean(a.hasImageAsset||a.imagePath||a.imageStorageKey||a.imageData);if(a.audioPath){const e=b.file(String(a.audioPath));if(e){const t=await e.async("blob"),s=await fr(a.id,new File([t],`${a.id}.audio`,{type:t.type||"application/octet-stream"}),"audio");n=s.storageKey,r=s.backend,i=URL.createObjectURL(t),x+=t.size}}if(a.imagePath){const e=b.file(String(a.imagePath));if(e){const n=await e.async("blob"),i=await fr(a.id,new File([n],`${a.id}.image`,{type:n.type||"application/octet-stream"}),"image");s=i.storageKey,o=i.backend,t=URL.createObjectURL(n),l=!0,x+=n.size}}e.push({...a,audioUrl:i,imageUrl:t,audioStorageKey:n,audioBackend:r,imageStorageKey:s,imageBackend:o,hasImageAsset:l,imageData:void 0,savedHotcuesMs:Array.isArray(a.savedHotcuesMs)?a.savedHotcuesMs.slice(0,4):[null,null,null,null]}),e.length%8==0&&await Xi()}_.push({...t,createdAt:new Date(t.createdAt||Date.now()),pads:e})}l.metrics.processedBytes=x,l.metrics.restoredBanks=_.length,r(_);const w=y.state||null;if(w){const e=new Set(_.map(e=>e.id));u(e.has(w.primaryBankId)?w.primaryBankId:null),h(e.has(w.secondaryBankId)?w.secondaryBankId:null),e.has(w.currentBankId)?p(w.currentBankId):p((null==(n=_[0])?void 0:n.id)||null)}else u(null),h(null),p((null==(s=_[0])?void 0:s.id)||null);return xi(l,"complete",{restoredBanks:_.length}),{message:c?`Backup restored: ${_.length} bank(s) from ${c.parts.length} part file(s).`:`Backup restored: ${_.length} bank(s).`,settings:y.settings||null,mappings:y.mappings||null,state:y.state||null}}catch(d){const e=wi(d)?new Error(ci):d,t=e instanceof Error?e.message:String(e),a=await Si(l,d);throw new Error(a?`${t} (Diagnostics log: ${a})`:t)}},[i,ee,e]),ne=a.useCallback(async(t,a)=>{var n;const s=(null==a?void 0:a.ownerId)??(null==e?void 0:e.id)??(null==(n=Fa())?void 0:n.id)??w.current??null,i=!1!==(null==a?void 0:a.addAsNewWhenNoTarget);let l=0;const d=o.current;let c=C(s);const u=[...d,...c.filter(e=>!d.some(t=>t.id===e.id))].find(e=>e.id!==t.id&&(!(!t.sourceBankId||e.sourceBankId!==t.sourceBankId&&e.id!==t.sourceBankId)||e.name===t.name));if(!u)return i||(await ee(t),r(e=>e.filter(e=>e.id!==t.id)),s&&(c=c.filter(e=>e.id!==t.id),S(s,c))),{merged:!1,recoveredItems:0,addedBank:i};const m=new Map(t.pads.map(e=>[e.id,e])),h=new Map,f=new Map;t.pads.forEach((e,t)=>{const a=qi(e,t);h.has(a)||h.set(a,e);const n=Ki(e.name);if(!n)return;const s=f.get(n)||[];s.push(e),f.set(n,s)});const p=[];for(let e=0;e<u.pads.length;e+=1){const a=u.pads[e],n=qi(a,e),s=Ki(a.name),i=s?f.get(s):void 0,r=m.get(a.id)||(i&&i.length>0?i.shift():void 0)||h.get(n)||t.pads[e]||t.pads[n];let o={...a};const d=await pr(o,"audio");if(d&&!o.audioUrl&&(o.audioUrl=URL.createObjectURL(d),o.audioBackend=o.audioStorageKey?"native":o.audioBackend||"idb"),!d&&r)try{const e=await gr(r,"audio");if(!e)throw new Error("Missing source audio blob");const t=await fr(o.id,new File([e],`${o.id}.audio`,{type:e.type||"application/octet-stream"}),"audio");o.audioUrl=URL.createObjectURL(e),t.storageKey&&(o.audioStorageKey=t.storageKey),o.audioBackend=t.backend,l+=1}catch(g){console.warn("Failed recovering audio for pad:",o.id,g)}const c=zi(o),b=c?await pr(o,"image"):null;if(b&&!o.imageUrl&&(o.imageUrl=URL.createObjectURL(b),o.imageBackend=o.imageStorageKey?"native":o.imageBackend||"idb",o.hasImageAsset=!0),c&&!b&&r)try{const e=await gr(r,"image");if(!e)throw new Error("Missing source image blob");const t=await fr(o.id,new File([e],`${o.id}.image`,{type:e.type||"application/octet-stream"}),"image");o.imageUrl=URL.createObjectURL(e),t.storageKey&&(o.imageStorageKey=t.storageKey),o.imageBackend=t.backend,o.hasImageAsset=!0,l+=1}catch(g){console.warn("Failed recovering image for pad:",o.id,g)}p.push(o)}if(await ee(t),r(e=>e.map(e=>e.id===u.id?{...e,pads:p}:e).filter(e=>e.id!==t.id)),s){const e=c.map(e=>e.id===u.id?{...e,pads:p}:e).filter(e=>e.id!==t.id);S(s,e)}return{merged:!0,recoveredItems:l,addedBank:!1}},[ee,C,S,null==e?void 0:e.id]),se=a.useCallback(async t=>{var a;if(!t.length)throw new Error("No bank files selected.");let n=0,s=0,i=0;const r=(null==e?void 0:e.id)||(null==(a=Fa())?void 0:a.id)||w.current||null;for(const e of t){if(!e.name.endsWith(".bank"))continue;let t=null;try{t=await Z(e,void 0,{allowDuplicateImport:!0,skipActivityLog:!0})}catch(o){console.warn(`Recovery import failed for ${e.name}:`,o);continue}if(!t)continue;const a=await ne(t,{ownerId:r,addAsNewWhenNoTarget:!0});a.merged&&(s+=1),a.addedBank&&(i+=1),n+=a.recoveredItems}return`Recovery complete. Merged ${s} bank(s), restored ${n} missing pad media item(s), added ${i} new bank(s).`},[Z,ne,null==e?void 0:e.id]),ie=a.useCallback(()=>{const e=window.navigator.userAgent.includes("Electron");/Android/.test(navigator.userAgent);return e?"./assets/DEFAULT_BANK.bank":"/assets/DEFAULT_BANK.bank"},[]),re=a.useRef(null);return a.useEffect(()=>{const t=e||Fa(),a=(null==t?void 0:t.id)||null;if(!a)return re.current=null,k.current=null,void(M.current=null);if(!l)return;const n=`vdjv-default-bank-loaded_${a}`,s=e=>"Default Bank"===e.name||e.sourceBankId===Ai,o=e=>Array.isArray(e.pads)&&e.pads.length>0,d=C(a).some(e=>s(e)&&o(e)),c=Pi(i);if(c.removedIdToKeptId.size>0){r(c.banks),p(e=>e&&c.removedIdToKeptId.get(e)||e),u(e=>e&&c.removedIdToKeptId.get(e)||e),h(e=>e&&c.removedIdToKeptId.get(e)||e);return void(c.banks.some(e=>s(e)&&o(e))&&Di(n,"true"))}if(!(a&&re.current!==a))return void(re.current=a);if(re.current=a,k.current===a)return;k.current=a;const m=Ri(n),g=i.some(e=>s(e)&&o(e)),b=g||d;if(m&&g)return;if(m&&!g)try{localStorage.removeItem(n)}catch{}if(b)return void Di(n,"true");const v=`vdjv-default-bank-loading-lock_${a}`,y=Ri(v),_=Number(y||0);if(y&&Number.isFinite(_)&&Date.now()-_<12e4)return void console.log("Default bank load is already in progress for this user, skipping.");(async()=>{Di(v,String(Date.now()));try{const e=i.some(e=>s(e)&&o(e)),t=C(a).some(e=>s(e)&&o(e));if(e)return void Di(n,"true");if(t)return void Di(n,"true");const l=i.find(e=>s(e)&&(!e.pads||0===e.pads.length));l&&(r(e=>e.filter(e=>e.id!==l.id)),f===l.id&&p(null));const d=ie();let c=await fetch(d);if(!c.ok&&/Android/.test(navigator.userAgent)&&d.startsWith("/")&&(c=await fetch("./assets/DEFAULT_BANK.bank")),!c.ok&&window.navigator.userAgent.includes("Electron")&&d.startsWith("./")&&(c=await fetch("/assets/DEFAULT_BANK.bank")),!c.ok)throw new Error(`Default bank file not found: ${c.status} ${c.statusText}`);const u=await c.blob();if(0===u.size)throw new Error("Default bank file is empty");const m=new File([u],"DEFAULT_BANK.bank",{type:"application/zip"}),h=await Z(m);if(!h)throw new Error("Import returned null");{let e=h.id;r(t=>{const a=t.map(e=>e.id===h.id?{...e,name:"Default Bank",sourceBankId:Ai}:e),n=a.filter(e=>"Default Bank"===e.name||e.sourceBankId===Ai);if(n.length<=1)return a;const s=n.find(e=>o(e))||n.find(e=>e.id===h.id)||n[0];e=s.id;const i=new Set(n.filter(e=>e.id!==s.id).map(e=>e.id));return a.filter(e=>!i.has(e.id))}),p(e),Di(n,"true")}}catch(e){console.warn("Failed to load default bank:",e)}finally{if("undefined"!=typeof window)try{localStorage.removeItem(v)}catch{}}})()},[null==e?void 0:e.id,Z,ie,i,f,l,C]),a.useEffect(()=>{const t=e||Fa(),a=(null==t?void 0:t.id)||null;if(!a||!l)return void(a||(M.current=null));if(M.current===a)return;const n=i.find(e=>e.sourceBankId===Ai||"Default Bank"===e.name);if(!n||!n.pads.length)return;if(!n.pads.some(e=>{if(!e.audioUrl)return!0;return zi(e)&&!e.imageUrl}))return void(M.current=a);M.current=a;let s=!1;return(async()=>{try{const e=ie();let t=await fetch(e);if(!t.ok&&/Android/.test(navigator.userAgent)&&e.startsWith("/")&&(t=await fetch("./assets/DEFAULT_BANK.bank")),!t.ok&&window.navigator.userAgent.includes("Electron")&&e.startsWith("./")&&(t=await fetch("/assets/DEFAULT_BANK.bank")),!t.ok)throw new Error(`Default bank file not found: ${t.status} ${t.statusText}`);const n=await t.blob();if(0===n.size)throw new Error("Default bank file is empty");const i=new File([n],"DEFAULT_BANK.bank",{type:"application/zip"}),r=await Z(i,void 0,{allowDuplicateImport:!0,skipActivityLog:!0});if(!r||s)return;const o={...r,name:"Default Bank",sourceBankId:Ai},l=await ne(o,{ownerId:a,addAsNewWhenNoTarget:!1});l.merged&&l.recoveredItems>0&&console.log(`[default-recovery] Restored ${l.recoveredItems} missing media item(s) from embedded default bank.`)}catch(e){console.warn("Default bank media auto-recovery failed:",e)}})(),()=>{s=!0}},[null==e?void 0:e.id,i,l,ie,Z,ne]),{banks:i,primaryBankId:c,secondaryBankId:m,currentBankId:f,primaryBank:g,secondaryBank:b,currentBank:v,isDualMode:y,addPad:R,addPads:D,updatePad:O,removePad:L,createBank:V,setPrimaryBank:q,setSecondaryBank:z,setCurrentBank:G,updateBank:X,deleteBank:W,importBank:Z,exportBank:Y,reorderPads:F,moveBankUp:$,moveBankDown:H,transferPad:K,exportAdminBank:J,canTransferFromBank:Q,exportAppBackup:te,restoreAppBackup:ae,recoverMissingMediaFromBanks:se}}function xr(){const[e,t]=a.useState(()=>{if("undefined"==typeof window)return"dark";const e=localStorage.getItem("vdjv-theme");return!e||"light"!==e&&"dark"!==e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e});a.useEffect(()=>{"undefined"!=typeof window&&(localStorage.setItem("vdjv-theme",e),document.documentElement.classList.toggle("dark","dark"===e))},[e]);const n=a.useCallback(()=>{t(e=>"light"===e?"dark":"light")},[]);return{theme:e,toggleTheme:n}}
/*! Capacitor: https://capacitorjs.com/ - MIT License */
const wr=(e=>e.CapacitorPlatforms=(e=>{const t=new Map;t.set("web",{name:"web"});const a=e.CapacitorPlatforms||{currentPlatform:{name:"web"},platforms:t};return a.addPlatform=(e,t)=>{a.platforms.set(e,t)},a.setPlatform=e=>{a.platforms.has(e)&&(a.currentPlatform=a.platforms.get(e))},a})(e))("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{});var kr,Mr;wr.addPlatform,wr.setPlatform,(Mr=kr||(kr={})).Unimplemented="UNIMPLEMENTED",Mr.Unavailable="UNAVAILABLE";class Sr extends Error{constructor(e,t,a){super(e),this.message=e,this.code=t,this.data=a}}const Cr=e=>{var t,a,n,s,i;const r=e.CapacitorCustomPlatform||null,o=e.Capacitor||{},l=o.Plugins=o.Plugins||{},d=e.CapacitorPlatforms,c=(null===(t=null==d?void 0:d.currentPlatform)||void 0===t?void 0:t.getPlatform)||(()=>null!==r?r.name:(e=>{var t,a;return(null==e?void 0:e.androidBridge)?"android":(null===(a=null===(t=null==e?void 0:e.webkit)||void 0===t?void 0:t.messageHandlers)||void 0===a?void 0:a.bridge)?"ios":"web"})(e)),u=(null===(a=null==d?void 0:d.currentPlatform)||void 0===a?void 0:a.isNativePlatform)||(()=>"web"!==c()),m=(null===(n=null==d?void 0:d.currentPlatform)||void 0===n?void 0:n.isPluginAvailable)||(e=>{const t=f.get(e);return!!(null==t?void 0:t.platforms.has(c()))||!!h(e)}),h=(null===(s=null==d?void 0:d.currentPlatform)||void 0===s?void 0:s.getPluginHeader)||(e=>{var t;return null===(t=o.PluginHeaders)||void 0===t?void 0:t.find(t=>t.name===e)}),f=new Map,p=(null===(i=null==d?void 0:d.currentPlatform)||void 0===i?void 0:i.registerPlugin)||((e,t={})=>{const a=f.get(e);if(a)return console.warn(`Capacitor plugin "${e}" already registered. Cannot register plugins twice.`),a.proxy;const n=c(),s=h(e);let i;const d=a=>{let l;const d=(...d)=>{const c=(async()=>(!i&&n in t?i=i="function"==typeof t[n]?await t[n]():t[n]:null!==r&&!i&&"web"in t&&(i=i="function"==typeof t.web?await t.web():t.web),i))().then(t=>{const i=((t,a)=>{var i,r;if(!s){if(t)return null===(r=t[a])||void 0===r?void 0:r.bind(t);throw new Sr(`"${e}" plugin is not implemented on ${n}`,kr.Unimplemented)}{const n=null==s?void 0:s.methods.find(e=>a===e.name);if(n)return"promise"===n.rtype?t=>o.nativePromise(e,a.toString(),t):(t,n)=>o.nativeCallback(e,a.toString(),t,n);if(t)return null===(i=t[a])||void 0===i?void 0:i.bind(t)}})(t,a);if(i){const e=i(...d);return l=null==e?void 0:e.remove,e}throw new Sr(`"${e}.${a}()" is not implemented on ${n}`,kr.Unimplemented)});return"addListener"===a&&(c.remove=async()=>l()),c};return d.toString=()=>`${a.toString()}() { [capacitor code] }`,Object.defineProperty(d,"name",{value:a,writable:!1,configurable:!1}),d},u=d("addListener"),m=d("removeListener"),p=(e,t)=>{const a=u({eventName:e},t),n=async()=>{const n=await a;m({eventName:e,callbackId:n},t)},s=new Promise(e=>a.then(()=>e({remove:n})));return s.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await n()},s},g=new Proxy({},{get(e,t){switch(t){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return s?p:u;case"removeListener":return m;default:return d(t)}}});return l[e]=g,f.set(e,{name:e,proxy:g,platforms:new Set([...Object.keys(t),...s?[n]:[]])}),g});return o.convertFileSrc||(o.convertFileSrc=e=>e),o.getPlatform=c,o.handleError=t=>e.console.error(t),o.isNativePlatform=u,o.isPluginAvailable=m,o.pluginMethodNoop=(e,t,a)=>Promise.reject(`${a} does not have an implementation of "${t}".`),o.registerPlugin=p,o.Exception=Sr,o.DEBUG=!!o.DEBUG,o.isLoggingEnabled=!!o.isLoggingEnabled,o.platform=o.getPlatform(),o.isNative=o.isNativePlatform(),o},Nr=(e=>e.Capacitor=Cr(e))("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}),Ar=Nr.registerPlugin;Nr.Plugins;class Er{constructor(e){this.listeners={},this.retainedEventArguments={},this.windowListeners={},e&&(console.warn(`Capacitor WebPlugin "${e.name}" config object was deprecated in v3 and will be removed in v4.`),this.config=e)}addListener(e,t){let a=!1;this.listeners[e]||(this.listeners[e]=[],a=!0),this.listeners[e].push(t);const n=this.windowListeners[e];n&&!n.registered&&this.addWindowListener(n),a&&this.sendRetainedArgumentsForEvent(e);return Promise.resolve({remove:async()=>this.removeListener(e,t)})}async removeAllListeners(){this.listeners={};for(const e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,t,a){const n=this.listeners[e];if(n)n.forEach(e=>e(t));else if(a){let a=this.retainedEventArguments[e];a||(a=[]),a.push(t),this.retainedEventArguments[e]=a}}hasListeners(e){return!!this.listeners[e].length}registerWindowListener(e,t){this.windowListeners[t]={registered:!1,windowEventName:e,pluginEventName:t,handler:e=>{this.notifyListeners(t,e)}}}unimplemented(e="not implemented"){return new Nr.Exception(e,kr.Unimplemented)}unavailable(e="not available"){return new Nr.Exception(e,kr.Unavailable)}async removeListener(e,t){const a=this.listeners[e];if(!a)return;const n=a.indexOf(t);this.listeners[e].splice(n,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){const t=this.retainedEventArguments[e];t&&(delete this.retainedEventArguments[e],t.forEach(t=>{this.notifyListeners(e,t)}))}}const Ir=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),jr=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class Tr extends Er{async getCookies(){const e=document.cookie,t={};return e.split(";").forEach(e=>{if(e.length<=0)return;let[a,n]=e.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");a=jr(a).trim(),n=jr(n).trim(),t[a]=n}),t}async setCookie(e){try{const t=Ir(e.key),a=Ir(e.value),n=`; expires=${(e.expires||"").replace("expires=","")}`,s=(e.path||"/").replace("path=",""),i=null!=e.url&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${t}=${a||""}${n}; path=${s}; ${i};`}catch(t){return Promise.reject(t)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(t){return Promise.reject(t)}}async clearCookies(){try{const e=document.cookie.split(";")||[];for(const t of e)document.cookie=t.replace(/^ +/,"").replace(/=.*/,`=;expires=${(new Date).toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}}Ar("CapacitorCookies",{web:()=>new Tr});const Br=(e,t={})=>{const a=Object.assign({method:e.method||"GET",headers:e.headers},t),n=((e={})=>{const t=Object.keys(e);return Object.keys(e).map(e=>e.toLocaleLowerCase()).reduce((a,n,s)=>(a[n]=e[t[s]],a),{})})(e.headers)["content-type"]||"";if("string"==typeof e.data)a.body=e.data;else if(n.includes("application/x-www-form-urlencoded")){const t=new URLSearchParams;for(const[a,n]of Object.entries(e.data||{}))t.set(a,n);a.body=t.toString()}else if(n.includes("multipart/form-data")||e.data instanceof FormData){const t=new FormData;if(e.data instanceof FormData)e.data.forEach((e,a)=>{t.append(a,e)});else for(const a of Object.keys(e.data))t.append(a,e.data[a]);a.body=t;const n=new Headers(a.headers);n.delete("content-type"),a.headers=n}else(n.includes("application/json")||"object"==typeof e.data)&&(a.body=JSON.stringify(e.data));return a};class Pr extends Er{async request(e){const t=Br(e,e.webFetchExtra),a=((e,t=!0)=>{if(!e)return null;const a=Object.entries(e).reduce((e,a)=>{const[n,s]=a;let i,r;return Array.isArray(s)?(r="",s.forEach(e=>{i=t?encodeURIComponent(e):e,r+=`${n}=${i}&`}),r.slice(0,-1)):(i=t?encodeURIComponent(s):s,r=`${n}=${i}`),`${e}&${r}`},"");return a.substr(1)})(e.params,e.shouldEncodeUrlParams),n=a?`${e.url}?${a}`:e.url,s=await fetch(n,t),i=s.headers.get("content-type")||"";let r,o,{responseType:l="text"}=s.ok?e:{};switch(i.includes("application/json")&&(l="json"),l){case"arraybuffer":case"blob":o=await s.blob(),r=await(async e=>new Promise((t,a)=>{const n=new FileReader;n.onload=()=>{const e=n.result;t(e.indexOf(",")>=0?e.split(",")[1]:e)},n.onerror=e=>a(e),n.readAsDataURL(e)}))(o);break;case"json":r=await s.json();break;default:r=await s.text()}const d={};return s.headers.forEach((e,t)=>{d[t]=e}),{data:r,headers:d,status:s.status,url:s.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}}Ar("CapacitorHttp",{web:()=>new Pr});const Rr=Ar("Midi");function Dr(e){const[t]=a.useState(()=>(()=>{var e,t;if("undefined"==typeof window)return!1;const a=window.Capacitor||Nr;return!0===(null==(e=null==a?void 0:a.isNativePlatform)?void 0:e.call(a))&&"android"===(null==(t=null==a?void 0:a.getPlatform)?void 0:t.call(a))})()&&Nr.isPluginAvailable("Midi")),[n,s]=a.useState(!1),[i,r]=a.useState([]),[o,l]=a.useState([]),[d,c]=a.useState(null),[u,m]=a.useState(null),h=a.useRef(null),f=a.useRef(new Map),p=t&&"function"==typeof Rr.sendNoteOn,g=a.useCallback(e=>{if("cc"!==e.type)return!1;const t=`${e.inputId}:${e.channel}:${e.cc}`,a=Date.now(),n=f.current.get(t);return!!(n&&n.value===e.value&&a-n.at<20)||(f.current.set(t,{value:e.value,at:a}),f.current.size>256&&f.current.clear(),!1)},[]),b=a.useCallback(async()=>{if(t)try{const e=await Rr.requestAccess();s((null==e?void 0:e.granted)??!0);const t=await Rr.getInputs();if(r(t.inputs||[]),Rr.getOutputs){const e=await Rr.getOutputs();l(e.outputs||[])}m(null)}catch(e){m(e instanceof Error?e.message:"Failed to access native MIDI.")}else m("Native MIDI is not available on this device.")},[t]),v=a.useCallback(async e=>{if(c(e),t)try{await Rr.selectInput({id:e})}catch(a){m(a instanceof Error?a.message:"Failed to select MIDI input.")}},[t]);a.useEffect(()=>{if(!t||!e)return void(h.current&&(h.current.remove(),h.current=null));const a=Rr.addListener("midi",e=>{g(e)||"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("vdjv-midi",{detail:e}))});return Promise.resolve(a).then(e=>{h.current=e}),()=>{h.current&&(h.current.remove(),h.current=null)}},[e,g,t]);const y=a.useCallback((e,a,n)=>{t&&Rr.sendNoteOn&&Rr.sendNoteOn({note:e,velocity:a,channel:null==n?void 0:n.channel,outputId:null==n?void 0:n.outputId,outputName:null==n?void 0:n.outputName}).catch(()=>{})},[t]),_=a.useCallback((e,a)=>{t&&Rr.sendNoteOff&&Rr.sendNoteOff({note:e,channel:null==a?void 0:a.channel,outputId:null==a?void 0:a.outputId,outputName:null==a?void 0:a.outputName}).catch(()=>{})},[t]);return{backend:"native",supported:t,outputSupported:p,accessGranted:n,inputs:i,outputs:o,selectedInputId:d,setSelectedInputId:v,requestAccess:b,lastMessage:null,error:u,sendNoteOn:y,sendNoteOff:_}}const Or="vdjv-midi-selected-input",Lr=e=>e?Array.from(e.inputs.values()).map(e=>({id:e.id,name:e.name||void 0,manufacturer:e.manufacturer||void 0})):[],Fr=e=>e?Array.from(e.outputs.values()).map(e=>({id:e.id,name:e.name||void 0,manufacturer:e.manufacturer||void 0})):[];function Ur(){const[e,t]=a.useState(!1),n=function(e){const[t]=a.useState(()=>"undefined"!=typeof navigator&&!!navigator.requestMIDIAccess),[n,s]=a.useState(null),[i,r]=a.useState([]),[o,l]=a.useState([]),[d,c]=a.useState(null),[u,m]=a.useState(null),h=a.useRef(null),f=a.useRef(new Map),p=a.useCallback(e=>{if("cc"!==e.type)return!1;const t=`${e.inputId}:${e.channel}:${e.cc}`,a=Date.now(),n=f.current.get(t);return!!(n&&n.value===e.value&&a-n.at<20)||(f.current.set(t,{value:e.value,at:a}),f.current.size>256&&f.current.clear(),!1)},[]),g=a.useCallback(async()=>{if(t)try{const e=await navigator.requestMIDIAccess();s(e),r(Lr(e)),l(Fr(e)),e.onstatechange=()=>{r(Lr(e)),l(Fr(e))},m(null)}catch(e){m(e instanceof Error?e.message:"Failed to access MIDI devices.")}else m("Web MIDI is not supported in this browser.")},[t]);a.useEffect(()=>{if(!n||!e)return void(h.current&&(h.current.onmidimessage=null,h.current=null));const t=n.inputs,a=d&&t.get(d)||null;h.current&&h.current!==a&&(h.current.onmidimessage=null),a?(a.onmidimessage=e=>{const t=(e=>{const t=e.data;if(!t||t.length<2)return null;const a=t[0],n=240&a,s=15&a,i=e.currentTarget,r=(null==i?void 0:i.id)||"unknown",o=(null==i?void 0:i.name)||void 0;if(144===n){const e=t[1],a=t[2]??0;return 0===a?{type:"noteoff",note:e,velocity:a,channel:s,inputId:r,inputName:o}:{type:"noteon",note:e,velocity:a,channel:s,inputId:r,inputName:o}}return 128===n?{type:"noteoff",note:t[1],velocity:t[2]??0,channel:s,inputId:r,inputName:o}:176===n?{type:"cc",cc:t[1],value:t[2]??0,channel:s,inputId:r,inputName:o}:null})(e);t&&(p(t)||"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("vdjv-midi",{detail:t})))},h.current=a):d||(h.current=null)},[n,e,d,p]),a.useEffect(()=>{if("undefined"!=typeof window&&e&&i.length&&(!d||!i.some(e=>e.id===d)))try{const e=localStorage.getItem(Or),t=e?JSON.parse(e):null,a=null==t?void 0:t.id,n=null==t?void 0:t.name,s=a?i.find(e=>e.id===a):void 0,r=!s&&n?i.find(e=>e.name===n):void 0,o=s||r||i[0];o&&o.id!==d&&c(o.id)}catch{}},[e,i,d]),a.useEffect(()=>{if("undefined"==typeof window)return;if(!d)return;const e=i.find(e=>e.id===d);if(e)try{localStorage.setItem(Or,JSON.stringify({id:e.id,name:e.name||""}))}catch{}},[d,i]);const b=a.useCallback((e,t,a)=>{if(!n)return;const s=(null==a?void 0:a.channel)??0,i=n.outputs;let r;(null==a?void 0:a.outputId)&&(r=i.get(a.outputId)),!r&&(null==a?void 0:a.outputName)&&(r=Array.from(i.values()).find(e=>e.name===a.outputName)),r||(r=i.values().next().value),r&&r.send([144+s,e,Math.max(0,Math.min(127,t))])},[n]),v=a.useCallback((e,t)=>{if(!n)return;const a=(null==t?void 0:t.channel)??0,s=n.outputs;let i;(null==t?void 0:t.outputId)&&(i=s.get(t.outputId)),!i&&(null==t?void 0:t.outputName)&&(i=Array.from(s.values()).find(e=>e.name===t.outputName)),i||(i=s.values().next().value),i&&i.send([128+a,e,0])},[n]);return{backend:"web",supported:t,outputSupported:o.length>0,accessGranted:!!n,inputs:i,outputs:o,selectedInputId:d,setSelectedInputId:c,requestAccess:g,lastMessage:null,error:u,sendNoteOn:b,sendNoteOff:v}}(e),s=Dr(e),i=a.useMemo(()=>(()=>{var e,t;if("undefined"==typeof window)return!1;const a=window.Capacitor||Nr;return!0===(null==(e=null==a?void 0:a.isNativePlatform)?void 0:e.call(a))&&"android"===(null==(t=null==a?void 0:a.getPlatform)?void 0:t.call(a))})()&&s.supported,[s.supported])?s:n;return{backend:i.backend,supported:i.supported,outputSupported:i.outputSupported,enabled:e,accessGranted:i.accessGranted,inputs:i.inputs,outputs:i.outputs,selectedInputId:i.selectedInputId,setSelectedInputId:i.setSelectedInputId,setEnabled:t,requestAccess:i.requestAccess,lastMessage:i.lastMessage,error:i.error,sendNoteOn:i.sendNoteOn,sendNoteOff:i.sendNoteOff}}const Vr=e=>yt(e),$r=e=>yt(e),Hr={id:"akai-apc-mini-mk2",name:"Akai APC mini mk2",matches:e=>{if(!e)return!1;const t=e.toLowerCase();return t.includes("apc mini mk2")||t.includes("akai apc")},mapColorToVelocity:$r,resolveLed:(e,t,a)=>{const n=e>=100&&e<=107?"#ff0000":e>=112&&e<=119?"#00ff00":null;return n?{color:n,channel:a,velocity:127}:{color:t,channel:a,velocity:$r(t)}}},Kr=[Hr,{id:"generic",name:"Generic (no fixed button colors)",matches:()=>!1,mapColorToVelocity:Vr,resolveLed:(e,t,a)=>({color:t,channel:a,velocity:Vr(t)})}],qr="vdjv-sampler-settings",zr="VDJV-Export",Gr=async(e,t)=>{if((()=>{var e;if("undefined"==typeof window)return!1;const t=navigator.userAgent,a=/Android/.test(t),n=window.Capacitor;return a&&!0===(null==(e=null==n?void 0:n.isNativePlatform)?void 0:e.call(n))})())try{const{Filesystem:a,Directory:n}=await U(async()=>{const{Filesystem:e,Directory:t}=await import("./index-DcmRPkj8.js");return{Filesystem:e,Directory:t}},__vite__mapDeps([5,4,2,1,3])),i=await new Promise((t,a)=>{const n=new FileReader;n.onloadend=()=>{const e=n.result.split(",")[1];t(e)},n.onerror=a,n.readAsDataURL(e)}),r=`Download/${zr}/${t}`,o=`/storage/emulated/0/Download/${zr}/${t}`;try{"granted"!==(await a.checkPermissions()).publicStorage&&await a.requestPermissions()}catch{}try{return await a.writeFile({path:o,data:i,recursive:!0}),`Mappings exported to ${r}`}catch(s){console.warn("Download folder write failed, falling back to Documents:",s)}return await a.writeFile({path:`${zr}/${t}`,data:i,directory:n.Documents,recursive:!0}),`Mappings exported to Documents/${zr}/${t}`}catch(i){console.error("Failed to save mappings using Capacitor Filesystem:",i)}const a=URL.createObjectURL(e),n=document.createElement("a");return n.href=a,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a),`Mappings exported to selected path (${t})`},Xr={masterVolume:1,eqSettings:{low:0,mid:0,high:0},stopMode:"instant",sideMenuOpen:!1,mixerOpen:!1,channelCount:4,mixerEqCollapsed:"undefined"==typeof window||window.innerWidth<768,channelCollapsedMap:{},deckLayout:[],sidePanelMode:"overlay",editMode:!1,padSize:5,hideShortcutLabels:!0,autoPadBankMapping:!0,midiEnabled:!1,midiDeviceProfileId:null,systemMappings:dn},Wr=e=>{const t={...dn,...e||{}};return"toggleTheme"in t&&delete t.toggleTheme,"number"==typeof t.channelCount&&Number.isFinite(t.channelCount)?t.channelCount=Math.max(2,Math.min(8,Math.floor(t.channelCount))):t.channelCount=dn.channelCount,t};function Yr(){var e;const{banks:t,primaryBankId:s,secondaryBankId:i,currentBankId:r,primaryBank:o,secondaryBank:l,currentBank:d,isDualMode:c,addPad:u,updatePad:m,removePad:h,createBank:f,setPrimaryBank:p,setSecondaryBank:g,setCurrentBank:b,updateBank:v,deleteBank:y,importBank:_,exportBank:x,reorderPads:w,moveBankUp:k,moveBankDown:M,transferPad:S,exportAdminBank:C,canTransferFromBank:N,exportAppBackup:A,restoreAppBackup:E,recoverMissingMediaFromBanks:I}=_r(),j=$e(),{theme:T,toggleTheme:B}=xr(),{width:P,height:R}=function(){const[e,t]=a.useState({width:"undefined"!=typeof window?window.innerWidth:1024,height:"undefined"!=typeof window?window.innerHeight:768});return a.useEffect(()=>{if("undefined"!=typeof window)return window.addEventListener("resize",e),e(),()=>window.removeEventListener("resize",e);function e(){t({width:window.innerWidth,height:window.innerHeight})}},[]),e}(),D=Ur(),{user:O,profile:L}=Qa(),F=a.useRef(null),V="admin"===(null==L?void 0:L.role),[$,H]=a.useState(()=>{if("undefined"==typeof window)return Xr;try{const e=localStorage.getItem(qr);if(e){const t=JSON.parse(e),a=Wr(t.systemMappings||{}),n="number"==typeof t.channelCount?Math.max(2,Math.min(8,Math.floor(t.channelCount))):Xr.channelCount;return{...Xr,...t,channelCount:n,mixerEqCollapsed:"boolean"==typeof t.mixerEqCollapsed?t.mixerEqCollapsed:Xr.mixerEqCollapsed,channelCollapsedMap:"object"==typeof t.channelCollapsedMap&&t.channelCollapsedMap?t.channelCollapsedMap:{},deckLayout:Array.isArray(t.deckLayout)?t.deckLayout:[],systemMappings:{...a,channelCount:n}}}}catch(e){console.warn("Failed to load settings:",e)}return Xr}),[K,q]=a.useState(!1),[z,G]=a.useState(null),[X,W]=a.useState(!1),[Y,Z]=a.useState(null),J=a.useRef(null),Q=a.useRef(null),[ee,te]=a.useState(null),[ae,ne]=a.useState(null),[se,ie]=a.useState(null),[re,oe]=a.useState(null),le=a.useRef(new Map),de=a.useRef(null),ce=a.useRef(null),ue=a.useRef(null),me=a.useRef(0),he=a.useRef(0),fe=a.useRef(0),pe=a.useRef(null),ge=a.useRef(null),be=a.useRef(null),ve=a.useRef(!1),ye=a.useRef("");a.useEffect(()=>{$.mixerOpen&&!ee&&U(()=>import("./VolumeMixer-Jyskqlbo.js"),__vite__mapDeps([7,1,2,3,4])).then(e=>{te(()=>e.VolumeMixer)}).catch(e=>{console.error("Failed to load VolumeMixer:",e)})},[$.mixerOpen,ee]),a.useEffect(()=>("undefined"!=typeof window&&(null!==F.current&&window.clearTimeout(F.current),F.current=window.setTimeout(()=>{try{localStorage.setItem(qr,JSON.stringify($))}catch(e){console.warn("Failed to save settings:",e)}},200)),()=>{null!==F.current&&(window.clearTimeout(F.current),F.current=null)}),[$]),a.useEffect(()=>{const e="number"==typeof $.systemMappings.channelCount?Math.max(2,Math.min(8,Math.floor($.systemMappings.channelCount))):null;null!==e&&e!==$.channelCount&&H(t=>({...t,channelCount:e,systemMappings:{...t.systemMappings,channelCount:e}}))},[$.channelCount,$.systemMappings.channelCount]),a.useEffect(()=>{$.midiEnabled&&D.enabled&&!D.accessGranted&&D.requestAccess()},[$.midiEnabled,D.enabled,D.accessGranted,D.requestAccess]),a.useEffect(()=>{D.enabled!==$.midiEnabled&&D.setEnabled($.midiEnabled)},[D,$.midiEnabled]),a.useEffect(()=>{var e,t;if("undefined"==typeof window)return;const a=window.Capacitor;if(!(null==(e=null==a?void 0:a.isNativePlatform)?void 0:e.call(a)))return;const n=null==(t=null==a?void 0:a.Plugins)?void 0:t.App;if(!(null==n?void 0:n.addListener))return;let s=!1,i=null;return(async()=>{try{const e=await n.addListener("appStateChange",({isActive:e})=>{e&&j.preUnlockAudio().catch(e=>{console.warn("Failed to restore audio after app resume:",e)})});if(s)return void(await e.remove());i=()=>{e.remove()}}catch(e){console.warn("Capacitor appStateChange listener setup failed:",e)}})(),()=>{s=!0,i&&i()}},[j]),a.useEffect(()=>{const e=e=>{const t=e.detail;!t||t.missingAudio<=0&&t.missingImages<=0||Z(t)};return window.addEventListener("vdjv-missing-media-detected",e),()=>window.removeEventListener("vdjv-missing-media-detected",e)},[]);const _e=a.useCallback((e,t)=>{H(a=>({...a,[e]:t}))},[]),xe=a.useCallback(e=>{ne({padId:e,token:Date.now()})},[]),we=a.useCallback(e=>{ie({bankId:e,token:Date.now()})},[]),ke=a.useCallback(e=>{_e("hideShortcutLabels",e)},[_e]),Me=a.useCallback(e=>{_e("midiEnabled",e),D.setEnabled(e),e?D.accessGranted||D.requestAccess():D.setSelectedInputId(null)},[D,_e]),Se=a.useMemo(()=>"undefined"!=typeof navigator&&/Mac|iPhone|iPad|iPod/.test(navigator.userAgent),[]),Ce=a.useMemo(()=>["1","2","3","4","5","6","7","8","9","0","Q","W","E","R","T","Y","U","I","O","P","A","S","D","F","G","H","J","K","L",";","Numpad1","Numpad2","Numpad3","Numpad4","Numpad5","Numpad6","Numpad7","Numpad8","Numpad9","Numpad0"],[]),Ne=a.useMemo(()=>{const e=Se?"Meta":"Alt";return[`${e}+1`,`${e}+2`,`${e}+3`,`${e}+4`,`${e}+5`,`${e}+6`,`${e}+7`,`${e}+8`,`${e}+9`,`${e}+0`]},[Se]),Ae=a.useCallback(e=>{if(!$.autoPadBankMapping)return;if(!e)return;const a=t.find(t=>t.id===e);if(!a)return;if(a.disableDefaultPadShortcutLayout)return;[...a.pads].sort((e,t)=>(e.position||0)-(t.position||0)).forEach((e,t)=>{const n=Ce[t]||void 0;e.shortcutKey!==n&&m(a.id,e.id,{...e,shortcutKey:n})})},[t,Ce,$.autoPadBankMapping,m]),Ee=a.useMemo(()=>[...t].sort((e,t)=>(e.sortOrder||0)-(t.sortOrder||0)),[t]),Ie=a.useRef({});a.useEffect(()=>{$.autoPadBankMapping&&(c?(s&&Ie.current.primary!==s&&(Ae(s),Ie.current.primary=s),i&&Ie.current.secondary!==i&&(Ae(i),Ie.current.secondary=i)):r&&Ie.current.single!==r&&(Ae(r),Ie.current.single=r))},[Ae,r,c,s,i,$.autoPadBankMapping]);const je=a.useRef(new Map);a.useEffect(()=>{const e=je.current,a=new Map;t.forEach(t=>{const n=t.pads.length,s=e.get(t.id)??0;a.set(t.id,n),$.autoPadBankMapping&&0===s&&n>0&&Ae(t.id)}),je.current=a},[t,Ae,$.autoPadBankMapping]);const Be=a.useCallback((e,t)=>{H(a=>({...a,systemMappings:{...a.systemMappings,[e]:{...a.systemMappings[e],...t}}}))},[]),Pe=a.useCallback((e,t)=>{Be(e,{key:t})},[Be]),Re=a.useCallback((e,t,a)=>{Be(e,{midiNote:t,midiCC:a})},[Be]),De=a.useCallback((e,t)=>{Be(e,{color:t})},[Be]),Oe=a.useCallback(e=>{H(t=>({...t,systemMappings:{...t.systemMappings,[e]:{...dn[e]}}}))},[]),Le=a.useCallback(e=>{H(t=>({...t,systemMappings:{...t.systemMappings,masterVolumeCC:e}}))},[]),Fe=a.useCallback((e,t)=>{H(a=>{const n=[...a.systemMappings.channelMappings||[]];for(;n.length<8;)n.push({keyUp:"",keyDown:"",keyStop:"",midiCC:void 0,midiNote:void 0});return n[e]={...n[e],...t},{...a,systemMappings:{...a.systemMappings,channelMappings:n}}})},[]),Ue=a.useCallback(e=>{const t=Math.max(2,Math.min(8,Math.floor(e||4)));H(e=>({...e,channelCount:t,systemMappings:{...e.systemMappings,channelCount:t}})),j.setChannelCount(t)},[j]),Ve=a.useMemo(()=>Object.keys(dn).filter(e=>"channelMappings"!==e&&"masterVolumeCC"!==e),[]),He=a.useCallback(()=>dn.channelMappings.map(e=>({...e})),[]),qe=a.useCallback(()=>{H(e=>{const t={...e.systemMappings};return Ve.forEach(e=>{t[e]={...dn[e]}}),{...e,systemMappings:t}})},[Ve]),ze=a.useCallback(()=>{H(e=>{const t={...e.systemMappings};return Ve.forEach(e=>{t[e]={key:""}}),t.masterVolumeCC=void 0,{...e,systemMappings:t}})},[Ve]),We=a.useCallback(()=>{H(e=>({...e,systemMappings:{...e.systemMappings,channelMappings:He()}}))},[He]),Ze=a.useCallback(()=>{H(e=>({...e,systemMappings:{...e.systemMappings,channelMappings:He()}}))},[He]),Je=a.useCallback(()=>{const e=$.systemMappings.channelMappings||[],a={},n={};return t.forEach(e=>{a[e.id]={shortcutKey:e.shortcutKey||"",midiNote:"number"==typeof e.midiNote?e.midiNote:null,midiCC:"number"==typeof e.midiCC?e.midiCC:null,bankName:e.name};const t={};e.pads.forEach(e=>{t[e.id]={shortcutKey:e.shortcutKey||"",midiNote:"number"==typeof e.midiNote?e.midiNote:null,midiCC:"number"==typeof e.midiCC?e.midiCC:null,padName:e.name}}),n[e.id]=t}),{version:1,exportedAt:(new Date).toISOString(),systemMappings:$.systemMappings,channelMappings:e,bankShortcutKeys:a,padShortcutKeys:n}},[t,$.systemMappings]),Qe=a.useCallback(async()=>{const e=Je(),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=(new Date).toISOString().replace(/[:.]/g,"-");return Gr(t,`vdjv-mappings-${a}.json`)},[Je]),et=a.useCallback(async e=>{const a=await e.text();let n=null;try{n=JSON.parse(a)}catch(y){throw new Error("Invalid mapping file: JSON parse failed.")}if(!n||"object"!=typeof n)throw new Error("Invalid mapping file: missing data.");const s="object"==typeof n.systemMappings&&n.systemMappings?n.systemMappings:null,i=Array.isArray(n.channelMappings)?n.channelMappings:Array.isArray(null==s?void 0:s.channelMappings)?s.channelMappings||[]:$.systemMappings.channelMappings||[],r=Wr(s||{});r.channelMappings=i,H(e=>({...e,systemMappings:r}));const o=new Map(t.map(e=>[e.id,e])),l=n.bankShortcutKeys&&"object"==typeof n.bankShortcutKeys?n.bankShortcutKeys:{},d=n.padShortcutKeys&&"object"==typeof n.padShortcutKeys?n.padShortcutKeys:{},c=Object.keys(l).length>0,u=Object.keys(d).length>0,h=new Map;Object.entries(l).forEach(([e,t])=>{const a=t;(null==a?void 0:a.bankName)&&h.set(e,a.bankName)}),c&&t.forEach(e=>{v(e.id,{shortcutKey:void 0,midiNote:void 0,midiCC:void 0})}),u&&t.forEach(e=>{e.pads.forEach(t=>{m(e.id,t.id,{...t,shortcutKey:void 0,midiNote:void 0,midiCC:void 0})})});let f=0,p=0,g=0,b=0;return Object.entries(l).forEach(([e,a])=>{const n=a;let s=o.get(e);if(!s&&(null==n?void 0:n.bankName)&&(s=t.find(e=>e.name===n.bankName)),!s)return void(p+=1);if(!a||"object"!=typeof a)return;const i="string"==typeof n.shortcutKey?n.shortcutKey:"";v(s.id,{shortcutKey:i||void 0,midiNote:"number"==typeof n.midiNote?n.midiNote:void 0,midiCC:"number"==typeof n.midiCC?n.midiCC:void 0}),f+=1}),Object.entries(d).forEach(([e,a])=>{let n=o.get(e);if(!n){const a=h.get(e);a&&(n=t.find(e=>e.name===a))}if(!n)return a&&"object"==typeof a&&(b+=Object.keys(a).length),void(p+=1);a&&"object"==typeof a&&Object.entries(a).forEach(([e,t])=>{let a=n.pads.find(t=>t.id===e);if(!a&&(null==t?void 0:t.padName)&&(a=n.pads.find(e=>e.name===t.padName)),!a)return void(b+=1);const s="string"==typeof t.shortcutKey?t.shortcutKey:"",i={...a,shortcutKey:s||void 0,midiNote:"number"==typeof t.midiNote?t.midiNote:void 0,midiCC:"number"==typeof t.midiCC?t.midiCC:void 0};m(n.id,a.id,i),g+=1})}),`Mappings imported. Banks: ${f} updated, ${p} skipped. Pads: ${g} updated, ${b} skipped.`},[t,$.systemMappings,v,m,H]),tt=a.useCallback(async e=>{const t={settings:$,mappings:Je(),state:{primaryBankId:s,secondaryBankId:i,currentBankId:r}};return A(t,e)},[$,Je,s,i,r,A]),at=a.useCallback(async(e,t=[])=>{const a=await E(e,t);if(a.settings){const e=a.settings;H(t=>({...t,...e,systemMappings:Wr(e.systemMappings||t.systemMappings)}))}if(a.mappings){const e=a.mappings;(null==e?void 0:e.systemMappings)&&H(t=>({...t,systemMappings:Wr(e.systemMappings)}))}return a.message},[E,H]),nt=a.useCallback(async e=>I(e),[I]);a.useEffect(()=>{j.setChannelCount($.channelCount)},[j,$.channelCount]),a.useEffect(()=>{if(ve.current)return;if(!t.length)return;let e=!1;return(async()=>{var a;for(const n of $.deckLayout||[]){if(e)return;if(!(null==(a=null==n?void 0:n.loadedPadRef)?void 0:a.padId)||"number"!=typeof n.channelId)continue;const s=t.find(e=>{var t;return e.id===(null==(t=n.loadedPadRef)?void 0:t.bankId)}),i=null==s?void 0:s.pads.find(e=>{var t;return e.id===(null==(t=n.loadedPadRef)?void 0:t.padId)});if(!s||!i)continue;await j.registerPad(i.id,i,s.id,s.name);j.loadPadToChannel(n.channelId,i.id)&&(Array.isArray(n.hotcuesMs)&&n.hotcuesMs.slice(0,4).forEach((e,t)=>{"number"==typeof e?j.setChannelHotcue(n.channelId,t,e):j.clearChannelHotcue(n.channelId,t)}),"boolean"==typeof n.collapsed&&j.setChannelCollapsed(n.channelId,n.collapsed),"number"==typeof n.channelVolume&&j.setChannelVolume(n.channelId,n.channelVolume))}j.resetDeckPlaybackToStart(),ve.current=!0})(),()=>{e=!0}},[t,j,$.deckLayout]);const st=a.useCallback(e=>Math.max(0,Math.min(127,e))/127,[]),it=j.getChannelStates(),rt=j.getLegacyPlayingPads();a.useEffect(()=>{const e=j.persistDeckLayoutSnapshot(),t=JSON.stringify(e);ye.current!==t&&(ye.current=t,H(a=>{if(JSON.stringify(a.deckLayout||[])===t)return a;const n={};return e.forEach(e=>{n[e.channelId]=!!e.collapsed}),{...a,deckLayout:e,channelCollapsedMap:n}}))},[it,j]);const ot=a.useCallback(()=>{const e=D.inputs.find(e=>e.id===D.selectedInputId);return null==e?void 0:e.name},[D.inputs,D.selectedInputId]),lt=a.useRef(new Set),dt=a.useRef(new Map),ct=a.useRef(new Map),[ut,mt]=a.useState(0),pt=a.useCallback((e,t)=>{dt.current.set(`${e}:${t}`,Date.now())},[]),bt=a.useCallback((e,t,a,n=250)=>{"number"==typeof e&&(ct.current.set(e,{until:Date.now()+n,color:t,channel:a}),mt(Date.now()),window.setTimeout(()=>mt(Date.now()),n+20))},[]),[vt,yt]=a.useState(!1),[_t,xt]=a.useState(!1);a.useEffect(()=>{const e=()=>yt(!0),t=()=>yt(!1),a=()=>xt(!0),n=()=>xt(!1);return window.addEventListener("vdjv-upload-start",e),window.addEventListener("vdjv-upload-end",t),window.addEventListener("vdjv-import-start",a),window.addEventListener("vdjv-import-end",n),()=>{window.removeEventListener("vdjv-upload-start",e),window.removeEventListener("vdjv-upload-end",t),window.removeEventListener("vdjv-import-start",a),window.removeEventListener("vdjv-import-end",n)}},[]),a.useEffect(()=>{if(!D.accessGranted)return;const e=ot(),a=new Set,n=new Set,o=new Set,l=new Set(j.getAllPlayingPads().map(e=>`${e.bankId}:${e.padId}`)),d=$.midiDeviceProfileId?(m=$.midiDeviceProfileId)&&Kr.find(e=>e.id===m)||Hr:(u=e,Kr.find(e=>e.matches(u))||Hr);var u,m;const h=(e,t,a)=>d.resolveLed(e,t,a),f=Na.current,p=c?f?i:s:r;if(t.forEach(t=>{if(t.pads.forEach(e=>{"number"==typeof e.midiNote&&n.add(e.midiNote)}),"number"==typeof t.midiNote){const n=(c?t.id===s||t.id===i:t.id===r)?7:0,o=h(t.midiNote,t.defaultColor,n);D.sendNoteOn(t.midiNote,o.velocity,{outputName:e,channel:o.channel}),pt(t.midiNote,o.channel),a.add(t.midiNote)}}),p){const n=t.find(e=>e.id===p);n&&n.pads.forEach(t=>{if("number"!=typeof t.midiNote)return;o.add(t.midiNote);const s=$.editMode?0:6;if(l.has(`${n.id}:${t.id}`)){const n=h(t.midiNote,t.color,13);return D.sendNoteOn(t.midiNote,n.velocity,{outputName:e,channel:n.channel}),pt(t.midiNote,n.channel),void a.add(t.midiNote)}const i=h(t.midiNote,t.color,s);D.sendNoteOn(t.midiNote,i.velocity,{outputName:e,channel:i.channel}),pt(t.midiNote,i.channel),a.add(t.midiNote)})}const g={stopAll:"#00ff00",mixer:"#00a9ff",editMode:"#ffff00",mute:"#ff0000",banksMenu:"#00a9ff",nextBank:"#ffffff",prevBank:"#ffffff",upload:"#ffffff",volumeUp:"#ffffff",volumeDown:"#ffffff",padSizeUp:"#ffffff",padSizeDown:"#ffffff",importBank:"#ffffff",activateSecondary:"#7f00ff",midiShift:"#00a9ff"};Object.keys(dn).filter(e=>"masterVolumeCC"!==e&&"channelMappings"!==e).forEach(t=>{var n;const s=t,r=$.systemMappings[s];if("number"!=typeof(null==r?void 0:r.midiNote))return;const o=ct.current.get(r.midiNote),l=Date.now();if(o&&o.until>l){const t=h(r.midiNote,o.color,o.channel);return D.sendNoteOn(r.midiNote,t.velocity,{outputName:e,channel:t.channel}),pt(r.midiNote,t.channel),void a.add(r.midiNote)}const d=r.color||g[s]||(null==(n=gt[0])?void 0:n.hex);let u=0;if("mixer"===s&&(u=$.mixerOpen?6:0),"banksMenu"===s&&(u=$.sideMenuOpen?6:0),"editMode"===s&&(u=$.editMode?6:0),"activateSecondary"===s&&(u=c?6:0),"midiShift"===s){u=c&&Boolean(i)?f?13:6:0}"upload"===s&&vt&&(u=13),"importBank"===s&&_t&&(u=13);const m="midiShift"===s&&f?"#ff0000":d,p=h(r.midiNote,m,u);D.sendNoteOn(r.midiNote,p.velocity,{outputName:e,channel:p.channel}),pt(r.midiNote,p.channel),a.add(r.midiNote)});($.systemMappings.channelMappings||[]).forEach(t=>{if("number"!=typeof(null==t?void 0:t.midiNote))return;const n=h(t.midiNote,"#ff0000",6);D.sendNoteOn(t.midiNote,n.velocity,{outputName:e,channel:n.channel}),pt(t.midiNote,n.channel),a.add(t.midiNote)});const b=[6,0,7,13];n.forEach(t=>{o.has(t)||a.has(t)||b.forEach(a=>{D.sendNoteOn(t,0,{outputName:e,channel:a}),pt(t,a)})}),lt.current.forEach(t=>{a.has(t)||b.forEach(a=>{D.sendNoteOn(t,0,{outputName:e,channel:a}),pt(t,a)})}),lt.current=a},[t,$.systemMappings,D,ot,j,c,s,i,r,pt,$.editMode,$.mixerOpen,$.sideMenuOpen,T,vt,_t,ut,$.midiDeviceProfileId]),a.useEffect(()=>{const e=e=>{var t;console.error("Application Error:",e.error),G(`An error occurred: ${(null==(t=e.error)?void 0:t.message)||"Unknown error"}`),W(!0)},t=e=>{var t;console.error("Unhandled Promise Rejection:",e.reason),G(`Promise rejection: ${(null==(t=e.reason)?void 0:t.message)||"Unknown error"}`),W(!0)};return window.addEventListener("error",e),window.addEventListener("unhandledrejection",t),()=>{window.removeEventListener("error",e),window.removeEventListener("unhandledrejection",t)}},[]),a.useEffect(()=>{P<768&&$.sideMenuOpen&&$.mixerOpen&&_e("mixerOpen",!1)},[P,$.sideMenuOpen,$.mixerOpen,_e]),a.useEffect(()=>{j.setGlobalMute(K)},[K,j]),a.useEffect(()=>{j.setMasterVolume($.masterVolume)},[$.masterVolume,j]),a.useEffect(()=>{j.applyGlobalEQ($.eqSettings)},[$.eqSettings,j]);const wt=a.useCallback(e=>{_e("sideMenuOpen",e),e&&P<768&&_e("mixerOpen",!1)},[P,_e]),kt=a.useCallback(e=>{_e("mixerOpen",e),e&&P<768&&_e("sideMenuOpen",!1)},[P,_e]),Mt=a.useMemo(()=>{const e=P<900&&R>P;return"overlay"===$.sidePanelMode||e},[$.sidePanelMode,R,P]);a.useEffect(()=>{if(null===re)return;const e=Math.max(2,Math.min(8,$.channelCount||4));re>e&&oe(null)},[re,$.channelCount]);const St=a.useCallback(async(e,t)=>{try{if(!(O||Fa()))return void window.dispatchEvent(new Event("vdjv-login-request"));if(!e.type.startsWith("audio/"))return G("Invalid file type. Please select an audio file."),void W(!0);const a=50,n=1024*a*1024;if(e.size>n)return G(`Audio file is too large (${(e.size/1024/1024).toFixed(1)}MB). Maximum size allowed is ${a}MB. Please use a smaller audio file.`),void W(!0);window.dispatchEvent(new Event("vdjv-upload-start")),await u(e,t),window.dispatchEvent(new Event("vdjv-upload-end"))}catch(a){console.error("Error uploading file:",a),window.dispatchEvent(new Event("vdjv-upload-end")),a instanceof Error?G(a.message):G("Failed to upload file. Please try again."),W(!0)}},[u,O]),Nt=a.useCallback(()=>{j.stopAllPads($.stopMode)},[j,$.stopMode]),At=a.useCallback(e=>{j.stopPad(e,$.stopMode)},[j,$.stopMode]),Et=a.useCallback(()=>{q(!K)},[K]),It=a.useCallback((e,a)=>{for(const n of t){const t=n.pads.find(t=>t.id===e);if(t){m(n.id,e,{...t,volume:a});break}}j.updatePadVolume(e,a)},[t,m,j]),jt=a.useCallback((e,t)=>{j.setChannelVolume(e,t)},[j]),Tt=a.useCallback(e=>{j.stopChannel(e,$.stopMode)},[j,$.stopMode]),Bt=a.useCallback(e=>{j.pauseChannel(e)},[j]),Pt=a.useCallback(e=>{j.playChannel(e)},[j]),Rt=a.useCallback((e,t)=>{j.seekChannel(e,t)},[j]),Dt=a.useCallback(e=>{j.unloadChannel(e)},[j]),Ot=a.useCallback((e,t,a)=>{j.setChannelHotcue(e,t,a)},[j]),Lt=a.useCallback((e,t)=>{j.triggerChannelHotcue(e,t)},[j]),Ft=a.useCallback(e=>{const a=j.saveChannelHotcuesToPad(e);if(a.ok&&a.padId)for(const n of t){const t=n.pads.find(e=>e.id===a.padId);if(t){const a=j.getChannelStates().find(t=>t.channelId===e);if(!a)return;return void m(n.id,t.id,{...t,savedHotcuesMs:a.hotcuesMs})}}},[t,j,m]),Ut=a.useCallback((e,t)=>{j.setChannelCollapsed(e,t)},[j]),Vt=a.useCallback(e=>{const t=re===e;oe(t?null:e),!t&&Mt&&(_e("sideMenuOpen",!1),_e("mixerOpen",!1))},[re,Mt,_e]),$t=a.useCallback(()=>{oe(null)},[]),Ht=a.useCallback(async(e,t,a)=>{if(null===re)return;const n=re;try{await j.registerPad(e.id,e,t,a);if(!j.loadPadToChannel(n,e.id))return G(`Failed to load "${e.name}" into Channel ${n}.`),void W(!0);oe(null),_e("mixerOpen",!0)}catch(s){G(s instanceof Error?s.message:"Failed to load pad into channel."),W(!0)}},[re,j,_e]),Kt=a.useCallback(e=>{c&&e%2!=0&&(e=e>1?e-1:e+1),_e("padSize",e)},[c,_e]);a.useCallback(()=>{_e("padSize",4)},[_e]);const qt=P<768?6:14,zt=a.useCallback(()=>{let e=$.padSize+1;c&&e%2!=0&&e<qt&&(e+=1),e<=qt&&Kt(e)},[$.padSize,c,qt,Kt]),Gt=a.useCallback(()=>{let e=$.padSize-1;c&&e%2!=0&&e>1&&(e-=1),e>=1&&Kt(e)},[$.padSize,c,Kt]),Xt=a.useCallback((e,t)=>{console.log("Removing pad and cleaning up playback:",t),j.unregisterPad(t),h(e,t)},[j,h]),Wt=a.useCallback(e=>{const a=t.find(t=>t.id===e);a&&(console.log("Cleaning up playback for all pads in bank:",e),a.pads.forEach(e=>{j.unregisterPad(e.id)})),y(e)},[t,j,y]),Yt=a.useCallback(async(e,a,n)=>{try{let e=t.find(e=>e.pads.some(e=>e.id===a));if(!e)throw new Error("Pad not found");const s=e.pads.find(e=>e.id===a);if(!s)throw new Error("Pad not found");const i={...s,...n,imageData:void 0!==n.imageData?n.imageData:s.imageData,imageUrl:void 0!==n.imageUrl?n.imageUrl:s.imageUrl};await m(e.id,a,i)}catch(s){console.error("Failed to update pad:",s),s instanceof Error?G(s.message):G("Failed to update pad. Please try again."),W(!0)}},[t,m]),Zt=a.useMemo(()=>{const e=new Map;return t.forEach(t=>{const a=new Map;t.pads.forEach(e=>{const n=ft(e.shortcutKey);n&&a.set(n,{pad:{...e,shortcutKey:n},bankId:t.id,bankName:t.name})}),e.set(t.id,a)}),e},[t,ft]),Jt=a.useMemo(()=>{const e=new Map;return t.forEach(t=>{const a=new Map;t.pads.forEach(e=>{const n=e;"number"==typeof n.midiNote&&a.set(n.midiNote,{pad:n,bankId:t.id,bankName:t.name})}),e.set(t.id,a)}),e},[t]),Qt=a.useMemo(()=>{const e=new Map;return t.forEach(t=>{const a=new Map;t.pads.forEach(e=>{const n=e;"number"==typeof n.midiCC&&a.set(n.midiCC,{pad:n,bankId:t.id,bankName:t.name})}),e.set(t.id,a)}),e},[t]),ea=a.useMemo(()=>{const e=new Map;return t.forEach(t=>{"number"==typeof t.midiNote&&e.set(t.midiNote,{bankId:t.id,bankName:t.name})}),e},[t]),ta=a.useMemo(()=>{const e=new Map;return t.forEach(t=>{"number"==typeof t.midiCC&&e.set(t.midiCC,{bankId:t.id,bankName:t.name})}),e},[t]),aa=a.useMemo(()=>{const e=[];return t.forEach(t=>{"number"==typeof t.midiNote&&e.push({note:t.midiNote,type:"bank",bankName:t.name}),t.pads.forEach(a=>{"number"==typeof a.midiNote&&e.push({note:a.midiNote,type:"pad",bankName:t.name,padName:a.name})})}),e},[t]),na=a.useMemo(()=>{const e=new Map;return t.forEach(t=>{const a=ft(t.shortcutKey);a&&e.set(a,{bankId:t.id,bankName:t.name})}),e},[t,ft]),sa=a.useMemo(()=>{const e=new Set;return t.forEach(t=>{const a=ft(t.shortcutKey);a&&e.add(a),t.pads.forEach(t=>{const a=ft(t.shortcutKey);a&&e.add(a)})}),e},[t,ft]),ia=a.useMemo(()=>{const e=new Set;return t.forEach(t=>{"number"==typeof t.midiNote&&e.add(t.midiNote),t.pads.forEach(t=>{const a=t;"number"==typeof a.midiNote&&e.add(a.midiNote)})}),e},[t]),ra=a.useMemo(()=>{const e=new Set;return t.forEach(t=>{"number"==typeof t.midiCC&&e.add(t.midiCC),t.pads.forEach(t=>{const a=t;"number"==typeof a.midiCC&&e.add(a.midiCC)})}),e},[t]),oa=$.systemMappings.channelMappings||[],la=a.useMemo(()=>{const e=new Set;return Object.keys(dn).filter(e=>"masterVolumeCC"!==e&&"channelMappings"!==e).forEach(t=>{const a=$.systemMappings[t];(null==a?void 0:a.key)&&e.add(a.key)}),e},[$.systemMappings]),da=a.useMemo(()=>{const e=new Set;return Object.keys(dn).filter(e=>"masterVolumeCC"!==e&&"channelMappings"!==e).forEach(t=>{const a=$.systemMappings[t];"number"==typeof(null==a?void 0:a.midiNote)&&e.add(a.midiNote)}),e},[$.systemMappings]),ca=a.useMemo(()=>{const e=new Set;return Object.keys(dn).filter(e=>"masterVolumeCC"!==e&&"channelMappings"!==e).forEach(t=>{const a=$.systemMappings[t];"number"==typeof(null==a?void 0:a.midiCC)&&e.add(a.midiCC)}),"number"==typeof $.systemMappings.masterVolumeCC&&e.add($.systemMappings.masterVolumeCC),e},[$.systemMappings]),ua=a.useMemo(()=>{const e=new Set;return oa.forEach(t=>{(null==t?void 0:t.keyUp)&&e.add(t.keyUp),(null==t?void 0:t.keyDown)&&e.add(t.keyDown),(null==t?void 0:t.keyStop)&&e.add(t.keyStop)}),e},[oa]),ma=a.useMemo(()=>{const e=new Set;return oa.forEach(t=>{"number"==typeof(null==t?void 0:t.midiNote)&&e.add(t.midiNote)}),e},[oa]),ha=a.useMemo(()=>{const e=new Set;return oa.forEach(t=>{"number"==typeof(null==t?void 0:t.midiCC)&&e.add(t.midiCC)}),e},[oa]),fa=a.useMemo(()=>new Set([...la,...ua]),[la,ua]),pa=a.useMemo(()=>new Set([...da,...ma]),[da,ma]),ga=a.useMemo(()=>new Set([...ca,...ha]),[ca,ha]);a.useEffect(()=>{if(!$.autoPadBankMapping)return;if(0===Ee.length)return;const e=new Set;la.forEach(t=>e.add(t)),ua.forEach(t=>e.add(t)),sa.forEach(t=>e.add(t));const t=Ne.map(e=>{const[t,a]=e.split("+");if(!t||!a)return null;const n=t.toLowerCase();return ht(a,{altKey:"alt"===n,metaKey:"meta"===n||"cmd"===n||"command"===n})}).filter(Boolean);let a=0;Ee.forEach(n=>{if(n.disableDefaultBankShortcutLayout)return;if(ft(n.shortcutKey))return;for(;a<t.length&&e.has(t[a]);)a+=1;if(a>=t.length)return;const s=t[a];e.add(s),v(n.id,{shortcutKey:s}),a+=1})},[Ee,la,ua,sa,Ne,$.autoPadBankMapping,v,ft]);const ba=a.useCallback((e,t)=>{e&&le.current.set(e,Math.max(0,t))},[]),va=a.useCallback((e,t,a)=>{if(!e||!t)return;const n=le.current.get(t);e.scrollTop="number"==typeof n?n:a},[]);a.useEffect(()=>{const e=pe.current;if(e&&de.current&&ba(e,de.current.scrollTop),de.current&&r){const e=de.current.scrollTop||me.current;requestAnimationFrame(()=>va(de.current,r,e))}pe.current=r},[r,va,ba]),a.useEffect(()=>{const e=ge.current;if(e&&ce.current&&ba(e,ce.current.scrollTop),ce.current&&s){const e=ce.current.scrollTop||he.current;requestAnimationFrame(()=>va(ce.current,s,e))}ge.current=s},[s,va,ba]),a.useEffect(()=>{const e=be.current;if(e&&ue.current&&ba(e,ue.current.scrollTop),ue.current&&i){const e=ue.current.scrollTop||fe.current;requestAnimationFrame(()=>va(ue.current,i,e))}be.current=i},[i,va,ba]);const ya=a.useCallback((e,t,a,n)=>{j.isPadRegistered(e.id)?n():j.registerPad(e.id,e,t,a).then(()=>n()).catch(t=>{console.error("Failed to register pad for shortcut:",e.id,t)})},[j]),_a=a.useRef(new Map),xa=a.useRef(null);a.useEffect(()=>{c||!r?c&&i&&(xa.current=i):xa.current=r},[c,r,i]);const wa=a.useCallback(e=>{if(c){if(e===s){const e=xa.current;return void(e&&e!==s&&g(e))}return g(e),void(xa.current=e)}b(e),xa.current=e},[c,s,g,b]),ka=a.useCallback(e=>{var t;if(0===Ee.length)return;const a=c?i||s:r,n=Ee.findIndex(e=>e.id===a),o=((n>=0?n:0)+("next"===e?1:-1)+Ee.length)%Ee.length,l=null==(t=Ee[o])?void 0:t.id;l&&(c?g(l):b(l),xa.current=l)},[Ee,c,i,s,r,g,b]);a.useEffect(()=>{const e=e=>{if(!e||!e.tagName)return!1;const t=e,a=t.tagName.toLowerCase();return"input"===a||"textarea"===a||"select"===a||t.isContentEditable},a=a=>{var n,o,l,d,u,m,h,f,g;if(a.defaultPrevented)return;if(e(a.target))return;const b=ht(a.key,{shiftKey:a.shiftKey,ctrlKey:a.ctrlKey,altKey:a.altKey,metaKey:a.metaKey,code:a.code});if(!b)return;const v=Object.keys(dn).filter(e=>"masterVolumeCC"!==e&&"channelMappings"!==e&&"midiShift"!==e).find(e=>{var t;return(null==(t=$.systemMappings[e])?void 0:t.key)===b});if(v)switch(a.preventDefault(),v){case"stopAll":return Nt(),void bt(null==(n=$.systemMappings.stopAll)?void 0:n.midiNote,"#00ff00",6);case"mixer":return void kt(!$.mixerOpen);case"editMode":return void _e("editMode",!$.editMode);case"mute":return void Et();case"banksMenu":return void wt(!$.sideMenuOpen);case"nextBank":return ka("next"),void bt(null==(o=$.systemMappings.nextBank)?void 0:o.midiNote,"#ffffff",6);case"prevBank":return ka("prev"),void bt(null==(l=$.systemMappings.prevBank)?void 0:l.midiNote,"#ffffff",6);case"upload":{const e=document.getElementById("global-audio-upload-input");return null==e||e.click(),void bt(null==(d=$.systemMappings.upload)?void 0:d.midiNote,"#ffffff",6)}case"volumeDown":{const e=Math.max(0,Number(($.masterVolume-.05).toFixed(2)));return void _e("masterVolume",e)}case"volumeUp":{const e=Math.min(1,Number(($.masterVolume+.05).toFixed(2)));return void _e("masterVolume",e)}case"padSizeUp":return zt(),void bt(null==(u=$.systemMappings.padSizeUp)?void 0:u.midiNote,"#ffffff",6);case"padSizeDown":return Gt(),void bt(null==(m=$.systemMappings.padSizeDown)?void 0:m.midiNote,"#ffffff",6);case"importBank":return window.dispatchEvent(new Event("vdjv-import-bank")),void bt(null==(h=$.systemMappings.importBank)?void 0:h.midiNote,"#ffffff",6);case"activateSecondary":{const e=r||(null==(f=t[0])?void 0:f.id)||null;return void(c?p(null):e&&p(e))}}const y=$.systemMappings.channelMappings||[],_=Math.max(2,Math.min(8,$.channelCount||4));for(let e=0;e<Math.min(y.length,_);e+=1){const t=y[e];if(t){if(t.keyUp&&t.keyUp===b){a.preventDefault();const t=j.getChannelVolume(e+1),n=Math.min(1,Number((t+.05).toFixed(2)));return void j.setChannelVolume(e+1,n)}if(t.keyDown&&t.keyDown===b){a.preventDefault();const t=j.getChannelVolume(e+1),n=Math.max(0,Number((t-.05).toFixed(2)));return void j.setChannelVolume(e+1,n)}if(t.keyStop&&t.keyStop===b){a.preventDefault();const t=j.getChannelStates().find(t=>t.channelId===e+1);return void((null==(g=null==t?void 0:t.pad)?void 0:g.padId)&&j.stopPad(t.pad.padId,$.stopMode))}}}if(a.repeat)return;const x=a.ctrlKey||a.altKey||a.metaKey,w=x?ht(a.key,{shiftKey:!1,ctrlKey:a.ctrlKey,altKey:a.altKey,metaKey:a.metaKey,code:a.code}):null,k=ht(a.key,{code:a.code});if(!k&&!w)return;const M=!x&&a.shiftKey,S=w&&!a.shiftKey?w:k;if(!M&&S){const e=na.get(S);if(e)return a.preventDefault(),$.editMode?void we(e.bankId):void wa(e.bankId)}if(!S)return;const C=c?M?i:s:r;if(!C)return;const N=Zt.get(C),A=null==N?void 0:N.get(S);if(A){if(a.preventDefault(),$.editMode)return void xe(A.pad.id);switch(A.pad.triggerMode){case"toggle":ya(A.pad,A.bankId,A.bankName,()=>j.triggerToggle(A.pad.id));break;case"hold":{const e=`${A.bankId}:${S}`;_a.current.set(e,A.pad.id),ya(A.pad,A.bankId,A.bankName,()=>j.triggerHoldStart(A.pad.id));break}case"stutter":ya(A.pad,A.bankId,A.bankName,()=>j.triggerStutter(A.pad.id));break;default:ya(A.pad,A.bankId,A.bankName,()=>j.triggerUnmuteToggle(A.pad.id))}}},n=t=>{if(t.defaultPrevented)return;if(e(t.target))return;const a=t.ctrlKey||t.altKey||t.metaKey?ht(t.key,{shiftKey:!1,ctrlKey:t.ctrlKey,altKey:t.altKey,metaKey:t.metaKey,code:t.code}):null,n=ht(t.key,{code:t.code}),o=a&&!t.shiftKey?a:n;if(!o)return;[s?`${s}:${o}`:null,i?`${i}:${o}`:null,r?`${r}:${o}`:null].filter(Boolean).forEach(e=>{const t=_a.current.get(e);t&&(j.triggerHoldStop(t),_a.current.delete(e))})};return window.addEventListener("keydown",a),window.addEventListener("keyup",n),()=>{window.removeEventListener("keydown",a),window.removeEventListener("keyup",n)}},[kt,wt,Nt,Et,ya,Zt,na,$.editMode,$.masterVolume,$.mixerOpen,$.sideMenuOpen,$.systemMappings,_e,c,b,g,j,zt,Gt,ka,r,t,wa,s,i,xe,we]);const Ma=a.useRef(new Map),Sa=a.useRef(new Map),Ca=a.useRef(new Map),Na=a.useRef(!1),Aa=a.useRef(null),Ea=a.useRef(null);a.useEffect(()=>{c&&i||(Na.current=!1)},[c,i]),a.useEffect(()=>()=>{null!==Ea.current&&(window.cancelAnimationFrame(Ea.current),Ea.current=null),Aa.current=null},[]);const Ia=a.useCallback(e=>{var a,n,o,l,d;const u=e=>e||null,m=e=>{var a,n,s,i,o,l,d,u;switch(e){case"stopAll":return Nt(),bt(null==(a=$.systemMappings.stopAll)?void 0:a.midiNote,"#00ff00",6),!0;case"mixer":return kt(!$.mixerOpen),!0;case"editMode":return _e("editMode",!$.editMode),!0;case"mute":return Et(),!0;case"banksMenu":return wt(!$.sideMenuOpen),!0;case"nextBank":return ka("next"),bt(null==(n=$.systemMappings.nextBank)?void 0:n.midiNote,"#ffffff",6),!0;case"prevBank":return ka("prev"),bt(null==(s=$.systemMappings.prevBank)?void 0:s.midiNote,"#ffffff",6),!0;case"upload":{const e=document.getElementById("global-audio-upload-input");return null==e||e.click(),bt(null==(i=$.systemMappings.upload)?void 0:i.midiNote,"#ffffff",6),!0}case"volumeUp":{const e=Math.min(1,Number(($.masterVolume+.05).toFixed(2)));return _e("masterVolume",e),!0}case"volumeDown":{const e=Math.max(0,Number(($.masterVolume-.05).toFixed(2)));return _e("masterVolume",e),!0}case"padSizeUp":return zt(),bt(null==(o=$.systemMappings.padSizeUp)?void 0:o.midiNote,"#ffffff",6),!0;case"padSizeDown":return Gt(),bt(null==(l=$.systemMappings.padSizeDown)?void 0:l.midiNote,"#ffffff",6),!0;case"importBank":return window.dispatchEvent(new Event("vdjv-import-bank")),bt(null==(d=$.systemMappings.importBank)?void 0:d.midiNote,"#ffffff",6),!0;case"activateSecondary":{const e=r||(null==(u=t[0])?void 0:u.id)||null;return c?p(null):e&&p(e),!0}}return!1},h=null==(a=$.systemMappings.midiShift)?void 0:a.midiNote;if("noteon"===e.type||"noteoff"===e.type){if(0!==e.channel){const t=dt.current.get(`${e.note}:${e.channel}`);if(t&&Date.now()-t<80)return}const t=`${e.inputId}:${e.note}`;if("noteoff"===e.type)Sa.current.delete(t);else{if(Sa.current.get(t))return;Sa.current.set(t,!0)}if(e.note===h)return void(c&&i&&"noteon"===e.type&&(Na.current=!Na.current));if("noteon"===e.type){const t=$.systemMappings.channelMappings||[],a=Math.max(2,Math.min(8,$.channelCount||4)),n=t.findIndex((t,n)=>n<a&&(null==t?void 0:t.midiNote)===e.note);if(n>=0)return void Tt(n+1);const s=Object.keys(dn).find(t=>{var a;return"midiShift"!==t&&(null==(a=$.systemMappings[t])?void 0:a.midiNote)===e.note});if(s&&m(s))return}const a=Na.current,l=c?a?i:s:r,d=c?a?s:i:null,f=ea.get(e.note);if(f&&"noteon"===e.type)return void($.editMode?we(f.bankId):wa(f.bankId));const p=(l?u(null==(n=Jt.get(l))?void 0:n.get(e.note)):null)||("noteoff"===e.type&&d?u(null==(o=Jt.get(d))?void 0:o.get(e.note)):null);if(!p)return;if("noteoff"===e.type){if($.editMode)return;if("hold"===p.pad.triggerMode){Ca.current.get(e.note)===p.pad.id&&(ya(p.pad,p.bankId,p.bankName,()=>j.triggerHoldStop(p.pad.id)),Ca.current.delete(e.note))}return}const g=`${p.pad.id}-${e.note}`,b=Date.now();if(b-(Ma.current.get(g)||0)<120)return;if(Ma.current.set(g,b),$.editMode)return void xe(p.pad.id);switch(p.pad.triggerMode){case"toggle":ya(p.pad,p.bankId,p.bankName,()=>j.triggerToggle(p.pad.id));break;case"hold":ya(p.pad,p.bankId,p.bankName,()=>j.triggerHoldStart(p.pad.id)),Ca.current.set(e.note,p.pad.id);break;case"stutter":ya(p.pad,p.bankId,p.bankName,()=>j.triggerStutter(p.pad.id));break;default:ya(p.pad,p.bankId,p.bankName,()=>j.triggerUnmuteToggle(p.pad.id))}}else if("cc"===e.type){const t=$.systemMappings.channelMappings||[],a=Math.max(2,Math.min(8,$.channelCount||4)),n=t.findIndex((t,n)=>n<a&&(null==t?void 0:t.midiCC)===e.cc);if(n>=0){const t=st(e.value);return void j.setChannelVolume(n+1,Number(t.toFixed(3)))}if("number"==typeof $.systemMappings.masterVolumeCC&&$.systemMappings.masterVolumeCC===e.cc)return Aa.current=Number(st(e.value).toFixed(3)),void(null===Ea.current&&(Ea.current=window.requestAnimationFrame(()=>{Ea.current=null;const e=Aa.current;Aa.current=null,"number"==typeof e&&_e("masterVolume",e)})));const o=Object.keys(dn).find(t=>{var a;return"midiShift"!==t&&(null==(a=$.systemMappings[t])?void 0:a.midiCC)===e.cc});if(o&&m(o))return;const h=Na.current,f=c?h?i:s:r,p=c?h?s:i:null,g=ta.get(e.cc);if(g)return void($.editMode?we(g.bankId):wa(g.bankId));const b=(f?u(null==(l=Qt.get(f))?void 0:l.get(e.cc)):null)||(p?u(null==(d=Qt.get(p))?void 0:d.get(e.cc)):null);if(!b)return;const v=`${b.pad.id}-cc-${e.cc}`,y=Date.now();if(y-(Ma.current.get(v)||0)<120)return;if(Ma.current.set(v,y),$.editMode)return void xe(b.pad.id);switch(b.pad.triggerMode){case"toggle":ya(b.pad,b.bankId,b.bankName,()=>j.triggerToggle(b.pad.id));break;case"hold":ya(b.pad,b.bankId,b.bankName,()=>j.triggerHoldStart(b.pad.id));break;case"stutter":ya(b.pad,b.bankId,b.bankName,()=>j.triggerStutter(b.pad.id));break;default:ya(b.pad,b.bankId,b.bankName,()=>j.triggerUnmuteToggle(b.pad.id))}}},[Jt,Qt,ea,ta,j,ya,b,g,$.systemMappings,$.masterVolume,$.mixerOpen,$.sideMenuOpen,_e,Nt,kt,Et,wt,zt,Gt,ka,r,s,i,c,t,c,wa,s,i,st,Tt,xe,we]);a.useEffect(()=>{const e=e=>{const t=e.detail;t&&Ia(t)};return window.addEventListener("vdjv-midi",e),()=>{window.removeEventListener("vdjv-midi",e)}},[Ia]);const ja=a.useCallback((e,a,n)=>{if(console.log("App handling pad transfer:",{padId:e,sourceBankId:a,targetBankId:n}),console.log("Current dual mode state:",{isDualMode:c,primaryBankId:s,secondaryBankId:i,currentBankId:r}),a===n)return void console.log("Source and target banks are the same, ignoring transfer");const o=t.find(e=>e.id===a),l=t.find(e=>e.id===n);if(!o||!l)return void console.error("Source or target bank not found:",{sourceBank:!!o,targetBank:!!l});if(o.pads.find(t=>t.id===e)){if(c){const e=a===i&&n===s;a===s&&n===i?console.log("Transferring from Primary to Secondary bank"):e?console.log("Transferring from Secondary to Primary bank"):console.log("Transferring between active dual mode bank and other bank")}try{console.log("Executing transfer via store..."),S(e,a,n),console.log("Transfer completed successfully")}catch(d){console.error("Failed to transfer pad:",d),G("Failed to transfer pad. Please try again."),W(!0)}}else console.error("Pad to transfer not found in source bank")},[t,S,c,s,i,r]),Ta=a.useCallback((e,t,a)=>{if(!$.editMode)return void e.preventDefault();console.log("App level pad drag start:",{padId:t.id,sourceBankId:a,isDualMode:c,primaryBankId:s,secondaryBankId:i});const n={type:"pad-transfer",pad:t,sourceBankId:a,isDualMode:c,primaryBankId:s,secondaryBankId:i};e.dataTransfer.setData("application/json",JSON.stringify(n)),e.dataTransfer.setData("text/plain",JSON.stringify(n)),e.dataTransfer.effectAllowed="move",console.log("Drag data set:",n)},[$.editMode,c,s,i]),Ba=a.useMemo(()=>{const e=P<768,t=e?6:14,a=e?1:2;let n=$.padSize;P<480&&(n=Math.min($.padSize,6));const s=Math.max(a,Math.min(t,n));return c?Math.max(1,Math.floor(s/2)):s},[$.padSize,P,c]),Pa=a.useMemo(()=>P<768||"overlay"===$.sidePanelMode?"mx-0":$.sideMenuOpen&&!$.mixerOpen?"ml-64":!$.sideMenuOpen&&$.mixerOpen?"mr-64":$.sideMenuOpen&&$.mixerOpen?"mx-64":"mx-0",[P,$.sidePanelMode,$.sideMenuOpen,$.mixerOpen]),Ra=a.useMemo(()=>P<768?"px-1":"px-2",[P]),Da=a.useCallback(()=>{var e;null==(e=J.current)||e.click()},[]),Oa=a.useCallback(()=>{var e;null==(e=Q.current)||e.click()},[]),La=a.useCallback(async e=>{var t;const a=null==(t=e.target.files)?void 0:t[0];if(e.target.value="",a)try{const e=await at(a);Z(null),G(e),W(!0)}catch(n){G(n instanceof Error?n.message:"Backup restore failed."),W(!0)}},[at]),Ua=a.useCallback(async e=>{const t=Array.from(e.target.files||[]);if(e.target.value="",t.length)try{const e=await nt(t);Z(null),G(e),W(!0)}catch(a){G(a instanceof Error?a.message:"Recovery import failed."),W(!0)}},[nt]),Va=a.useMemo(()=>t.flatMap(e=>e.pads),[t]),$a=a.useMemo(()=>t.map(e=>({id:e.id,name:e.name})),[t]),{primaryBank:Ha,secondaryBank:Ka,singleBank:qa}=c?{primaryBank:o,secondaryBank:l}:{singleBank:d},za=c?"h-screen overflow-hidden":"min-h-screen";return n.jsxs("div",{className:`${za} transition-all duration-300 ${"dark"===T?"bg-gray-900":"bg-gray-50"} flex`,children:[n.jsx(sn,{open:$.sideMenuOpen,onOpenChange:wt,banks:t,primaryBankId:s,secondaryBankId:i,currentBankId:r,isDualMode:c,theme:T,editMode:$.editMode,onCreateBank:f,onSetPrimaryBank:p,onSetSecondaryBank:g,onSetCurrentBank:b,onUpdateBank:v,onUpdatePad:Yt,onDeleteBank:Wt,onImportBank:_,onExportBank:x,onMoveBankUp:k,onMoveBankDown:M,onTransferPad:ja,canTransferFromBank:N,onExportAdmin:V?C:void 0,midiEnabled:D.enabled&&D.accessGranted,blockedShortcutKeys:fa,blockedMidiNotes:pa,blockedMidiCCs:ga,editBankRequest:se,hideShortcutLabels:$.hideShortcutLabels}),ee&&n.jsx(ee,{open:$.mixerOpen,onOpenChange:kt,channelStates:it,channelCount:$.channelCount,legacyPlayingPads:rt,masterVolume:$.masterVolume,onMasterVolumeChange:e=>_e("masterVolume",e),onPadVolumeChange:It,onStopPad:At,onChannelVolumeChange:jt,onStopChannel:Tt,onPlayChannel:Pt,onPauseChannel:Bt,onSeekChannel:Rt,onUnloadChannel:Dt,onArmChannelLoad:Vt,onCancelChannelLoad:$t,armedLoadChannelId:re,onSetChannelHotcue:Ot,onTriggerChannelHotcue:Lt,onSaveChannelHotcuesToPad:Ft,onSetChannelCollapsed:Ut,stopMode:$.stopMode,editMode:$.editMode,eqSettings:$.eqSettings,onEqChange:e=>_e("eqSettings",e),mixerEqCollapsed:$.mixerEqCollapsed,onMixerEqCollapsedChange:e=>_e("mixerEqCollapsed",e),theme:T,windowWidth:P}),n.jsx("div",{className:`flex-1 min-h-0 ${Pa} ${Ra}`,children:n.jsxs("div",{className:"max-w-full mx-auto py-2 relative z-10 h-full min-h-0 flex flex-col",children:[n.jsx(pn,{primaryBank:Ha,secondaryBank:Ka,currentBank:qa,isDualMode:c,padSize:$.padSize,stopMode:$.stopMode,editMode:$.editMode,globalMuted:K,sideMenuOpen:$.sideMenuOpen,mixerOpen:$.mixerOpen,theme:T,windowWidth:P,onFileUpload:St,onToggleEditMode:()=>_e("editMode",!$.editMode),onToggleMute:Et,onStopAll:Nt,onToggleSideMenu:()=>wt(!$.sideMenuOpen),onToggleMixer:()=>kt(!$.mixerOpen),onToggleTheme:B,onExitDualMode:()=>p(null),onPadSizeChange:Kt,onStopModeChange:e=>_e("stopMode",e),midiSupported:D.supported,midiEnabled:D.enabled,midiAccessGranted:D.enabled&&D.accessGranted,midiBackend:D.backend,midiOutputSupported:D.outputSupported,midiInputs:D.inputs,midiSelectedInputId:D.selectedInputId,midiError:D.error,onRequestMidiAccess:D.requestAccess,onSelectMidiInput:D.setSelectedInputId,onToggleMidiEnabled:Me,systemMappings:$.systemMappings,onUpdateSystemKey:Pe,onResetSystemKey:Oe,onUpdateSystemMidi:Re,onUpdateSystemColor:De,onSetMasterVolumeCC:Le,channelCount:$.channelCount,onChangeChannelCount:Ue,onUpdateChannelMapping:Fe,padBankShortcutKeys:sa,padBankMidiNotes:ia,padBankMidiCCs:ra,midiNoteAssignments:aa,hideShortcutLabels:$.hideShortcutLabels,onToggleHideShortcutLabels:ke,autoPadBankMapping:$.autoPadBankMapping,onToggleAutoPadBankMapping:e=>_e("autoPadBankMapping",e),sidePanelMode:$.sidePanelMode,onChangeSidePanelMode:e=>_e("sidePanelMode",e),onResetAllSystemMappings:qe,onClearAllSystemMappings:ze,onResetAllChannelMappings:We,onClearAllChannelMappings:Ze,onExportMappings:Qe,onImportMappings:et,onExportAppBackup:tt,onRestoreAppBackup:at,onRecoverMissingMediaFromBanks:nt,midiDeviceProfiles:Kr,midiDeviceProfileId:$.midiDeviceProfileId,onSelectMidiDeviceProfile:e=>_e("midiDeviceProfileId",e)}),c?n.jsxs("div",{className:"flex gap-2 flex-1 min-h-0",children:[n.jsx("div",{className:"flex-1 min-h-0",children:n.jsx("div",{ref:ce,onScroll:()=>{const e=ce.current;e&&s&&(he.current=e.scrollTop,ba(s,e.scrollTop))},className:"h-full overflow-y-auto overscroll-contain pr-1",children:n.jsx(Ct,{pads:(null==Ha?void 0:Ha.pads)||[],bankId:s||"",bankName:(null==Ha?void 0:Ha.name)||"",allBanks:t,allPads:Va,editMode:$.editMode,globalMuted:K,masterVolume:$.masterVolume,padSize:Ba,theme:T,stopMode:$.stopMode,eqSettings:$.eqSettings,windowWidth:P,onUpdatePad:Yt,onRemovePad:e=>Xt(s||"",e),onReorderPads:(e,t)=>w(s||"",e,t),onFileUpload:e=>St(e,s||void 0),onPadDragStart:Ta,onTransferPad:ja,availableBanks:$a,canTransferFromBank:N,midiEnabled:D.enabled&&D.accessGranted,hideShortcutLabel:$.hideShortcutLabels,editRequest:ae,blockedShortcutKeys:fa,blockedMidiNotes:pa,blockedMidiCCs:ga,channelLoadArmed:null!==re,onSelectPadForChannelLoad:Ht})})}),n.jsx("div",{className:"flex-1 min-h-0",children:Ka?n.jsx("div",{ref:ue,onScroll:()=>{const e=ue.current;e&&i&&(fe.current=e.scrollTop,ba(i,e.scrollTop))},className:"h-full overflow-y-auto overscroll-contain pl-1",children:n.jsx(Ct,{pads:Ka.pads||[],bankId:i||"",bankName:Ka.name||"",allBanks:t,allPads:Va,editMode:$.editMode,globalMuted:K,masterVolume:$.masterVolume,padSize:Ba,theme:T,stopMode:$.stopMode,eqSettings:$.eqSettings,windowWidth:P,onUpdatePad:Yt,onRemovePad:e=>Xt(i||"",e),onReorderPads:(e,t)=>w(i||"",e,t),onFileUpload:e=>St(e,i||void 0),onPadDragStart:Ta,onTransferPad:ja,availableBanks:$a,canTransferFromBank:N,midiEnabled:D.enabled&&D.accessGranted,hideShortcutLabel:$.hideShortcutLabels,editRequest:ae,blockedShortcutKeys:fa,blockedMidiNotes:pa,blockedMidiCCs:ga,channelLoadArmed:null!==re,onSelectPadForChannelLoad:Ht})}):n.jsx("div",{className:"flex items-center justify-center h-64 rounded-2xl border-2 border-dashed transition-all duration-300 "+("dark"===T?"bg-gray-800 border-gray-600":"bg-white border-gray-300"),children:n.jsx("p",{className:"text-center "+("dark"===T?"text-gray-400":"text-gray-600"),children:"Select a secondary bank from the sidebar"})})})]}):qa?n.jsx("div",{ref:de,onScroll:()=>{const e=de.current;e&&r&&(me.current=e.scrollTop,ba(r,e.scrollTop))},className:"flex-1 min-h-0 overflow-y-auto overscroll-contain",children:n.jsx(Ct,{pads:qa.pads||[],bankId:r||"",bankName:qa.name||"",allBanks:t,allPads:Va,editMode:$.editMode,globalMuted:K,masterVolume:$.masterVolume,padSize:Ba,theme:T,stopMode:$.stopMode,eqSettings:$.eqSettings,windowWidth:P,onUpdatePad:Yt,onRemovePad:e=>Xt(r||"",e),onReorderPads:(e,t)=>w(r||"",e,t),onFileUpload:St,onPadDragStart:Ta,onTransferPad:ja,availableBanks:$a,canTransferFromBank:N,midiEnabled:D.enabled&&D.accessGranted,hideShortcutLabel:$.hideShortcutLabels,editRequest:ae,blockedShortcutKeys:fa,blockedMidiNotes:pa,blockedMidiCCs:ga,channelLoadArmed:null!==re,onSelectPadForChannelLoad:Ht})}):n.jsx("div",{className:"flex items-center justify-center h-64 rounded-2xl border-2 border-dashed transition-all duration-300 "+("dark"===T?"bg-gray-800 border-gray-600":"bg-white border-gray-300"),children:n.jsx("p",{className:"text-center "+("dark"===T?"text-gray-400":"text-gray-600"),children:"Select a bank from the sidebar to get started"})})]})}),n.jsx("input",{ref:J,type:"file",accept:".vdjvbackup,application/octet-stream",className:"hidden",onChange:La}),n.jsx("input",{ref:Q,type:"file",accept:".bank,application/zip,application/octet-stream,*/*",multiple:!0,className:"hidden",onChange:Ua}),n.jsx(Ke,{open:Boolean(Y),onOpenChange:e=>{e||Z(null)},children:n.jsxs(Ge,{className:""+("dark"===T?"bg-gray-800 border-amber-500":"bg-white border-amber-400"),"aria-describedby":void 0,children:[n.jsx(Xe,{children:n.jsx(Ye,{className:"text-amber-500",children:"Some pad files are missing"})}),n.jsxs("div",{className:"space-y-3",children:[n.jsxs("p",{className:"text-sm "+("dark"===T?"text-gray-300":"text-gray-700"),children:["Missing audio: ",n.jsx("span",{className:"font-semibold",children:(null==Y?void 0:Y.missingAudio)||0})," | Missing images: ",n.jsx("span",{className:"font-semibold",children:(null==Y?void 0:Y.missingImages)||0})]}),(null==(e=null==Y?void 0:Y.affectedBanks)?void 0:e.length)?n.jsxs("p",{className:"text-xs "+("dark"===T?"text-gray-400":"text-gray-500"),children:["Affected banks: ",Y.affectedBanks.join(", ")]}):null,n.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[n.jsx(Te,{onClick:Da,variant:"default",children:"Restore from Backup"}),n.jsx(Te,{onClick:Oa,variant:"outline",children:"Import .bank files one by one"}),n.jsx(Te,{onClick:()=>Z(null),variant:"ghost",children:"Continue"})]})]})]})}),n.jsx(Ke,{open:X,onOpenChange:W,children:n.jsxs(Ge,{className:"sm:max-w-md "+("dark"===T?"bg-gray-800 border-red-500":"bg-white border-red-500"),"aria-describedby":void 0,children:[n.jsx(Xe,{children:n.jsx(Ye,{className:"text-red-600",children:"Error"})}),n.jsxs("div",{className:"space-y-4",children:[n.jsx("p",{className:"text-sm "+("dark"===T?"text-gray-300":"text-gray-700"),children:z}),n.jsx(Te,{onClick:()=>{W(!1),G(null)},className:"w-full",children:"OK"})]})]})})]})}const Zr=a.forwardRef(({className:e,...t},a)=>n.jsx("div",{ref:a,className:Ie("rounded-xl border bg-card text-card-foreground shadow",e),...t}));Zr.displayName="Card";const Jr=a.forwardRef(({className:e,...t},a)=>n.jsx("div",{ref:a,className:Ie("flex flex-col space-y-1.5 p-6",e),...t}));Jr.displayName="CardHeader";const Qr=a.forwardRef(({className:e,...t},a)=>n.jsx("div",{ref:a,className:Ie("font-semibold leading-none tracking-tight",e),...t}));Qr.displayName="CardTitle";const eo=a.forwardRef(({className:e,...t},a)=>n.jsx("div",{ref:a,className:Ie("text-sm text-muted-foreground",e),...t}));eo.displayName="CardDescription";const to=a.forwardRef(({className:e,...t},a)=>n.jsx("div",{ref:a,className:Ie("p-6 pt-0",e),...t}));to.displayName="CardContent";function ao({children:e}){const[t,a]=D.useState({error:null,errorInfo:null,errorId:"",showError:!1}),s=D.useCallback((e,t)=>{const n=`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;console.error("Global error caught:",e,t),a({error:e,errorInfo:t||null,errorId:n,showError:!0});{const a={message:e.message,stack:e.stack,componentStack:null==t?void 0:t.componentStack,timestamp:(new Date).toISOString(),userAgent:navigator.userAgent,url:window.location.href,errorId:n};console.log("Error data for external service:",a)}},[]),i=D.useCallback(e=>{const t=e.reason instanceof Error?e.reason:new Error(String(e.reason));s(t)},[s]),r=D.useCallback(e=>{const t=e.error||new Error(e.message);s(t)},[s]);D.useEffect(()=>(window.addEventListener("error",r),window.addEventListener("unhandledrejection",i),()=>{window.removeEventListener("error",r),window.removeEventListener("unhandledrejection",i)}),[r,i]);const o=()=>{a(e=>({...e,showError:!1}))},l=()=>{window.location.reload()},d=()=>{window.location.href="/"},c=()=>{var e,a,n;const s=t.errorId,i=null==(e=t.error)?void 0:e.message,r=null==(a=t.error)?void 0:a.stack,o=null==(n=t.errorInfo)?void 0:n.componentStack,l=window.location.href,d=navigator.userAgent,c=`mailto:support@vdjv.com?subject=Error Report ${s}&body=${encodeURIComponent(`Error Report (ID: ${s})\n\nError: ${i}\n\nURL: ${l}\nUser Agent: ${d}\n\nStack Trace:\n${r}\n\nComponent Stack:\n${o}\n\nPlease describe what you were doing when this error occurred:\n`)}`;window.open(c)},u=()=>{a(e=>({...e,showError:!1}))};return t.showError&&t.error?n.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-background/80 backdrop-blur-sm",children:n.jsxs(Zr,{className:"w-full max-w-md relative",children:[n.jsx(Te,{variant:"ghost",size:"sm",className:"absolute top-2 right-2 h-8 w-8 p-0",onClick:u,children:n.jsx(K,{className:"h-4 w-4"})}),n.jsxs(Jr,{className:"text-center pr-8",children:[n.jsx("div",{className:"mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/20",children:n.jsx(X,{className:"h-6 w-6 text-red-600 dark:text-red-400"})}),n.jsx(Qr,{className:"text-xl",children:"Something went wrong"}),n.jsxs(eo,{children:["An unexpected error occurred. Error ID: ",t.errorId]})]}),n.jsxs(to,{className:"space-y-4",children:[n.jsx("div",{className:"rounded-lg bg-muted p-3",children:n.jsx("p",{className:"text-sm text-muted-foreground",children:t.error.message||"Unknown error occurred"})}),n.jsxs("div",{className:"flex flex-col gap-2",children:[n.jsxs(Te,{onClick:o,variant:"default",className:"w-full",children:[n.jsx(Me,{className:"mr-2 h-4 w-4"}),"Try Again"]}),n.jsxs(Te,{onClick:l,variant:"outline",className:"w-full",children:[n.jsx(Me,{className:"mr-2 h-4 w-4"}),"Reload Page"]}),n.jsxs(Te,{onClick:d,variant:"outline",className:"w-full",children:[n.jsx(Se,{className:"mr-2 h-4 w-4"}),"Go Home"]}),n.jsxs(Te,{onClick:c,variant:"ghost",className:"w-full",children:[n.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Report Bug"]})]}),!1]})]})}):n.jsx(n.Fragment,{children:e})}a.forwardRef(({className:e,...t},a)=>n.jsx("div",{ref:a,className:Ie("flex items-center p-6 pt-0",e),...t})).displayName="CardFooter";class no extends D.Component{constructor(e){super(e),t(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null,errorId:""})}),t(this,"handleReload",()=>{window.location.reload()}),t(this,"handleGoHome",()=>{window.location.href="/"}),t(this,"handleReportBug",()=>{var e,t,a;const n=this.state.errorId,s=null==(e=this.state.error)?void 0:e.message,i=null==(t=this.state.error)?void 0:t.stack,r=null==(a=this.state.errorInfo)?void 0:a.componentStack,o=window.location.href,l=navigator.userAgent,d=`mailto:support@vdjv.com?subject=Error Report ${n}&body=${encodeURIComponent(`Error Report (ID: ${n})\n\nError: ${s}\n\nURL: ${o}\nUser Agent: ${l}\n\nStack Trace:\n${i}\n\nComponent Stack:\n${r}\n\nPlease describe what you were doing when this error occurred:\n`)}`;window.open(d)}),this.state={hasError:!1,error:null,errorInfo:null,errorId:""}}static getDerivedStateFromError(e){return{hasError:!0,error:e,errorId:`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}componentDidCatch(e,t){console.error("ErrorBoundary caught an error:",e,t),this.setState({errorInfo:t,errorId:`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}),this.props.onError&&this.props.onError(e,t),this.logErrorToService(e,t)}logErrorToService(e,t){const a={message:e.message,stack:e.stack,componentStack:t.componentStack,timestamp:(new Date).toISOString(),userAgent:navigator.userAgent,url:window.location.href,errorId:this.state.errorId};console.log("Error data for external service:",a)}render(){var e;if(this.state.hasError){if(this.props.fallback){const e=this.props.fallback;return n.jsx(e,{error:this.state.error,errorInfo:this.state.errorInfo,errorId:this.state.errorId,onReset:this.handleReset})}return n.jsx("div",{className:"min-h-screen flex items-center justify-center p-4 bg-background",children:n.jsxs(Zr,{className:"w-full max-w-md",children:[n.jsxs(Jr,{className:"text-center",children:[n.jsx("div",{className:"mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/20",children:n.jsx(X,{className:"h-6 w-6 text-red-600 dark:text-red-400"})}),n.jsx(Qr,{className:"text-xl",children:"Something went wrong"}),n.jsxs(eo,{children:["An unexpected error occurred. Error ID: ",this.state.errorId]})]}),n.jsxs(to,{className:"space-y-4",children:[n.jsx("div",{className:"rounded-lg bg-muted p-3",children:n.jsx("p",{className:"text-sm text-muted-foreground",children:(null==(e=this.state.error)?void 0:e.message)||"Unknown error occurred"})}),n.jsxs("div",{className:"flex flex-col gap-2",children:[n.jsxs(Te,{onClick:this.handleReset,variant:"default",className:"w-full",children:[n.jsx(Me,{className:"mr-2 h-4 w-4"}),"Try Again"]}),n.jsxs(Te,{onClick:this.handleReload,variant:"outline",className:"w-full",children:[n.jsx(Me,{className:"mr-2 h-4 w-4"}),"Reload Page"]}),n.jsxs(Te,{onClick:this.handleGoHome,variant:"outline",className:"w-full",children:[n.jsx(Se,{className:"mr-2 h-4 w-4"}),"Go Home"]}),n.jsxs(Te,{onClick:this.handleReportBug,variant:"ghost",className:"w-full",children:[n.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Report Bug"]})]}),!1]})]})})}return this.props.children}}function so({isVisible:e,onClose:t}){const{theme:a}=xr(),[s,i]=D.useState({isUnlocked:!1,isRingerBypassed:!1,contextState:"unknown",failureCount:0}),[r,o]=D.useState(!1),l=D.useMemo(()=>De(),[]);D.useEffect(()=>{if(!e)return;const t=()=>{if(l){const e=l.getState();i({isUnlocked:l.isUnlocked(),isRingerBypassed:l.isRingerBypassed(),contextState:e.contextState,failureCount:e.failureCount})}};t();const a=setInterval(t,1e3);return()=>clearInterval(a)},[e,l]);const d=async()=>{o(!0);try{if(l){await l.forceUnlock()?console.log("‚úÖ iOS audio unlocked successfully"):console.log("‚ùå iOS audio unlock failed")}}catch(e){console.error("iOS unlock error:",e)}finally{o(!1)}};if(!e)return null;const c=(()=>{const e=[];return s.isUnlocked||e.push({icon:n.jsx(ye,{className:"w-4 h-4"}),title:"Unlock Audio Context",description:"Tap the button below to unlock iOS audio playback",action:d,actionText:"Unlock Audio",critical:!0}),s.isRingerBypassed||e.push({icon:n.jsx(ee,{className:"w-4 h-4"}),title:"Silent Switch Issue",description:"Your device's silent switch may be affecting audio. This will be automatically bypassed.",critical:!1}),s.failureCount>0&&e.push({icon:n.jsx(Me,{className:"w-4 h-4"}),title:"Audio System Recovery",description:`Detected ${s.failureCount} unlock failures. Consider reloading the page.`,action:()=>window.location.reload(),actionText:"Reload Page",critical:!0}),e})();return n.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:n.jsxs(Zr,{className:"w-full max-w-md "+("dark"===a?"bg-gray-800 text-white":"bg-white"),children:[n.jsxs(Jr,{children:[n.jsxs(Qr,{className:"flex items-center gap-2",children:[n.jsx(X,{className:"w-5 h-5 text-yellow-500"}),"iOS Audio Setup"]}),n.jsx(eo,{children:"iOS requires special setup for audio playback in web apps"})]}),n.jsxs(to,{className:"space-y-4",children:[n.jsxs("div",{className:"p-3 rounded-lg "+("dark"===a?"bg-gray-700":"bg-gray-50"),children:[n.jsx("h4",{className:"font-medium text-sm mb-2",children:"Current Status"}),n.jsxs("div",{className:"space-y-1 text-xs",children:[n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{children:"Audio Context:"}),n.jsx("span",{className:s.isUnlocked&&s.isRingerBypassed?"text-green-600":s.failureCount>2?"text-red-600":"text-yellow-600",children:s.contextState})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{children:"Unlocked:"}),n.jsx("span",{className:s.isUnlocked?"text-green-600":"text-red-600",children:s.isUnlocked?"‚úÖ Yes":"‚ùå No"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{children:"Silent Switch Bypass:"}),n.jsx("span",{className:s.isRingerBypassed?"text-green-600":"text-yellow-600",children:s.isRingerBypassed?"‚úÖ Active":"‚è≥ Pending"})]})]})]}),c.length>0&&n.jsxs("div",{className:"space-y-3",children:[n.jsx("h4",{className:"font-medium text-sm",children:"Troubleshooting Steps"}),c.map((e,t)=>n.jsx("div",{className:"p-3 rounded-lg border "+(e.critical?"dark"===a?"border-red-400 bg-red-900/20":"border-red-200 bg-red-50":"dark"===a?"border-yellow-400 bg-yellow-900/20":"border-yellow-200 bg-yellow-50"),children:n.jsxs("div",{className:"flex items-start gap-2",children:[n.jsx("div",{className:"mt-0.5 "+(e.critical?"text-red-600":"text-yellow-600"),children:e.icon}),n.jsxs("div",{className:"flex-1",children:[n.jsx("h5",{className:"font-medium text-sm",children:e.title}),n.jsx("p",{className:"text-xs mt-1 "+("dark"===a?"text-gray-300":"text-gray-600"),children:e.description}),e.action&&n.jsx(Te,{size:"sm",variant:e.critical?"destructive":"secondary",className:"mt-2",onClick:e.action,disabled:r,children:r&&"Unlock Audio"===e.actionText?n.jsxs(n.Fragment,{children:[n.jsx(Me,{className:"w-3 h-3 mr-1 animate-spin"}),"Unlocking..."]}):e.actionText})]})]})},t))]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("h4",{className:"font-medium text-sm",children:"iOS Audio Tips"}),n.jsxs("div",{className:"text-xs space-y-1 "+("dark"===a?"text-gray-300":"text-gray-600"),children:[n.jsx("p",{children:"‚Ä¢ Make sure your volume is turned up"}),n.jsx("p",{children:"‚Ä¢ Check that silent mode is off (switch above volume buttons)"}),n.jsx("p",{children:"‚Ä¢ Close the Control Center if audio controls appear there"}),n.jsx("p",{children:"‚Ä¢ Try locking and unlocking your device if audio stops"}),n.jsx("p",{children:"‚Ä¢ Reload the page if problems persist"})]})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("h4",{className:"font-medium text-sm",children:"Debug Information"}),n.jsxs("div",{className:"text-xs font-mono p-2 rounded overflow-x-auto "+("dark"===a?"bg-gray-700":"bg-gray-100"),children:[n.jsxs("div",{children:["Context: ",s.contextState]}),n.jsxs("div",{children:["Failures: ",s.failureCount]}),n.jsxs("div",{children:["UA: ",navigator.userAgent.includes("iPhone")?"iPhone":navigator.userAgent.includes("iPad")?"iPad":"Other"]})]})]}),n.jsxs("div",{className:"flex gap-2 pt-4",children:[n.jsxs(Te,{size:"sm",variant:"outline",onClick:()=>{try{window.debugIOSAudio?(window.debugIOSAudio(),console.log("iOS debug info logged to console")):console.log("Debug function not available")}catch(e){console.error("Debug error:",e)}},className:"flex-1",children:[n.jsx(ue,{className:"w-3 h-3 mr-1"}),"Debug"]}),n.jsx(Te,{size:"sm",onClick:()=>{t()},className:"flex-1",children:s.isUnlocked?"Continue":"Close"})]})]})]})})}function io(){const{IOSAudioHelper:e}=function(){const[e,t]=D.useState(!1),[a,s]=D.useState(!1);D.useEffect(()=>{if(!/iPad|iPhone|iPod/.test(navigator.userAgent)||a)return;const e=()=>{const e=De();e&&!e.isUnlocked()&&t(!0)},n=["touchstart","click","mousedown"],s=()=>{setTimeout(e,1e3),n.forEach(e=>document.removeEventListener(e,s))};return n.forEach(e=>document.addEventListener(e,s,{once:!0})),()=>{n.forEach(e=>document.removeEventListener(e,s))}},[a]);const i=()=>{t(!1),s(!0)};return{showHelper:e,hideHelper:i,IOSAudioHelper:t=>n.jsx(so,{...t,isVisible:e,onClose:i})}}();return n.jsx(no,{children:n.jsx(ao,{children:n.jsxs(Ja,{children:[n.jsx(Yr,{}),n.jsx(e,{})]})})})}const ro="https:"===window.location.protocol||"localhost"===window.location.hostname;"serviceWorker"in navigator&&ro&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(e=>{console.log("SW registered: ",e)}).catch(e=>{console.log("SW registration failed: ",e)})});const oo=window.matchMedia("(prefers-color-scheme: dark)");function lo(e=null){const t=e?e.matches:oo.matches;document.documentElement.classList.toggle("dark",t)}lo(),oo.addEventListener("change",lo),Ee.createRoot(document.getElementById("root")).render(n.jsx(a.StrictMode,{children:n.jsx(io,{})}));export{Te as B,dt as C,Ke as D,Je as I,et as L,lt as S,Er as W,Ge as a,Xe as b,Ie as c,Ye as d,sa as e,bt as f,ia as g,Ht as h,Br as i,Ar as r,jt as s};
//# sourceMappingURL=index-DlAi4YWJ.js.map
